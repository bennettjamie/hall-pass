<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hall Pass</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-card: #252540;
            --bg-hover: #2d2d4a;
            --accent: #6366f1;
            --accent-light: #818cf8;
            --success: #22c55e;
            --success-glow: rgba(34, 197, 94, 0.3);
            --warning: #f59e0b;
            --warning-glow: rgba(245, 158, 11, 0.3);
            --danger: #ef4444;
            --danger-glow: rgba(239, 68, 68, 0.3);
            --excused: #8b5cf6;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --border: rgba(255,255,255,0.1);
            --shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            user-select: none;
        }

        /* Navigation */
        .nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 48px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .logo {
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .nav-tabs {
            display: flex;
            gap: 2px;
        }
        
        .nav-tab {
            padding: 14px 12px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.85rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .nav-tab:hover {
            color: var(--text-primary);
        }
        
        .nav-tab.active {
            color: var(--accent-light);
            border-bottom-color: var(--accent);
        }
        
        .nav-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .class-selector select {
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 8px;
        }
        
        .icon-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .icon-btn:hover {
            background: var(--bg-hover);
        }

        /* Status Bar - Compact */
        .status-bar {
            background: var(--bg-secondary);
            padding: 8px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }
        
        .period-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .date-display {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 10px;
            background: var(--bg-card);
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .date-display:hover {
            background: var(--bg-hover);
        }
        
        .date-day {
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .date-full {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        
        .schedule-type {
            background: var(--accent);
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .schedule-type.amfit {
            background: #f59e0b;
            color: black;
        }
        
        .schedule-type.pmfit {
            background: #8b5cf6;
        }
        
        .schedule-type.custom {
            background: #06b6d4;
        }
        
        .class-name {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.8rem;
        }
        
        /* Schedule Tabs */
        .sched-tab.active {
            background: var(--accent) !important;
            color: white;
        }
        
        .sched-panel {
            display: none;
        }
        
        .sched-panel.active {
            display: block;
        }
        
        /* Visual Schedule Calendar */
        .calendar-container {
            display: grid;
            grid-template-columns: 60px repeat(5, 1fr);
            gap: 2px;
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 12px;
            min-height: 500px;
        }
        
        .calendar-header {
            text-align: center;
            font-weight: 600;
            padding: 10px 4px;
            background: var(--bg-card);
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .calendar-times {
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .calendar-time-label {
            position: absolute;
            right: 4px;
            font-size: 0.7rem;
            color: var(--text-secondary);
            transform: translateY(-50%);
        }
        
        .calendar-day {
            position: relative;
            background: var(--bg-primary);
            border-radius: 6px;
            min-height: 400px;
        }
        
        .calendar-block {
            position: absolute;
            left: 2px;
            right: 2px;
            border-radius: 6px;
            padding: 4px 6px;
            font-size: 0.75rem;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .calendar-block:hover {
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            transform: scale(1.02);
        }
        
        .calendar-block.period { background: var(--accent); color: white; }
        .calendar-block.break { background: var(--bg-card); color: var(--text-secondary); }
        .calendar-block.lunch { background: #22c55e44; border: 1px solid var(--success); color: var(--success); }
        .calendar-block.fit { background: #f59e0b44; border: 1px solid #f59e0b; color: #f59e0b; }
        .calendar-block.custom { background: #8b5cf644; border: 1px solid #8b5cf6; color: #8b5cf6; }
        
        .calendar-block .block-title {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .calendar-block .block-time {
            font-size: 0.65rem;
            opacity: 0.8;
        }
        
        .calendar-block .block-class {
            font-size: 0.65rem;
            opacity: 0.9;
            margin-top: 2px;
        }
        
        /* Period Rotation Grid */
        .rotation-grid {
            display: grid;
            grid-template-columns: auto repeat(5, 1fr);
            gap: 4px;
            margin-top: 20px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }
        
        .rotation-header {
            font-weight: 600;
            text-align: center;
            padding: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .rotation-label {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 12px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .rotation-cell {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 4px;
            text-align: center;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .rotation-cell.fit-block {
            background: #f59e0b22;
            border-color: #f59e0b;
        }
        
        .rotation-select {
            width: 100%;
            padding: 8px 4px;
            border: none;
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.8rem;
            cursor: pointer;
            text-align: center;
            text-align-last: center;
        }
        
        .rotation-select:hover {
            background: var(--accent);
            color: white;
        }
        
        .rotation-select:focus {
            outline: 2px solid var(--accent);
            outline-offset: 1px;
        }
        
        .fit-block .rotation-select {
            background: #f59e0b33;
        }
        
        .fit-block .rotation-select:hover {
            background: #f59e0b;
        }
        
        .rotation-section-title {
            font-size: 0.95rem;
            font-weight: 600;
            margin: 20px 0 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .rotation-help {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }
        
        /* Calendar Context Menu */
        .calendar-context-menu {
            position: fixed;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 0;
            min-width: 180px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            z-index: 1000;
            display: none;
        }
        
        .calendar-context-menu.open { display: block; }
        
        .calendar-context-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .calendar-context-item:hover {
            background: var(--bg-hover);
        }
        
        .week-toggle-btn.active, .current-week-btn.active, .preset-edit-btn.active {
            background: var(--accent) !important;
            color: white !important;
        }
        
        .period-class-row {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 12px;
            align-items: center;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .period-class-row label {
            font-weight: 500;
        }
        
        .period-class-row select {
            padding: 10px;
            border-radius: 8px;
            background: var(--bg-card);
            color: white;
            border: 1px solid var(--border);
            font-size: 0.95rem;
        }
        
        /* Layout Selector */
        .layout-selector {
            padding: 6px 12px;
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
            font-size: 0.9rem;
            cursor: pointer;
            min-width: 120px;
        }
        
        .layout-selector:hover {
            background: var(--bg-hover);
        }
        
        .layout-manager-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .layout-manager-item.active {
            border: 2px solid var(--accent);
        }
        
        .layout-manager-item .layout-name {
            font-weight: 500;
        }
        
        .layout-manager-item .layout-actions {
            display: flex;
            gap: 8px;
        }
        
        .day-sched {
            padding: 6px 10px;
            border-radius: 6px;
            background: var(--bg-card);
            color: white;
            border: 1px solid var(--border);
            width: 120px;
        }
        
        .class-assignment {
            display: grid;
            grid-template-columns: 100px 1fr 100px;
            gap: 8px;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .period-badge {
            background: var(--accent);
            padding: 4px 12px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        .period-badge:hover {
            background: var(--accent-light);
        }
        
        .countdown {
            font-size: 1.3rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }
        
        .countdown.pre-class {
            color: var(--success);
        }
        
        .countdown.in-class {
            color: var(--text-secondary);
        }
        
        .countdown.ending-soon {
            color: var(--warning);
        }
        
        .class-status {
            color: var(--text-secondary);
            font-size: 0.75rem;
        }
        
        .stats {
            display: flex;
            gap: 20px;
        }
        
        .stat {
            text-align: center;
            padding: 8px 16px;
            border-radius: 12px;
            background: var(--bg-card);
        }
        
        .stat.ontime { border-left: 3px solid var(--success); }
        .stat.late { border-left: 3px solid var(--warning); }
        .stat.absent { border-left: 3px solid var(--danger); }
        
        .stat-value {
            font-size: 1.6rem;
            font-weight: 700;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .close-attendance-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 16px;
        }
        
        .close-attendance-btn:hover {
            background: #dc2626;
        }

        /* Main Content */
        .main {
            padding: 24px;
            min-height: calc(100vh - 180px);
        }
        
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
        }

        /* Seating Canvas */
        .seating-container {
            width: 100%;
            height: calc(100vh - 220px);
            overflow: auto;
            position: relative;
        }
        
        .seating-toolbar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .toolbar-group {
            display: flex;
            gap: 8px;
        }
        
        .toolbar-btn {
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        
        .toolbar-btn:hover {
            background: var(--bg-hover);
        }
        
        .toolbar-btn.active {
            background: var(--accent);
        }
        
        .seating-canvas {
            position: relative;
            width: 100%;
            min-height: 600px;
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            overflow: hidden;
        }
        
        .seating-canvas.edit-mode {
            background: repeating-linear-gradient(
                0deg,
                var(--bg-card),
                var(--bg-card) 20px,
                var(--bg-hover) 20px,
                var(--bg-hover) 21px
            ),
            repeating-linear-gradient(
                90deg,
                var(--bg-card),
                var(--bg-card) 20px,
                var(--bg-hover) 20px,
                var(--bg-hover) 21px
            );
        }

        /* Student Cards */
        .canvas-student {
            position: absolute;
            width: 100px;
            text-align: center;
            padding: 8px;
            border-radius: 12px;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            border: 3px solid transparent;
        }
        
        .canvas-student:hover {
            transform: scale(1.05);
        }
        
        .canvas-student.dragging {
            z-index: 1000;
            opacity: 0.9;
            transform: scale(1.1);
        }
        
        .canvas-student.selected {
            border-color: var(--accent) !important;
            box-shadow: 0 0 0 3px var(--accent), 0 0 15px rgba(139, 92, 246, 0.5) !important;
        }
        
        .edit-mode .canvas-student:hover::after {
            content: 'Ctrl+click to multi-select';
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6rem;
            white-space: nowrap;
            color: var(--text-secondary);
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .edit-mode .canvas-student:hover::after {
            opacity: 1;
        }
        
        /* Attendance States */
        .canvas-student.unchecked {
            border-color: var(--border);
            opacity: 0.6;
        }
        
        .canvas-student.ontime {
            border-color: var(--success);
            box-shadow: 0 0 20px var(--success-glow);
            animation: pulseGreen 2s ease-in-out;
        }
        
        .canvas-student.late {
            border-color: var(--warning);
            box-shadow: 0 0 20px var(--warning-glow);
        }
        
        .canvas-student.absent {
            border-color: var(--danger);
            opacity: 0.5;
        }
        
        .canvas-student.excused {
            border-color: var(--excused);
            opacity: 0.7;
        }
        
        .canvas-student.hp-out {
            border-color: var(--warning);
            box-shadow: 0 0 15px var(--warning-glow);
        }
        
        .canvas-student.hp-queued {
            border-color: #06b6d4;
            opacity: 0.7;
        }
        
        @keyframes pulseGreen {
            0% { box-shadow: 0 0 0 0 var(--success-glow); }
            50% { box-shadow: 0 0 30px 10px var(--success-glow); }
            100% { box-shadow: 0 0 20px var(--success-glow); }
        }
        
        .student-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 6px;
        }
        
        .student-name {
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .student-status {
            font-size: 0.7rem;
            margin-top: 4px;
            color: var(--text-secondary);
        }
        
        .canvas-student.ontime .student-status {
            color: var(--success);
        }
        
        .canvas-student.late .student-status {
            color: var(--warning);
        }
        
        .late-timer {
            font-size: 0.75rem;
            color: var(--warning);
            font-weight: 600;
            margin-top: 2px;
        }
        
        .streak-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 700;
        }
        
        .streak-badge.fire::after {
            content: ' üî•';
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 8px 0;
            min-width: 200px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
        }
        
        .context-menu.open {
            display: block;
        }
        
        .context-menu-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
        }
        
        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.15s;
        }
        
        .context-menu-item:hover {
            background: var(--bg-hover);
        }
        
        .context-menu-item.danger {
            color: var(--danger);
        }
        
        .context-menu-divider {
            height: 1px;
            background: var(--border);
            margin: 8px 0;
        }
        
        .context-menu-note {
            padding: 8px 16px;
        }
        
        .context-menu-note input {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-overlay.open {
            display: flex;
        }
        
        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-header h2 {
            font-size: 1.3rem;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .setting-section {
            margin-bottom: 24px;
        }
        
        .setting-section h3 {
            margin-bottom: 12px;
            font-size: 1rem;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--accent-light);
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: var(--bg-hover);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: black;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        /* Hall Pass */
        .hp-duration.active {
            background: var(--accent) !important;
            color: white;
        }
        
        .hp-student {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.15s;
            border: 2px solid transparent;
        }
        
        .hp-student:hover {
            background: var(--bg-hover);
        }
        
        .hp-student.on-pass {
            border-color: #06b6d4;
            background: rgba(6,182,212,0.15);
            animation: passGlow 2s infinite;
        }
        
        .hp-student.in-queue {
            border-color: var(--warning);
            background: rgba(245,158,11,0.1);
        }
        
        .hp-student img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin-bottom: 6px;
        }
        
        .hp-student .name {
            font-size: 12px;
            font-weight: 500;
            text-align: center;
        }
        
        .hp-student .pass-timer {
            font-size: 11px;
            color: #06b6d4;
            font-weight: 600;
            margin-top: 4px;
        }
        
        .hp-student .queue-pos {
            font-size: 10px;
            color: var(--warning);
            margin-top: 4px;
        }
        
        @keyframes passGlow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(6,182,212,0.4); }
            50% { box-shadow: 0 0 12px 4px rgba(6,182,212,0.2); }
        }
        
        .queue-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 8px;
        }
        
        .queue-item.active {
            background: rgba(6,182,212,0.15);
            border: 1px solid #06b6d4;
        }
        
        .queue-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
        
        .queue-item .info {
            flex: 1;
        }
        
        .queue-item .name {
            font-weight: 600;
        }
        
        .queue-item .time {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .queue-item .etd {
            font-size: 13px;
            font-weight: 600;
            color: #06b6d4;
        }
        
        .queue-item .back-btn {
            padding: 6px 12px;
            background: var(--success);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .queue-item .back-btn:hover {
            background: #16a34a;
        }
        
        .avatar-tab.active {
            background: var(--accent) !important;
            color: white;
        }

        /* Schedule Editor */
        .schedule-grid {
            display: grid;
            gap: 12px;
        }
        
        .schedule-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
        }
        
        .schedule-row label {
            width: 100px;
            font-weight: 500;
        }
        
        .schedule-row input[type="time"] {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .pattern-select {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 16px;
        }
        
        .pattern-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid var(--border);
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .pattern-btn.active {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
        }

        /* Summary Modal */
        .summary-grid {
            display: grid;
            gap: 16px;
        }
        
        .summary-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }
        
        .summary-stat.ontime { border-left: 4px solid var(--success); }
        .summary-stat.late { border-left: 4px solid var(--warning); }
        .summary-stat.absent { border-left: 4px solid var(--danger); }
        .summary-stat.excused { border-left: 4px solid var(--excused); }
        
        .summary-label {
            font-weight: 500;
        }
        
        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .summary-names {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
            z-index: 3000;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
        
        /* Mini Overlay */
        .mini-overlay {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 320px;
            min-width: 200px;
            max-width: 500px;
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 5000;
            display: none;
            opacity: 0.9;
            border: 1px solid var(--border);
            overflow: hidden;
            resize: both;
        }
        
        .mini-overlay.open {
            display: block;
        }
        
        .mini-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-secondary);
            cursor: move;
            gap: 8px;
        }
        
        .mini-title {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .mini-stats {
            display: flex;
            gap: 6px;
        }
        
        .mini-stat {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 8px;
        }
        
        .mini-stat.ontime { background: var(--success); color: white; }
        .mini-stat.late { background: var(--warning); color: black; }
        .mini-stat.absent { background: var(--danger); color: white; }
        
        .mini-controls {
            display: flex;
            gap: 4px;
        }
        
        .mini-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 4px;
            border-radius: 4px;
        }
        
        .mini-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .mini-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 6px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .mini-student {
            text-align: center;
            cursor: pointer;
            padding: 4px;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.15s;
        }
        
        .mini-student:hover {
            background: var(--bg-hover);
        }
        
        .mini-student.unchecked {
            opacity: 0.5;
        }
        
        .mini-student.ontime {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }
        
        .mini-student.late {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }
        
        .mini-student.absent {
            border-color: var(--danger);
            opacity: 0.4;
        }
        
        .mini-student img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }
        
        .mini-student .name {
            font-size: 0.6rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }
        
        .mini-student .late-badge {
            font-size: 0.55rem;
            color: var(--warning);
            font-weight: 600;
        }
        
        .mini-resize {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 16px;
            height: 16px;
            cursor: se-resize;
            background: linear-gradient(135deg, transparent 50%, var(--text-secondary) 50%);
            opacity: 0.3;
            border-radius: 0 0 16px 0;
        }
        
        /* Fun animations */
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-100px) rotate(720deg); opacity: 0; }
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--success);
            animation: confetti 1s ease-out forwards;
            pointer-events: none;
            z-index: 3000;
        }
        
        /* Student History Panel */
        .history-panel {
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }
        
        .history-title {
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .history-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }
        
        .history-row:last-child {
            border-bottom: none;
        }
        
        .history-status {
            font-weight: 500;
        }
        
        .history-status.ontime { color: var(--success); }
        .history-status.late { color: var(--warning); }
        .history-status.absent { color: var(--danger); }
        .history-status.excused { color: var(--excused); }

        /* Upload zone */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .upload-zone:hover {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.05);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-left">
            <div class="logo">
                <span>üéüÔ∏è</span>
                <span>Hall Pass</span>
            </div>
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="showView('attendance')">üìã Attendance</div>
                <div class="nav-tab" onclick="showView('hallpass')">üö™ Hall Pass</div>
                <div class="nav-tab" onclick="showView('groups')">üë• Groups</div>
                <div class="nav-tab" onclick="showView('history')">üìä History</div>
            </div>
        </div>
        <div class="nav-right">
            <select id="classSelect" class="class-selector" onchange="switchClass(this.value)">
                <option value="">No class loaded</option>
            </select>
            <button class="icon-btn" title="Add Class" onclick="openImportClass()" style="font-size:1rem;">‚ûï</button>
            <button class="icon-btn" title="Schedule" onclick="openSchedule()">üïê</button>
            <button class="icon-btn" title="Settings" onclick="openSettings()">‚öôÔ∏è</button>
            <button class="icon-btn" title="Help" onclick="openHelp()">‚ùì</button>
        </div>
    </nav>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="period-info">
            <div class="date-display" id="dateDisplay" onclick="openSchedule()">
                <span class="date-day" id="dateDay">Monday</span>
                <span class="date-full" id="dateFull">Feb 10</span>
                <span class="schedule-type" id="scheduleType">Regular</span>
            </div>
            <select id="periodSelect" class="period-badge" onchange="manuallySetPeriod(this.value)" style="cursor:pointer;border:none;appearance:none;-webkit-appearance:none;text-align:center;">
                <option value="1">Period 1</option>
                <option value="2">Period 2</option>
                <option value="3">Period 3</option>
                <option value="4">Period 4</option>
            </select>
            <button id="autoModeBtn" onclick="clearPeriodOverride()" style="display:none;background:var(--warning);border:none;color:black;font-size:0.65rem;padding:2px 6px;border-radius:4px;cursor:pointer;" title="Click to resume auto-detect">MANUAL</button>
            <div class="class-name" id="className" onclick="openSchedule()"></div>
            <div class="countdown pre-class" id="countdown" ondblclick="openQuickTimeEdit()" title="Double-click to adjust time" style="cursor:pointer;">--:--</div>
            <div class="class-status" id="classStatus" ondblclick="openQuickTimeEdit()" title="Double-click to adjust time" style="cursor:pointer;">Loading...</div>
        </div>
        <div class="stats">
            <div class="stat ontime">
                <div class="stat-value" id="statOntime">0</div>
                <div class="stat-label">On Time</div>
            </div>
            <div class="stat late">
                <div class="stat-value" id="statLate">0</div>
                <div class="stat-label">Late</div>
            </div>
            <div class="stat absent">
                <div class="stat-value" id="statAbsent">0</div>
                <div class="stat-label">Not Here</div>
            </div>
            <button class="close-attendance-btn" onclick="closeAttendance()" id="closeAttendanceBtn">
                Close Attendance
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main">
        <!-- Attendance View -->
        <div class="view active" id="attendanceView">
            <div class="seating-container">
                <div class="seating-toolbar">
                    <div class="toolbar-group">
                        <button class="toolbar-btn" id="editModeBtn" onclick="toggleEditMode()">‚úèÔ∏è Edit</button>
                        <button class="toolbar-btn" onclick="openStudentManager()">üë§ Students</button>
                        <button class="toolbar-btn" onclick="resetAttendance()">üîÑ Reset</button>
                        <button class="toolbar-btn" id="removeClassBtn" onclick="removeClassFromPeriod()" title="Remove class from this period" style="display:none;background:var(--error);">üö´ Prep</button>
                    </div>
                    <div class="toolbar-group" style="display:flex;align-items:center;gap:4px;">
                        <span style="font-size:0.75rem;color:var(--text-secondary);">Bulk:</span>
                        <button class="toolbar-btn" onclick="markAllPresent()" title="Mark all students present" style="background:var(--success);">‚úì All Present</button>
                        <button class="toolbar-btn" id="bulkActionBtn" onclick="showBulkActionMenu()" style="display:none;">üìã Selected (<span id="selectedCount">0</span>)</button>
                    </div>
                    <div class="toolbar-group" style="display:flex;align-items:center;gap:6px;">
                        <span style="font-size:0.75rem;color:var(--text-secondary);">Layout:</span>
                        <select id="layoutSelect" class="layout-selector" onchange="switchLayout(this.value)" style="font-size:0.8rem;padding:4px 8px;">
                            <option value="default">Default</option>
                        </select>
                        <button class="toolbar-btn" onclick="saveCurrentLayout()" title="Save positions">üíæ</button>
                        <button class="toolbar-btn" onclick="openLayoutManager()" title="Manage layouts">‚öôÔ∏è</button>
                    </div>
                    <div class="toolbar-group" style="display:flex;align-items:center;gap:4px;">
                        <span style="font-size:0.75rem;color:var(--text-secondary);">Sort:</span>
                        <button class="toolbar-btn" onclick="sortStudentsAlphabetically('horizontal')" title="Sort A-Z horizontally (rows)">A‚ÜíZ</button>
                        <button class="toolbar-btn" onclick="sortStudentsAlphabetically('vertical')" title="Sort A-Z vertically (columns)">A‚ÜìZ</button>
                    </div>
                    <div class="toolbar-group">
                        <button class="toolbar-btn" id="miniModeBtn" onclick="toggleMiniOverlay()">üìå Mini</button>
                        <button class="toolbar-btn" onclick="zoomCanvas(-0.1)">‚ûñ</button>
                        <button class="toolbar-btn" onclick="zoomCanvas(0)">Fit</button>
                        <button class="toolbar-btn" onclick="zoomCanvas(0.1)">‚ûï</button>
                    </div>
                </div>
                <div class="seating-canvas" id="seatingCanvas">
                    <!-- Students rendered here -->
                </div>
            </div>
        </div>

        <!-- Hall Pass View -->
        <div class="view" id="hallpassView">
            <div style="display:flex;gap:16px;padding:12px;height:calc(100vh - 72px);">
                <!-- Left: Student Canvas (same layout as Attendance) -->
                <div style="flex:1;overflow:auto;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <h3 style="font-size:1rem;">üö™ Hall Pass</h3>
                            <span style="font-size:0.8rem;color:var(--text-secondary);">Tap student to start</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <span style="font-size:0.8rem;color:var(--text-secondary);">Layout:</span>
                            <select id="hallpassLayoutSelect" class="layout-selector" onchange="switchLayout(this.value); renderHallPassCanvas();" style="font-size:0.8rem;padding:4px 8px;">
                                <option value="default">Default</option>
                            </select>
                        </div>
                    </div>
                    <div id="hallpassCanvas" class="seating-canvas" style="min-height:400px;position:relative;"></div>
                </div>
                <!-- Right: Queue -->
                <div style="width:280px;background:var(--bg-card);border-radius:16px;padding:16px;display:flex;flex-direction:column;">
                    <h3 style="margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                        <span>üìã Queue</span>
                        <span id="queueCount" style="background:var(--accent);padding:2px 8px;border-radius:10px;font-size:12px;">0</span>
                    </h3>
                    <div id="hallpassQueue" style="flex:1;overflow-y:auto;"></div>
                    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);font-size:12px;color:var(--text-secondary);">
                        <div>‚ö†Ô∏è One student out at a time</div>
                        <div style="margin-top:4px;">üö® Emergency override available</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hall Pass Duration Modal -->
        <div class="modal-overlay" id="hallpassModal" onclick="if(event.target===this)closeHallPassModal()">
            <div class="modal" style="max-width:400px;">
                <div class="modal-header">
                    <h2>üö∂ Hall Pass</h2>
                    <button class="close-btn" onclick="closeHallPassModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <div id="hallpassModalStudent" style="display:flex;align-items:center;gap:12px;margin-bottom:20px;padding:12px;background:var(--bg-secondary);border-radius:12px;">
                        <img id="hallpassModalImg" src="" style="width:48px;height:48px;border-radius:50%;">
                        <div>
                            <div id="hallpassModalName" style="font-weight:600;font-size:18px;"></div>
                            <div id="hallpassModalStatus" style="font-size:13px;color:var(--text-secondary);"></div>
                        </div>
                    </div>
                    <label style="display:block;margin-bottom:8px;font-weight:500;">How long?</label>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;">
                        <button class="btn btn-secondary hp-duration active" data-min="3" onclick="selectHpDuration(3)">3 min</button>
                        <button class="btn btn-secondary hp-duration" data-min="5" onclick="selectHpDuration(5)">5 min</button>
                        <button class="btn btn-secondary hp-duration" data-min="8" onclick="selectHpDuration(8)">8 min</button>
                    </div>
                    <div style="margin-bottom:16px;">
                        <label style="display:block;margin-bottom:6px;font-size:13px;color:var(--text-secondary);">Or special reason:</label>
                        <input type="text" id="hallpassCustomReason" placeholder="e.g., Counselor visit, Office..." 
                               style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--bg-secondary);color:white;">
                    </div>
                    <div id="hallpassQueueWarning" style="display:none;padding:12px;background:rgba(245,158,11,0.1);border:1px solid var(--warning);border-radius:8px;margin-bottom:16px;">
                        <div style="color:var(--warning);font-weight:500;">‚ö†Ô∏è Someone is already out</div>
                        <div id="hallpassQueueInfo" style="font-size:13px;margin-top:4px;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeHallPassModal()">Cancel</button>
                    <button class="btn btn-primary" id="hallpassStartBtn" onclick="startHallPass()">üö∂ Start Pass</button>
                    <button class="btn btn-warning" id="hallpassQueueBtn" style="display:none;" onclick="queueHallPass()">üìã Join Queue</button>
                </div>
            </div>
        </div>

        <!-- Groups View -->
        <div class="view" id="groupsView">
            <div style="max-width:1000px;margin:0 auto;">
                <h2 style="margin-bottom:24px;">üë• Quick Groups</h2>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;">
                    <button class="btn btn-secondary" onclick="makeGroups(2)">Pairs</button>
                    <button class="btn btn-secondary" onclick="makeGroups(3)">3s</button>
                    <button class="btn btn-secondary" onclick="makeGroups(4)">4s</button>
                    <button class="btn btn-secondary" onclick="makeGroups(5)">5s</button>
                    <button class="btn btn-secondary" onclick="shuffleGroups()">üîÄ Shuffle</button>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:24px;padding-top:12px;border-top:1px solid var(--border);">
                    <button class="btn btn-primary" onclick="saveCurrentGroups()">üíæ Save Groups</button>
                    <button class="btn btn-secondary" onclick="showSavedGroups()">üìÇ Load Past Groups</button>
                </div>
                <div id="savedGroupsPanel" style="display:none;margin-bottom:24px;padding:16px;background:var(--bg-card);border-radius:12px;">
                    <h3 style="margin-bottom:12px;">üìÇ Saved Groups</h3>
                    <div id="savedGroupsList"></div>
                </div>
                <div id="groupsContainer"></div>
            </div>
        </div>

        <!-- History View -->
        <div class="view" id="historyView">
            <div style="max-width:800px;margin:0 auto;">
                <h2 style="margin-bottom:24px;">üìä Attendance History</h2>
                <div id="historyContainer">
                    <p style="color:var(--text-secondary);">Select a student to view their history, or view class trends.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-header" id="contextMenuHeader">Student Name</div>
        <div class="context-menu-item" onclick="setStatus('ontime')">‚úÖ Mark On-Time</div>
        <div class="context-menu-item" onclick="setStatus('late')">‚ö†Ô∏è Mark Late</div>
        <div class="context-menu-item" onclick="setStatus('absent')">‚ùå Mark Absent</div>
        <div class="context-menu-item" onclick="setStatus('excused')">üìù Mark Excused</div>
        <div class="context-menu-item" onclick="clearStatus()">üîÑ Clear (Reset)</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="ctxHallPass" onclick="showHallPassModal()">üö∂ Hall Pass</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-note">
            <input type="text" id="contextMenuNote" placeholder="Add note..." onkeypress="if(event.key==='Enter')saveNote()">
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="viewStudentHistory()">üìä View History</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="editStudent()">‚úèÔ∏è Edit Student</div>
        <div class="context-menu-item danger" onclick="removeStudent()">üóëÔ∏è Remove Student</div>
    </div>

    <!-- Canvas Context Menu (for adding students) -->
    <!-- Calendar Context Menu -->
    <div class="calendar-context-menu" id="calendarContextMenu">
        <div class="calendar-context-item" onclick="applyScheduleToDay('regular')">üìó Apply Regular Schedule</div>
        <div class="calendar-context-item" onclick="applyScheduleToDay('amfit')">üåÖ Apply AM FIT Schedule</div>
        <div class="calendar-context-item" onclick="applyScheduleToDay('pmfit')">üåÜ Apply PM FIT Schedule</div>
        <div style="border-top:1px solid var(--border);margin:4px 0;"></div>
        <div class="calendar-context-item" onclick="addBlockFromContext('break')">‚òï Add Break</div>
        <div class="calendar-context-item" onclick="addBlockFromContext('lunch')">üçΩÔ∏è Add Lunch</div>
        <div class="calendar-context-item" onclick="addBlockFromContext('custom')">‚ú® Add Custom Block</div>
        <div style="border-top:1px solid var(--border);margin:4px 0;"></div>
        <div class="calendar-context-item" onclick="editBlockFromContext()">‚úèÔ∏è Edit Block</div>
        <div class="calendar-context-item" onclick="deleteBlockFromContext()">üóëÔ∏è Delete Block</div>
    </div>
    
    <div class="context-menu" id="canvasContextMenu">
        <div class="context-menu-header">Canvas Options</div>
        <div class="context-menu-item" onclick="addStudentAtPosition()">‚ûï Add Student Here</div>
        <div class="context-menu-item" onclick="openStudentManager()">üë§ Manage Students</div>
    </div>

    <!-- Student Manager Modal -->
    <div class="modal-overlay" id="studentManagerModal" onclick="if(event.target===this)closeStudentManager()">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header">
                <h2>üë§ Manage Students</h2>
                <button class="close-btn" onclick="closeStudentManager()">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="display:flex;gap:12px;margin-bottom:16px;">
                    <button class="btn btn-primary" onclick="showAddStudentForm()">‚ûï Add Student</button>
                    <input type="text" id="studentSearch" placeholder="Search students..." 
                           style="flex:1;padding:10px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);"
                           oninput="filterStudentList()">
                </div>
                <div id="studentManagerList" style="max-height:400px;overflow-y:auto;">
                    <!-- Filled dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Student Modal -->
    <div class="modal-overlay" id="editStudentModal" onclick="if(event.target===this)closeEditStudent()">
        <div class="modal" style="max-width:550px;">
            <div class="modal-header">
                <h2 id="editStudentTitle">‚ûï Add Student</h2>
                <button class="close-btn" onclick="closeEditStudent()">‚úï</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editStudentId">
                <input type="hidden" id="editSelectedAvatar">
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div class="setting-section">
                        <label style="display:block;margin-bottom:8px;font-weight:500;">First Name *</label>
                        <input type="text" id="editFirstName" placeholder="First name" 
                               style="width:100%;padding:12px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:1rem;">
                    </div>
                    <div class="setting-section">
                        <label style="display:block;margin-bottom:8px;font-weight:500;">Last Name</label>
                        <input type="text" id="editLastName" placeholder="Last name" 
                               style="width:100%;padding:12px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:1rem;">
                    </div>
                </div>
                
                <div class="setting-section">
                    <label style="display:block;margin-bottom:8px;font-weight:500;">Preferred Name (optional)</label>
                    <input type="text" id="editPreferredName" placeholder="What they like to be called" 
                           style="width:100%;padding:12px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:1rem;">
                </div>
                
                <div class="setting-section">
                    <label style="display:block;margin-bottom:8px;font-weight:500;">Choose Avatar</label>
                    <div style="display:flex;gap:8px;margin-bottom:12px;">
                        <button type="button" class="btn btn-secondary avatar-tab active" onclick="showAvatarTab('cartoon')" style="padding:6px 12px;font-size:13px;">üé® Cartoon</button>
                        <button type="button" class="btn btn-secondary avatar-tab" onclick="showAvatarTab('modern')" style="padding:6px 12px;font-size:13px;">‚ú® Modern</button>
                        <button type="button" class="btn btn-secondary avatar-tab" onclick="showAvatarTab('playful')" style="padding:6px 12px;font-size:13px;">üòä Playful</button>
                        <button type="button" class="btn btn-secondary avatar-tab" onclick="showAvatarTab('pixel')" style="padding:6px 12px;font-size:13px;">üéÆ Pixel</button>
                        <button type="button" class="btn btn-secondary avatar-tab" onclick="showAvatarTab('classic')" style="padding:6px 12px;font-size:13px;">üé≠ Classic</button>
                    </div>
                    <div id="avatarGrid" style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;max-height:180px;overflow-y:auto;padding:8px;background:var(--bg-secondary);border-radius:12px;">
                        <!-- Avatars loaded dynamically -->
                    </div>
                </div>
                
                <div class="setting-section">
                    <label style="display:block;margin-bottom:8px;font-weight:500;">Or paste image URL</label>
                    <input type="text" id="editPhotoUrl" placeholder="https://..." 
                           style="width:100%;padding:12px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:1rem;"
                           oninput="clearAvatarSelection()">
                </div>
                
                <div style="display:flex;gap:12px;margin-top:24px;">
                    <button class="btn btn-primary" onclick="saveStudent()">Save Student</button>
                    <button class="btn btn-secondary" onclick="closeEditStudent()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div class="modal-overlay" id="scheduleModal" onclick="if(event.target===this)closeSchedule()">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header">
                <h2>üïê Schedule Settings</h2>
                <button class="close-btn" onclick="closeSchedule()">‚úï</button>
            </div>
            <div class="modal-body">
                <!-- Tab Navigation -->
                <div style="display:flex;gap:4px;margin-bottom:20px;border-bottom:1px solid var(--border);padding-bottom:12px;flex-wrap:wrap;">
                    <button class="btn btn-secondary sched-tab active" onclick="showSchedTab('today')">üìÖ Today</button>
                    <button class="btn btn-secondary sched-tab" onclick="showSchedTab('weekly')">üóìÔ∏è Calendar</button>
                    <button class="btn btn-secondary sched-tab" onclick="showSchedTab('rotation')">üîÑ Rotation</button>
                    <button class="btn btn-secondary sched-tab" onclick="showSchedTab('classes')">üìö My Classes</button>
                    <button class="btn btn-secondary sched-tab" onclick="showSchedTab('presets')">‚ö° Presets</button>
                </div>
                
                <!-- Today Tab -->
                <div class="sched-panel active" id="schedPanelToday">
                    <div class="setting-section">
                        <h3>Today: <span id="schedTodayDate">Monday, Feb 10</span></h3>
                        <div class="schedule-grid">
                            <div class="schedule-row">
                                <label>Schedule Type:</label>
                                <select id="schedType" onchange="onSchedTypeChange()">
                                    <option value="regular">Regular</option>
                                    <option value="amfit">AM FIT</option>
                                    <option value="pmfit">PM FIT</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div class="schedule-row">
                                <label>Period:</label>
                                <select id="schedPeriod" onchange="updateSchedulePreview()">
                                    <option value="1">Period 1</option>
                                    <option value="2">Period 2</option>
                                    <option value="3">Period 3</option>
                                    <option value="4">Period 4</option>
                                </select>
                            </div>
                            <div class="schedule-row">
                                <label>Class:</label>
                                <select id="schedClass" onchange="onClassChange()">
                                    <option value="">-- Select Class --</option>
                                </select>
                            </div>
                            <div class="schedule-row">
                                <label>Start:</label>
                                <input type="time" id="schedStart" value="08:40" onchange="updateSchedulePreview()">
                            </div>
                            <div class="schedule-row">
                                <label>End:</label>
                                <input type="time" id="schedEnd" value="10:00" onchange="updateSchedulePreview()">
                            </div>
                        </div>
                        <div style="margin-top:12px;padding:12px;background:var(--bg-secondary);border-radius:8px;font-size:0.85rem;">
                            <div>üö™ Hall pass: <span id="hallpassWindow">8:50 AM - 9:50 AM</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Weekly Pattern Tab -->
                <div class="sched-panel" id="schedPanelWeekly">
                    <div class="setting-section">
                        <h3>Weekly Schedule</h3>
                        <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:16px;">
                            Visual calendar of your week. Right-click to add breaks, edit blocks, or customize times.
                        </p>
                        
                        <!-- Week Toggle -->
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                            <div style="display:flex;gap:4px;">
                                <button class="btn btn-secondary week-toggle-btn active" data-type="simple" onclick="setWeekType('simple')">Same Every Week</button>
                                <button class="btn btn-secondary week-toggle-btn" data-type="biweekly" onclick="setWeekType('biweekly')">Week 1 / Week 2</button>
                            </div>
                            <div id="currentWeekToggle" style="display:none;">
                                <span style="margin-right:8px;font-size:0.9rem;">Current:</span>
                                <button class="btn current-week-btn active" data-week="1" onclick="setCurrentWeek(1)" style="padding:6px 16px;">Wk 1</button>
                                <button class="btn current-week-btn" data-week="2" onclick="setCurrentWeek(2)" style="padding:6px 16px;">Wk 2</button>
                            </div>
                        </div>
                        
                        <!-- Visual Calendar -->
                        <div id="calendarView" class="calendar-container">
                            <div class="calendar-times" id="calendarTimes">
                                <!-- Time labels populated by JS -->
                            </div>
                            <div class="calendar-header">Mon</div>
                            <div class="calendar-header">Tue</div>
                            <div class="calendar-header">Wed</div>
                            <div class="calendar-header">Thu</div>
                            <div class="calendar-header">Fri</div>
                            <div></div><!-- spacer for time column -->
                            <div class="calendar-day" id="calDay-mon" oncontextmenu="openCalendarContext(event, 'mon'); return false;"></div>
                            <div class="calendar-day" id="calDay-tue" oncontextmenu="openCalendarContext(event, 'tue'); return false;"></div>
                            <div class="calendar-day" id="calDay-wed" oncontextmenu="openCalendarContext(event, 'wed'); return false;"></div>
                            <div class="calendar-day" id="calDay-thu" oncontextmenu="openCalendarContext(event, 'thu'); return false;"></div>
                            <div class="calendar-day" id="calDay-fri" oncontextmenu="openCalendarContext(event, 'fri'); return false;"></div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap;">
                            <button class="btn btn-secondary" onclick="addBlockToDay(null, 'break')">+ Add Break</button>
                            <button class="btn btn-secondary" onclick="addBlockToDay(null, 'fit')">+ Add FIT</button>
                            <button class="btn btn-secondary" onclick="resetToDefaultSchedule()">‚Ü∫ Reset to Britannia Default</button>
                        </div>
                        
                        <!-- Hidden old inputs for compatibility -->
                        <div style="display:none;">
                            <select id="weekPatternType"><option value="simple">simple</option><option value="biweekly">biweekly</option></select>
                            <select class="day-sched" data-day="mon"></select>
                            <select class="day-sched" data-day="tue"></select>
                            <select class="day-sched" data-day="wed"></select>
                            <select class="day-sched" data-day="thu"></select>
                            <select class="day-sched" data-day="fri"></select>
                            <select id="currentWeekNum"><option value="1">1</option><option value="2">2</option></select>
                        </div>
                    </div>
                </div>
                
                <!-- Rotation Tab -->
                <div class="sched-panel" id="schedPanelRotation">
                    <div class="setting-section">
                        <h3>Period Rotation</h3>
                        <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:16px;">
                            Set which period/class meets in each time block for each day. Use the dropdowns to rearrange.
                        </p>
                        
                        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;flex-wrap:wrap;">
                            <span style="font-size:0.9rem;">Pattern:</span>
                            <select id="rotationPatternType" onchange="setRotationPatternType(this.value)" style="padding:8px 12px;border-radius:6px;border:1px solid var(--border);background:var(--bg-card);">
                                <option value="simple">Same Every Week</option>
                                <option value="biweekly">Week 1 / Week 2</option>
                            </select>
                            <div id="rotationWeekToggle" style="display:none;gap:4px;">
                                <button class="btn rotation-week-btn active" data-week="1" onclick="setRotationWeek(1)" style="padding:6px 12px;">Week 1</button>
                                <button class="btn rotation-week-btn" data-week="2" onclick="setRotationWeek(2)" style="padding:6px 12px;">Week 2</button>
                            </div>
                        </div>
                        
                        <div id="periodRotationGrid" class="rotation-grid">
                            <!-- Populated by renderRotationGrid() -->
                        </div>
                        
                        <div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap;">
                            <button class="btn btn-secondary" onclick="resetRotationToDefault()">‚Ü∫ Reset to Default</button>
                            <button class="btn btn-secondary" onclick="addBlockToRotation()">+ Add Block</button>
                            <button class="btn btn-secondary" onclick="removeBlockFromRotation()">- Remove Block</button>
                        </div>
                        
                        <div style="margin-top:16px;padding:12px;background:var(--bg-secondary);border-radius:8px;">
                            <p style="font-size:0.85rem;color:var(--text-secondary);">
                                üí° This controls which <strong>class</strong> meets in each <strong>time block</strong>. 
                                For example, if Tuesday Block 1 = P3, then your Period 3 class meets in the first time slot on Tuesdays.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- My Classes Tab -->
                <div class="sched-panel" id="schedPanelClasses">
                    <div class="setting-section">
                        <h3>My Teaching Schedule</h3>
                        <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:16px;">
                            Assign your loaded classes to each period. The app will auto-switch when the period changes.
                        </p>
                        <div id="classAssignmentsContainer">
                            <!-- Populated by JS -->
                        </div>
                        <div style="margin-top:16px;padding:12px;background:var(--bg-secondary);border-radius:8px;">
                            <p style="font-size:0.85rem;color:var(--text-secondary);">
                                üí° Classes shown here are from your imported rosters. Import more classes in Settings.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Presets Tab -->
                <div class="sched-panel" id="schedPanelPresets">
                    <div class="setting-section">
                        <h3>Bell Schedule Presets</h3>
                        <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:16px;">
                            Quick-load common bell schedules. Currently configured for Britannia Secondary.
                        </p>
                        <div style="display:grid;gap:12px;">
                            <div style="padding:16px;background:var(--bg-secondary);border-radius:12px;cursor:pointer;" onclick="loadPreset('regular')">
                                <div style="font-weight:600;margin-bottom:8px;">üìó Regular Day</div>
                                <div style="font-size:0.85rem;color:var(--text-secondary);">P1: 8:40-10:00 ‚Ä¢ P2: 10:10-11:30 ‚Ä¢ P3: 12:15-1:35 ‚Ä¢ P4: 1:45-3:05</div>
                            </div>
                            <div style="padding:16px;background:var(--bg-secondary);border-radius:12px;cursor:pointer;" onclick="loadPreset('amfit')">
                                <div style="font-weight:600;margin-bottom:8px;">üåÖ AM FIT (Wed/Fri)</div>
                                <div style="font-size:0.85rem;color:var(--text-secondary);">P1: 9:20-10:20 ‚Ä¢ P2: 10:30-11:30 ‚Ä¢ P3: 12:15-1:35 ‚Ä¢ P4: 1:45-3:05</div>
                            </div>
                            <div style="padding:16px;background:var(--bg-secondary);border-radius:12px;cursor:pointer;" onclick="loadPreset('pmfit')">
                                <div style="font-weight:600;margin-bottom:8px;">üåÜ PM FIT (Tue/Thu)</div>
                                <div style="font-size:0.85rem;color:var(--text-secondary);">P1: 8:40-10:00 ‚Ä¢ P2: 10:10-11:30 ‚Ä¢ P3: 12:15-1:15 ‚Ä¢ P4: 1:25-2:25</div>
                            </div>
                        </div>
                        <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border);">
                            <h4 style="margin-bottom:12px;">Custom Preset</h4>
                            <button class="btn btn-secondary" onclick="createCustomPreset()">+ Create New Preset</button>
                        </div>
                    </div>
                </div>
                
                <div style="display:flex;gap:12px;margin-top:24px;padding-top:16px;border-top:1px solid var(--border);">
                    <button class="btn btn-primary" onclick="saveSchedule()">üíæ Save Schedule</button>
                    <button class="btn btn-secondary" onclick="closeSchedule()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Time Edit Popup -->
    <div id="quickTimePopup" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-card);border-radius:16px;padding:24px;box-shadow:0 20px 60px rgba(0,0,0,0.5);z-index:2000;min-width:300px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <h3 style="margin:0;">‚è±Ô∏è Quick Time Adjust</h3>
            <button onclick="closeQuickTimeEdit()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-secondary);">‚úï</button>
        </div>
        <div style="margin-bottom:16px;">
            <label style="display:block;margin-bottom:6px;font-size:0.9rem;color:var(--text-secondary);">Period <span id="quickTimePeriod">1</span> Start Time</label>
            <input type="time" id="quickStartTime" style="width:100%;padding:12px;font-size:1.2rem;border-radius:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);">
        </div>
        <div style="margin-bottom:20px;">
            <label style="display:block;margin-bottom:6px;font-size:0.9rem;color:var(--text-secondary);">Period <span id="quickTimePeriod2">1</span> End Time</label>
            <input type="time" id="quickEndTime" style="width:100%;padding:12px;font-size:1.2rem;border-radius:8px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);">
        </div>
        <div style="display:flex;gap:8px;">
            <button onclick="applyQuickTime()" class="btn btn-primary" style="flex:1;">‚úì Apply</button>
            <button onclick="closeQuickTimeEdit()" class="btn btn-secondary">Cancel</button>
        </div>
        <div style="margin-top:12px;font-size:0.8rem;color:var(--text-secondary);text-align:center;">
            Tip: This adjusts the current period only. Use Settings for full schedule.
        </div>
    </div>
    <div id="quickTimeOverlay" onclick="closeQuickTimeEdit()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:1999;"></div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal" onclick="if(event.target===this)closeSettings()">
        <div class="modal">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="close-btn" onclick="closeSettings()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="setting-section">
                    <h3>üì• Import Class</h3>
                    <div class="upload-zone" onclick="document.getElementById('importFile').click()">
                        <div style="font-size:2rem;margin-bottom:8px;">üìÅ</div>
                        <div>Click to import class JSON</div>
                    </div>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="handleImport(event)">
                    <div style="margin-top:12px;">
                        <a href="processor.html" class="btn btn-secondary" style="display:inline-block;text-decoration:none;">
                            ‚ú® Create from MyEd
                        </a>
                    </div>
                </div>
                
                <div class="setting-section">
                    <h3>üìö Loaded Classes</h3>
                    <div id="loadedClassesList" style="margin-bottom:12px;"></div>
                    <script>
                        function updateLoadedClassesList() {
                            const container = document.getElementById('loadedClassesList');
                            const classes = Object.entries(allClasses);
                            if (classes.length === 0) {
                                container.innerHTML = '<p style="color:var(--text-secondary);font-size:0.9rem;">No classes loaded. Import a class to get started.</p>';
                                return;
                            }
                            container.innerHTML = classes.map(([id, cls]) => {
                                const name = cls.classData?.settings?.className || id;
                                const studentCount = cls.students?.length || 0;
                                const isCurrent = id === currentClassId;
                                return `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:${isCurrent ? 'var(--accent)' : 'var(--bg-secondary)'};border-radius:8px;margin-bottom:6px;">
                                    <span style="font-weight:${isCurrent ? '600' : '400'};">${name} (${studentCount} students)</span>
                                    <button onclick="removeClassById('${id}')" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:1.1rem;" title="Remove class">‚úï</button>
                                </div>`;
                            }).join('');
                        }
                    </script>
                </div>
                
                <div class="setting-section" style="background:var(--bg-secondary);padding:16px;border-radius:12px;border:2px solid var(--accent);">
                    <h3>üíæ Backup & Restore</h3>
                    <p style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:12px;">
                        <strong>‚ö†Ô∏è Important:</strong> Browser storage can be lost. Download backups regularly!
                    </p>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
                        <button class="btn btn-primary" onclick="downloadFullBackup()">üì• Download Full Backup</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('restoreFile').click()">üì§ Restore from Backup</button>
                        <input type="file" id="restoreFile" accept=".json" style="display:none" onchange="handleRestore(event)">
                    </div>
                    <div id="lastBackupInfo" style="font-size:0.8rem;color:var(--text-secondary);"></div>
                </div>
                
                <div class="setting-section">
                    <h3>üìÖ Schedule Template</h3>
                    <p style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:12px;">
                        Share your school's bell schedule with other teachers. No student data included.
                    </p>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button class="btn btn-secondary" onclick="exportScheduleTemplate()">üì§ Export Schedule</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('scheduleTemplateFile').click()">üì• Import Schedule</button>
                        <input type="file" id="scheduleTemplateFile" accept=".json" style="display:none" onchange="importScheduleTemplate(event)">
                    </div>
                </div>
                
                <div class="setting-section">
                    <h3>üì§ Export</h3>
                    <p style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:12px;">
                        Export individual classes or attendance records.
                    </p>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button class="btn btn-secondary" onclick="exportCurrentClass()">üìã Current Class Only</button>
                    </div>
                </div>
                
                <div class="setting-section">
                    <h3>üìä Export Attendance</h3>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-secondary" onclick="exportAttendance('csv')">üìä CSV</button>
                        <button class="btn btn-secondary" onclick="exportAttendance('json')">üíæ JSON</button>
                    </div>
                </div>
                
                <div class="setting-section">
                    <h3>‚è±Ô∏è Timing Settings</h3>
                    <div style="display:grid;gap:12px;">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <label style="font-size:0.9rem;min-width:180px;">Grace period (seconds):</label>
                            <input type="number" id="graceSecondsInput" value="45" min="0" max="300" 
                                style="width:70px;padding:6px;border-radius:6px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);"
                                onchange="appSettings.graceSeconds = parseInt(this.value) || 45; saveClass();">
                            <span style="font-size:0.8rem;color:var(--text-secondary);">after bell = still on-time</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:12px;">
                            <label style="font-size:0.9rem;min-width:180px;">Bell offset (seconds):</label>
                            <input type="number" id="bellOffsetInput" value="0" min="-300" max="300" 
                                style="width:70px;padding:6px;border-radius:6px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);"
                                onchange="appSettings.bellOffsetSeconds = parseInt(this.value) || 0; saveClass();">
                            <span style="font-size:0.8rem;color:var(--text-secondary);">+ if bell is late, - if early</span>
                        </div>
                        <div style="display:flex;align-items:center;gap:12px;">
                            <label style="font-size:0.9rem;min-width:180px;">Auto-absent after class:</label>
                            <input type="number" id="autoAbsentMinInput" value="5" min="1" max="30" 
                                style="width:70px;padding:6px;border-radius:6px;border:1px solid var(--border);background:var(--bg-secondary);color:var(--text-primary);"
                                onchange="appSettings.autoAbsentMinutes = parseInt(this.value) || 5; saveClass();">
                            <span style="font-size:0.8rem;color:var(--text-secondary);">minutes after end</span>
                        </div>
                    </div>
                    <p style="font-size:0.75rem;color:var(--text-secondary);margin-top:8px;">
                        Example: Bell is 60 seconds late ‚Üí set offset to 60. Grace period is added on top.
                    </p>
                </div>
                
                <div class="setting-section">
                    <h3>üóëÔ∏è Clear Data</h3>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button class="btn btn-warning" onclick="removeCurrentClass()">Remove Current Class</button>
                        <button class="btn btn-danger" onclick="clearAllData()">Clear Everything</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Modal -->
    <div class="modal-overlay" id="summaryModal" onclick="if(event.target===this)closeSummary()">
        <div class="modal">
            <div class="modal-header">
                <h2>üìã Attendance Summary</h2>
                <button class="close-btn" onclick="closeSummary()">‚úï</button>
            </div>
            <div class="modal-body" id="summaryContent">
                <!-- Filled dynamically -->
            </div>
        </div>
    </div>

    <!-- Student History Modal -->
    <div class="modal-overlay" id="studentHistoryModal" onclick="if(event.target===this)closeStudentHistory()">
        <div class="modal">
            <div class="modal-header">
                <h2 id="studentHistoryTitle">üìä Student History</h2>
                <button class="close-btn" onclick="closeStudentHistory()">‚úï</button>
            </div>
            <div class="modal-body" id="studentHistoryContent">
                <!-- Filled dynamically -->
            </div>
        </div>
    </div>

    <!-- Toast -->
    <!-- Help Modal -->
    <div class="modal-overlay" id="helpModal" onclick="if(event.target===this)closeHelp()">
        <div class="modal" style="max-width:550px;">
            <div class="modal-header">
                <h2>‚ùì Help</h2>
                <button class="close-btn" onclick="closeHelp()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="setting-section">
                    <h3>üìã Taking Attendance</h3>
                    <ul style="margin-left:20px;color:var(--text-secondary);line-height:1.8;">
                        <li><strong>Click a student</strong> to check them in</li>
                        <li><strong style="color:var(--success);">Green</strong> = On time</li>
                        <li><strong style="color:var(--warning);">Amber</strong> = Late (shows how late)</li>
                        <li><strong>Right-click</strong> to change status or add notes</li>
                        <li><strong>Close Attendance</strong> marks remaining as absent</li>
                    </ul>
                </div>
                
                <div class="setting-section">
                    <h3>üìå Mini Overlay</h3>
                    <p style="color:var(--text-secondary);margin-bottom:12px;">
                        Perfect for marking attendance while presenting!
                    </p>
                    <ul style="margin-left:20px;color:var(--text-secondary);line-height:1.8;">
                        <li>Click <strong>üìå Mini Overlay</strong> to show floating window</li>
                        <li>Click <strong>ü™ü Pop Out</strong> to open in separate window</li>
                        <li>Drag to reposition, resize from corner</li>
                    </ul>
                </div>
                
                <div class="setting-section">
                    <h3>ü™ü Keep Pop-Out Window on Top</h3>
                    <div style="background:var(--bg-secondary);border-radius:12px;padding:16px;margin-top:8px;">
                        <div style="margin-bottom:16px;">
                            <strong style="font-size:1rem;">ü™ü Windows</strong>
                            <ol style="margin-left:20px;margin-top:8px;color:var(--text-secondary);line-height:1.8;">
                                <li>Install <a href="https://github.com/microsoft/PowerToys/releases" target="_blank" style="color:var(--accent-light);">Microsoft PowerToys</a> (free)</li>
                                <li>Click the pop-out attendance window</li>
                                <li>Press <strong style="color:var(--text-primary);">Win + Ctrl + T</strong></li>
                                <li>Window stays on top of PowerPoint! üìå</li>
                            </ol>
                        </div>
                        <div>
                            <strong style="font-size:1rem;">üçé Mac</strong>
                            <ol style="margin-left:20px;margin-top:8px;color:var(--text-secondary);line-height:1.8;">
                                <li>Install <a href="https://apps.apple.com/app/afloat/id1612376590" target="_blank" style="color:var(--accent-light);">Afloat</a> or <a href="https://www.macupdate.com/app/mac/31724/afloat" target="_blank" style="color:var(--accent-light);">Rectangle Pro</a></li>
                                <li>Or use <strong>Shortcut:</strong> Some apps use <strong style="color:var(--text-primary);">Cmd + Shift + T</strong></li>
                                <li>Alternative: Use Split View or position in corner</li>
                            </ol>
                        </div>
                    </div>
                </div>
                
                <div class="setting-section">
                    <h3>üî• Streaks</h3>
                    <ul style="margin-left:20px;color:var(--text-secondary);line-height:1.8;">
                        <li>Students build streaks for consecutive on-time days</li>
                        <li>3+ days shows a badge on their card</li>
                        <li>5+ days = üî• fire badge</li>
                        <li>View full history by right-clicking ‚Üí View History</li>
                    </ul>
                </div>
                
                <div style="margin-top:24px;text-align:center;">
                    <button class="btn btn-primary" onclick="closeHelp()">Got it!</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Layout Manager Modal -->
    <div class="modal-overlay" id="layoutManagerModal" onclick="if(event.target===this)closeLayoutManager()">
        <div class="modal" style="max-width:500px;">
            <div class="modal-header">
                <h2>üìê Manage Layouts</h2>
                <button class="close-btn" onclick="closeLayoutManager()">‚úï</button>
            </div>
            <div class="modal-body">
                <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:16px;">
                    Create different seating arrangements for your class. Switch between them using the dropdown in the toolbar.
                </p>
                
                <div id="layoutList">
                    <!-- Populated by JS -->
                </div>
                
                <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);">
                    <h4 style="margin-bottom:12px;">Create New Layout</h4>
                    <div style="display:flex;gap:8px;">
                        <input type="text" id="newLayoutName" placeholder="Layout name (e.g., Group Work)" 
                            style="flex:1;padding:10px;border-radius:8px;background:var(--bg-secondary);color:white;border:1px solid var(--border);">
                        <button class="btn btn-primary" onclick="createNewLayout()">+ Create</button>
                    </div>
                    <div style="margin-top:12px;">
                        <label style="display:flex;align-items:center;gap:8px;font-size:0.9rem;color:var(--text-secondary);">
                            <input type="checkbox" id="copyCurrentPositions" checked>
                            Copy current positions to new layout
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mini Overlay -->
    <div class="mini-overlay" id="miniOverlay">
        <div class="mini-header" id="miniHeader">
            <span class="mini-title">üìã Attendance</span>
            <div class="mini-stats">
                <span class="mini-stat ontime" id="miniOntime">0</span>
                <span class="mini-stat late" id="miniLate">0</span>
                <span class="mini-stat absent" id="miniAbsent">0</span>
            </div>
            <div class="mini-controls">
                <button class="mini-btn" onclick="popOutMini()" title="Pop out to separate window">ü™ü</button>
                <button class="mini-btn" onclick="adjustMiniOpacity(-0.1)" title="More transparent">üëª</button>
                <button class="mini-btn" onclick="adjustMiniOpacity(0.1)" title="Less transparent">üî≤</button>
                <button class="mini-btn" onclick="toggleMiniOverlay()" title="Close">‚úï</button>
            </div>
        </div>
        <div class="mini-grid" id="miniGrid">
            <!-- Mini student cards -->
        </div>
        <div class="mini-resize" id="miniResize"></div>
    </div>

    <script>
        // ========== APP STATE ==========
        let students = [];
        let classData = null;
        let currentZoom = 1;
        let editMode = false;
        let contextStudentId = null;
        let currentGroups = [];
        
        // Multi-class support
        let allClasses = {}; // { classId: { classData, students, attendanceHistory, streaks } }
        let currentClassId = null;
        
        // Settings
        let appSettings = {
            graceSeconds: 45, // Grace period after bell (still on-time)
            bellOffsetSeconds: 0, // If bell is late (+) or early (-)
            autoAbsentMinutes: 5, // Minutes after class to auto-mark absent
            autoBackup: true,
            backupRetentionDays: 3
        };
        
        // Schedule state
        let schedule = {
            period: 1,
            startTime: '08:40',
            endTime: '10:00',
            pattern: 'oneoff',
            patternName: ''
        };
        
        // Attendance history: { date: { studentId: { status, time, note, lateBy } } }
        let attendanceHistory = {};
        
        // Student streaks: { studentId: { current: N, best: N, lastDate: 'YYYY-MM-DD' } }
        let streaks = {};
        
        // Fun messages
        const ontimeMessages = [
            "‚úì On time!",
            "‚úì Nice! Right on time",
            "‚úì Perfect timing!",
            "‚úì Looking good!",
            "‚úì Nailed it!"
        ];
        
        const streakMessages = {
            3: "üé© Hat trick! 3 days on time!",
            5: "üî• On fire! 5 days!",
            10: "‚≠ê Perfect 10! You're unstoppable!",
            20: "üèÜ Legend status! 20 days!"
        };
        
        const improvementMessages = [
            "üìà Better than yesterday!",
            "üìà Improvement! Keep it up!",
            "üìà Nice progress!"
        ];
        
        // Britannia bell schedule presets
        const presets = {
            regular: {
                1: { start: '08:40', end: '10:00' },
                2: { start: '10:10', end: '11:30' },
                3: { start: '12:15', end: '13:35' },
                4: { start: '13:45', end: '15:05' }
            },
            amfit: { // Wed, Fri
                1: { start: '09:20', end: '10:20' },
                2: { start: '10:30', end: '11:30' },
                3: { start: '12:15', end: '13:35' },
                4: { start: '13:45', end: '15:05' }
            },
            pmfit: { // Tue, Thu
                1: { start: '08:40', end: '10:00' },
                2: { start: '10:10', end: '11:30' },
                3: { start: '12:15', end: '13:15' },
                4: { start: '13:25', end: '14:25' }
            }
        };
        
        // ========== DATE HELPERS ==========
        function getToday() {
            return new Date().toISOString().split('T')[0];
        }
        
        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }
        
        function parseTime(timeStr) {
            let [hours, minutes] = timeStr.split(':').map(Number);
            
            // Smart PM detection for school hours:
            // If hours are 1-6, assume PM (13:00-18:00)
            // School runs ~7am-5pm, so 1:00 means 1 PM, not 1 AM
            if (hours >= 1 && hours <= 6) {
                hours += 12;
            }
            
            const d = new Date();
            d.setHours(hours, minutes, 0, 0);
            return d;
        }
        
        // Normalize time string to 24-hour format (for storage)
        function normalizeTimeStr(timeStr) {
            if (!timeStr) return timeStr;
            let [hours, minutes] = timeStr.split(':').map(Number);
            
            // Smart PM detection: 1-6 ‚Üí 13-18
            if (hours >= 1 && hours <= 6) {
                hours += 12;
            }
            
            return `${hours.toString().padStart(2, '0')}:${(minutes || 0).toString().padStart(2, '0')}`;
        }
        
        // Migration: fix any existing schedule blocks with AM times (1:00 ‚Üí 13:00)
        function migrateScheduleBlockTimes() {
            let migrated = false;
            const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
            
            days.forEach(day => {
                if (!scheduleBlocks[day]) return;
                scheduleBlocks[day].forEach(block => {
                    const oldStart = block.start;
                    const oldEnd = block.end;
                    block.start = normalizeTimeStr(block.start);
                    block.end = normalizeTimeStr(block.end);
                    if (oldStart !== block.start || oldEnd !== block.end) {
                        migrated = true;
                        console.log(`Migrated ${day} block: ${oldStart}-${oldEnd} ‚Üí ${block.start}-${block.end}`);
                    }
                });
            });
            
            if (migrated) {
                saveScheduleBlocks();
                console.log('Schedule times migrated to 24-hour format');
            }
        }
        
        // ========== SCHEDULE ==========
        let weeklyPattern = {
            type: 'simple', // simple, biweekly, cycle
            simple: { mon: 'regular', tue: 'pmfit', wed: 'amfit', thu: 'pmfit', fri: 'amfit' },
            week1: { mon: 'regular', tue: 'pmfit', wed: 'amfit', thu: 'pmfit', fri: 'amfit' },
            week2: { mon: 'regular', tue: 'pmfit', wed: 'amfit', thu: 'pmfit', fri: 'amfit' },
            currentWeek: 1
        };
        
        let classAssignments = {
            1: { name: '', classId: null },
            2: { name: '', classId: null },
            3: { name: '', classId: null },
            4: { name: '', classId: null }
        };
        
        // Period rotation - which period goes in which block for each day
        // Default: period 1 in block 1, period 2 in block 2, etc.
        let periodRotation = {
            type: 'simple', // simple, biweekly
            numBlocks: 4,   // configurable for different schools
            simple: {
                mon: [1, 2, 3, 4],
                tue: [1, 2, 3, 4],
                wed: [1, 2, 3, 4],
                thu: [1, 2, 3, 4],
                fri: [1, 2, 3, 4]
            },
            week1: {
                mon: [1, 2, 3, 4],
                tue: [1, 2, 3, 4],
                wed: [1, 2, 3, 4],
                thu: [1, 2, 3, 4],
                fri: [1, 2, 3, 4]
            },
            week2: {
                mon: [1, 2, 3, 4],
                tue: [1, 2, 3, 4],
                wed: [1, 2, 3, 4],
                thu: [1, 2, 3, 4],
                fri: [1, 2, 3, 4]
            }
        };
        
        // Track selected cell for swap operation
        let rotationSwapSelection = null;
        
        // Load saved patterns
        const savedWeekly = localStorage.getItem('hallpass_weeklyPattern');
        if (savedWeekly) {
            try { weeklyPattern = JSON.parse(savedWeekly); } catch(e) {}
        }
        const savedClasses = localStorage.getItem('hallpass_classAssignments');
        if (savedClasses) {
            try { classAssignments = JSON.parse(savedClasses); } catch(e) {}
        }
        const savedRotation = localStorage.getItem('hallpass_periodRotation');
        if (savedRotation) {
            try { periodRotation = JSON.parse(savedRotation); } catch(e) {}
        }
        const savedPresets = localStorage.getItem('hallpass_presets');
        if (savedPresets) {
            try { 
                const loaded = JSON.parse(savedPresets);
                Object.assign(presets, loaded);
            } catch(e) {}
        }
        
        function openSchedule() {
            // Update today's date display
            const now = new Date();
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            document.getElementById('schedTodayDate').textContent = 
                `${dayNames[now.getDay()]}, ${monthNames[now.getMonth()]} ${now.getDate()}`;
            
            // Load current values
            document.getElementById('schedPeriod').value = schedule.period;
            document.getElementById('schedStart').value = schedule.startTime;
            document.getElementById('schedEnd').value = schedule.endTime;
            document.getElementById('schedType').value = schedule.scheduleType || 'regular';
            
            // Populate class dropdown
            populateClassDropdown();
            
            // Load weekly pattern
            loadWeeklyPatternUI();
            
            // Load class assignments
            loadClassAssignmentsUI();
            
            // Load period rotation grid
            renderRotationGrid();
            
            updateSchedulePreview();
            showSchedTab('today');
            document.getElementById('scheduleModal').classList.add('open');
        }
        
        function closeSchedule() {
            document.getElementById('scheduleModal').classList.remove('open');
        }
        
        // Quick Time Edit (double-click on countdown)
        function openQuickTimeEdit() {
            const popup = document.getElementById('quickTimePopup');
            const overlay = document.getElementById('quickTimeOverlay');
            
            // Set current values
            document.getElementById('quickTimePeriod').textContent = schedule.period;
            document.getElementById('quickTimePeriod2').textContent = schedule.period;
            document.getElementById('quickStartTime').value = schedule.startTime;
            document.getElementById('quickEndTime').value = schedule.endTime;
            
            popup.style.display = 'block';
            overlay.style.display = 'block';
            
            // Focus the start time input
            document.getElementById('quickStartTime').focus();
        }
        
        function closeQuickTimeEdit() {
            document.getElementById('quickTimePopup').style.display = 'none';
            document.getElementById('quickTimeOverlay').style.display = 'none';
        }
        
        function applyQuickTime() {
            const newStart = document.getElementById('quickStartTime').value;
            const newEnd = document.getElementById('quickEndTime').value;
            
            if (!newStart || !newEnd) {
                showToast('Please enter both times');
                return;
            }
            
            // Validate end is after start
            if (newEnd <= newStart) {
                showToast('End time must be after start time');
                return;
            }
            
            // Apply to current period
            schedule.startTime = newStart;
            schedule.endTime = newEnd;
            
            // Set manual override so auto-detect doesn't revert
            manualPeriodOverride = true;
            
            // Save
            localStorage.setItem('hallpass_schedule', JSON.stringify(schedule));
            
            // Update UI
            updateStatusBar();
            closeQuickTimeEdit();
            
            showToast(`‚è±Ô∏è Period ${schedule.period}: ${newStart} - ${newEnd}`);
        }
        
        // Allow Enter key to apply
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.getElementById('quickTimePopup').style.display === 'block') {
                applyQuickTime();
            }
            if (e.key === 'Escape' && document.getElementById('quickTimePopup').style.display === 'block') {
                closeQuickTimeEdit();
            }
        });
        
        function showSchedTab(tab) {
            document.querySelectorAll('.sched-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sched-panel').forEach(p => p.classList.remove('active'));
            
            document.querySelector(`.sched-tab[onclick*="${tab}"]`)?.classList.add('active');
            document.getElementById('schedPanel' + tab.charAt(0).toUpperCase() + tab.slice(1))?.classList.add('active');
            
            // Render rotation grid when switching to rotation tab
            if (tab === 'rotation') {
                renderRotationGrid();
            }
            // Render calendar when switching to weekly tab
            if (tab === 'weekly') {
                renderCalendar();
            }
        }
        
        function updateSchedulePreview() {
            const start = parseTime(document.getElementById('schedStart').value);
            const end = parseTime(document.getElementById('schedEnd').value);
            
            // Hall pass: 10 min after start until 10 min before end
            const passStart = new Date(start.getTime() + 10 * 60000);
            const passEnd = new Date(end.getTime() - 10 * 60000);
            
            document.getElementById('hallpassWindow').textContent = 
                `${formatTime(passStart)} - ${formatTime(passEnd)}`;
        }
        
        function onSchedTypeChange() {
            const type = document.getElementById('schedType').value;
            const period = parseInt(document.getElementById('schedPeriod').value);
            
            if (type !== 'custom' && presets[type] && presets[type][period]) {
                document.getElementById('schedStart').value = presets[type][period].start;
                document.getElementById('schedEnd').value = presets[type][period].end;
                updateSchedulePreview();
            }
        }
        
        function onClassChange() {
            const classSelect = document.getElementById('schedClass');
            const className = classSelect.options[classSelect.selectedIndex]?.text || '';
            // Could auto-load roster here
        }
        
        function populateClassDropdown() {
            const select = document.getElementById('schedClass');
            select.innerHTML = '<option value="">-- Select Class --</option>';
            
            Object.entries(classAssignments).forEach(([period, data]) => {
                if (data.name) {
                    const opt = document.createElement('option');
                    opt.value = period;
                    opt.textContent = `P${period}: ${data.name}`;
                    select.appendChild(opt);
                }
            });
            
            // Select current period's class
            if (classAssignments[schedule.period]?.name) {
                select.value = schedule.period;
            }
        }
        
        // Calendar configuration
        const CALENDAR_START = '08:00';
        const CALENDAR_END = '16:00';
        const CALENDAR_HEIGHT = 400; // pixels
        
        // Schedule blocks per day: { day: [ {id, type, start, end, title, classId?}, ... ] }
        let scheduleBlocks = {
            mon: [], tue: [], wed: [], thu: [], fri: []
        };
        
        // Initialize default blocks if not loaded
        function initDefaultScheduleBlocks() {
            const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
            days.forEach(day => {
                if (!scheduleBlocks[day] || scheduleBlocks[day].length === 0) {
                    // Create default blocks based on preset
                    const schedType = weeklyPattern.simple[day] || 'regular';
                    const preset = presets[schedType] || presets.regular;
                    
                    scheduleBlocks[day] = [
                        { id: `${day}-p1`, type: 'period', period: 1, start: preset[1].start, end: preset[1].end, title: 'Period 1' },
                        { id: `${day}-break1`, type: 'break', start: preset[1].end, end: preset[2].start, title: 'Break' },
                        { id: `${day}-p2`, type: 'period', period: 2, start: preset[2].start, end: preset[2].end, title: 'Period 2' },
                        { id: `${day}-lunch`, type: 'lunch', start: '11:30', end: '12:15', title: 'Lunch' },
                        { id: `${day}-p3`, type: 'period', period: 3, start: preset[3].start, end: preset[3].end, title: 'Period 3' },
                        { id: `${day}-break2`, type: 'break', start: preset[3].end, end: preset[4].start, title: 'Break' },
                        { id: `${day}-p4`, type: 'period', period: 4, start: preset[4].start, end: preset[4].end, title: 'Period 4' }
                    ];
                    
                    // Add FIT if applicable
                    if (schedType === 'amfit') {
                        scheduleBlocks[day].unshift({ id: `${day}-fit`, type: 'fit', start: '08:40', end: '09:20', title: 'FIT' });
                    } else if (schedType === 'pmfit') {
                        scheduleBlocks[day].push({ id: `${day}-fit`, type: 'fit', start: '14:25', end: '15:05', title: 'FIT' });
                    }
                }
            });
        }
        
        function loadWeeklyPatternUI() {
            // Set pattern type
            document.getElementById('weekPatternType').value = weeklyPattern.type;
            
            // Update toggle buttons
            document.querySelectorAll('.week-toggle-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === weeklyPattern.type);
            });
            
            // Show/hide current week toggle
            document.getElementById('currentWeekToggle').style.display = weeklyPattern.type === 'biweekly' ? 'flex' : 'none';
            
            // Update current week buttons
            document.querySelectorAll('.current-week-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.week) === (weeklyPattern.currentWeek || 1));
            });
            
            // Load hidden selects for compatibility
            document.querySelectorAll('.day-sched').forEach(sel => {
                const day = sel.dataset.day;
                sel.value = weeklyPattern.simple[day] || 'regular';
            });
            
            // Set current week
            const weekSelect = document.getElementById('currentWeekNum');
            if (weekSelect) weekSelect.value = weeklyPattern.currentWeek || 1;
            
            // Load schedule blocks from storage or init defaults
            const savedBlocks = localStorage.getItem('hallpass_scheduleBlocks');
            if (savedBlocks) {
                try { 
                    scheduleBlocks = JSON.parse(savedBlocks);
                    // Migrate: normalize all times (fix 1:00 AM ‚Üí 1:00 PM issues)
                    migrateScheduleBlockTimes();
                } catch(e) {}
            } else {
                initDefaultScheduleBlocks();
            }
            
            // Render the calendar
            renderCalendar();
            
            // Render class assignments
            renderClassAssignments();
        }
        
        function timeToPixels(timeStr) {
            const [hours, mins] = timeStr.split(':').map(Number);
            const [startHours, startMins] = CALENDAR_START.split(':').map(Number);
            const [endHours, endMins] = CALENDAR_END.split(':').map(Number);
            
            const startMinutes = startHours * 60 + startMins;
            const endMinutes = endHours * 60 + endMins;
            const currentMinutes = hours * 60 + mins;
            
            const totalMinutes = endMinutes - startMinutes;
            const offsetMinutes = currentMinutes - startMinutes;
            
            return (offsetMinutes / totalMinutes) * CALENDAR_HEIGHT;
        }
        
        function renderCalendar() {
            const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
            
            // Render time labels
            const timesCol = document.getElementById('calendarTimes');
            if (timesCol) {
                let timesHtml = '';
                for (let h = 8; h <= 16; h++) {
                    const timeStr = `${h.toString().padStart(2, '0')}:00`;
                    const top = timeToPixels(timeStr);
                    const label = h > 12 ? `${h-12}pm` : (h === 12 ? '12pm' : `${h}am`);
                    timesHtml += `<span class="calendar-time-label" style="top:${top + 40}px;">${label}</span>`;
                }
                timesCol.innerHTML = timesHtml;
            }
            
            // Render each day
            days.forEach(day => {
                const dayEl = document.getElementById(`calDay-${day}`);
                if (!dayEl) return;
                
                const blocks = scheduleBlocks[day] || [];
                let html = '';
                
                // Count period blocks to get their index for rotation
                let periodBlockIndex = 0;
                
                blocks.forEach(block => {
                    const top = timeToPixels(block.start);
                    const bottom = timeToPixels(block.end);
                    const height = Math.max(20, bottom - top);
                    
                    // Get class name if it's a period - use rotation to get actual period
                    let className = '';
                    let displayPeriod = block.period;
                    if (block.type === 'period' && block.period) {
                        // Use rotation to get the actual period for this block
                        const rotatedPeriod = getPeriodForBlock(day, periodBlockIndex);
                        displayPeriod = rotatedPeriod;
                        const assignment = classAssignments[rotatedPeriod];
                        if (assignment?.name) {
                            className = assignment.name;
                        }
                        periodBlockIndex++;
                    }
                    
                    // For period blocks, show the rotated period number
                    const displayTitle = block.type === 'period' ? `Period ${displayPeriod}` : block.title;
                    
                    html += `
                        <div class="calendar-block ${block.type}" 
                             data-id="${block.id}"
                             style="top:${top}px;height:${height}px;"
                             onclick="editBlock('${day}', '${block.id}')"
                             oncontextmenu="openBlockContext(event, '${day}', '${block.id}'); return false;">
                            <span class="block-title">${displayTitle}</span>
                            <span class="block-time">${block.start} - ${block.end}</span>
                            ${className ? `<span class="block-class">${className}</span>` : ''}
                        </div>
                    `;
                });
                
                dayEl.innerHTML = html;
            });
        }
        
        // Calendar context menu
        let calendarContextDay = null;
        let calendarContextBlockId = null;
        let calendarContextY = 0;
        
        function openCalendarContext(event, day) {
            event.preventDefault();
            calendarContextDay = day;
            calendarContextBlockId = null;
            calendarContextY = event.clientY;
            
            const menu = document.getElementById('calendarContextMenu');
            menu.style.left = event.clientX + 'px';
            menu.style.top = event.clientY + 'px';
            menu.classList.add('open');
            
            // Hide edit/delete options when clicking empty area
            menu.querySelectorAll('.calendar-context-item').forEach((item, i) => {
                if (i >= 5) item.style.display = 'none';
            });
        }
        
        function openBlockContext(event, day, blockId) {
            event.preventDefault();
            event.stopPropagation();
            calendarContextDay = day;
            calendarContextBlockId = blockId;
            
            const menu = document.getElementById('calendarContextMenu');
            menu.style.left = event.clientX + 'px';
            menu.style.top = event.clientY + 'px';
            menu.classList.add('open');
            
            // Show edit/delete options
            menu.querySelectorAll('.calendar-context-item').forEach((item, i) => {
                item.style.display = 'block';
            });
        }
        
        function closeCalendarContext() {
            document.getElementById('calendarContextMenu').classList.remove('open');
        }
        
        document.addEventListener('click', () => closeCalendarContext());
        
        function addBlockFromContext(type) {
            closeCalendarContext();
            
            if (!calendarContextDay) return;
            
            // Calculate approximate time from click position
            const dayEl = document.getElementById(`calDay-${calendarContextDay}`);
            if (!dayEl) return;
            
            const rect = dayEl.getBoundingClientRect();
            const relativeY = calendarContextY - rect.top;
            const percentage = relativeY / CALENDAR_HEIGHT;
            
            const [startH, startM] = CALENDAR_START.split(':').map(Number);
            const [endH, endM] = CALENDAR_END.split(':').map(Number);
            const totalMins = (endH * 60 + endM) - (startH * 60 + startM);
            const clickMins = startH * 60 + startM + (percentage * totalMins);
            
            const startHour = Math.floor(clickMins / 60);
            const startMin = Math.round((clickMins % 60) / 5) * 5;
            const start = `${startHour.toString().padStart(2, '0')}:${startMin.toString().padStart(2, '0')}`;
            
            // Default duration by type
            let duration = 60;
            if (type === 'break') duration = 10;
            else if (type === 'lunch') duration = 45;
            else if (type === 'fit') duration = 40;
            
            const endMins = clickMins + duration;
            const endHour = Math.floor(endMins / 60);
            const endMin = Math.round((endMins % 60) / 5) * 5;
            const end = `${endHour.toString().padStart(2, '0')}:${endMin.toString().padStart(2, '0')}`;
            
            const title = prompt(`Enter ${type} name:`, type.charAt(0).toUpperCase() + type.slice(1));
            if (!title) return;
            
            const block = {
                id: `${calendarContextDay}-${Date.now()}`,
                type,
                start,
                end,
                title
            };
            
            scheduleBlocks[calendarContextDay].push(block);
            saveScheduleBlocks();
            renderCalendar();
        }
        
        function editBlock(day, blockId) {
            const blocks = scheduleBlocks[day];
            const block = blocks.find(b => b.id === blockId);
            if (!block) return;
            
            const newStart = prompt('Start time (HH:MM, e.g. 1:30 = 1:30 PM):', block.start);
            if (!newStart) return;
            
            const newEnd = prompt('End time (HH:MM, e.g. 2:45 = 2:45 PM):', block.end);
            if (!newEnd) return;
            
            const newTitle = prompt('Title:', block.title);
            if (!newTitle) return;
            
            // Normalize times (1:00 ‚Üí 13:00, etc.)
            block.start = normalizeTimeStr(newStart);
            block.end = normalizeTimeStr(newEnd);
            block.title = newTitle;
            
            saveScheduleBlocks();
            renderCalendar();
        }
        
        function editBlockFromContext() {
            closeCalendarContext();
            if (calendarContextDay && calendarContextBlockId) {
                editBlock(calendarContextDay, calendarContextBlockId);
            }
        }
        
        function deleteBlockFromContext() {
            closeCalendarContext();
            if (!calendarContextDay || !calendarContextBlockId) return;
            
            const blocks = scheduleBlocks[calendarContextDay];
            const idx = blocks.findIndex(b => b.id === calendarContextBlockId);
            if (idx === -1) return;
            
            if (!confirm(`Delete "${blocks[idx].title}"?`)) return;
            
            blocks.splice(idx, 1);
            saveScheduleBlocks();
            renderCalendar();
        }
        
        function addBlockToDay(day, type) {
            // If no day specified, ask
            if (!day) {
                day = prompt('Which day? (mon, tue, wed, thu, fri):', 'mon');
                if (!day || !['mon', 'tue', 'wed', 'thu', 'fri'].includes(day.toLowerCase())) return;
                day = day.toLowerCase();
            }
            
            const start = prompt('Start time (HH:MM, e.g. 1:30 = 1:30 PM):', '10:00');
            if (!start) return;
            
            const end = prompt('End time (HH:MM, e.g. 2:45 = 2:45 PM):', '10:10');
            if (!end) return;
            
            const title = prompt('Title:', type.charAt(0).toUpperCase() + type.slice(1));
            if (!title) return;
            
            scheduleBlocks[day].push({
                id: `${day}-${Date.now()}`,
                type,
                start: normalizeTimeStr(start),
                end: normalizeTimeStr(end),
                title
            });
            
            saveScheduleBlocks();
            renderCalendar();
        }
        
        function resetToDefaultSchedule() {
            if (!confirm('Reset to Britannia default schedule? This will overwrite your current blocks.')) return;
            
            scheduleBlocks = { mon: [], tue: [], wed: [], thu: [], fri: [] };
            initDefaultScheduleBlocks();
            saveScheduleBlocks();
            renderCalendar();
            showToast('Reset to default schedule');
        }
        
        // Apply a schedule type (regular, amfit, pmfit) to a specific day
        function applyScheduleToDay(schedType) {
            closeCalendarContext();
            
            if (!calendarContextDay) return;
            
            const day = calendarContextDay;
            const preset = presets[schedType] || presets.regular;
            
            // Build blocks for this day based on preset
            const blocks = [];
            
            // AM FIT goes first
            if (schedType === 'amfit') {
                blocks.push({ 
                    id: `${day}-fit`, 
                    type: 'fit', 
                    start: '08:40', 
                    end: '09:20', 
                    title: 'FIT' 
                });
            }
            
            // Period 1
            blocks.push({ 
                id: `${day}-p1`, 
                type: 'period', 
                period: 1, 
                start: preset[1].start, 
                end: preset[1].end, 
                title: 'Period 1' 
            });
            
            // Break 1
            blocks.push({ 
                id: `${day}-break1`, 
                type: 'break', 
                start: preset[1].end, 
                end: preset[2].start, 
                title: 'Break' 
            });
            
            // Period 2
            blocks.push({ 
                id: `${day}-p2`, 
                type: 'period', 
                period: 2, 
                start: preset[2].start, 
                end: preset[2].end, 
                title: 'Period 2' 
            });
            
            // Lunch
            blocks.push({ 
                id: `${day}-lunch`, 
                type: 'lunch', 
                start: '11:30', 
                end: '12:15', 
                title: 'Lunch' 
            });
            
            // Period 3
            blocks.push({ 
                id: `${day}-p3`, 
                type: 'period', 
                period: 3, 
                start: preset[3].start, 
                end: preset[3].end, 
                title: 'Period 3' 
            });
            
            // Break 2
            blocks.push({ 
                id: `${day}-break2`, 
                type: 'break', 
                start: preset[3].end, 
                end: preset[4].start, 
                title: 'Break' 
            });
            
            // Period 4
            blocks.push({ 
                id: `${day}-p4`, 
                type: 'period', 
                period: 4, 
                start: preset[4].start, 
                end: preset[4].end, 
                title: 'Period 4' 
            });
            
            // PM FIT goes last
            if (schedType === 'pmfit') {
                blocks.push({ 
                    id: `${day}-fit`, 
                    type: 'fit', 
                    start: '14:25', 
                    end: '15:05', 
                    title: 'FIT' 
                });
            }
            
            // Update the weekly pattern for compatibility
            weeklyPattern.simple[day] = schedType;
            
            // Replace day's blocks
            scheduleBlocks[day] = blocks;
            saveScheduleBlocks();
            saveScheduleConfig();
            renderCalendar();
            
            const dayNames = { mon: 'Monday', tue: 'Tuesday', wed: 'Wednesday', thu: 'Thursday', fri: 'Friday' };
            const schedNames = { regular: 'Regular', amfit: 'AM FIT', pmfit: 'PM FIT' };
            showToast(`${dayNames[day]}: ${schedNames[schedType]} schedule applied`);
        }
        
        function saveScheduleBlocks() {
            localStorage.setItem('hallpass_scheduleBlocks', JSON.stringify(scheduleBlocks));
        }
        
        function onWeekPatternTypeChange() {
            const type = document.getElementById('weekPatternType').value;
            weeklyPattern.type = type;
            loadWeeklyPatternUI();
            saveScheduleConfig();
        }
        
        function setWeekType(type) {
            weeklyPattern.type = type;
            document.getElementById('weekPatternType').value = type;
            loadWeeklyPatternUI();
            saveScheduleConfig();
        }
        
        function setCurrentWeek(weekNum) {
            weeklyPattern.currentWeek = weekNum;
            document.getElementById('currentWeekNum').value = weekNum;
            document.querySelectorAll('.current-week-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.week) === weekNum);
            });
            saveScheduleConfig();
            updateStatusBar();
        }
        
        function saveScheduleConfig() {
            localStorage.setItem('hallpass_weeklyPattern', JSON.stringify(weeklyPattern));
            localStorage.setItem('hallpass_presets', JSON.stringify(presets));
            localStorage.setItem('hallpass_periodRotation', JSON.stringify(periodRotation));
        }
        
        // Class assignments UI
        function renderClassAssignments() {
            const container = document.getElementById('classAssignmentsContainer');
            if (!container) return;
            
            // Get list of loaded classes
            const classIds = Object.keys(allClasses);
            
            let html = '';
            for (let p = 1; p <= 4; p++) {
                const current = classAssignments[p]?.classId || '';
                const hasClass = current && allClasses[current];
                
                html += `
                    <div class="period-class-row" style="display:flex;align-items:center;gap:8px;">
                        <label style="min-width:70px;">Period ${p}</label>
                        <select onchange="assignClassToPeriod(${p}, this.value)" style="flex:1;">
                            <option value="">-- None / Prep --</option>
                            ${classIds.map(id => {
                                const cls = allClasses[id];
                                const name = cls.classData?.settings?.className || id;
                                return `<option value="${id}" ${id === current ? 'selected' : ''}>${name}</option>`;
                            }).join('')}
                        </select>
                        ${hasClass ? `<button onclick="clearPeriodAssignment(${p})" style="background:var(--danger);border:none;color:white;padding:6px 10px;border-radius:6px;cursor:pointer;" title="Remove class from Period ${p}">‚úï</button>` : ''}
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        function clearPeriodAssignment(period) {
            classAssignments[period] = { name: '', classId: null };
            localStorage.setItem('hallpass_classAssignments', JSON.stringify(classAssignments));
            renderClassAssignments();
            renderCalendar();
            showToast(`Period ${period} cleared`);
        }
        
        function assignClassToPeriod(period, classId) {
            if (!classAssignments[period]) {
                classAssignments[period] = {};
            }
            
            if (classId) {
                const cls = allClasses[classId];
                classAssignments[period] = {
                    classId: classId,
                    name: cls?.classData?.settings?.className || classId
                };
            } else {
                classAssignments[period] = { name: '', classId: null };
            }
            
            localStorage.setItem('hallpass_classAssignments', JSON.stringify(classAssignments));
            renderCalendar();
            renderClassAssignments(); // Refresh the dropdowns
        }
        
        function loadClassAssignmentsUI() {
            // Legacy function - now handled by renderClassAssignments
            renderClassAssignments();
        }
        
        // ========== PERIOD ROTATION ==========
        function renderRotationGrid() {
            const container = document.getElementById('periodRotationGrid');
            if (!container) return;
            
            const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
            const dayLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
            const numBlocks = periodRotation.numBlocks || 4;
            
            // Get the current rotation pattern based on type
            const pattern = periodRotation.type === 'biweekly' 
                ? (periodRotation.currentWeek === 2 ? periodRotation.week2 : periodRotation.week1)
                : periodRotation.simple;
            
            // Update UI toggles
            const typeSelect = document.getElementById('rotationPatternType');
            if (typeSelect) typeSelect.value = periodRotation.type;
            
            const weekToggle = document.getElementById('rotationWeekToggle');
            if (weekToggle) {
                weekToggle.style.display = periodRotation.type === 'biweekly' ? 'flex' : 'none';
            }
            
            document.querySelectorAll('.rotation-week-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.week) === (periodRotation.currentWeek || 1));
            });
            
            let html = '';
            
            // Header row
            html += '<div class="rotation-header"></div>'; // empty corner cell
            dayLabels.forEach(label => {
                html += `<div class="rotation-header">${label}</div>`;
            });
            
            // Block rows - using dropdown selects
            for (let blockIdx = 0; blockIdx < numBlocks; blockIdx++) {
                html += `<div class="rotation-label">Block ${blockIdx + 1}</div>`;
                
                days.forEach(day => {
                    const periods = pattern[day] || [];
                    // Ensure array is long enough
                    while (periods.length <= blockIdx) {
                        periods.push(periods.length + 1);
                    }
                    const periodNum = periods[blockIdx] || (blockIdx + 1);
                    
                    // Build dropdown options
                    let options = '';
                    for (let p = 1; p <= numBlocks; p++) {
                        const assignment = classAssignments[p];
                        const className = assignment?.name || '';
                        const label = className ? `P${p}: ${className.substring(0, 15)}` : `Period ${p}`;
                        const selected = p === periodNum ? 'selected' : '';
                        options += `<option value="${p}" ${selected}>${label}</option>`;
                    }
                    
                    // Check if this is a FIT-affected block
                    const schedType = getScheduleTypeForDay(day);
                    const isFitAffected = (schedType === 'amfit' && blockIdx < 2) || 
                                         (schedType === 'pmfit' && blockIdx >= 2);
                    
                    html += `
                        <div class="rotation-cell ${isFitAffected ? 'fit-block' : ''}">
                            <select class="rotation-select" 
                                    data-day="${day}" 
                                    data-block="${blockIdx}"
                                    onchange="handleRotationChange('${day}', ${blockIdx}, this.value)">
                                ${options}
                            </select>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }
        
        function getScheduleTypeForDay(dayKey) {
            // Reuse existing logic
            if (weeklyPattern.type === 'simple') {
                return weeklyPattern.simple[dayKey] || 'regular';
            } else if (weeklyPattern.type === 'biweekly') {
                const pattern = weeklyPattern.currentWeek === 1 ? weeklyPattern.week1 : weeklyPattern.week2;
                return pattern[dayKey] || 'regular';
            }
            return 'regular';
        }
        
        function handleRotationChange(day, blockIdx, newPeriod) {
            newPeriod = parseInt(newPeriod);
            
            // Get the current pattern
            const pattern = periodRotation.type === 'biweekly'
                ? (periodRotation.currentWeek === 2 ? periodRotation.week2 : periodRotation.week1)
                : periodRotation.simple;
            
            // Ensure the day array exists
            if (!pattern[day]) {
                pattern[day] = [1, 2, 3, 4];
            }
            
            const periods = pattern[day];
            
            // Ensure array is long enough
            while (periods.length <= blockIdx) {
                periods.push(periods.length + 1);
            }
            
            // Set the new period for this block
            periods[blockIdx] = newPeriod;
            
            // Save and update
            saveRotation();
            renderCalendar();
            
            // Get class name for toast
            const className = classAssignments[newPeriod]?.name || `Period ${newPeriod}`;
            showToast(`${day.charAt(0).toUpperCase() + day.slice(1)} Block ${blockIdx + 1} ‚Üí ${className}`);
        }
        
        function setRotationPatternType(type) {
            periodRotation.type = type;
            document.getElementById('rotationWeekToggle').style.display = type === 'biweekly' ? 'flex' : 'none';
            saveRotation();
            renderRotationGrid();
        }
        
        function setRotationWeek(weekNum) {
            periodRotation.currentWeek = weekNum;
            document.querySelectorAll('.rotation-week-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.week) === weekNum);
            });
            saveRotation();
            renderRotationGrid();
        }
        
        function resetRotationToDefault() {
            const numBlocks = periodRotation.numBlocks || 4;
            const defaultOrder = Array.from({length: numBlocks}, (_, i) => i + 1);
            
            ['mon', 'tue', 'wed', 'thu', 'fri'].forEach(day => {
                periodRotation.simple[day] = [...defaultOrder];
                periodRotation.week1[day] = [...defaultOrder];
                periodRotation.week2[day] = [...defaultOrder];
            });
            
            saveRotation();
            renderRotationGrid();
            renderCalendar();
            showToast('Rotation reset to default');
        }
        
        function addBlockToRotation() {
            periodRotation.numBlocks = (periodRotation.numBlocks || 4) + 1;
            const newPeriod = periodRotation.numBlocks;
            
            ['mon', 'tue', 'wed', 'thu', 'fri'].forEach(day => {
                periodRotation.simple[day] = periodRotation.simple[day] || [];
                periodRotation.simple[day].push(newPeriod);
                periodRotation.week1[day] = periodRotation.week1[day] || [];
                periodRotation.week1[day].push(newPeriod);
                periodRotation.week2[day] = periodRotation.week2[day] || [];
                periodRotation.week2[day].push(newPeriod);
            });
            
            saveRotation();
            renderRotationGrid();
            showToast(`Added Block ${periodRotation.numBlocks}`);
        }
        
        function removeBlockFromRotation() {
            if ((periodRotation.numBlocks || 4) <= 1) {
                showToast('Cannot remove last block');
                return;
            }
            
            periodRotation.numBlocks = (periodRotation.numBlocks || 4) - 1;
            
            ['mon', 'tue', 'wed', 'thu', 'fri'].forEach(day => {
                if (periodRotation.simple[day]) periodRotation.simple[day].pop();
                if (periodRotation.week1[day]) periodRotation.week1[day].pop();
                if (periodRotation.week2[day]) periodRotation.week2[day].pop();
            });
            
            saveRotation();
            renderRotationGrid();
            showToast(`Removed block row`);
        }
        
        function saveRotation() {
            localStorage.setItem('hallpass_periodRotation', JSON.stringify(periodRotation));
        }
        
        // Get the period number for a given day and block index (used by calendar and period detection)
        function getPeriodForBlock(day, blockIdx) {
            const pattern = periodRotation.type === 'biweekly'
                ? (periodRotation.currentWeek === 2 ? periodRotation.week2 : periodRotation.week1)
                : periodRotation.simple;
            
            const periods = pattern[day] || [1, 2, 3, 4];
            return periods[blockIdx] || (blockIdx + 1);
        }
        
        function loadRosterForPeriod(period) {
            // Open file picker to load a roster JSON for this period
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = JSON.parse(evt.target.result);
                        // Save roster reference
                        const className = document.querySelector(`.class-assignment[data-period="${period}"] .class-name-input`).value || `Period ${period}`;
                        classAssignments[period] = {
                            name: className,
                            roster: data.students || data
                        };
                        localStorage.setItem('hallpass_classAssignments', JSON.stringify(classAssignments));
                        showToast(`Loaded roster for ${className}`);
                    } catch (err) {
                        showToast('Error loading roster file');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function loadPreset(preset) {
            const period = parseInt(document.getElementById('schedPeriod').value);
            const times = presets[preset][period];
            if (times) {
                document.getElementById('schedStart').value = times.start;
                document.getElementById('schedEnd').value = times.end;
                document.getElementById('schedType').value = preset;
                updateSchedulePreview();
                showToast('Loaded ' + preset + ' preset');
                showSchedTab('today');
            }
        }
        
        function createCustomPreset() {
            const name = prompt('Enter preset name:');
            if (!name) return;
            // Would open a full preset editor - for now just show a message
            showToast('Custom preset editor coming soon!');
        }
        
        function saveSchedule() {
            // Save today's settings
            schedule.period = parseInt(document.getElementById('schedPeriod').value);
            schedule.startTime = document.getElementById('schedStart').value;
            schedule.endTime = document.getElementById('schedEnd').value;
            schedule.scheduleType = document.getElementById('schedType').value;
            
            localStorage.setItem('hallpass_schedule', JSON.stringify(schedule));
            
            // Save weekly pattern
            weeklyPattern.type = document.getElementById('weekPatternType').value;
            document.querySelectorAll('.day-sched').forEach(sel => {
                const day = sel.dataset.day;
                weeklyPattern.simple[day] = sel.value;
            });
            const weekSelect = document.getElementById('currentWeekNum');
            if (weekSelect) weeklyPattern.currentWeek = parseInt(weekSelect.value);
            localStorage.setItem('hallpass_weeklyPattern', JSON.stringify(weeklyPattern));
            
            // Class assignments are already saved live via assignClassToPeriod()
            // Just ensure they're persisted
            localStorage.setItem('hallpass_classAssignments', JSON.stringify(classAssignments));
            
            // Clear manual override so auto-detect can work with new assignments
            manualPeriodOverride = false;
            
            updateDateDisplay();
            updateStatusBar();
            closeSchedule();
            showToast('Schedule saved!');
        }
        
        function getTodayScheduleType() {
            const now = new Date();
            const dayIndex = now.getDay(); // 0=Sun, 1=Mon, etc.
            const dayKeys = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const dayKey = dayKeys[dayIndex];
            
            if (weeklyPattern.type === 'simple') {
                return weeklyPattern.simple[dayKey] || 'regular';
            } else if (weeklyPattern.type === 'biweekly') {
                const pattern = weeklyPattern.currentWeek === 1 ? weeklyPattern.week1 : weeklyPattern.week2;
                return pattern[dayKey] || 'regular';
            }
            return 'regular';
        }
        
        function updateDateDisplay() {
            const now = new Date();
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            const dayEl = document.getElementById('dateDay');
            const fullEl = document.getElementById('dateFull');
            const typeEl = document.getElementById('scheduleType');
            const classNameEl = document.getElementById('className');
            
            if (dayEl) dayEl.textContent = dayNames[now.getDay()];
            if (fullEl) fullEl.textContent = `${monthNames[now.getMonth()]} ${now.getDate()}`;
            
            // Get schedule type for today
            const todayType = getTodayScheduleType();
            if (typeEl) {
                typeEl.textContent = todayType === 'regular' ? 'Regular' : 
                                    todayType === 'amfit' ? 'AM FIT' : 
                                    todayType === 'pmfit' ? 'PM FIT' : 
                                    todayType === 'noschool' ? 'No School' : todayType;
                typeEl.className = 'schedule-type ' + todayType;
            }
            
            // Show class name for current period
            const className = classAssignments[schedule.period]?.name;
            if (classNameEl) {
                classNameEl.textContent = className || '';
            }
            
            // Auto-apply schedule type if not manually overridden today
            if (presets[todayType] && presets[todayType][schedule.period]) {
                // Only auto-apply if schedule hasn't been manually set today
                const lastSaved = localStorage.getItem('hallpass_schedule_date');
                const today = getToday();
                if (lastSaved !== today) {
                    schedule.scheduleType = todayType;
                    schedule.startTime = presets[todayType][schedule.period].start;
                    schedule.endTime = presets[todayType][schedule.period].end;
                    localStorage.setItem('hallpass_schedule', JSON.stringify(schedule));
                    localStorage.setItem('hallpass_schedule_date', today);
                }
            }
        }
        
        // ========== COUNTDOWN & STATUS ==========
        let lastAutoSwitchPeriod = null;
        
        function updateStatusBar() {
            // Update date display
            updateDateDisplay();
            
            // Auto-detect period and switch class
            autoDetectPeriodAndClass();
            
            const now = new Date();
            const start = parseTime(schedule.startTime);
            const end = parseTime(schedule.endTime);
            
            const periodBadge = document.getElementById('periodBadge');
            const countdown = document.getElementById('countdown');
            const classStatus = document.getElementById('classStatus');
            
            // Show period and time range
            const startFormatted = formatTime(start);
            const endFormatted = formatTime(end);
            const periodSelect = document.getElementById('periodSelect');
            if (periodSelect) {
                periodSelect.value = schedule.period;
                periodSelect.title = `${startFormatted} - ${endFormatted}`;
            }
            
            // Show/hide manual mode indicator
            const autoModeBtn = document.getElementById('autoModeBtn');
            if (autoModeBtn) {
                autoModeBtn.style.display = manualPeriodOverride ? 'inline-block' : 'none';
            }
            
            if (now < start) {
                // Pre-class
                const diff = start - now;
                const mins = Math.floor(diff / 60000);
                const secs = Math.floor((diff % 60000) / 1000);
                countdown.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                countdown.className = 'countdown pre-class';
                classStatus.textContent = `Class starts in ${mins} minute${mins !== 1 ? 's' : ''}`;
            } else if (now < end) {
                // In class
                const diff = end - now;
                const mins = Math.floor(diff / 60000);
                countdown.textContent = `${mins}m left`;
                countdown.className = mins <= 10 ? 'countdown ending-soon' : 'countdown in-class';
                classStatus.textContent = 'Class in session';
            } else {
                // After class
                countdown.textContent = 'Done';
                countdown.className = 'countdown';
                classStatus.textContent = 'Class ended';
                
                // Auto-mark absent after class ends (configurable)
                const minutesAfterEnd = Math.floor((now - end) / 60000);
                const autoAbsentMins = appSettings.autoAbsentMinutes || 5;
                if (minutesAfterEnd >= autoAbsentMins) {
                    autoMarkAbsent();
                }
            }
            
            // Update stats
            updateStats();
        }
        
        // Track which period we've auto-marked absent for today
        let lastAutoAbsentKey = null;
        
        // Track manual period override (prevents auto-detect from reverting)
        let manualPeriodOverride = false;
        
        function autoMarkAbsent() {
            const today = getToday();
            const key = `${today}-${schedule.period}`;
            
            // Only run once per period per day
            if (lastAutoAbsentKey === key) return;
            
            let markedCount = 0;
            students.forEach(s => {
                // If not checked in (not ontime, late, or excused)
                if (!s.status || s.status === 'unchecked') {
                    s.status = 'absent';
                    s.statusText = 'Absent';
                    
                    // Save to attendance history
                    if (!attendanceHistory[today]) {
                        attendanceHistory[today] = {};
                    }
                    attendanceHistory[today][s.id] = {
                        status: 'absent',
                        time: new Date().toISOString(),
                        period: schedule.period,
                        auto: true // Mark as auto-recorded
                    };
                    
                    markedCount++;
                }
            });
            
            if (markedCount > 0) {
                lastAutoAbsentKey = key;
                localStorage.setItem('hallpass_attendance', JSON.stringify(attendanceHistory));
                saveClass();
                renderCanvas();
                showToast(`Auto-marked ${markedCount} absent (class ended)`);
            } else {
                lastAutoAbsentKey = key; // Still mark as done even if no one absent
            }
        }
        
        function autoDetectPeriodAndClass() {
            const now = new Date();
            const dayKey = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][now.getDay()];
            
            // Skip weekends
            if (dayKey === 'sun' || dayKey === 'sat') return;
            
            // Get today's schedule type
            const schedType = getTodayScheduleType();
            const dayPreset = presets[schedType] || presets.regular;
            
            // Find which time block we're in (block index 0, 1, 2, 3)
            let currentBlockIndex = null;
            for (let blockIdx = 0; blockIdx < 4; blockIdx++) {
                const p = blockIdx + 1;
                const periodTimes = dayPreset[p];
                const periodStart = parseTime(periodTimes.start);
                const periodEnd = parseTime(periodTimes.end);
                
                // Include 15 min before class starts
                const prePeriodStart = new Date(periodStart.getTime() - 15 * 60000);
                
                if (now >= prePeriodStart && now <= periodEnd) {
                    currentBlockIndex = blockIdx;
                    break;
                }
            }
            
            if (currentBlockIndex === null) return;
            
            // Use rotation to get the actual period for this block today
            let currentPeriod = getPeriodForBlock(dayKey, currentBlockIndex);
            
            // Only auto-update period if user hasn't manually overridden
            // Times come from the BLOCK position (1-indexed), not the rotated period
            const blockPosition = currentBlockIndex + 1;
            const times = dayPreset[blockPosition];
            if (times && schedule.period !== currentPeriod && !manualPeriodOverride) {
                schedule.period = currentPeriod;
                schedule.startTime = times.start;
                schedule.endTime = times.end;
                const periodSelect = document.getElementById('periodSelect');
                if (periodSelect) periodSelect.value = currentPeriod;
                document.getElementById('schedPeriod').value = currentPeriod;
                document.getElementById('schedStart').value = times.start;
                document.getElementById('schedEnd').value = times.end;
            }
            
            // Check if we should auto-switch class based on period
            // SKIP if user has manually overridden the period!
            if (manualPeriodOverride) return;
            
            if (lastAutoSwitchPeriod === currentPeriod) return; // Already switched
            
            const assignment = classAssignments[currentPeriod];
            if (assignment && assignment.classId && allClasses[assignment.classId]) {
                // Use the exact classId from assignment
                if (assignment.classId !== currentClassId) {
                    switchClass(assignment.classId);
                    lastAutoSwitchPeriod = currentPeriod;
                    showToast(`Auto-switched to ${allClasses[assignment.classId].classData?.settings?.className || assignment.classId}`);
                }
            } else if (!assignment || !assignment.classId) {
                // No class for this period - show prep state
                lastAutoSwitchPeriod = currentPeriod;
                showPrepPeriod(currentPeriod);
            }
            
            updateRemoveButtonVisibility();
        }
        
        // Manually set period from dropdown
        function manuallySetPeriod(period) {
            period = parseInt(period);
            if (period < 1 || period > 4) return;
            
            // Set manual override to prevent auto-detect from reverting
            manualPeriodOverride = true;
            
            schedule.period = period;
            
            // Get times from current schedule type
            const schedType = getTodayScheduleType();
            const preset = presets[schedType] || presets.regular;
            const times = preset[period];
            
            if (times) {
                schedule.startTime = times.start;
                schedule.endTime = times.end;
            }
            
            // Check if we should switch class
            const assignment = classAssignments[period];
            let switched = false;
            
            // Only show prep if explicitly no class assigned (empty classId)
            if (!assignment || !assignment.classId) {
                // Explicitly set to None/Prep - show prep state
                showPrepPeriod(period);
                showToast(`Switched to Period ${period} - Prep`);
                switched = true;
            } else if (allClasses[assignment.classId]) {
                // Period has an assigned class that exists - switch to it
                switchClass(assignment.classId);
                showToast(`Switched to Period ${period} (manual)`);
                switched = true;
            } else {
                // Class assigned but classId not found in allClasses
                // Try to find the class by name instead
                const classIdByName = Object.keys(allClasses).find(id => {
                    const cls = allClasses[id];
                    return cls.classData?.settings?.className === assignment.name;
                });
                
                if (classIdByName) {
                    // Found by name - switch and fix the assignment
                    switchClass(classIdByName);
                    classAssignments[period].classId = classIdByName;
                    localStorage.setItem('hallpass_classAssignments', JSON.stringify(classAssignments));
                    showToast(`Switched to Period ${period} (manual)`);
                    switched = true;
                } else {
                    showToast(`‚ö†Ô∏è Period ${period}: "${assignment.name}" not loaded. Import class in Settings.`);
                }
            }
            
            // If we didn't switch to anything (class not found), render current state
            // But DON'T render if we showed prep (that would overwrite it)
            if (!switched && students.length > 0) {
                renderCanvas();
            }
            
            // Reset auto-switch tracker so it doesn't fight us
            lastAutoSwitchPeriod = period;
            
            localStorage.setItem('hallpass_schedule', JSON.stringify(schedule));
            updateStatusBar();
            updateRemoveButtonVisibility();
        }
        
        // Clear manual override (call when you want auto-detect to resume)
        function clearPeriodOverride() {
            manualPeriodOverride = false;
            showToast('Auto-detect resumed');
        }
        
        // Show warning when period has no class assigned
        function showPeriodWarning(period) {
            // Check if we have a current class loaded
            if (currentClassId && allClasses[currentClassId]) {
                const className = allClasses[currentClassId].classData?.settings?.className || currentClassId;
                const assign = confirm(
                    `Period ${period} has no class assigned.\n\n` +
                    `Currently showing: ${className}\n\n` +
                    `Would you like to assign ${className} to Period ${period}?`
                );
                
                if (assign) {
                    assignClassToPeriod(period, currentClassId);
                    showToast(`${className} assigned to Period ${period}`);
                }
            } else {
                showToast(`Period ${period}: No class assigned (Prep period)`);
            }
        }
        
        // Quick assign current class to current period
        function assignCurrentClassToPeriod() {
            if (!currentClassId || !allClasses[currentClassId]) {
                showToast('No class loaded to assign');
                return;
            }
            
            const className = allClasses[currentClassId].classData?.settings?.className || currentClassId;
            assignClassToPeriod(schedule.period, currentClassId);
            showToast(`${className} ‚Üí Period ${schedule.period}`);
        }
        
        // Remove class from current period (set to prep)
        function removeClassFromPeriod() {
            const period = schedule.period;
            const currentAssignment = classAssignments[period];
            const className = currentAssignment?.name || 'current class';
            
            if (!confirm(`Remove ${className} from Period ${period}?\n\nThis will make Period ${period} a prep period.`)) {
                return;
            }
            
            // Clear the assignment (but keep class data in allClasses for other periods)
            classAssignments[period] = { name: '', classId: null };
            localStorage.setItem('hallpass_classAssignments', JSON.stringify(classAssignments));
            
            // Show prep period state (doesn't clear loaded class)
            showPrepPeriod(period);
            updateRemoveButtonVisibility();
            showToast(`Period ${period} is now a prep period`);
        }
        
        // Show prep period (no class) state
        // Note: This does NOT clear the loaded class data - just shows prep UI for this period
        function showPrepPeriod(period) {
            // Update class name in header to show prep
            const classNameEl = document.getElementById('className');
            if (classNameEl) {
                classNameEl.textContent = '‚Äî Prep ‚Äî';
                classNameEl.style.color = 'var(--text-secondary)';
            }
            
            // Hide remove button, since no class to remove
            const removeBtn = document.getElementById('removeClassBtn');
            if (removeBtn) removeBtn.style.display = 'none';
            
            // Show prep message on canvas (don't clear students array - just show overlay)
            const canvas = document.getElementById('seatingCanvas');
            if (canvas) {
                canvas.innerHTML = `
                    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text-secondary);gap:16px;">
                        <div style="font-size:4rem;">üìö</div>
                        <div style="font-size:1.5rem;font-weight:600;">Period ${period} - Prep Time</div>
                        <div style="font-size:0.9rem;">No class assigned to this period</div>
                        <button class="btn btn-primary" onclick="openSchedule()" style="margin-top:16px;">
                            ‚öôÔ∏è Assign a Class
                        </button>
                    </div>
                `;
            }
            
            updateStats();
            updateStatusBar();
        }
        
        // Update remove button visibility based on current period assignment
        function updateRemoveButtonVisibility() {
            const removeBtn = document.getElementById('removeClassBtn');
            if (!removeBtn) return;
            
            const assignment = classAssignments[schedule.period];
            if (assignment && assignment.classId) {
                removeBtn.style.display = 'inline-flex';
            } else {
                removeBtn.style.display = 'none';
            }
        }
        
        function getTodayScheduleType() {
            const now = new Date();
            const dayKey = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][now.getDay()];
            
            if (weeklyPattern.type === 'simple') {
                return weeklyPattern.simple[dayKey] || 'regular';
            } else if (weeklyPattern.type === 'biweekly') {
                const pattern = weeklyPattern.currentWeek === 1 ? weeklyPattern.simple : (weeklyPattern.week2 || weeklyPattern.simple);
                return pattern[dayKey] || 'regular';
            }
            return 'regular';
        }
        
        function updateStats() {
            let ontime = 0, late = 0, absent = 0;
            students.forEach(s => {
                if (s.status === 'ontime') ontime++;
                else if (s.status === 'late') late++;
                else if (s.status !== 'excused' && s.status !== 'withdrawn') absent++;
            });
            
            document.getElementById('statOntime').textContent = ontime;
            document.getElementById('statLate').textContent = late;
            document.getElementById('statAbsent').textContent = absent;
        }
        
        // ========== CHECK-IN LOGIC ==========
        function handleStudentClick(event, studentId) {
            if (editMode) return;
            
            // Right-click opens context menu
            if (event.button === 2) {
                openContextMenu(event, studentId);
                return;
            }
            
            // Left-click: toggle check-in
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // If already checked in, do nothing (use right-click to change)
            if (student.status === 'ontime' || student.status === 'late') {
                showToast('Right-click to change status');
                return;
            }
            
            // Check in
            checkInStudent(student);
        }
        
        function checkInStudent(student) {
            const now = new Date();
            const start = parseTime(schedule.startTime);
            
            // Add bell offset (if bell is running late/early)
            const bellOffsetMs = (appSettings.bellOffsetSeconds || 0) * 1000;
            const adjustedStart = new Date(start.getTime() + bellOffsetMs);
            
            // Add grace period on top of adjusted start
            const graceMs = (appSettings.graceSeconds || 45) * 1000;
            const graceEnd = new Date(adjustedStart.getTime() + graceMs);
            
            // Determine on-time vs late (bell offset + grace period)
            const isLate = now > graceEnd;
            student.status = isLate ? 'late' : 'ontime';
            student.checkInTime = now.toISOString();
            
            if (isLate) {
                // Calculate late from adjusted start (not grace end)
                const lateBy = Math.floor((now - adjustedStart) / 60000);
                student.lateBy = lateBy;
                student.statusText = `Late by ${lateBy}m`;
            } else {
                student.lateBy = 0;
                student.statusText = ontimeMessages[Math.floor(Math.random() * ontimeMessages.length)];
            }
            
            // Update streak
            updateStreak(student, isLate);
            
            // Save to today's attendance
            saveAttendance(student);
            
            // Show fun effects
            if (!isLate) {
                const streak = streaks[student.id]?.current || 0;
                if (streakMessages[streak]) {
                    showToast(streakMessages[streak]);
                    spawnConfetti();
                } else {
                    showToast(student.statusText);
                }
            } else {
                // Check for improvement
                const yesterday = getYesterdayAttendance(student.id);
                if (yesterday?.lateBy && student.lateBy < yesterday.lateBy) {
                    const improvement = yesterday.lateBy - student.lateBy;
                    student.statusText += ` (${improvement}m better than yesterday!)`;
                    showToast(improvementMessages[Math.floor(Math.random() * improvementMessages.length)]);
                } else {
                    showToast(`Late by ${student.lateBy} minutes`);
                }
            }
            
            renderCanvas();
            updateStats();
            saveClass();
        }
        
        function updateStreak(student, isLate) {
            const today = getToday();
            if (!streaks[student.id]) {
                streaks[student.id] = { current: 0, best: 0, lastDate: null, broken: false };
            }
            
            const streak = streaks[student.id];
            
            if (!isLate) {
                // Clear broken flag on on-time arrival
                streak.broken = false;
                
                // Check if continuing streak (was yesterday)
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                
                if (streak.lastDate === yesterdayStr || streak.lastDate === today) {
                    if (streak.lastDate !== today) {
                        streak.current++;
                    }
                } else {
                    streak.current = 1;
                }
                
                streak.best = Math.max(streak.best, streak.current);
                streak.lastDate = today;
            } else {
                // Late breaks streak - flag if they had a good streak going
                if (streak.current >= 3) {
                    streak.broken = true;
                    streak.brokenFrom = streak.current;
                }
                streak.current = 0;
            }
            
            localStorage.setItem('hallpass_streaks', JSON.stringify(streaks));
        }
        
        function getYesterdayAttendance(studentId) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const dateStr = yesterday.toISOString().split('T')[0];
            return attendanceHistory[dateStr]?.[studentId];
        }
        
        function saveAttendance(student) {
            const today = getToday();
            if (!attendanceHistory[today]) {
                attendanceHistory[today] = {};
            }
            
            attendanceHistory[today][student.id] = {
                status: student.status,
                time: student.checkInTime,
                lateBy: student.lateBy || 0,
                note: student.note || ''
            };
            
            localStorage.setItem('hallpass_attendance', JSON.stringify(attendanceHistory));
        }
        
        // ========== CONTEXT MENU ==========
        function openContextMenu(event, studentId) {
            event.preventDefault();
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            contextStudentId = studentId;
            
            const menu = document.getElementById('contextMenu');
            const name = student.displayName || `${student.firstName} ${student.lastInitial}.`;
            document.getElementById('contextMenuHeader').textContent = name;
            document.getElementById('contextMenuNote').value = student.note || '';
            
            // Update hall pass option based on student's pass status
            updateHallPassContextMenu();
            
            // Smart positioning - keep menu on screen
            positionContextMenu(menu, event.clientX, event.clientY);
            menu.classList.add('open');
        }
        
        function positionContextMenu(menu, x, y) {
            // Temporarily show to get dimensions
            menu.style.visibility = 'hidden';
            menu.style.display = 'block';
            const menuRect = menu.getBoundingClientRect();
            menu.style.display = '';
            menu.style.visibility = '';
            
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            // Adjust X if menu would go off right edge
            if (x + menuRect.width > viewportWidth - 10) {
                x = viewportWidth - menuRect.width - 10;
            }
            
            // Adjust Y if menu would go off bottom edge
            if (y + menuRect.height > viewportHeight - 10) {
                y = viewportHeight - menuRect.height - 10;
            }
            
            // Ensure minimum values
            x = Math.max(10, x);
            y = Math.max(10, y);
            
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
        }
        
        function closeContextMenu() {
            document.getElementById('contextMenu').classList.remove('open');
            contextStudentId = null;
        }
        
        function setStatus(status) {
            if (!contextStudentId) return;
            const student = students.find(s => s.id === contextStudentId);
            if (!student) return;
            
            student.status = status;
            student.checkInTime = new Date().toISOString();
            
            if (status === 'late' && !student.lateBy) {
                const now = new Date();
                const start = parseTime(schedule.startTime);
                student.lateBy = Math.max(0, Math.floor((now - start) / 60000));
            }
            
            // Log correction
            logCorrection(student, status);
            saveAttendance(student);
            renderCanvas();
            updateStats();
            closeContextMenu();
            showToast(`Marked ${student.firstName} as ${status}`);
            saveClass();
        }
        
        function clearStatus() {
            if (!contextStudentId) return;
            const student = students.find(s => s.id === contextStudentId);
            if (!student) return;
            
            student.status = 'unchecked';
            student.checkInTime = null;
            student.lateBy = null;
            student.statusText = null;
            
            saveAttendance(student);
            renderCanvas();
            updateStats();
            closeContextMenu();
            showToast(`Cleared status for ${student.firstName}`);
            saveClass();
        }
        
        function saveNote() {
            if (!contextStudentId) return;
            const student = students.find(s => s.id === contextStudentId);
            if (!student) return;
            
            student.note = document.getElementById('contextMenuNote').value;
            saveAttendance(student);
            closeContextMenu();
            showToast('Note saved');
            saveClass();
        }
        
        function logCorrection(student, newStatus) {
            const corrections = JSON.parse(localStorage.getItem('hallpass_corrections') || '[]');
            corrections.push({
                date: getToday(),
                time: new Date().toISOString(),
                studentId: student.id,
                studentName: student.firstName + ' ' + student.lastInitial,
                newStatus,
                note: student.note || ''
            });
            localStorage.setItem('hallpass_corrections', JSON.stringify(corrections));
        }
        
        function viewStudentHistory() {
            if (!contextStudentId) return;
            closeContextMenu();
            showStudentHistoryModal(contextStudentId);
        }
        
        // ========== STUDENT HISTORY MODAL ==========
        function showStudentHistoryModal(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const name = student.displayName || `${student.firstName} ${student.lastInitial}.`;
            document.getElementById('studentHistoryTitle').textContent = `üìä ${name}'s History`;
            
            const streak = streaks[studentId] || { current: 0, best: 0 };
            
            // Get last 14 days of attendance
            const days = [];
            for (let i = 0; i < 14; i++) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                const record = attendanceHistory[dateStr]?.[studentId];
                if (record) {
                    days.push({ date: dateStr, ...record });
                }
            }
            
            // Calculate stats
            const ontimeCount = days.filter(d => d.status === 'ontime').length;
            const lateCount = days.filter(d => d.status === 'late').length;
            const absentCount = days.filter(d => d.status === 'absent').length;
            const avgLateBy = days.filter(d => d.lateBy > 0).length > 0
                ? Math.round(days.filter(d => d.lateBy > 0).reduce((a, d) => a + d.lateBy, 0) / days.filter(d => d.lateBy > 0).length)
                : 0;
            
            let html = `
                <div class="summary-grid" style="margin-bottom:24px;">
                    <div class="summary-stat ontime">
                        <span class="summary-label">Current Streak</span>
                        <span class="summary-value">${streak.current} ${streak.current >= 5 ? 'üî•' : ''}</span>
                    </div>
                    <div class="summary-stat" style="border-left:4px solid var(--accent);">
                        <span class="summary-label">Best Streak</span>
                        <span class="summary-value">${streak.best}</span>
                    </div>
                </div>
                
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px;">
                    <div style="text-align:center;">
                        <div style="font-size:1.5rem;font-weight:700;color:var(--success);">${ontimeCount}</div>
                        <div style="font-size:0.8rem;color:var(--text-secondary);">On Time</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:1.5rem;font-weight:700;color:var(--warning);">${lateCount}</div>
                        <div style="font-size:0.8rem;color:var(--text-secondary);">Late</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:1.5rem;font-weight:700;color:var(--danger);">${absentCount}</div>
                        <div style="font-size:0.8rem;color:var(--text-secondary);">Absent</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:1.5rem;font-weight:700;color:var(--warning);">${avgLateBy}m</div>
                        <div style="font-size:0.8rem;color:var(--text-secondary);">Avg Late</div>
                    </div>
                </div>
                
                <h3 style="margin-bottom:12px;">Recent Days</h3>
                <div class="history-panel" style="margin-top:0;">
            `;
            
            if (days.length === 0) {
                html += '<p style="color:var(--text-secondary);">No attendance records yet.</p>';
            } else {
                days.slice(0, 10).forEach(d => {
                    const dateObj = new Date(d.date + 'T12:00:00');
                    const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    const lateText = d.lateBy > 0 ? ` (+${d.lateBy}m)` : '';
                    html += `
                        <div class="history-row">
                            <span>${dateStr}</span>
                            <span class="history-status ${d.status}">${d.status}${lateText}</span>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            
            document.getElementById('studentHistoryContent').innerHTML = html;
            document.getElementById('studentHistoryModal').classList.add('open');
        }
        
        function closeStudentHistory() {
            document.getElementById('studentHistoryModal').classList.remove('open');
        }
        
        // ========== CLOSE ATTENDANCE ==========
        function closeAttendance() {
            const now = new Date();
            const end = parseTime(schedule.endTime);
            
            // Mark remaining as absent
            students.forEach(s => {
                if (!s.status || s.status === 'unchecked') {
                    s.status = 'absent';
                    s.checkInTime = now.toISOString();
                    saveAttendance(s);
                }
            });
            
            // Show summary
            showSummary();
            saveClass();
        }
        
        function showSummary() {
            const today = getToday();
            const ontime = students.filter(s => s.status === 'ontime');
            const late = students.filter(s => s.status === 'late');
            const absent = students.filter(s => s.status === 'absent');
            const excused = students.filter(s => s.status === 'excused');
            
            const className = classData?.settings?.className || 'Class';
            const dateStr = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            
            let html = `
                <div style="text-align:center;margin-bottom:24px;">
                    <h3>${className}</h3>
                    <p style="color:var(--text-secondary);">${dateStr} ‚Ä¢ Period ${schedule.period}</p>
                </div>
                
                <div class="summary-grid">
                    <div class="summary-stat ontime">
                        <div>
                            <span class="summary-label">‚úÖ On Time</span>
                            <div class="summary-names">${ontime.map(s => s.firstName).join(', ') || 'None'}</div>
                        </div>
                        <span class="summary-value">${ontime.length}</span>
                    </div>
                    <div class="summary-stat late">
                        <div>
                            <span class="summary-label">‚ö†Ô∏è Late</span>
                            <div class="summary-names">${late.map(s => s.firstName + (s.lateBy ? ` +${s.lateBy}m` : '')).join(', ') || 'None'}</div>
                        </div>
                        <span class="summary-value">${late.length}</span>
                    </div>
                    <div class="summary-stat absent">
                        <div>
                            <span class="summary-label">‚ùå Absent</span>
                            <div class="summary-names">${absent.map(s => s.firstName).join(', ') || 'None'}</div>
                        </div>
                        <span class="summary-value">${absent.length}</span>
                    </div>
            `;
            
            if (excused.length > 0) {
                html += `
                    <div class="summary-stat excused">
                        <div>
                            <span class="summary-label">üìù Excused</span>
                            <div class="summary-names">${excused.map(s => s.firstName).join(', ')}</div>
                        </div>
                        <span class="summary-value">${excused.length}</span>
                    </div>
                `;
            }
            
            html += `
                </div>
                <div style="margin-top:24px;text-align:center;">
                    <button class="btn btn-primary" onclick="closeSummary()">Done</button>
                </div>
            `;
            
            document.getElementById('summaryContent').innerHTML = html;
            document.getElementById('summaryModal').classList.add('open');
        }
        
        function closeSummary() {
            document.getElementById('summaryModal').classList.remove('open');
        }
        
        // ========== BULK ACTIONS ==========
        function markAllPresent() {
            const count = students.filter(s => s.status !== 'ontime').length;
            if (count === 0) {
                showToast('All students already marked present');
                return;
            }
            
            if (!confirm(`Mark all ${students.length} students as present/on-time?`)) return;
            
            const now = new Date();
            const today = getToday();
            
            students.forEach(s => {
                s.status = 'ontime';
                s.checkInTime = now.toISOString();
                s.statusText = 'On time';
                s.lateBy = null;
                
                // Save to attendance history
                if (!attendanceHistory[today]) {
                    attendanceHistory[today] = {};
                }
                attendanceHistory[today][s.id] = {
                    status: 'ontime',
                    time: now.toISOString(),
                    period: schedule.period,
                    bulk: true // Mark as bulk action
                };
            });
            
            renderCanvas();
            updateStats();
            saveClass();
            showToast(`‚úì Marked ${students.length} students present`);
        }
        
        function markSelectedStatus(status) {
            if (selectedStudents.size === 0) {
                showToast('No students selected. Ctrl+click to select.');
                return;
            }
            
            const now = new Date();
            const today = getToday();
            const statusText = status === 'ontime' ? 'On time' : status === 'late' ? 'Late' : status === 'absent' ? 'Absent' : status === 'excused' ? 'Excused' : status;
            
            selectedStudents.forEach(studentId => {
                const student = students.find(s => s.id === studentId);
                if (student) {
                    student.status = status;
                    student.checkInTime = status !== 'absent' ? now.toISOString() : null;
                    student.statusText = statusText;
                    
                    if (!attendanceHistory[today]) {
                        attendanceHistory[today] = {};
                    }
                    attendanceHistory[today][student.id] = {
                        status: status,
                        time: now.toISOString(),
                        period: schedule.period,
                        bulk: true
                    };
                }
            });
            
            const count = selectedStudents.size;
            clearStudentSelection();
            renderCanvas();
            updateStats();
            saveClass();
            updateBulkActionButton();
            showToast(`‚úì Marked ${count} students as ${statusText}`);
        }
        
        function showBulkActionMenu() {
            // Create popup menu for bulk actions
            const btn = document.getElementById('bulkActionBtn');
            const rect = btn.getBoundingClientRect();
            
            // Remove existing menu
            const existing = document.getElementById('bulkActionMenu');
            if (existing) existing.remove();
            
            const menu = document.createElement('div');
            menu.id = 'bulkActionMenu';
            menu.className = 'context-menu';
            menu.style.cssText = `position:fixed;top:${rect.bottom + 5}px;left:${rect.left}px;z-index:1000;`;
            menu.innerHTML = `
                <div class="context-menu-item" onclick="markSelectedStatus('ontime');closeBulkMenu();">‚úì Mark Present</div>
                <div class="context-menu-item" onclick="markSelectedStatus('late');closeBulkMenu();">‚è∞ Mark Late</div>
                <div class="context-menu-item" onclick="markSelectedStatus('excused');closeBulkMenu();">üìù Mark Excused</div>
                <div class="context-menu-item" onclick="markSelectedStatus('absent');closeBulkMenu();">‚úï Mark Absent</div>
                <div class="context-menu-divider"></div>
                <div class="context-menu-item" onclick="clearStudentSelection();updateBulkActionButton();closeBulkMenu();">Clear Selection</div>
            `;
            document.body.appendChild(menu);
            
            // Close on click outside
            setTimeout(() => {
                document.addEventListener('click', closeBulkMenuOnClick);
            }, 10);
        }
        
        function closeBulkMenu() {
            const menu = document.getElementById('bulkActionMenu');
            if (menu) menu.remove();
            document.removeEventListener('click', closeBulkMenuOnClick);
        }
        
        function closeBulkMenuOnClick(e) {
            if (!e.target.closest('#bulkActionMenu') && !e.target.closest('#bulkActionBtn')) {
                closeBulkMenu();
            }
        }
        
        function updateBulkActionButton() {
            const btn = document.getElementById('bulkActionBtn');
            const countEl = document.getElementById('selectedCount');
            if (btn && countEl) {
                countEl.textContent = selectedStudents.size;
                btn.style.display = selectedStudents.size > 0 ? 'inline-flex' : 'none';
            }
        }
        
        // ========== RESET DAY ==========
        function resetAttendance() {
            if (!confirm('Reset attendance for all students today?')) return;
            
            students.forEach(s => {
                s.status = 'unchecked';
                s.checkInTime = null;
                s.lateBy = null;
                s.statusText = null;
            });
            
            // Clear today's attendance
            const today = getToday();
            delete attendanceHistory[today];
            localStorage.setItem('hallpass_attendance', JSON.stringify(attendanceHistory));
            
            renderCanvas();
            updateStats();
            saveClass();
            showToast('Attendance reset');
        }
        
        // ========== RENDERING ==========
        function renderCanvas() {
            const canvas = document.getElementById('seatingCanvas');
            if (!canvas) return;
            
            if (students.length === 0) {
                canvas.innerHTML = `
                    <div style="text-align:center;padding:60px;color:var(--text-secondary);">
                        <div style="font-size:3rem;margin-bottom:16px;">üì•</div>
                        <h3>No class loaded</h3>
                        <p>Click ‚öôÔ∏è Settings to import a class</p>
                    </div>
                `;
                return;
            }
            
            const cardWidth = 100;
            const cardHeight = 130;
            const padding = 20;
            const gap = 15;
            
            // Calculate optimal grid for students without positions
            const studentCount = students.length;
            let cols = Math.min(10, Math.max(4, Math.ceil(Math.sqrt(studentCount * 1.5))));
            let rows = Math.ceil(studentCount / cols);
            
            // Migrate positions for students without positions
            students.forEach((s, idx) => {
                if (!s.position || s.position.x === undefined) {
                    s.position = {
                        x: padding + (idx % cols) * (cardWidth + gap),
                        y: padding + Math.floor(idx / cols) * (cardHeight + gap)
                    };
                }
            });
            
            // Calculate canvas size based on ACTUAL student positions (not just grid)
            let maxX = 0, maxY = 0;
            students.forEach(s => {
                if (s.position) {
                    maxX = Math.max(maxX, s.position.x + cardWidth);
                    maxY = Math.max(maxY, s.position.y + cardHeight);
                }
            });
            
            // Ensure minimum size and add padding
            const seatingEl = document.getElementById('seatingCanvas');
            const neededWidth = Math.max(maxX + padding, padding * 2 + cols * (cardWidth + gap));
            const neededHeight = Math.max(maxY + padding, padding * 2 + rows * (cardHeight + gap));
            seatingEl.style.minWidth = neededWidth + 'px';
            seatingEl.style.minHeight = neededHeight + 'px';
            
            let html = '';
            students.forEach(s => {
                const imgSrc = getStudentImage(s);
                const name = s.displayName || `${s.firstName} ${s.lastInitial || ''}.`;
                const status = s.status || 'unchecked';
                const streak = streaks[s.id]?.current || 0;
                
                let statusHtml = '';
                if (status === 'ontime') {
                    statusHtml = `<div class="student-status">${s.statusText || '‚úì On time'}</div>`;
                } else if (status === 'late') {
                    statusHtml = `
                        <div class="student-status">‚ö†Ô∏è Late</div>
                        <div class="late-timer">+${s.lateBy || 0}m</div>
                    `;
                } else if (status === 'absent') {
                    statusHtml = `<div class="student-status" style="color:var(--danger);">‚ùå Absent</div>`;
                } else if (status === 'excused') {
                    statusHtml = `<div class="student-status" style="color:var(--excused);">üìù Excused</div>`;
                } else {
                    statusHtml = `<div class="student-status">Tap to check in</div>`;
                }
                
                let streakBadge = '';
                if (streak >= 3) {
                    streakBadge = `<div class="streak-badge${streak >= 5 ? ' fire' : ''}">${streak}</div>`;
                }
                
                html += `
                    <div class="canvas-student ${status}" 
                         data-id="${s.id}"
                         style="left:${s.position.x}px; top:${s.position.y}px;"
                         onclick="handleStudentClick(event, ${s.id})"
                         oncontextmenu="handleStudentClick(event, ${s.id}); return false;"
                         onmousedown="startDrag(event, ${s.id})"
                         ontouchstart="startDrag(event, ${s.id})">
                        ${streakBadge}
                        <img class="student-avatar" src="${imgSrc}" alt="${name}">
                        <div class="student-name">${name}</div>
                        ${statusHtml}
                    </div>
                `;
            });
            
            canvas.innerHTML = html;
        }
        
        function getStudentImage(student) {
            if (student.caricatures?.photo) return student.caricatures.photo;
            if (student.caricature) return student.caricature;
            return `https://api.dicebear.com/7.x/avataaars/svg?seed=${student.firstName}`;
        }
        
        // ========== ALPHABETICAL SORTING ==========
        function sortStudentsAlphabetically(direction) {
            const studentCount = students.length;
            
            // Ask for sort field
            const sortBy = prompt('Sort by:\n1 = First name\n2 = Last name\n\nEnter 1 or 2:', '1');
            if (!sortBy) return;
            
            const byLastName = sortBy.trim() === '2';
            
            // Ask for grid size
            let promptText, defaultVal;
            if (direction === 'horizontal') {
                promptText = `How many students per row?\n(${studentCount} students total)`;
                defaultVal = Math.min(8, Math.ceil(Math.sqrt(studentCount * 1.5)));
            } else {
                promptText = `How many students per column?\n(${studentCount} students total)`;
                defaultVal = Math.min(6, Math.ceil(Math.sqrt(studentCount)));
            }
            
            const input = prompt(promptText, defaultVal);
            if (!input) return;
            
            const perLine = parseInt(input);
            if (isNaN(perLine) || perLine < 1) {
                showToast('Invalid number');
                return;
            }
            
            // Sort students by chosen field
            const sorted = [...students].sort((a, b) => {
                let nameA, nameB;
                if (byLastName) {
                    nameA = ((a.lastInitial || a.lastName || '') + ' ' + a.firstName).toLowerCase();
                    nameB = ((b.lastInitial || b.lastName || '') + ' ' + b.firstName).toLowerCase();
                } else {
                    nameA = (a.firstName + ' ' + (a.lastInitial || '')).toLowerCase();
                    nameB = (b.firstName + ' ' + (b.lastInitial || '')).toLowerCase();
                }
                return nameA.localeCompare(nameB);
            });
            
            const cardWidth = 100;
            const cardHeight = 130;
            const padding = 20;
            const gap = 15;
            
            // Calculate grid dimensions
            let cols, rows;
            if (direction === 'horizontal') {
                cols = perLine;
                rows = Math.ceil(studentCount / cols);
            } else {
                rows = perLine;
                cols = Math.ceil(studentCount / rows);
            }
            
            // Assign positions based on direction
            sorted.forEach((s, idx) => {
                const student = students.find(st => st.id === s.id);
                if (!student) return;
                
                let row, col;
                if (direction === 'horizontal') {
                    // A-Z across rows (left to right, then next row)
                    row = Math.floor(idx / cols);
                    col = idx % cols;
                } else {
                    // A-Z down columns (top to bottom, then next column)
                    col = Math.floor(idx / rows);
                    row = idx % rows;
                }
                
                student.position = {
                    x: padding + col * (cardWidth + gap),
                    y: padding + row * (cardHeight + gap)
                };
            });
            
            renderCanvas();
            saveClass();
            showToast(`Sorted by ${byLastName ? 'last' : 'first'} name: ${cols}√ó${rows}`);
        }
        
        // ========== HALL PASS CANVAS ==========
        function renderHallPassCanvas() {
            const canvas = document.getElementById('hallpassCanvas');
            if (!canvas) return;
            
            if (students.length === 0) {
                canvas.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-secondary);">No students loaded</div>';
                return;
            }
            
            // Calculate bounding box of all students to scale to fit
            const CARD_WIDTH = 100;
            const CARD_HEIGHT = 120;
            const PADDING = 20;
            
            let maxX = 0, maxY = 0;
            students.forEach(s => {
                const pos = s.position || { x: 0, y: 0 };
                maxX = Math.max(maxX, pos.x + CARD_WIDTH);
                maxY = Math.max(maxY, pos.y + CARD_HEIGHT);
            });
            
            // Get container size and calculate scale factor
            const containerWidth = canvas.parentElement?.clientWidth || 800;
            const containerHeight = canvas.parentElement?.clientHeight - 40 || 500; // Account for header
            
            // Calculate scale to fit all students (with some padding)
            const scaleX = (containerWidth - PADDING * 2) / (maxX || 1);
            const scaleY = (containerHeight - PADDING * 2) / (maxY || 1);
            const fitScale = Math.min(scaleX, scaleY, 1); // Don't scale up, only down
            
            // Base scale for hall pass (smaller cards) * fit scale
            const baseScale = 0.85;
            const totalScale = baseScale * fitScale;
            
            let html = '';
            students.forEach(s => {
                const imgSrc = getStudentImage(s);
                const name = s.displayName || `${s.firstName} ${s.lastInitial || ''}.`;
                
                // Check hall pass status
                const isOut = hallPassQueue.some(hp => hp.studentId === s.id && hp.status === 'out');
                const isQueued = hallPassQueue.some(hp => hp.studentId === s.id && hp.status === 'queued');
                
                let statusClass = '';
                let statusText = '';
                if (isOut) {
                    statusClass = 'hp-out';
                    statusText = 'üö∂ Out';
                } else if (isQueued) {
                    statusClass = 'hp-queued';
                    statusText = '‚è≥ Queued';
                }
                
                // Use same position as attendance view, scaled to fit
                const pos = s.position || { x: 0, y: 0 };
                const scaledX = pos.x * fitScale + PADDING;
                const scaledY = pos.y * fitScale + PADDING;
                
                html += `
                    <div class="canvas-student ${statusClass}" 
                         data-id="${s.id}"
                         style="left:${scaledX}px; top:${scaledY}px; transform:scale(${totalScale}); transform-origin:top left;"
                         onclick="openHallPassModal(${s.id})">
                        <img class="student-avatar" src="${imgSrc}" alt="${name}">
                        <div class="student-name">${name}</div>
                        ${statusText ? `<div class="student-status">${statusText}</div>` : '<div class="student-status" style="font-size:0.7rem;">Tap for pass</div>'}
                    </div>
                `;
            });
            
            canvas.innerHTML = html;
            
            // Update hall pass layout selector
            const hpSelect = document.getElementById('hallpassLayoutSelect');
            if (hpSelect) {
                const layoutIds = Object.keys(classLayouts);
                hpSelect.innerHTML = layoutIds.map(id => {
                    const layout = classLayouts[id];
                    return `<option value="${id}" ${id === currentLayoutId ? 'selected' : ''}>${layout.name}</option>`;
                }).join('');
            }
        }
        
        // ========== EDIT MODE ==========
        let dragState = null;
        let selectedStudents = new Set(); // For multi-select
        
        function toggleEditMode() {
            editMode = !editMode;
            const canvas = document.getElementById('seatingCanvas');
            const btn = document.getElementById('editModeBtn');
            
            if (editMode) {
                canvas.classList.add('edit-mode');
                btn.classList.add('active');
                btn.textContent = '‚úì Done';
            } else {
                canvas.classList.remove('edit-mode');
                btn.classList.remove('active');
                btn.textContent = '‚úèÔ∏è Edit';
                selectedStudents.clear();
                saveClass();
                renderCanvas(); // Clear selection highlights
            }
        }
        
        // Toggle student selection (Ctrl+click) - works in edit mode AND normal mode
        function toggleStudentSelection(studentId, event) {
            const canvas = document.getElementById('seatingCanvas');
            const studentEl = canvas.querySelector(`[data-id="${studentId}"]`);
            
            if (selectedStudents.has(studentId)) {
                selectedStudents.delete(studentId);
                studentEl?.classList.remove('selected');
            } else {
                selectedStudents.add(studentId);
                studentEl?.classList.add('selected');
            }
            
            // Update bulk action button
            updateBulkActionButton();
            
            // Show appropriate message
            if (selectedStudents.size > 0) {
                if (editMode) {
                    showToast(`${selectedStudents.size} selected - drag to move together`);
                } else {
                    showToast(`${selectedStudents.size} selected - click "Selected" button for bulk actions`);
                }
            }
        }
        
        // Clear all selections
        function clearStudentSelection() {
            const canvas = document.getElementById('seatingCanvas');
            selectedStudents.forEach(id => {
                const el = canvas.querySelector(`[data-id="${id}"]`);
                el?.classList.remove('selected');
            });
            selectedStudents.clear();
        }
        
        function startDrag(event, studentId) {
            // Handle Ctrl+click for selection (works in ALL modes)
            if (event.ctrlKey || event.metaKey) {
                event.preventDefault();
                toggleStudentSelection(studentId, event);
                return;
            }
            
            // For dragging, must be in edit mode
            if (!editMode) return;
            event.preventDefault();
            
            const canvas = document.getElementById('seatingCanvas');
            const studentEl = canvas.querySelector(`[data-id="${studentId}"]`);
            if (!studentEl) return;
            
            const touch = event.touches ? event.touches[0] : event;
            
            // If clicking on a non-selected student, clear selection and drag just that one
            // If clicking on a selected student, drag all selected
            let studentsToDrag = [];
            if (selectedStudents.has(studentId) && selectedStudents.size > 1) {
                // Drag all selected students
                studentsToDrag = Array.from(selectedStudents);
            } else {
                // Clear selection and drag just this one
                clearStudentSelection();
                studentsToDrag = [studentId];
            }
            
            // Build drag state for all students being dragged
            const elements = studentsToDrag.map(id => {
                const el = canvas.querySelector(`[data-id="${id}"]`);
                return {
                    studentId: id,
                    element: el,
                    origLeft: parseInt(el?.style.left || 0),
                    origTop: parseInt(el?.style.top || 0)
                };
            }).filter(e => e.element);
            
            dragState = {
                studentId, // Primary student
                elements,  // All students being dragged
                startX: touch.clientX,
                startY: touch.clientY
            };
            
            elements.forEach(e => e.element.classList.add('dragging'));
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchmove', onDrag, { passive: false });
            document.addEventListener('touchend', endDrag);
        }
        
        function onDrag(event) {
            if (!dragState) return;
            event.preventDefault();
            
            const touch = event.touches ? event.touches[0] : event;
            const dx = touch.clientX - dragState.startX;
            const dy = touch.clientY - dragState.startY;
            
            // Move all elements being dragged
            dragState.elements.forEach(e => {
                e.element.style.left = (e.origLeft + dx) + 'px';
                e.element.style.top = (e.origTop + dy) + 'px';
            });
        }
        
        function endDrag() {
            if (!dragState) return;
            
            // Update positions for all dragged students
            dragState.elements.forEach(e => {
                const student = students.find(s => s.id === e.studentId);
                if (student) {
                    student.position = {
                        x: parseInt(e.element.style.left),
                        y: parseInt(e.element.style.top)
                    };
                }
                e.element.classList.remove('dragging');
            });
            
            dragState = null;
            
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchmove', onDrag);
            document.removeEventListener('touchend', endDrag);
        }
        
        function zoomCanvas(delta) {
            const canvas = document.getElementById('seatingCanvas');
            if (delta === 0) {
                currentZoom = 1;
            } else {
                currentZoom = Math.max(0.5, Math.min(2, currentZoom + delta));
            }
            canvas.style.transform = `scale(${currentZoom})`;
            canvas.style.transformOrigin = 'top left';
        }
        
        // ========== GROUPS ==========
        const groupColors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899'];
        
        function makeGroups(size) {
            if (students.length === 0) {
                showToast('No students loaded');
                return;
            }
            
            const shuffled = [...students].sort(() => Math.random() - 0.5);
            currentGroups = [];
            
            for (let i = 0; i < shuffled.length; i += size) {
                currentGroups.push({
                    id: currentGroups.length + 1,
                    members: shuffled.slice(i, i + size),
                    color: groupColors[currentGroups.length % groupColors.length]
                });
            }
            
            renderGroups();
        }
        
        function shuffleGroups() {
            if (currentGroups.length === 0) {
                makeGroups(2);
            } else {
                const avgSize = Math.round(currentGroups.reduce((a, g) => a + g.members.length, 0) / currentGroups.length);
                makeGroups(avgSize);
            }
        }
        
        function renderGroups() {
            const container = document.getElementById('groupsContainer');
            if (!container) return;
            
            if (currentGroups.length === 0) {
                container.innerHTML = '<p style="color:var(--text-secondary);">Click a group size above to create groups.</p>';
                return;
            }
            
            container.innerHTML = currentGroups.map(g => `
                <div style="background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:12px;border-left:4px solid ${g.color};">
                    <h4 style="margin-bottom:12px;">Group ${g.id}</h4>
                    <div style="display:flex;flex-wrap:wrap;gap:12px;">
                        ${g.members.map(m => `
                            <div style="display:flex;align-items:center;gap:8px;">
                                <img src="${getStudentImage(m)}" style="width:32px;height:32px;border-radius:50%;">
                                <span>${m.displayName || m.firstName}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        // ========== SAVE/LOAD GROUPS ==========
        function saveCurrentGroups() {
            if (currentGroups.length === 0) {
                showToast('Create groups first!');
                return;
            }
            
            const name = prompt('Name these groups (e.g., "Project Teams", "Lab Partners"):');
            if (!name) return;
            
            const savedGroups = JSON.parse(localStorage.getItem('hallpass_saved_groups') || '[]');
            
            const groupData = {
                id: Date.now(),
                name: name,
                date: new Date().toISOString(),
                groupCount: currentGroups.length,
                groups: currentGroups.map(g => ({
                    id: g.id,
                    color: g.color,
                    memberIds: g.members.map(m => m.id),
                    memberNames: g.members.map(m => m.displayName || m.firstName)
                }))
            };
            
            savedGroups.unshift(groupData);
            
            // Keep max 20 saved groups
            if (savedGroups.length > 20) savedGroups.pop();
            
            localStorage.setItem('hallpass_saved_groups', JSON.stringify(savedGroups));
            showToast(`üíæ Saved "${name}"`);
        }
        
        function showSavedGroups() {
            const panel = document.getElementById('savedGroupsPanel');
            const list = document.getElementById('savedGroupsList');
            
            if (panel.style.display === 'block') {
                panel.style.display = 'none';
                return;
            }
            
            const savedGroups = JSON.parse(localStorage.getItem('hallpass_saved_groups') || '[]');
            
            if (savedGroups.length === 0) {
                list.innerHTML = '<p style="color:var(--text-secondary);">No saved groups yet. Create groups and click "Save Groups".</p>';
            } else {
                list.innerHTML = savedGroups.map(sg => {
                    const date = new Date(sg.date);
                    const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    return `
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-secondary);border-radius:8px;margin-bottom:8px;">
                            <div>
                                <div style="font-weight:500;">${sg.name}</div>
                                <div style="font-size:0.8rem;color:var(--text-secondary);">${dateStr} ‚Ä¢ ${sg.groupCount} groups</div>
                            </div>
                            <div style="display:flex;gap:8px;">
                                <button class="btn btn-primary" style="padding:6px 12px;font-size:0.85rem;" onclick="loadSavedGroup(${sg.id})">Load</button>
                                <button class="btn btn-danger" style="padding:6px 12px;font-size:0.85rem;" onclick="deleteSavedGroup(${sg.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            panel.style.display = 'block';
        }
        
        function loadSavedGroup(groupId) {
            const savedGroups = JSON.parse(localStorage.getItem('hallpass_saved_groups') || '[]');
            const saved = savedGroups.find(g => g.id === groupId);
            
            if (!saved) {
                showToast('Group not found');
                return;
            }
            
            // Rebuild groups with current student data
            currentGroups = saved.groups.map(g => ({
                id: g.id,
                color: g.color,
                members: g.memberIds.map(id => students.find(s => s.id === id)).filter(Boolean)
            }));
            
            // Check if any students are missing
            const missingCount = saved.groups.reduce((count, g) => 
                count + g.memberIds.filter(id => !students.find(s => s.id === id)).length, 0);
            
            if (missingCount > 0) {
                showToast(`‚ö†Ô∏è Loaded "${saved.name}" (${missingCount} students no longer in class)`);
            } else {
                showToast(`‚úì Loaded "${saved.name}"`);
            }
            
            document.getElementById('savedGroupsPanel').style.display = 'none';
            renderGroups();
        }
        
        function deleteSavedGroup(groupId) {
            if (!confirm('Delete this saved group?')) return;
            
            let savedGroups = JSON.parse(localStorage.getItem('hallpass_saved_groups') || '[]');
            savedGroups = savedGroups.filter(g => g.id !== groupId);
            localStorage.setItem('hallpass_saved_groups', JSON.stringify(savedGroups));
            
            showSavedGroups(); // Refresh the list
            showToast('Deleted');
        }
        
        // ========== VIEW SWITCHING ==========
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(viewName + 'View')?.classList.add('active');
            document.querySelectorAll('.nav-tab').forEach(t => {
                if (t.textContent.toLowerCase().includes(viewName)) {
                    t.classList.add('active');
                }
            });
            
            if (viewName === 'groups') renderGroups();
            if (viewName === 'history') renderHistoryView();
            if (viewName === 'hallpass') {
                renderHallPassView();
                renderHallPassCanvas();
            }
        }
        
        // ========== HALL PASS SYSTEM ==========
        let hallPassQueue = []; // Array of { studentId, duration, reason, startTime, queuedAt }
        let selectedHpDuration = 3;
        let hallPassModalStudentId = null;
        
        function renderHallPassView() {
            const grid = document.getElementById('hallpassGrid');
            const queueEl = document.getElementById('hallpassQueue');
            const countEl = document.getElementById('queueCount');
            if (!grid || !queueEl) return;
            
            // Load hall pass state from localStorage
            const saved = localStorage.getItem('hallpass_queue');
            if (saved) {
                try { hallPassQueue = JSON.parse(saved); } catch(e) {}
            }
            
            // Clean up expired passes (auto-return after 30 min)
            const now = Date.now();
            hallPassQueue = hallPassQueue.filter(p => {
                if (p.startTime && (now - p.startTime) > 30 * 60 * 1000) {
                    // Auto-return after 30 min
                    logHallPassReturn(p);
                    return false;
                }
                return true;
            });
            saveHallPassQueue();
            
            // Render student grid
            grid.innerHTML = students.map(s => {
                const pass = hallPassQueue.find(p => p.studentId === s.id);
                const isOut = pass && pass.startTime;
                const inQueue = pass && !pass.startTime;
                const queuePos = inQueue ? hallPassQueue.filter(p => !p.startTime).findIndex(p => p.studentId === s.id) + 1 : 0;
                const img = getStudentImage(s);
                const name = s.preferredName || s.firstName || '';
                const lastName = s.lastName || '';
                const displayName = name + (lastName ? ' ' + lastName.charAt(0) + '.' : '');
                
                let timerHtml = '';
                if (isOut) {
                    const mins = Math.floor((now - pass.startTime) / 60000);
                    const etd = pass.duration - mins;
                    timerHtml = `<div class="pass-timer">üö∂ ${mins}m (ETD: ${etd > 0 ? etd : 0}m)</div>`;
                } else if (inQueue) {
                    timerHtml = `<div class="queue-pos">üìã #${queuePos} in queue</div>`;
                }
                
                return `
                    <div class="hp-student ${isOut ? 'on-pass' : ''} ${inQueue ? 'in-queue' : ''}" 
                         onclick="${isOut ? `returnFromPass(${s.id})` : `openHallPassModal(${s.id})`}">
                        <img src="${img}" alt="${name}">
                        <div class="name">${displayName}</div>
                        ${timerHtml}
                    </div>
                `;
            }).join('');
            
            // Render queue
            const activePass = hallPassQueue.find(p => p.startTime);
            const waiting = hallPassQueue.filter(p => !p.startTime);
            
            let queueHtml = '';
            
            if (activePass) {
                const student = students.find(s => s.id === activePass.studentId);
                if (student) {
                    const mins = Math.floor((now - activePass.startTime) / 60000);
                    const etd = activePass.duration - mins;
                    const img = getStudentImage(student);
                    queueHtml += `
                        <div class="queue-item active">
                            <img src="${img}">
                            <div class="info">
                                <div class="name">${student.preferredName || student.firstName}</div>
                                <div class="time">${activePass.reason || `${activePass.duration} min pass`}</div>
                            </div>
                            <div style="text-align:right;">
                                <div class="etd">ETD: ${etd > 0 ? etd : 0}m</div>
                                <button class="back-btn" onclick="returnFromPass(${student.id})">I'm Back</button>
                            </div>
                        </div>
                    `;
                }
            }
            
            waiting.forEach((p, i) => {
                const student = students.find(s => s.id === p.studentId);
                if (student) {
                    const img = getStudentImage(student);
                    queueHtml += `
                        <div class="queue-item">
                            <img src="${img}">
                            <div class="info">
                                <div class="name">${student.preferredName || student.firstName}</div>
                                <div class="time">#${i + 1} in queue ‚Ä¢ ${p.duration} min</div>
                            </div>
                            <button class="btn btn-secondary" style="font-size:11px;padding:4px 8px;" onclick="removeFromQueue(${student.id})">‚úï</button>
                        </div>
                    `;
                }
            });
            
            if (!activePass && waiting.length === 0) {
                queueHtml = '<div style="text-align:center;padding:24px;color:var(--text-secondary);">No active passes</div>';
            }
            
            queueEl.innerHTML = queueHtml;
            countEl.textContent = hallPassQueue.length;
            
            // Update context menu item based on student status
            updateHallPassContextMenu();
        }
        
        function openHallPassModal(studentId) {
            hallPassModalStudentId = studentId;
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // Check if already has a pass
            const existingPass = hallPassQueue.find(p => p.studentId === studentId);
            if (existingPass) {
                if (existingPass.startTime) {
                    // Already out - offer to return
                    if (confirm(`${student.preferredName || student.firstName} is already out. Mark as returned?`)) {
                        returnFromPass(studentId);
                    }
                } else {
                    // In queue - offer to remove
                    if (confirm(`${student.preferredName || student.firstName} is in the queue. Remove from queue?`)) {
                        removeFromQueue(studentId);
                    }
                }
                return;
            }
            
            // Set up modal
            const img = getStudentImage(student);
            document.getElementById('hallpassModalImg').src = img;
            document.getElementById('hallpassModalName').textContent = student.preferredName || student.firstName;
            document.getElementById('hallpassModalStatus').textContent = student.status === 'ontime' ? '‚úì On time today' : student.status === 'late' ? '‚è∞ Late today' : '';
            
            // Reset duration selection
            selectedHpDuration = 3;
            document.querySelectorAll('.hp-duration').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.min === '3');
            });
            document.getElementById('hallpassCustomReason').value = '';
            
            // Check if someone is already out
            const activePass = hallPassQueue.find(p => p.startTime);
            const warning = document.getElementById('hallpassQueueWarning');
            const startBtn = document.getElementById('hallpassStartBtn');
            const queueBtn = document.getElementById('hallpassQueueBtn');
            
            if (activePass) {
                const outStudent = students.find(s => s.id === activePass.studentId);
                const mins = Math.floor((Date.now() - activePass.startTime) / 60000);
                const etd = activePass.duration - mins;
                warning.style.display = 'block';
                document.getElementById('hallpassQueueInfo').textContent = 
                    `${outStudent?.preferredName || outStudent?.firstName} is out (ETD: ${etd > 0 ? etd : 0}m)`;
                startBtn.style.display = 'none';
                queueBtn.style.display = 'inline-flex';
            } else {
                warning.style.display = 'none';
                startBtn.style.display = 'inline-flex';
                queueBtn.style.display = 'none';
            }
            
            document.getElementById('hallpassModal').classList.add('open');
        }
        
        function closeHallPassModal() {
            document.getElementById('hallpassModal').classList.remove('open');
            hallPassModalStudentId = null;
        }
        
        function selectHpDuration(mins) {
            selectedHpDuration = mins;
            document.querySelectorAll('.hp-duration').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.min) === mins);
            });
        }
        
        function startHallPass() {
            if (!hallPassModalStudentId) return;
            
            const customReason = document.getElementById('hallpassCustomReason').value.trim();
            
            hallPassQueue.push({
                studentId: hallPassModalStudentId,
                duration: selectedHpDuration,
                reason: customReason || null,
                startTime: Date.now(),
                queuedAt: Date.now()
            });
            
            saveHallPassQueue();
            closeHallPassModal();
            renderHallPassView();
            renderCanvas(); // Update main view too
            
            const student = students.find(s => s.id === hallPassModalStudentId);
            showToast(`üö∂ ${student?.preferredName || student?.firstName} is out on hall pass`);
        }
        
        function queueHallPass() {
            if (!hallPassModalStudentId) return;
            
            const customReason = document.getElementById('hallpassCustomReason').value.trim();
            
            hallPassQueue.push({
                studentId: hallPassModalStudentId,
                duration: selectedHpDuration,
                reason: customReason || null,
                startTime: null, // Not started yet
                queuedAt: Date.now()
            });
            
            saveHallPassQueue();
            closeHallPassModal();
            renderHallPassView();
            
            const student = students.find(s => s.id === hallPassModalStudentId);
            const pos = hallPassQueue.filter(p => !p.startTime).length;
            showToast(`üìã ${student?.preferredName || student?.firstName} added to queue (#${pos})`);
        }
        
        function returnFromPass(studentId) {
            const passIndex = hallPassQueue.findIndex(p => p.studentId === studentId && p.startTime);
            if (passIndex === -1) return;
            
            const pass = hallPassQueue[passIndex];
            const duration = Math.floor((Date.now() - pass.startTime) / 60000);
            
            // Log the completed pass
            logHallPassReturn(pass, duration);
            
            // Remove from queue
            hallPassQueue.splice(passIndex, 1);
            
            // Start next person in queue
            const nextInQueue = hallPassQueue.find(p => !p.startTime);
            if (nextInQueue) {
                nextInQueue.startTime = Date.now();
                const nextStudent = students.find(s => s.id === nextInQueue.studentId);
                showToast(`üö∂ ${nextStudent?.preferredName || nextStudent?.firstName}'s turn!`);
            }
            
            saveHallPassQueue();
            renderHallPassView();
            renderCanvas();
            
            const student = students.find(s => s.id === studentId);
            showToast(`‚úì ${student?.preferredName || student?.firstName} back in ${duration}m`);
        }
        
        function removeFromQueue(studentId) {
            hallPassQueue = hallPassQueue.filter(p => p.studentId !== studentId);
            saveHallPassQueue();
            renderHallPassView();
        }
        
        function logHallPassReturn(pass, duration) {
            // Save to history
            const today = getToday();
            const student = students.find(s => s.id === pass.studentId);
            if (!student) return;
            
            if (!student.hallPassHistory) student.hallPassHistory = [];
            student.hallPassHistory.push({
                date: today,
                duration: duration || Math.floor((Date.now() - pass.startTime) / 60000),
                reason: pass.reason,
                startTime: pass.startTime,
                endTime: Date.now()
            });
            
            saveToLocalStorage();
        }
        
        function saveHallPassQueue() {
            localStorage.setItem('hallpass_queue', JSON.stringify(hallPassQueue));
        }
        
        function showHallPassModal() {
            if (!contextStudentId) return;
            closeContextMenu();
            openHallPassModal(contextStudentId);
        }
        
        function updateHallPassContextMenu() {
            const ctxItem = document.getElementById('ctxHallPass');
            if (!ctxItem || !contextStudentId) return;
            
            const pass = hallPassQueue.find(p => p.studentId === contextStudentId);
            if (pass && pass.startTime) {
                ctxItem.textContent = 'üèÅ End Hall Pass';
                ctxItem.onclick = () => { closeContextMenu(); returnFromPass(contextStudentId); };
            } else if (pass) {
                ctxItem.textContent = '‚ùå Remove from Queue';
                ctxItem.onclick = () => { closeContextMenu(); removeFromQueue(contextStudentId); };
            } else {
                ctxItem.textContent = 'üö∂ Hall Pass';
                ctxItem.onclick = showHallPassModal;
            }
        }
        
        // Update hall pass view periodically
        setInterval(() => {
            if (document.getElementById('hallpassView')?.classList.contains('active')) {
                renderHallPassView();
            }
        }, 10000);
        
        function renderHistoryView() {
            const container = document.getElementById('historyContainer');
            if (!container || students.length === 0) return;
            
            // Class overview
            const days = Object.keys(attendanceHistory).sort().reverse().slice(0, 7);
            
            let html = `
                <h3 style="margin-bottom:16px;">Class Trends (Last 7 Days)</h3>
                <div style="background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:24px;">
            `;
            
            if (days.length === 0) {
                html += '<p style="color:var(--text-secondary);">No attendance data yet.</p>';
            } else {
                html += '<div style="display:grid;gap:8px;">';
                days.forEach(date => {
                    const day = attendanceHistory[date];
                    const total = Object.keys(day).length;
                    const ontime = Object.values(day).filter(d => d.status === 'ontime').length;
                    const late = Object.values(day).filter(d => d.status === 'late').length;
                    const absent = Object.values(day).filter(d => d.status === 'absent').length;
                    const pct = total > 0 ? Math.round((ontime / total) * 100) : 0;
                    
                    const dateObj = new Date(date + 'T12:00:00');
                    const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    
                    html += `
                        <div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg-secondary);border-radius:8px;">
                            <span>${dateStr}</span>
                            <span>
                                <span style="color:var(--success);">${ontime}‚úì</span>
                                <span style="color:var(--warning);margin-left:8px;">${late}‚ö†Ô∏è</span>
                                <span style="color:var(--danger);margin-left:8px;">${absent}‚ùå</span>
                                <span style="margin-left:12px;color:var(--text-secondary);">${pct}%</span>
                            </span>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '</div>';
            
            // Student list
            html += `
                <h3 style="margin-bottom:16px;">Student Records</h3>
                <p style="color:var(--text-secondary);margin-bottom:16px;">Click a student to view their detailed history.</p>
                <div style="display:grid;gap:8px;">
            `;
            
            students.forEach(s => {
                const streak = streaks[s.id]?.current || 0;
                const name = s.displayName || `${s.firstName} ${s.lastInitial}.`;
                html += `
                    <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-card);border-radius:10px;cursor:pointer;" onclick="showStudentHistoryModal(${s.id})">
                        <img src="${getStudentImage(s)}" style="width:40px;height:40px;border-radius:50%;">
                        <div style="flex:1;">
                            <div style="font-weight:500;">${name}</div>
                            <div style="font-size:0.8rem;color:var(--text-secondary);">
                                ${streak > 0 ? `üî• ${streak} day streak` : 'No streak'}
                            </div>
                        </div>
                        <span style="color:var(--text-secondary);">‚Üí</span>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // ========== SETTINGS & IMPORT/EXPORT ==========
        function openSettings() {
            document.getElementById('settingsModal').classList.add('open');
            updateLoadedClassesList();
            document.getElementById('graceSecondsInput').value = appSettings.graceSeconds || 45;
            document.getElementById('bellOffsetInput').value = appSettings.bellOffsetSeconds || 0;
            document.getElementById('autoAbsentMinInput').value = appSettings.autoAbsentMinutes || 5;
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('open');
        }
        
        function removeClassById(classId) {
            const cls = allClasses[classId];
            const name = cls?.classData?.settings?.className || classId;
            if (!confirm(`Remove "${name}"?`)) return;
            removeClass(classId);
            updateLoadedClassesList();
        }
        
        function openHelp() {
            document.getElementById('helpModal').classList.add('open');
        }
        
        function closeHelp() {
            document.getElementById('helpModal').classList.remove('open');
        }
        
        async function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                // Check format version
                if (data.hallpass_backup && data.version === 2) {
                    // Multi-class backup (v2)
                    if (data.allClasses && Object.keys(data.allClasses).length > 0) {
                        // Ask user: merge or replace?
                        const existingCount = Object.keys(allClasses).length;
                        const importCount = Object.keys(data.allClasses).length;
                        
                        let shouldReplace = true;
                        if (existingCount > 0) {
                            shouldReplace = confirm(
                                `You have ${existingCount} class(es). Import has ${importCount} class(es).\n\n` +
                                `OK = Replace all (recommended for sync)\n` +
                                `Cancel = Add to existing classes`
                            );
                        }
                        
                        if (shouldReplace) {
                            // Replace all
                            allClasses = data.allClasses;
                            currentClassId = data.currentClassId || Object.keys(allClasses)[0];
                        } else {
                            // Merge: add imported classes
                            Object.entries(data.allClasses).forEach(([id, classInfo]) => {
                                let newId = id;
                                let counter = 1;
                                while (allClasses[newId]) {
                                    newId = id + '-' + counter++;
                                }
                                allClasses[newId] = classInfo;
                            });
                            if (!currentClassId) {
                                currentClassId = Object.keys(allClasses)[0];
                            }
                        }
                        
                        // Load current class
                        if (currentClassId && allClasses[currentClassId]) {
                            const classInfo = allClasses[currentClassId];
                            classData = classInfo.classData;
                            students = classInfo.students || [];
                            attendanceHistory = classInfo.attendanceHistory || {};
                            streaks = classInfo.streaks || {};
                        }
                        
                        // Import shared settings
                        if (data.schedule) schedule = data.schedule;
                        if (data.weeklyPattern) weeklyPattern = data.weeklyPattern;
                        if (data.periodRotation) periodRotation = data.periodRotation;
                        if (data.classAssignments) classAssignments = data.classAssignments;
                        if (data.appSettings) appSettings = { ...appSettings, ...data.appSettings };
                        
                        populateClassSelector();
                        showToast(`Imported ${Object.keys(data.allClasses).length} classes!`);
                    }
                } else if (data.hallpass_backup) {
                    // Single-class backup (v1) - add to collection
                    if (data.classData) {
                        addClass(
                            data.classData,
                            data.classData.students || data.students || [],
                            data.attendanceHistory || {},
                            data.streaks || {}
                        );
                        showToast(`Added class: ${data.classData?.settings?.className || 'New Class'}`);
                    }
                    if (data.schedule) {
                        schedule = data.schedule;
                    }
                } else if (data.students) {
                    // Just class data (original format) - add to collection
                    const newClassData = {
                        ...data,
                        settings: data.settings || { className: file.name.replace('.json', '') }
                    };
                    addClass(
                        newClassData,
                        data.students.map(s => ({ ...s, status: 'unchecked' })),
                        {},
                        {}
                    );
                    showToast(`Added ${data.students.length} students`);
                }
                
                // FORCE SAVE everything to localStorage
                saveClass();
                localStorage.setItem('hallpass_allClasses', JSON.stringify(allClasses));
                localStorage.setItem('hallpass_currentClassId', currentClassId);
                localStorage.setItem('hallpass_schedule', JSON.stringify(schedule));
                localStorage.setItem('hallpass_weeklyPattern', JSON.stringify(weeklyPattern));
                localStorage.setItem('hallpass_classAssignments', JSON.stringify(classAssignments));
                localStorage.setItem('hallpass_settings', JSON.stringify(appSettings));
                
                // Verify save
                const verify = localStorage.getItem('hallpass_allClasses');
                if (!verify) {
                    alert('‚ö†Ô∏è WARNING: Save verification failed! Download a backup immediately.');
                }
                
                initializeLayouts();
                renderCanvas();
                updateStats();
                updateStatusBar();
                closeSettings();
                
                // Prompt backup for multi-class imports
                if (data.hallpass_backup && data.version === 2) {
                    setTimeout(() => {
                        if (confirm('Import complete! Download a backup now to be safe?')) {
                            downloadFullBackup();
                        }
                    }, 500);
                }
                
                // Reset file input
                event.target.value = '';
            } catch (e) {
                alert('Error importing: ' + e.message);
                console.error(e);
            }
        }
        
        // Open file picker for adding a class
        function openImportClass() {
            document.getElementById('importFile').click();
        }
        
        function exportAllData() {
            // Save current class first
            saveClass();
            
            const backup = {
                hallpass_backup: true,
                version: 2, // Multi-class format
                exportDate: new Date().toISOString(),
                // Multi-class data
                allClasses: allClasses,
                currentClassId: currentClassId,
                // Shared settings
                schedule: schedule,
                weeklyPattern: weeklyPattern,
                periodRotation: periodRotation,
                classAssignments: classAssignments,
                appSettings: appSettings,
                corrections: JSON.parse(localStorage.getItem('hallpass_corrections') || '[]')
            };
            
            const classCount = Object.keys(allClasses).length;
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hallpass-backup-${getToday()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast(`Exported ${classCount} class${classCount !== 1 ? 'es' : ''}!`);
        }
        
        // Export single class (for sharing individual class files)
        function exportCurrentClass() {
            if (!classData) {
                showToast('No class to export');
                return;
            }
            
            const backup = {
                hallpass_backup: true,
                version: 1, // Single-class format
                exportDate: new Date().toISOString(),
                classData: classData,
                students: students,
                attendanceHistory: attendanceHistory,
                streaks: streaks
            };
            
            const className = classData?.settings?.className || 'class';
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hallpass-${className.replace(/\s+/g, '-')}-${getToday()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast(`Exported ${className}!`);
        }
        
        // Export schedule template (for sharing with other teachers)
        function exportScheduleTemplate() {
            const template = {
                hallpass_schedule_template: true,
                version: 1,
                exportDate: new Date().toISOString(),
                schoolName: prompt('Enter school name (for the template):', 'My School') || 'School',
                // Schedule data - NO student/class info
                schedule: {
                    startTime: schedule.startTime,
                    endTime: schedule.endTime
                },
                weeklyPattern: weeklyPattern,
                periodRotation: periodRotation,
                presets: presets,
                appSettings: {
                    graceSeconds: appSettings.graceSeconds,
                    bellOffsetSeconds: appSettings.bellOffsetSeconds,
                    autoAbsentMinutes: appSettings.autoAbsentMinutes
                }
            };
            
            const blob = new Blob([JSON.stringify(template, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const schoolSlug = template.schoolName.toLowerCase().replace(/\s+/g, '-');
            a.download = `hallpass-schedule-${schoolSlug}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast(`üìÖ Schedule template exported! Share with colleagues.`);
        }
        
        // Import schedule template
        function importScheduleTemplate(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const template = JSON.parse(e.target.result);
                    
                    if (!template.hallpass_schedule_template) {
                        showToast('Invalid schedule template file', 'error');
                        return;
                    }
                    
                    const schoolName = template.schoolName || 'Unknown School';
                    if (!confirm(`Import schedule from "${schoolName}"?\n\nThis will replace your current bell schedule settings.\nYour classes and student data will NOT be affected.`)) {
                        return;
                    }
                    
                    // Import schedule settings
                    if (template.schedule) {
                        schedule.startTime = template.schedule.startTime || schedule.startTime;
                        schedule.endTime = template.schedule.endTime || schedule.endTime;
                    }
                    
                    if (template.weeklyPattern) {
                        weeklyPattern = template.weeklyPattern;
                    }
                    
                    if (template.periodRotation) {
                        periodRotation = template.periodRotation;
                    }
                    
                    if (template.presets) {
                        // Merge presets (keep custom ones, update standard ones)
                        Object.assign(presets, template.presets);
                    }
                    
                    if (template.appSettings) {
                        appSettings.graceSeconds = template.appSettings.graceSeconds ?? appSettings.graceSeconds;
                        appSettings.bellOffsetSeconds = template.appSettings.bellOffsetSeconds ?? appSettings.bellOffsetSeconds;
                        appSettings.autoAbsentMinutes = template.appSettings.autoAbsentMinutes ?? appSettings.autoAbsentMinutes;
                    }
                    
                    // Save to localStorage
                    localStorage.setItem('hallpass_schedule', JSON.stringify(schedule));
                    localStorage.setItem('hallpass_weeklyPattern', JSON.stringify(weeklyPattern));
                    localStorage.setItem('hallpass_periodRotation', JSON.stringify(periodRotation));
                    localStorage.setItem('hallpass_presets', JSON.stringify(presets));
                    localStorage.setItem('hallpass_settings', JSON.stringify(appSettings));
                    
                    updateStatusBar();
                    showToast(`‚úÖ Imported schedule from "${schoolName}"`);
                } catch(err) {
                    console.error('Import error:', err);
                    showToast('Failed to import: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }
        
        function exportAttendance(format) {
            if (format === 'csv') {
                let csv = 'Date,Student ID,Name,Status,Late By (min),Note\n';
                Object.entries(attendanceHistory).forEach(([date, day]) => {
                    Object.entries(day).forEach(([studentId, record]) => {
                        const student = students.find(s => s.id == studentId);
                        const name = student ? `${student.firstName} ${student.lastInitial}` : studentId;
                        csv += `${date},"${name}",${record.status},${record.lateBy || 0},"${record.note || ''}"\n`;
                    });
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `attendance-${getToday()}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            } else {
                // Anonymized JSON (no names for privacy)
                const anonymized = {};
                Object.entries(attendanceHistory).forEach(([date, day]) => {
                    anonymized[date] = {
                        ontime: Object.values(day).filter(d => d.status === 'ontime').length,
                        late: Object.values(day).filter(d => d.status === 'late').length,
                        absent: Object.values(day).filter(d => d.status === 'absent').length,
                        avgLateBy: Math.round(
                            Object.values(day).filter(d => d.lateBy > 0).reduce((a, d) => a + d.lateBy, 0) /
                            Math.max(1, Object.values(day).filter(d => d.lateBy > 0).length)
                        )
                    };
                });
                
                const blob = new Blob([JSON.stringify(anonymized, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `attendance-trends-${getToday()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
            showToast(`Exported as ${format.toUpperCase()}`);
        }
        
        // Full backup download (same as exportAllData but clearer name)
        function downloadFullBackup() {
            saveClass(); // Ensure current data is saved
            
            const backup = {
                hallpass_backup: true,
                version: 2,
                exportDate: new Date().toISOString(),
                allClasses: allClasses,
                currentClassId: currentClassId,
                schedule: schedule,
                weeklyPattern: weeklyPattern,
                periodRotation: periodRotation,
                classAssignments: classAssignments,
                appSettings: appSettings,
                hallPassHistory: JSON.parse(localStorage.getItem('hallpass_hallPassHistory') || '[]'),
                corrections: JSON.parse(localStorage.getItem('hallpass_corrections') || '[]')
            };
            
            const classCount = Object.keys(allClasses).length;
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hallpass-backup-${getToday()}-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            // Remember last backup
            localStorage.setItem('hallpass_lastBackup', new Date().toISOString());
            showToast(`‚úÖ Backup downloaded (${classCount} classes)`);
        }
        
        // Restore from backup file
        function handleRestore(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (!backup.hallpass_backup) {
                        showToast('Invalid backup file', 'error');
                        return;
                    }
                    
                    const classCount = backup.allClasses ? Object.keys(backup.allClasses).length : 0;
                    if (!confirm(`Restore from backup?\n\nThis will replace current data with:\n- ${classCount} classes\n- Schedule settings\n\nBackup date: ${backup.exportDate || 'Unknown'}`)) {
                        return;
                    }
                    
                    // Restore all data
                    if (backup.version >= 2 && backup.allClasses) {
                        // Multi-class format
                        allClasses = backup.allClasses;
                        currentClassId = backup.currentClassId || Object.keys(allClasses)[0];
                        
                        if (currentClassId && allClasses[currentClassId]) {
                            const cls = allClasses[currentClassId];
                            classData = cls.classData;
                            students = cls.students || [];
                            attendanceHistory = cls.attendanceHistory || {};
                            streaks = cls.streaks || {};
                        }
                    } else if (backup.classData) {
                        // Single class format - add it
                        addClass(backup.classData, backup.students || [], backup.attendanceHistory || {}, backup.streaks || {});
                    }
                    
                    // Restore settings
                    if (backup.schedule) schedule = backup.schedule;
                    if (backup.weeklyPattern) weeklyPattern = backup.weeklyPattern;
                    if (backup.periodRotation) periodRotation = backup.periodRotation;
                    if (backup.classAssignments) classAssignments = backup.classAssignments;
                    if (backup.appSettings) appSettings = { ...appSettings, ...backup.appSettings };
                    
                    // Save everything
                    localStorage.setItem('hallpass_allClasses', JSON.stringify(allClasses));
                    localStorage.setItem('hallpass_currentClassId', currentClassId);
                    localStorage.setItem('hallpass_schedule', JSON.stringify(schedule));
                    localStorage.setItem('hallpass_weeklyPattern', JSON.stringify(weeklyPattern));
                    localStorage.setItem('hallpass_periodRotation', JSON.stringify(periodRotation));
                    localStorage.setItem('hallpass_classAssignments', JSON.stringify(classAssignments));
                    localStorage.setItem('hallpass_settings', JSON.stringify(appSettings));
                    
                    // Update UI
                    populateClassSelector();
                    initializeLayouts();
                    renderCanvas();
                    updateStats();
                    updateStatusBar();
                    
                    showToast(`‚úÖ Restored ${classCount} classes from backup!`);
                    closeSettings();
                } catch(err) {
                    console.error('Restore error:', err);
                    showToast('Failed to restore: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        }
        
        function clearAllData() {
            const classCount = Object.keys(allClasses).length;
            if (!confirm(`This will delete ALL Hall Pass data (${classCount} classes). Are you sure?`)) return;
            if (!confirm('Really? This cannot be undone!')) return;
            
            // Clear all storage
            localStorage.removeItem('hallpass_allClasses');
            localStorage.removeItem('hallpass_currentClassId');
            localStorage.removeItem('hallpass_class');
            localStorage.removeItem('hallpass_attendance');
            localStorage.removeItem('hallpass_streaks');
            localStorage.removeItem('hallpass_schedule');
            localStorage.removeItem('hallpass_corrections');
            localStorage.removeItem('hallpass_settings');
            
            // Reset state
            allClasses = {};
            currentClassId = null;
            classData = null;
            students = [];
            attendanceHistory = {};
            streaks = {};
            
            populateClassSelector();
            renderCanvas();
            updateStats();
            closeSettings();
            showToast('All data cleared');
        }
        
        // Remove just the current class
        function removeCurrentClass() {
            if (!currentClassId) {
                showToast('No class selected');
                return;
            }
            
            const className = classData?.settings?.className || currentClassId;
            if (!confirm(`Delete "${className}"? This cannot be undone.`)) return;
            
            removeClass(currentClassId);
            closeSettings();
            showToast(`Deleted ${className}`);
        }
        
        // ========== PERSISTENCE ==========
        
        // Generate a class ID from class name
        function generateClassId(className) {
            return className.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-');
        }
        
        // Save current class to allClasses and persist
        function saveClass() {
            if (classData && currentClassId) {
                classData.students = students;
                
                // Save current layout positions
                if (currentLayoutId && classLayouts[currentLayoutId]) {
                    savePositionsToLayout(currentLayoutId);
                    classData.layouts = classLayouts;
                    classData.currentLayoutId = currentLayoutId;
                }
                
                // Store in allClasses
                allClasses[currentClassId] = {
                    classData: classData,
                    students: students,
                    attendanceHistory: attendanceHistory,
                    streaks: streaks
                };
                
                // Persist all classes
                localStorage.setItem('hallpass_allClasses', JSON.stringify(allClasses));
                localStorage.setItem('hallpass_currentClassId', currentClassId);
            }
            
            // Also save schedule and settings (shared across classes)
            localStorage.setItem('hallpass_schedule', JSON.stringify(schedule));
            localStorage.setItem('hallpass_settings', JSON.stringify(appSettings));
        }
        
        // Switch to a different class
        function switchClass(classId) {
            if (!classId || !allClasses[classId]) return;
            
            // Save current class first
            if (currentClassId && classData) {
                allClasses[currentClassId] = {
                    classData: classData,
                    students: students,
                    attendanceHistory: attendanceHistory,
                    streaks: streaks
                };
            }
            
            // Load new class
            currentClassId = classId;
            const classInfo = allClasses[classId];
            classData = classInfo.classData;
            students = classInfo.students || [];
            attendanceHistory = classInfo.attendanceHistory || {};
            streaks = classInfo.streaks || {};
            
            // Initialize layouts for this class
            initializeLayouts();
            applyLayoutPositions(currentLayoutId);
            
            // Update UI
            document.getElementById('classSelect').value = classId;
            renderCanvas();
            updateStats();
            updateStatusBar();
            updateRemoveButtonVisibility();
            
            // Restore class name color (in case it was grayed out for prep)
            const classNameEl = document.getElementById('className');
            if (classNameEl) classNameEl.style.color = '';
            
            showToast(`Switched to ${classData?.settings?.className || classId}`);
            
            // Persist
            localStorage.setItem('hallpass_currentClassId', currentClassId);
            localStorage.setItem('hallpass_allClasses', JSON.stringify(allClasses));
        }
        
        // Populate class dropdown
        function populateClassSelector() {
            const select = document.getElementById('classSelect');
            const classIds = Object.keys(allClasses);
            
            if (classIds.length === 0) {
                select.innerHTML = '<option value="">No class loaded</option>';
                return;
            }
            
            select.innerHTML = classIds.map(id => {
                const cls = allClasses[id];
                const name = cls.classData?.settings?.className || id;
                return `<option value="${id}" ${id === currentClassId ? 'selected' : ''}>${name}</option>`;
            }).join('');
        }
        
        // Add a new class from import data
        function addClass(importedClassData, importedStudents, importedAttendance = {}, importedStreaks = {}) {
            const className = importedClassData?.settings?.className || 'New Class';
            let classId = generateClassId(className);
            
            // Handle duplicate IDs
            let counter = 1;
            while (allClasses[classId]) {
                classId = generateClassId(className) + '-' + counter++;
            }
            
            allClasses[classId] = {
                classData: importedClassData,
                students: importedStudents,
                attendanceHistory: importedAttendance,
                streaks: importedStreaks
            };
            
            // Switch to the new class
            currentClassId = classId;
            classData = importedClassData;
            students = importedStudents;
            attendanceHistory = importedAttendance;
            streaks = importedStreaks;
            
            // Save IMMEDIATELY and verify
            saveClass();
            
            // Force save to localStorage directly as backup
            try {
                localStorage.setItem('hallpass_allClasses', JSON.stringify(allClasses));
                localStorage.setItem('hallpass_currentClassId', currentClassId);
                console.log('Class saved:', classId, 'Total classes:', Object.keys(allClasses).length);
                
                // Verify save worked
                const verify = localStorage.getItem('hallpass_allClasses');
                if (!verify || !JSON.parse(verify)[classId]) {
                    console.error('SAVE VERIFICATION FAILED!');
                    showToast('‚ö†Ô∏è Save may have failed - download backup!', 'warning');
                }
            } catch(e) {
                console.error('localStorage save error:', e);
                showToast('‚ö†Ô∏è Storage error - download backup NOW!', 'error');
            }
            
            populateClassSelector();
            renderCanvas();
            updateStats();
            
            // Prompt for backup after import
            setTimeout(() => {
                if (confirm(`${className} imported successfully!\n\nDownload a backup now to prevent data loss?`)) {
                    downloadFullBackup();
                }
            }, 500);
            
            return classId;
        }
        
        // Remove a class
        function removeClass(classId) {
            if (!allClasses[classId]) return;
            
            delete allClasses[classId];
            
            // If we deleted the current class, switch to another
            if (classId === currentClassId) {
                const remaining = Object.keys(allClasses);
                if (remaining.length > 0) {
                    switchClass(remaining[0]);
                } else {
                    currentClassId = null;
                    classData = null;
                    students = [];
                    attendanceHistory = {};
                    streaks = {};
                }
            }
            
            saveClass();
            populateClassSelector();
            renderCanvas();
        }
        
        // ========== LAYOUT MANAGEMENT ==========
        let currentLayoutId = 'default';
        let classLayouts = {}; // { layoutId: { name, positions: { studentId: {x,y} } } }
        
        function initializeLayouts() {
            // Load layouts from class data
            if (classData?.layouts) {
                classLayouts = classData.layouts;
            } else {
                // Create default layout
                classLayouts = {
                    'default': {
                        name: 'Default',
                        positions: {}
                    }
                };
            }
            
            // Get current layout from class data
            currentLayoutId = classData?.currentLayoutId || 'default';
            
            populateLayoutSelector();
        }
        
        function populateLayoutSelector() {
            const select = document.getElementById('layoutSelect');
            if (!select) return;
            
            const layoutIds = Object.keys(classLayouts);
            
            select.innerHTML = layoutIds.map(id => {
                const layout = classLayouts[id];
                return `<option value="${id}" ${id === currentLayoutId ? 'selected' : ''}>${layout.name}</option>`;
            }).join('');
        }
        
        function switchLayout(layoutId) {
            if (!classLayouts[layoutId]) return;
            
            // Save current positions first
            savePositionsToLayout(currentLayoutId);
            
            // Switch to new layout
            currentLayoutId = layoutId;
            
            // Apply positions from new layout
            applyLayoutPositions(layoutId);
            
            // Update class data
            if (classData) {
                classData.currentLayoutId = layoutId;
            }
            
            saveClass();
            renderCanvas();
            showToast(`Switched to ${classLayouts[layoutId].name}`);
        }
        
        function savePositionsToLayout(layoutId) {
            if (!classLayouts[layoutId]) return;
            
            const positions = {};
            students.forEach(s => {
                if (s.position) {
                    positions[s.id] = { x: s.position.x, y: s.position.y };
                }
            });
            
            classLayouts[layoutId].positions = positions;
            
            // Save to class data
            if (classData) {
                classData.layouts = classLayouts;
            }
        }
        
        function applyLayoutPositions(layoutId) {
            const layout = classLayouts[layoutId];
            if (!layout || !layout.positions) return;
            
            students.forEach(s => {
                if (layout.positions[s.id]) {
                    s.position = { ...layout.positions[s.id] };
                }
            });
        }
        
        function saveCurrentLayout() {
            savePositionsToLayout(currentLayoutId);
            saveClass();
            showToast(`Saved ${classLayouts[currentLayoutId].name} layout`);
        }
        
        function openLayoutManager() {
            renderLayoutList();
            document.getElementById('layoutManagerModal').classList.add('open');
        }
        
        function closeLayoutManager() {
            document.getElementById('layoutManagerModal').classList.remove('open');
        }
        
        function renderLayoutList() {
            const container = document.getElementById('layoutList');
            const layoutIds = Object.keys(classLayouts);
            
            if (layoutIds.length === 0) {
                container.innerHTML = '<p style="color:var(--text-secondary);">No layouts yet.</p>';
                return;
            }
            
            container.innerHTML = layoutIds.map(id => {
                const layout = classLayouts[id];
                const isActive = id === currentLayoutId;
                const isDefault = id === 'default';
                
                return `
                    <div class="layout-manager-item ${isActive ? 'active' : ''}">
                        <div>
                            <span class="layout-name">${layout.name}</span>
                            ${isActive ? '<span style="color:var(--accent);font-size:0.8rem;margin-left:8px;">Active</span>' : ''}
                        </div>
                        <div class="layout-actions">
                            ${!isActive ? `<button class="btn btn-secondary" style="padding:6px 12px;font-size:0.85rem;" onclick="switchLayout('${id}');renderLayoutList();">Use</button>` : ''}
                            ${!isDefault ? `<button class="btn btn-secondary" style="padding:6px 12px;font-size:0.85rem;" onclick="renameLayout('${id}')">‚úèÔ∏è</button>` : ''}
                            ${!isDefault ? `<button class="btn btn-danger" style="padding:6px 12px;font-size:0.85rem;" onclick="deleteLayout('${id}')">üóëÔ∏è</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function createNewLayout() {
            const nameInput = document.getElementById('newLayoutName');
            const copyPositions = document.getElementById('copyCurrentPositions').checked;
            
            let name = nameInput.value.trim();
            if (!name) {
                name = `Layout ${Object.keys(classLayouts).length + 1}`;
            }
            
            // Generate unique ID
            const id = 'layout-' + Date.now();
            
            // Create layout
            const positions = {};
            if (copyPositions) {
                students.forEach(s => {
                    if (s.position) {
                        positions[s.id] = { x: s.position.x, y: s.position.y };
                    }
                });
            }
            
            classLayouts[id] = { name, positions };
            
            // Save and update UI
            if (classData) {
                classData.layouts = classLayouts;
            }
            saveClass();
            
            // Switch to new layout
            currentLayoutId = id;
            if (classData) {
                classData.currentLayoutId = id;
            }
            
            populateLayoutSelector();
            renderLayoutList();
            nameInput.value = '';
            
            showToast(`Created "${name}" layout`);
        }
        
        function renameLayout(layoutId) {
            const layout = classLayouts[layoutId];
            if (!layout) return;
            
            const newName = prompt('Enter new name:', layout.name);
            if (newName && newName.trim()) {
                layout.name = newName.trim();
                if (classData) {
                    classData.layouts = classLayouts;
                }
                saveClass();
                populateLayoutSelector();
                renderLayoutList();
                showToast(`Renamed to "${newName}"`);
            }
        }
        
        function deleteLayout(layoutId) {
            if (layoutId === 'default') {
                showToast('Cannot delete default layout');
                return;
            }
            
            const layout = classLayouts[layoutId];
            if (!confirm(`Delete "${layout.name}" layout?`)) return;
            
            delete classLayouts[layoutId];
            
            // If deleted active layout, switch to default
            if (layoutId === currentLayoutId) {
                currentLayoutId = 'default';
                applyLayoutPositions('default');
                if (classData) {
                    classData.currentLayoutId = 'default';
                }
            }
            
            if (classData) {
                classData.layouts = classLayouts;
            }
            saveClass();
            
            populateLayoutSelector();
            renderLayoutList();
            renderCanvas();
            
            showToast(`Deleted layout`);
        }
        
        function loadSavedData() {
            // Load app settings
            const savedSettings = localStorage.getItem('hallpass_settings');
            if (savedSettings) {
                try { appSettings = { ...appSettings, ...JSON.parse(savedSettings) }; } catch(e) {}
            }
            
            // Load all classes (new multi-class format)
            const savedAllClasses = localStorage.getItem('hallpass_allClasses');
            if (savedAllClasses) {
                try {
                    allClasses = JSON.parse(savedAllClasses);
                    currentClassId = localStorage.getItem('hallpass_currentClassId');
                    
                    // If we have a current class, load it
                    if (currentClassId && allClasses[currentClassId]) {
                        const classInfo = allClasses[currentClassId];
                        classData = classInfo.classData;
                        students = classInfo.students || [];
                        attendanceHistory = classInfo.attendanceHistory || {};
                        streaks = classInfo.streaks || {};
                    } else if (Object.keys(allClasses).length > 0) {
                        // Default to first class
                        currentClassId = Object.keys(allClasses)[0];
                        const classInfo = allClasses[currentClassId];
                        classData = classInfo.classData;
                        students = classInfo.students || [];
                        attendanceHistory = classInfo.attendanceHistory || {};
                        streaks = classInfo.streaks || {};
                    }
                    
                    populateClassSelector();
                    initializeLayouts();
                } catch(e) {
                    console.error('Error loading classes:', e);
                }
            } else {
                // Migration: load old single-class format
                const savedClass = localStorage.getItem('hallpass_class');
                if (savedClass) {
                    try {
                        const oldClassData = JSON.parse(savedClass);
                        const oldAttendance = JSON.parse(localStorage.getItem('hallpass_attendance') || '{}');
                        const oldStreaks = JSON.parse(localStorage.getItem('hallpass_streaks') || '{}');
                        
                        // Migrate to new format
                        addClass(oldClassData, oldClassData.students || [], oldAttendance, oldStreaks);
                        
                        // Clean up old keys
                        localStorage.removeItem('hallpass_class');
                        localStorage.removeItem('hallpass_attendance');
                        localStorage.removeItem('hallpass_streaks');
                        
                        showToast('Migrated to multi-class format');
                    } catch(e) {
                        console.error('Migration error:', e);
                    }
                }
            }
            
            // Load schedule (shared)
            const savedSchedule = localStorage.getItem('hallpass_schedule');
            if (savedSchedule) {
                try { schedule = JSON.parse(savedSchedule); } catch(e) {}
            }
            
            // Load weekly pattern
            const savedWeeklyPattern = localStorage.getItem('hallpass_weeklyPattern');
            if (savedWeeklyPattern) {
                try { weeklyPattern = JSON.parse(savedWeeklyPattern); } catch(e) {}
            }
            
            // Load class assignments (period -> class mapping)
            const savedAssignments = localStorage.getItem('hallpass_classAssignments');
            if (savedAssignments) {
                try { classAssignments = JSON.parse(savedAssignments); } catch(e) {}
            }
            
            console.log('Data loaded:', {
                classCount: Object.keys(allClasses).length,
                currentClassId,
                studentCount: students.length,
                assignmentsSet: Object.values(classAssignments).filter(a => a?.classId).length
            });
        }
        
        // Auto-backup on page unload
        window.addEventListener('beforeunload', () => {
            if (appSettings.autoBackup) {
                saveClass();
                
                // Store timestamped backup
                const backupKey = `hallpass_backup_${new Date().toISOString().split('T')[0]}`;
                const backup = {
                    allClasses,
                    schedule,
                    weeklyPattern,
                    classAssignments,
                    appSettings,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem(backupKey, JSON.stringify(backup));
                
                // Prune old backups
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - appSettings.backupRetentionDays);
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key?.startsWith('hallpass_backup_')) {
                        const dateStr = key.replace('hallpass_backup_', '');
                        if (new Date(dateStr) < cutoff) {
                            localStorage.removeItem(key);
                        }
                    }
                }
            }
        });
        
        // ========== STUDENT MANAGEMENT ==========
        let addStudentPosition = null;
        
        function openStudentManager() {
            renderStudentManagerList();
            document.getElementById('studentManagerModal').classList.add('open');
        }
        
        function closeStudentManager() {
            document.getElementById('studentManagerModal').classList.remove('open');
        }
        
        function renderStudentManagerList() {
            const container = document.getElementById('studentManagerList');
            const search = document.getElementById('studentSearch')?.value?.toLowerCase() || '';
            
            let filtered = students;
            if (search) {
                filtered = students.filter(s => 
                    s.firstName?.toLowerCase().includes(search) ||
                    s.lastName?.toLowerCase().includes(search) ||
                    s.preferredName?.toLowerCase().includes(search)
                );
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:24px;">No students found. Click "Add Student" to get started.</p>';
                return;
            }
            
            container.innerHTML = filtered.map(s => {
                const name = s.displayName || `${s.preferredName || s.firstName} ${s.lastInitial || s.lastName?.charAt(0) || ''}.`;
                return `
                    <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-secondary);border-radius:10px;margin-bottom:8px;">
                        <img src="${getStudentImage(s)}" style="width:48px;height:48px;border-radius:50%;object-fit:cover;">
                        <div style="flex:1;">
                            <div style="font-weight:500;">${name}</div>
                            <div style="font-size:0.8rem;color:var(--text-secondary);">${s.firstName} ${s.lastName || ''}</div>
                        </div>
                        <button class="btn btn-secondary" style="padding:8px 12px;" onclick="showEditStudentForm(${s.id})">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger" style="padding:8px 12px;" onclick="confirmRemoveStudent(${s.id})">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');
        }
        
        function filterStudentList() {
            renderStudentManagerList();
        }
        
        // Avatar options - organized by style/vibe with diverse seeds
        const avatarOptions = {
            cartoon: [
                // Avataaars - Bitmoji-like, very popular
                { seed: 'Aiden', style: 'avataaars' },
                { seed: 'Bella', style: 'avataaars' },
                { seed: 'Carlos', style: 'avataaars' },
                { seed: 'Diana', style: 'avataaars' },
                { seed: 'Ethan', style: 'avataaars' },
                { seed: 'Fatima', style: 'avataaars' },
                { seed: 'Kai', style: 'avataaars' },
                { seed: 'Luna', style: 'avataaars' },
                { seed: 'Marcus', style: 'avataaars' },
                { seed: 'Nadia', style: 'avataaars' },
                { seed: 'Omar', style: 'avataaars' },
                { seed: 'Priya', style: 'avataaars' },
                // Adventurer - cute cartoon style
                { seed: 'River', style: 'adventurer' },
                { seed: 'Sage', style: 'adventurer' },
                { seed: 'Tyler', style: 'adventurer' },
                { seed: 'Uma', style: 'adventurer' },
                { seed: 'Victor', style: 'adventurer' },
                { seed: 'Willow', style: 'adventurer' }
            ],
            modern: [
                // Micah - clean modern illustrated
                { seed: 'Alex', style: 'micah' },
                { seed: 'Brooklyn', style: 'micah' },
                { seed: 'Charlie', style: 'micah' },
                { seed: 'Dakota', style: 'micah' },
                { seed: 'Ellis', style: 'micah' },
                { seed: 'Finley', style: 'micah' },
                { seed: 'Gray', style: 'micah' },
                { seed: 'Harper', style: 'micah' },
                { seed: 'Indigo', style: 'micah' },
                { seed: 'Jordan', style: 'micah' },
                // Notionists - Notion-style clean
                { seed: 'Kira', style: 'notionists' },
                { seed: 'Leo', style: 'notionists' },
                { seed: 'Morgan', style: 'notionists' },
                { seed: 'Noah', style: 'notionists' },
                { seed: 'Ocean', style: 'notionists' },
                { seed: 'Phoenix', style: 'notionists' },
                { seed: 'Quinn', style: 'notionists' },
                { seed: 'Reese', style: 'notionists' }
            ],
            playful: [
                // Big Smile - happy fun faces
                { seed: 'Sunny', style: 'big-smile' },
                { seed: 'Happy', style: 'big-smile' },
                { seed: 'Joy', style: 'big-smile' },
                { seed: 'Bliss', style: 'big-smile' },
                { seed: 'Spark', style: 'big-smile' },
                { seed: 'Glow', style: 'big-smile' },
                { seed: 'Shine', style: 'big-smile' },
                { seed: 'Bright', style: 'big-smile' },
                { seed: 'Lucky', style: 'big-smile' },
                { seed: 'Star', style: 'big-smile' },
                // Fun Emoji - expressive emoji faces
                { seed: 'Chill', style: 'fun-emoji' },
                { seed: 'Vibe', style: 'fun-emoji' },
                { seed: 'Cool', style: 'fun-emoji' },
                { seed: 'Rad', style: 'fun-emoji' },
                { seed: 'Epic', style: 'fun-emoji' },
                { seed: 'Ace', style: 'fun-emoji' },
                { seed: 'Zen', style: 'fun-emoji' },
                { seed: 'Wave', style: 'fun-emoji' }
            ],
            pixel: [
                // Pixel Art - retro gamer style
                { seed: 'Player1', style: 'pixel-art' },
                { seed: 'Player2', style: 'pixel-art' },
                { seed: 'Gamer', style: 'pixel-art' },
                { seed: 'Hero', style: 'pixel-art' },
                { seed: 'Legend', style: 'pixel-art' },
                { seed: 'Boss', style: 'pixel-art' },
                { seed: 'Ninja', style: 'pixel-art' },
                { seed: 'Knight', style: 'pixel-art' },
                { seed: 'Mage', style: 'pixel-art' },
                { seed: 'Rogue', style: 'pixel-art' },
                { seed: 'Scout', style: 'pixel-art' },
                { seed: 'Tank', style: 'pixel-art' },
                { seed: 'Healer', style: 'pixel-art' },
                { seed: 'Ranger', style: 'pixel-art' },
                { seed: 'Mystic', style: 'pixel-art' },
                { seed: 'Champion', style: 'pixel-art' }
            ],
            classic: [
                // Lorelei - illustrated portraits
                { seed: 'Emma', style: 'lorelei' },
                { seed: 'James', style: 'lorelei' },
                { seed: 'Sophia', style: 'lorelei' },
                { seed: 'William', style: 'lorelei' },
                { seed: 'Olivia', style: 'lorelei' },
                { seed: 'Benjamin', style: 'lorelei' },
                { seed: 'Ava', style: 'lorelei' },
                { seed: 'Lucas', style: 'lorelei' },
                { seed: 'Mia', style: 'lorelei' },
                { seed: 'Henry', style: 'lorelei' },
                // Open Peeps - hand-drawn trendy
                { seed: 'Ash', style: 'open-peeps' },
                { seed: 'Blake', style: 'open-peeps' },
                { seed: 'Casey', style: 'open-peeps' },
                { seed: 'Drew', style: 'open-peeps' },
                { seed: 'Emery', style: 'open-peeps' },
                { seed: 'Frankie', style: 'open-peeps' }
            ]
        };
        
        let currentAvatarTab = 'cartoon';
        
        function getAvatarUrl(seed, style = 'lorelei') {
            return `https://api.dicebear.com/7.x/${style}/svg?seed=${seed}`;
        }
        
        function showAvatarTab(tab) {
            currentAvatarTab = tab;
            document.querySelectorAll('.avatar-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderAvatarGrid();
        }
        
        function renderAvatarGrid() {
            const grid = document.getElementById('avatarGrid');
            const options = avatarOptions[currentAvatarTab] || avatarOptions.cartoon;
            const selectedAvatar = document.getElementById('editSelectedAvatar').value;
            
            grid.innerHTML = options.map(opt => {
                const url = getAvatarUrl(opt.seed, opt.style);
                const isSelected = selectedAvatar === url;
                return `
                    <div onclick="selectAvatar('${url}')" 
                         style="cursor:pointer;padding:4px;border-radius:8px;border:3px solid ${isSelected ? 'var(--accent)' : 'transparent'};transition:border 0.2s;">
                        <img src="${url}" style="width:100%;border-radius:50%;background:var(--bg-card);">
                    </div>
                `;
            }).join('');
        }
        
        function selectAvatar(url) {
            document.getElementById('editSelectedAvatar').value = url;
            document.getElementById('editPhotoUrl').value = '';
            renderAvatarGrid();
        }
        
        function clearAvatarSelection() {
            document.getElementById('editSelectedAvatar').value = '';
            renderAvatarGrid();
        }
        
        function showAddStudentForm() {
            document.getElementById('editStudentTitle').textContent = '‚ûï Add Student';
            document.getElementById('editStudentId').value = '';
            document.getElementById('editSelectedAvatar').value = '';
            document.getElementById('editFirstName').value = '';
            document.getElementById('editLastName').value = '';
            document.getElementById('editPreferredName').value = '';
            document.getElementById('editPhotoUrl').value = '';
            currentAvatarTab = 'cartoon';
            document.querySelectorAll('.avatar-tab').forEach((btn, i) => {
                btn.classList.toggle('active', i === 0);
            });
            renderAvatarGrid();
            document.getElementById('editStudentModal').classList.add('open');
        }
        
        function showEditStudentForm(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            document.getElementById('editStudentTitle').textContent = '‚úèÔ∏è Edit Student';
            document.getElementById('editStudentId').value = studentId;
            document.getElementById('editFirstName').value = student.firstName || '';
            document.getElementById('editLastName').value = student.lastName || '';
            document.getElementById('editPreferredName').value = student.preferredName || '';
            
            const existingPhoto = student.caricature || student.caricatures?.photo || '';
            if (existingPhoto.includes('dicebear.com')) {
                document.getElementById('editSelectedAvatar').value = existingPhoto;
                document.getElementById('editPhotoUrl').value = '';
            } else {
                document.getElementById('editSelectedAvatar').value = '';
                document.getElementById('editPhotoUrl').value = existingPhoto;
            }
            
            currentAvatarTab = 'cartoon';
            document.querySelectorAll('.avatar-tab').forEach((btn, i) => {
                btn.classList.toggle('active', i === 0);
            });
            renderAvatarGrid();
            document.getElementById('editStudentModal').classList.add('open');
        }
        
        function closeEditStudent() {
            document.getElementById('editStudentModal').classList.remove('open');
        }
        
        function saveStudent() {
            const idVal = document.getElementById('editStudentId').value;
            const firstName = document.getElementById('editFirstName').value.trim();
            const lastName = document.getElementById('editLastName').value.trim();
            const preferredName = document.getElementById('editPreferredName').value.trim();
            const selectedAvatar = document.getElementById('editSelectedAvatar').value.trim();
            const photoUrl = document.getElementById('editPhotoUrl').value.trim();
            
            // Use selected avatar, or photo URL, or generate from name
            const finalPhoto = photoUrl || selectedAvatar || getAvatarUrl(firstName || 'Student', 'lorelei');
            
            if (!firstName) {
                alert('First name is required');
                return;
            }
            
            if (idVal) {
                // Edit existing
                const student = students.find(s => s.id == idVal);
                if (student) {
                    student.firstName = firstName;
                    student.lastName = lastName;
                    student.preferredName = preferredName || firstName;
                    student.lastInitial = lastName ? lastName.charAt(0) : '';
                    student.displayName = `${preferredName || firstName} ${student.lastInitial}.`;
                    student.caricature = finalPhoto;
                    if (!student.caricatures) student.caricatures = {};
                    student.caricatures.photo = finalPhoto;
                    showToast(`Updated ${firstName}`);
                }
            } else {
                // Add new
                const newId = Math.max(0, ...students.map(s => s.id)) + 1;
                const lastInit = lastName ? lastName.charAt(0) : '';
                const newStudent = {
                    id: newId,
                    firstName,
                    lastName,
                    lastInitial: lastInit,
                    preferredName: preferredName || firstName,
                    displayName: `${preferredName || firstName} ${lastInit}.`,
                    status: 'unchecked',
                    caricature: finalPhoto,
                    caricatures: { photo: finalPhoto },
                    position: addStudentPosition || calculateNewStudentPosition(students.length)
                };
                
                students.push(newStudent);
                addStudentPosition = null;
                showToast(`Added ${firstName}`);
            }
            
            closeEditStudent();
            saveClass();
            renderCanvas();
            renderStudentManagerList();
        }
        
        function editStudent() {
            if (!contextStudentId) return;
            closeContextMenu();
            showEditStudentForm(contextStudentId);
        }
        
        function removeStudent() {
            if (!contextStudentId) return;
            confirmRemoveStudent(contextStudentId);
            closeContextMenu();
        }
        
        function confirmRemoveStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const name = student.displayName || student.firstName;
            if (!confirm(`Remove ${name} from the class?`)) return;
            
            students = students.filter(s => s.id !== studentId);
            saveClass();
            renderCanvas();
            renderStudentManagerList();
            showToast(`Removed ${name}`);
        }
        
        function addStudentAtPosition() {
            closeCanvasContextMenu();
            showAddStudentForm();
        }
        
        function openCanvasContextMenu(event) {
            const menu = document.getElementById('canvasContextMenu');
            addStudentPosition = {
                x: event.offsetX - 50,
                y: event.offsetY - 50
            };
            // Smart positioning - keep menu on screen
            positionContextMenu(menu, event.clientX, event.clientY);
            menu.classList.add('open');
        }
        
        function closeCanvasContextMenu() {
            document.getElementById('canvasContextMenu').classList.remove('open');
        }
        
        // ========== MINI OVERLAY ==========
        let miniOverlayOpen = false;
        let miniOpacity = 0.9;
        let miniDragState = null;
        
        function toggleMiniOverlay() {
            miniOverlayOpen = !miniOverlayOpen;
            const overlay = document.getElementById('miniOverlay');
            const btn = document.getElementById('miniModeBtn');
            
            if (miniOverlayOpen) {
                overlay.classList.add('open');
                btn.classList.add('active');
                btn.textContent = 'üìå Mini ON';
                renderMiniGrid();
            } else {
                overlay.classList.remove('open');
                btn.classList.remove('active');
                btn.textContent = 'üìå Mini Overlay';
            }
        }
        
        function renderMiniGrid() {
            if (!miniOverlayOpen) return;
            
            const grid = document.getElementById('miniGrid');
            let ontime = 0, late = 0, absent = 0;
            
            const html = students.map(s => {
                const status = s.status || 'unchecked';
                const name = s.preferredName || s.firstName || '';
                const shortName = name.length > 6 ? name.substring(0, 5) + '‚Ä¶' : name;
                const img = getStudentImage(s);
                
                if (status === 'ontime') ontime++;
                else if (status === 'late') late++;
                else if (status !== 'excused' && status !== 'withdrawn') absent++;
                
                const lateBadge = s.lateBy ? `<div class="late-badge">+${s.lateBy}m</div>` : '';
                
                return `
                    <div class="mini-student ${status}" onclick="miniCheckIn(${s.id})" title="${name}">
                        <img src="${img}" alt="${name}">
                        <div class="name">${shortName}</div>
                        ${lateBadge}
                    </div>
                `;
            }).join('');
            
            grid.innerHTML = html;
            
            // Update mini stats
            document.getElementById('miniOntime').textContent = ontime;
            document.getElementById('miniLate').textContent = late;
            document.getElementById('miniAbsent').textContent = absent;
        }
        
        function miniCheckIn(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // If already checked in, show quick menu
            if (student.status === 'ontime' || student.status === 'late') {
                // Toggle through: ontime -> late -> absent -> clear
                if (student.status === 'ontime') {
                    student.status = 'late';
                    const now = new Date();
                    const start = parseTime(schedule.startTime);
                    student.lateBy = Math.max(1, Math.floor((now - start) / 60000));
                } else if (student.status === 'late') {
                    student.status = 'absent';
                    student.lateBy = null;
                } else {
                    student.status = 'unchecked';
                    student.lateBy = null;
                }
                saveAttendance(student);
            } else {
                // Check in
                checkInStudent(student);
            }
            
            renderMiniGrid();
            renderCanvas();
            updateStats();
            saveClass();
        }
        
        function adjustMiniOpacity(delta) {
            miniOpacity = Math.max(0.3, Math.min(1, miniOpacity + delta));
            document.getElementById('miniOverlay').style.opacity = miniOpacity;
        }
        
        // Make mini overlay draggable
        function initMiniDrag() {
            const header = document.getElementById('miniHeader');
            const overlay = document.getElementById('miniOverlay');
            
            header.addEventListener('mousedown', (e) => {
                if (e.target.closest('.mini-btn')) return;
                
                miniDragState = {
                    startX: e.clientX,
                    startY: e.clientY,
                    origLeft: overlay.offsetLeft,
                    origTop: overlay.offsetTop
                };
                
                document.addEventListener('mousemove', onMiniDrag);
                document.addEventListener('mouseup', endMiniDrag);
            });
        }
        
        function onMiniDrag(e) {
            if (!miniDragState) return;
            
            const overlay = document.getElementById('miniOverlay');
            const dx = e.clientX - miniDragState.startX;
            const dy = e.clientY - miniDragState.startY;
            
            let newLeft = miniDragState.origLeft + dx;
            let newTop = miniDragState.origTop + dy;
            
            // Keep on screen
            newLeft = Math.max(0, Math.min(window.innerWidth - overlay.offsetWidth, newLeft));
            newTop = Math.max(0, Math.min(window.innerHeight - overlay.offsetHeight, newTop));
            
            overlay.style.left = newLeft + 'px';
            overlay.style.top = newTop + 'px';
            overlay.style.right = 'auto';
        }
        
        function endMiniDrag() {
            miniDragState = null;
            document.removeEventListener('mousemove', onMiniDrag);
            document.removeEventListener('mouseup', endMiniDrag);
        }
        
        // Pop out to separate window
        let popoutWindow = null;
        
        function popOutMini() {
            // Calculate tall & thin layout (3 columns, sidebar style)
            const count = students.length || 30;
            const cols = 3; // Fixed 3 columns for tall/thin layout
            const rows = Math.ceil(count / cols);
            const tileSize = 58; // Tile height including name
            const width = 200; // Narrow sidebar width
            const height = Math.max(300, rows * tileSize + 80); // Fit all rows + header/footer
            
            // Open popup window
            popoutWindow = window.open('', 'HallPassMini', 
                `width=${width},height=${height},top=50,left=${screen.width - width - 50},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`
            );
            
            if (!popoutWindow) {
                alert('Popup blocked! Please allow popups for this site.');
                return;
            }
            
            // Build the popup HTML
            const popupHTML = buildPopoutHTML();
            popoutWindow.document.write(popupHTML);
            popoutWindow.document.close();
            
            // Set proper window title
            popoutWindow.document.title = 'üìã Attendance';
            
            // Close the in-page overlay
            toggleMiniOverlay();
            
            // Set up communication
            popoutWindow.hallPassData = {
                students: students,
                schedule: schedule,
                checkIn: (id) => {
                    miniCheckIn(id);
                    updatePopoutWindow();
                }
            };
            
            // Update popup periodically
            const updateInterval = setInterval(() => {
                if (popoutWindow.closed) {
                    clearInterval(updateInterval);
                    return;
                }
                updatePopoutWindow();
            }, 2000);
            
            showToast('ü™ü Popped out! Use Win+Ctrl+T (PowerToys) to keep on top');
        }
        
        function buildPopoutHTML() {
            return `<!DOCTYPE html>
<html>
<head>
    <title>üìã Hall Pass</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a2e;
            color: white;
            padding: 4px;
            min-height: 100vh;
            overflow: hidden;
            user-select: none;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 6px;
            background: #252540;
            border-radius: 5px;
            margin-bottom: 4px;
            font-size: 10px;
        }
        .tabs { display: flex; gap: 2px; }
        .tab {
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            background: transparent;
            border: none;
            color: #888;
            font-size: 11px;
            transition: all 0.15s;
        }
        .tab:hover { color: #fff; background: #333; }
        .tab.active { background: #818cf8; color: white; }
        .stats { display: flex; gap: 4px; }
        .stat {
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 10px;
        }
        .stat.ontime { background: #22c55e; }
        .stat.late { background: #f59e0b; color: black; }
        .stat.absent { background: #ef4444; }
        .grid-container {
            height: calc(100vh - 46px);
            overflow: hidden;
            display: flex;
            align-items: start;
        }
        .grid {
            display: grid;
            gap: 4px;
            padding: 2px;
            height: 100%;
            align-content: start;
        }
        .student {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.12s;
            aspect-ratio: 1;
            min-width: 0;
            overflow: hidden;
        }
        .student:hover { background: #2d2d4a; transform: scale(1.02); }
        .student.unchecked { opacity: 0.5; }
        .student.ontime { border-color: #22c55e; background: rgba(34,197,94,0.15); }
        .student.late { border-color: #f59e0b; background: rgba(245,158,11,0.15); }
        .student.absent { border-color: #ef4444; background: rgba(239,68,68,0.1); opacity: 0.5; }
        .student.excused { border-color: #6366f1; background: rgba(99,102,241,0.1); opacity: 0.6; }
        .student.on-pass { border-color: #06b6d4; background: rgba(6,182,212,0.15); animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100% { box-shadow: 0 0 0 0 rgba(6,182,212,0.4); } 50% { box-shadow: 0 0 0 4px rgba(6,182,212,0); } }
        .student img { width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; }
        .student .name { font-size: 11px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; line-height: 1.2; margin-top: 2px; font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .student .badge { font-size: 7px; font-weight: 600; line-height: 1; }
        .student .badge.late-badge { color: #fbbf24; }
        .student .badge.streak-badge { color: #22c55e; }
        .student .badge.broken-badge { color: #f87171; }
        .student .badge.pass-badge { color: #06b6d4; }
        .context-menu {
            position: fixed;
            background: #252540;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 4px 0;
            min-width: 140px;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .context-menu.open { display: block; }
        .context-menu-item {
            padding: 6px 12px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .context-menu-item:hover { background: #333; }
        .context-menu-divider { border-top: 1px solid #444; margin: 4px 0; }
        .help-tip {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1e1e32;
            padding: 2px 6px;
            font-size: 8px;
            color: #555;
            text-align: center;
        }
        .help-tip strong { color: #818cf8; }
        .mode-groups .grid { gap: 8px; }
        .group-section { background: #252540; border-radius: 8px; padding: 6px; }
        .group-title { font-size: 10px; color: #888; margin-bottom: 4px; text-align: center; }
    </style>
</head>
<body>
    <div class="header">
        <div class="tabs">
            <button class="tab active" onclick="setMode('attendance')">üìã</button>
            <button class="tab" onclick="setMode('passes')">üö∂</button>
            <button class="tab" onclick="setMode('groups')">üë•</button>
        </div>
        <div class="stats" id="statsBar">
            <span class="stat ontime" id="statOn">0</span>
            <span class="stat late" id="statLate">0</span>
            <span class="stat absent" id="statAbs">0</span>
        </div>
    </div>
    <div class="grid-container">
        <div class="grid" id="grid"></div>
    </div>
    <div class="context-menu" id="ctxMenu"></div>
    <div class="help-tip">üìå <strong>Win+Ctrl+T</strong> to pin on top</div>
    <script>
        let currentMode = 'attendance';
        let contextStudentId = null;
        
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab').forEach((t,i) => {
                t.classList.toggle('active', 
                    (mode === 'attendance' && i === 0) ||
                    (mode === 'passes' && i === 1) ||
                    (mode === 'groups' && i === 2)
                );
            });
            render();
        }
        
        function calcGrid() {
            const data = window.hallPassData;
            if (!data) return { cols: 3, size: 50 };
            const count = data.students.length;
            const container = document.querySelector('.grid-container');
            const w = container.clientWidth - 8;
            const h = container.clientHeight - 8;
            // Default to 3 columns (tall/thin), allow 2-4 based on window width
            let cols = 3;
            if (w < 140) cols = 2;
            else if (w > 280) cols = 4;
            const rows = Math.ceil(count / cols);
            const tileW = Math.floor((w - (cols - 1) * 4) / cols);
            const tileH = Math.floor((h - (rows - 1) * 4) / rows);
            const size = Math.min(tileW, tileH, 65); // Cap at 65px
            return { cols: cols, size: Math.max(40, size) };
        }
        
        function getDisplayName(s) {
            const first = s.preferredName || s.firstName || '';
            const last = s.lastName || '';
            const initial = last ? last.charAt(0).toUpperCase() + '.' : '';
            return first.length > 7 ? first.substring(0,6) + '.' : first + (initial ? ' ' + initial : '');
        }
        
        function render() {
            const data = window.hallPassData;
            if (!data) return;
            
            const grid = document.getElementById('grid');
            const { cols, size } = calcGrid();
            grid.style.gridTemplateColumns = 'repeat(' + cols + ', ' + size + 'px)';
            
            let on = 0, late = 0, abs = 0;
            
            if (currentMode === 'groups' && data.groups && data.groups.length > 0) {
                // Groups mode
                document.getElementById('statsBar').style.display = 'none';
                grid.innerHTML = data.groups.map((group, gi) => {
                    return '<div class="group-section"><div class="group-title">Group ' + (gi+1) + '</div><div style="display:flex;flex-wrap:wrap;gap:3px;justify-content:center;">' +
                        group.map(sid => {
                            const s = data.students.find(st => st.id === sid);
                            if (!s) return '';
                            const img = s.caricature || s.caricatures?.photo || 'https://api.dicebear.com/7.x/lorelei/svg?seed=' + s.firstName;
                            return '<div style="text-align:center;"><img src="' + img + '" style="width:32px;height:32px;border-radius:50%;"><div style="font-size:8px;">' + (s.preferredName || s.firstName || '').substring(0,6) + '</div></div>';
                        }).join('') +
                    '</div></div>';
                }).join('');
                return;
            }
            
            document.getElementById('statsBar').style.display = 'flex';
            
            // Filter for passes mode
            let displayStudents = data.students;
            if (currentMode === 'passes') {
                displayStudents = data.students.filter(s => s.hallPass || s.status === 'ontime' || s.status === 'late');
            }
            
            grid.innerHTML = displayStudents.map(s => {
                const status = s.hallPass ? 'on-pass' : (s.status || 'unchecked');
                const name = getDisplayName(s);
                const img = s.caricature || s.caricatures?.photo || 'https://api.dicebear.com/7.x/lorelei/svg?seed=' + s.firstName;
                
                if (s.status === 'ontime') on++;
                else if (s.status === 'late') late++;
                else if (s.status !== 'excused' && !s.hallPass) abs++;
                
                let badge = '';
                if (s.hallPass) {
                    const mins = Math.floor((Date.now() - s.hallPass.startTime) / 60000);
                    badge = '<div class="badge pass-badge">üö∂ ' + mins + 'm</div>';
                } else if (s.lateBy) {
                    badge = '<div class="badge late-badge">+' + s.lateBy + 'm late</div>';
                }
                
                // Streak info
                const streak = data.streaks && data.streaks[s.id];
                if (streak && streak.current >= 3 && !s.hallPass) {
                    badge += '<div class="badge streak-badge">' + (streak.current >= 5 ? 'üî•' : '‚ö°') + streak.current + '</div>';
                }
                if (streak && streak.broken) {
                    badge = '<div class="badge broken-badge">üíî streak</div>' + badge;
                }
                
                return '<div class="student ' + status + '" onclick="handleClick(event,' + s.id + ')" oncontextmenu="showCtx(event,' + s.id + ')" data-id="' + s.id + '">' +
                    '<img src="' + img + '">' +
                    '<div class="name">' + name + '</div>' +
                    badge +
                '</div>';
            }).join('');
            
            document.getElementById('statOn').textContent = on;
            document.getElementById('statLate').textContent = late;
            document.getElementById('statAbs').textContent = abs;
        }
        
        function handleClick(e, id) {
            e.preventDefault();
            if (currentMode === 'passes') {
                // Toggle hall pass
                window.hallPassData.togglePass(id);
            } else {
                // Check in
                window.hallPassData.checkIn(id);
            }
        }
        
        function showCtx(e, id) {
            e.preventDefault();
            contextStudentId = id;
            const menu = document.getElementById('ctxMenu');
            const s = window.hallPassData.students.find(st => st.id === id);
            if (!s) return;
            
            const passOption = s.hallPass 
                ? '<div class="context-menu-item" onclick="doAction(\\'endPass\\')">üèÅ End Hall Pass</div>'
                : '<div class="context-menu-item" onclick="doAction(\\'startPass\\')">üö∂ Start Hall Pass</div>';
            
            menu.innerHTML = 
                '<div class="context-menu-item" onclick="doAction(\\'ontime\\')">‚úÖ Mark On-Time</div>' +
                '<div class="context-menu-item" onclick="doAction(\\'late\\')">‚è∞ Mark Late</div>' +
                '<div class="context-menu-item" onclick="doAction(\\'absent\\')">‚ùå Mark Absent</div>' +
                '<div class="context-menu-item" onclick="doAction(\\'excused\\')">üìù Mark Excused</div>' +
                '<div class="context-menu-divider"></div>' +
                passOption +
                '<div class="context-menu-divider"></div>' +
                '<div class="context-menu-item" onclick="doAction(\\'clear\\')">üîÑ Clear / Reset</div>';
            
            // Position menu
            let x = e.clientX, y = e.clientY;
            menu.classList.add('open');
            const rect = menu.getBoundingClientRect();
            if (x + rect.width > window.innerWidth) x = window.innerWidth - rect.width - 5;
            if (y + rect.height > window.innerHeight) y = window.innerHeight - rect.height - 5;
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
        }
        
        function doAction(action) {
            document.getElementById('ctxMenu').classList.remove('open');
            if (!contextStudentId) return;
            window.hallPassData.doAction(contextStudentId, action);
        }
        
        document.addEventListener('click', e => {
            if (!e.target.closest('.context-menu')) {
                document.getElementById('ctxMenu').classList.remove('open');
            }
        });
        
        window.addEventListener('resize', () => render());
        setInterval(render, 1000);
        setTimeout(render, 100);
    <\/script>
</body>
</html>`;
        }
        
        function updatePopoutWindow() {
            if (!popoutWindow || popoutWindow.closed) return;
            popoutWindow.hallPassData = {
                students: students,
                schedule: schedule,
                streaks: streaks,
                groups: currentGroups,
                checkIn: (id) => {
                    miniCheckIn(id);
                    updatePopoutWindow();
                },
                togglePass: (id) => {
                    const student = students.find(s => s.id === id);
                    if (!student) return;
                    if (student.hallPass) {
                        // End pass
                        student.hallPass = null;
                    } else {
                        // Start pass
                        student.hallPass = { startTime: Date.now(), reason: 'Hall pass' };
                    }
                    saveToLocalStorage();
                    updatePopoutWindow();
                    renderCanvas();
                },
                doAction: (id, action) => {
                    const student = students.find(s => s.id === id);
                    if (!student) return;
                    
                    switch(action) {
                        case 'ontime':
                            student.status = 'ontime';
                            student.lateBy = null;
                            saveAttendance(student);
                            break;
                        case 'late':
                            student.status = 'late';
                            const now = new Date();
                            const start = parseTime(schedule.startTime);
                            student.lateBy = Math.max(1, Math.floor((now - start) / 60000));
                            saveAttendance(student);
                            break;
                        case 'absent':
                            student.status = 'absent';
                            student.lateBy = null;
                            saveAttendance(student);
                            break;
                        case 'excused':
                            student.status = 'excused';
                            student.lateBy = null;
                            saveAttendance(student);
                            break;
                        case 'clear':
                            student.status = 'unchecked';
                            student.lateBy = null;
                            student.hallPass = null;
                            saveAttendance(student);
                            break;
                        case 'startPass':
                            student.hallPass = { startTime: Date.now(), reason: 'Hall pass' };
                            saveToLocalStorage();
                            break;
                        case 'endPass':
                            student.hallPass = null;
                            saveToLocalStorage();
                            break;
                    }
                    
                    updatePopoutWindow();
                    renderCanvas();
                }
            };
        }
        
        // Calculate position for a new student
        function calculateNewStudentPosition(currentCount) {
            const cardWidth = 100;
            const cardHeight = 130;
            const padding = 20;
            const gap = 15;
            
            // Use same column calculation as renderCanvas
            const totalCount = currentCount + 1;
            let cols = Math.min(10, Math.max(4, Math.ceil(Math.sqrt(totalCount * 1.5))));
            
            return {
                x: padding + (currentCount % cols) * (cardWidth + gap),
                y: padding + Math.floor(currentCount / cols) * (cardHeight + gap)
            };
        }
        
        // ========== UTILS ==========
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function spawnConfetti() {
            const colors = ['#22c55e', '#f59e0b', '#3b82f6', '#ec4899', '#8b5cf6'];
            for (let i = 0; i < 20; i++) {
                const conf = document.createElement('div');
                conf.className = 'confetti';
                conf.style.left = (Math.random() * window.innerWidth) + 'px';
                conf.style.top = (window.innerHeight - 100) + 'px';
                conf.style.background = colors[Math.floor(Math.random() * colors.length)];
                conf.style.animationDelay = (Math.random() * 0.5) + 's';
                document.body.appendChild(conf);
                setTimeout(() => conf.remove(), 1500);
            }
        }
        
        // ========== INIT ==========
        document.addEventListener('click', e => {
            if (!e.target.closest('.context-menu') && !e.target.closest('.canvas-student')) {
                closeContextMenu();
                closeCanvasContextMenu();
            }
        });
        
        // Context menu handling
        document.addEventListener('contextmenu', e => {
            const canvas = e.target.closest('.seating-canvas');
            const studentCard = e.target.closest('.canvas-student');
            
            if (studentCard) {
                // Right-click on student - handled by handleStudentClick
                e.preventDefault();
            } else if (canvas) {
                // Right-click on empty canvas area
                e.preventDefault();
                closeContextMenu();
                openCanvasContextMenu(e);
            }
        });
        
        // Load and start
        loadSavedData();
        
        // Check if it's a new day and reset attendance statuses
        checkNewDayReset();
        
        function checkNewDayReset() {
            const today = getToday();
            const lastActiveDay = localStorage.getItem('hallpass_lastActiveDay');
            
            if (lastActiveDay && lastActiveDay !== today) {
                // It's a new day! Reset all student statuses to unchecked
                console.log('New day detected, resetting attendance statuses');
                
                // Reset statuses for all classes
                Object.values(allClasses).forEach(cls => {
                    if (cls.students) {
                        cls.students.forEach(s => {
                            s.status = 'unchecked';
                            s.checkInTime = null;
                            s.lateBy = null;
                            s.statusText = null;
                        });
                    }
                });
                
                // Reset current class students too
                students.forEach(s => {
                    s.status = 'unchecked';
                    s.checkInTime = null;
                    s.lateBy = null;
                    s.statusText = null;
                });
                
                // Save the reset
                localStorage.setItem('hallpass_allClasses', JSON.stringify(allClasses));
                
                showToast('üìÖ New day - attendance reset');
            }
            
            // Update last active day
            localStorage.setItem('hallpass_lastActiveDay', today);
        }
        
        // Check for data loss: assignments exist but no class data
        const hasAssignments = Object.values(classAssignments).some(a => a && a.classId);
        const hasClasses = Object.keys(allClasses).length > 0;
        
        if (hasAssignments && !hasClasses) {
            console.warn('Class assignments exist but no class data - data may have been lost');
            // Show a helpful message instead of broken prep screen
            const canvas = document.getElementById('seatingCanvas');
            if (canvas) {
                canvas.innerHTML = `
                    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text-secondary);gap:16px;">
                        <div style="font-size:4rem;">‚ö†Ô∏è</div>
                        <div style="font-size:1.5rem;font-weight:600;color:var(--warning);">Class Data Lost</div>
                        <div style="font-size:0.9rem;max-width:400px;text-align:center;">
                            Your schedule settings are saved, but the class roster data was cleared.<br><br>
                            Please re-import your classes in Settings.
                        </div>
                        <button class="btn btn-primary" onclick="openSettings()" style="margin-top:16px;">
                            ‚öôÔ∏è Open Settings
                        </button>
                    </div>
                `;
            }
        } else {
            renderCanvas();
        }
        
        updateStatusBar();
        updateRemoveButtonVisibility();
        initMiniDrag();
        
        // Update countdown every second
        setInterval(updateStatusBar, 1000);
        
        // Update mini overlay when open
        setInterval(() => {
            if (miniOverlayOpen) renderMiniGrid();
        }, 5000);
    </script>
</body>
</html>
