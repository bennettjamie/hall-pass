<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hall Pass - Import Class</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-card: #252540;
            --accent: #6366f1;
            --accent-light: #818cf8;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --border: rgba(255,255,255,0.1);
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        /* Upload Section */
        .upload-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 24px;
        }
        
        .upload-card {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 48px;
            text-align: center;
            max-width: 500px;
        }
        
        .upload-card h1 { margin-bottom: 8px; }
        .upload-card .subtitle { color: var(--text-secondary); margin-bottom: 32px; }
        
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 48px 24px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .upload-zone:hover {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
        }
        
        .upload-icon { font-size: 3rem; margin-bottom: 16px; }
        
        /* Processing Section */
        .processing-container {
            display: none;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 24px;
        }
        
        .processing-card {
            background: var(--bg-card);
            border-radius: 24px;
            padding: 48px;
            text-align: center;
            max-width: 500px;
        }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--bg-secondary);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 24px;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .progress-text { color: var(--text-secondary); }
        
        /* Selection Section */
        .selection-container {
            display: none;
            height: 100vh;
        }
        
        .selection-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            height: 100%;
        }
        
        /* PDF Viewer */
        .pdf-viewer {
            background: #000;
            position: relative;
            overflow: hidden;
        }
        
        .pdf-canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: auto;
            cursor: crosshair;
        }
        
        #pdfCanvas {
            display: block;
        }
        
        .selection-rect {
            position: absolute;
            border: 3px solid var(--accent);
            background: rgba(99, 102, 241, 0.2);
            pointer-events: none;
        }
        
        .suggestion-rect {
            position: absolute;
            border: 3px dashed var(--success);
            background: rgba(34, 197, 94, 0.2);
            pointer-events: none;
        }
        
        .name-marker {
            position: absolute;
            background: var(--warning);
            color: black;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            pointer-events: none;
        }
        
        /* Sidebar */
        .sidebar {
            background: var(--bg-secondary);
            padding: 24px;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border);
        }
        
        .sidebar-header {
            margin-bottom: 24px;
        }
        
        .sidebar-header h2 {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }
        
        .progress-bar {
            height: 6px;
            background: var(--bg-card);
            border-radius: 3px;
            margin-top: 12px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s;
        }
        
        .current-student {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }
        
        .current-student h3 {
            font-size: 1.4rem;
            margin-bottom: 4px;
        }
        
        .current-student .instruction {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 16px;
        }
        
        .current-preview {
            width: 100px;
            height: 100px;
            background: var(--bg-secondary);
            border-radius: 50%;
            margin: 0 auto 16px;
            overflow: hidden;
            border: 3px solid var(--border);
        }
        
        .current-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .btn {
            padding: 12px 20px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            font-size: 0.95rem;
            transition: all 0.2s;
            margin-bottom: 8px;
        }
        
        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: var(--accent-light); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-success { background: var(--success); color: white; }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); }
        
        .btn-row {
            display: flex;
            gap: 8px;
        }
        
        .btn-row .btn {
            flex: 1;
        }
        
        .pattern-status {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            font-size: 0.85rem;
        }
        
        .pattern-status.learned {
            border: 1px solid var(--success);
            background: rgba(34, 197, 94, 0.1);
        }
        
        .pattern-status .icon { margin-right: 8px; }
        
        .student-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 16px;
        }
        
        .student-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .student-item:hover { background: var(--bg-card); }
        .student-item.current { background: var(--accent); }
        .student-item.done { opacity: 0.6; }
        
        .student-item .photo {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--bg-card);
            overflow: hidden;
        }
        
        .student-item .photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .student-item .name {
            flex: 1;
            font-size: 0.9rem;
        }
        
        .student-item .status {
            font-size: 1.1rem;
        }
        
        /* Review Section */
        .review-container {
            display: none;
            min-height: 100vh;
            padding: 24px;
        }
        
        .review-header {
            max-width: 1200px;
            margin: 0 auto 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }
        
        .review-header h1 { font-size: 1.5rem; }
        
        .class-input {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .class-input input {
            padding: 12px 16px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 1rem;
            width: 250px;
        }
        
        .review-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 16px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .review-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
        }
        
        .review-card img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 12px;
            border: 2px solid var(--border);
        }
        
        .review-card .name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .review-card .pos {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }
        
        #cropCanvas { display: none; }
    </style>
</head>
<body>
    <!-- Step 1: Upload -->
    <div class="upload-container" id="uploadSection">
        <div class="upload-card">
            <h1>üéüÔ∏è Hall Pass</h1>
            <p class="subtitle">Import class from PDF seating chart</p>
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">üìÑ</div>
                <div>Drop PDF here or click to browse</div>
            </div>
            <input type="file" id="pdfInput" accept=".pdf" style="display:none">
        </div>
    </div>
    
    <!-- Step 2: Processing -->
    <div class="processing-container" id="processingSection">
        <div class="processing-card">
            <div class="spinner"></div>
            <h2>Processing PDF...</h2>
            <p class="progress-text" id="processingStatus">Loading PDF...</p>
        </div>
    </div>
    
    <!-- Step 3: Face Selection -->
    <div class="selection-container" id="selectionSection">
        <div class="selection-layout">
            <div class="pdf-viewer">
                <div class="pdf-canvas-container" id="canvasContainer">
                    <canvas id="pdfCanvas"></canvas>
                </div>
            </div>
            <div class="sidebar">
                <div class="sidebar-header">
                    <h2>Select Faces</h2>
                    <p id="progressText">0 of 0 students</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
                
                <div class="current-student" id="currentStudent">
                    <h3 id="currentName">Loading...</h3>
                    <p class="instruction" id="instruction">Draw a rectangle around this student's face</p>
                    <div class="current-preview" id="currentPreview"></div>
                    <button class="btn btn-primary" id="confirmBtn" disabled onclick="confirmSelection()">
                        ‚úì Confirm Face
                    </button>
                    <div class="btn-row">
                        <button class="btn btn-secondary" onclick="skipStudent()">Skip</button>
                        <button class="btn btn-secondary" onclick="clearSelection()">Clear</button>
                    </div>
                </div>
                
                <div class="pattern-status" id="patternStatus">
                    <span class="icon">üîç</span>
                    <span>Learning pattern... Select a few faces</span>
                </div>
                
                <div class="student-list" id="studentList"></div>
            </div>
        </div>
    </div>
    
    <!-- Step 4: Review -->
    <div class="review-container" id="reviewSection">
        <div class="review-header">
            <h1>‚úì Review & Save</h1>
            <div class="class-input">
                <input type="text" id="className" placeholder="Class name">
                <button class="btn btn-primary" style="width:auto" onclick="saveClass()">üíæ Save Class</button>
            </div>
        </div>
        <div class="review-grid" id="reviewGrid"></div>
    </div>
    
    <canvas id="cropCanvas"></canvas>
    
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        // State
        let students = [];
        let currentIndex = 0;
        let pdfCanvas, pdfCtx;
        let scale = 1;
        
        // Selection state
        let isDrawing = false;
        let startX, startY;
        let currentRect = null;
        let selectionDiv = null;
        
        // Pattern learning
        let patterns = []; // Array of {nameX, nameY, photoOffsetX, photoOffsetY, photoWidth, photoHeight}
        let patternLearned = false;
        
        // Upload handlers
        document.getElementById('uploadZone').addEventListener('click', () => {
            document.getElementById('pdfInput').click();
        });
        
        document.getElementById('pdfInput').addEventListener('change', (e) => {
            if (e.target.files[0]) processPDF(e.target.files[0]);
        });
        
        document.getElementById('uploadZone').addEventListener('dragover', (e) => {
            e.preventDefault();
            e.currentTarget.style.borderColor = 'var(--accent)';
        });
        
        document.getElementById('uploadZone').addEventListener('drop', (e) => {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file?.type === 'application/pdf') processPDF(file);
        });
        
        async function processPDF(file) {
            showSection('processingSection');
            
            try {
                // Load PDF
                setStatus('Loading PDF...');
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                // Render page
                setStatus('Rendering page...');
                const page = await pdf.getPage(1);
                scale = 2;
                const viewport = page.getViewport({ scale });
                
                pdfCanvas = document.getElementById('pdfCanvas');
                pdfCtx = pdfCanvas.getContext('2d');
                pdfCanvas.width = viewport.width;
                pdfCanvas.height = viewport.height;
                
                await page.render({ canvasContext: pdfCtx, viewport }).promise;
                
                // Extract class name from filename
                document.getElementById('className').value = file.name.replace('.pdf', '').replace(/[_-]/g, ' ');
                
                // Run OCR
                setStatus('Finding names (this takes 30-60 seconds)...');
                const worker = await Tesseract.createWorker('eng');
                const { data } = await worker.recognize(pdfCanvas);
                await worker.terminate();
                
                // Find name patterns
                setStatus('Analyzing names...');
                const namePattern = /([A-Z][a-z]+(?:-[A-Z][a-z]+)?),\s*([A-Z][a-z]+)/g;
                let match;
                
                while ((match = namePattern.exec(data.text)) !== null) {
                    const lastName = match[1];
                    const firstName = match[2];
                    
                    // Find position in OCR data
                    const wordData = findWordPosition(data.words, lastName);
                    
                    students.push({
                        firstName,
                        lastName,
                        lastInitial: lastName[0],
                        displayName: firstName + ' ' + lastName[0] + '.',
                        namePosition: wordData ? { x: wordData.x, y: wordData.y, w: wordData.w, h: wordData.h } : null,
                        photoRect: null,
                        photoData: null,
                        confirmed: false
                    });
                }
                
                if (students.length === 0) {
                    alert('No student names found in PDF. Please check the file.');
                    showSection('uploadSection');
                    return;
                }
                
                // Sort by position (top to bottom, left to right)
                students.sort((a, b) => {
                    if (!a.namePosition || !b.namePosition) return 0;
                    const rowDiff = Math.floor(a.namePosition.y / 100) - Math.floor(b.namePosition.y / 100);
                    if (rowDiff !== 0) return rowDiff;
                    return a.namePosition.x - b.namePosition.x;
                });
                
                // Assign IDs and positions
                let row = 0, col = 0, lastY = -1;
                students.forEach((s, i) => {
                    s.id = i + 1;
                    if (s.namePosition) {
                        const currentY = Math.floor(s.namePosition.y / 150);
                        if (lastY !== -1 && currentY > lastY) {
                            row++;
                            col = 0;
                        }
                        lastY = currentY;
                    }
                    s.position = { row, col };
                    col++;
                });
                
                // Start selection process
                initSelection();
                showSection('selectionSection');
                
            } catch (err) {
                alert('Error processing PDF: ' + err.message);
                showSection('uploadSection');
            }
        }
        
        function findWordPosition(words, searchText) {
            for (const word of words) {
                if (word.text.includes(searchText) && word.confidence > 50) {
                    return {
                        x: word.bbox.x0,
                        y: word.bbox.y0,
                        w: word.bbox.x1 - word.bbox.x0,
                        h: word.bbox.y1 - word.bbox.y0
                    };
                }
            }
            return null;
        }
        
        function setStatus(text) {
            document.getElementById('processingStatus').textContent = text;
        }
        
        function showSection(id) {
            ['uploadSection', 'processingSection', 'selectionSection', 'reviewSection'].forEach(s => {
                document.getElementById(s).style.display = 'none';
            });
            document.getElementById(id).style.display = id.includes('selection') ? 'block' : 'flex';
        }
        
        function initSelection() {
            const container = document.getElementById('canvasContainer');
            
            // Mouse events for drawing
            container.addEventListener('mousedown', startDraw);
            container.addEventListener('mousemove', draw);
            container.addEventListener('mouseup', endDraw);
            container.addEventListener('mouseleave', endDraw);
            
            // Render student list
            renderStudentList();
            
            // Show first student
            showStudent(0);
            
            // Add name markers to PDF
            addNameMarkers();
        }
        
        function addNameMarkers() {
            const container = document.getElementById('canvasContainer');
            
            students.forEach((s, i) => {
                if (s.namePosition) {
                    const marker = document.createElement('div');
                    marker.className = 'name-marker';
                    marker.textContent = s.displayName;
                    marker.style.left = s.namePosition.x + 'px';
                    marker.style.top = (s.namePosition.y - 20) + 'px';
                    container.appendChild(marker);
                }
            });
        }
        
        function renderStudentList() {
            const list = document.getElementById('studentList');
            list.innerHTML = students.map((s, i) => `
                <div class="student-item ${i === currentIndex ? 'current' : ''} ${s.confirmed ? 'done' : ''}" 
                     onclick="showStudent(${i})">
                    <div class="photo">
                        ${s.photoData ? `<img src="${s.photoData}">` : ''}
                    </div>
                    <div class="name">${s.displayName}</div>
                    <div class="status">${s.confirmed ? '‚úì' : ''}</div>
                </div>
            `).join('');
        }
        
        function showStudent(index) {
            currentIndex = index;
            const student = students[index];
            
            document.getElementById('currentName').textContent = student.displayName;
            document.getElementById('progressText').textContent = `${index + 1} of ${students.length} students`;
            document.getElementById('progressFill').style.width = ((index + 1) / students.length * 100) + '%';
            
            // Update preview
            const preview = document.getElementById('currentPreview');
            if (student.photoData) {
                preview.innerHTML = `<img src="${student.photoData}">`;
            } else {
                preview.innerHTML = '';
            }
            
            // Clear any existing selection
            clearSelectionRect();
            
            // Check if we can suggest based on pattern
            if (patternLearned && student.namePosition && !student.confirmed) {
                suggestPhotoPosition(student);
            }
            
            // Scroll to name position
            if (student.namePosition) {
                const container = document.getElementById('canvasContainer');
                container.scrollTop = Math.max(0, student.namePosition.y - 100);
                container.scrollLeft = Math.max(0, student.namePosition.x - 100);
            }
            
            // Update button state
            document.getElementById('confirmBtn').disabled = !currentRect;
            
            // Update list highlight
            renderStudentList();
        }
        
        function startDraw(e) {
            const rect = pdfCanvas.getBoundingClientRect();
            const container = document.getElementById('canvasContainer');
            startX = e.clientX - rect.left + container.scrollLeft;
            startY = e.clientY - rect.top + container.scrollTop;
            isDrawing = true;
            
            clearSelectionRect();
        }
        
        function draw(e) {
            if (!isDrawing) return;
            
            const rect = pdfCanvas.getBoundingClientRect();
            const container = document.getElementById('canvasContainer');
            const currentX = e.clientX - rect.left + container.scrollLeft;
            const currentY = e.clientY - rect.top + container.scrollTop;
            
            const x = Math.min(startX, currentX);
            const y = Math.min(startY, currentY);
            const w = Math.abs(currentX - startX);
            const h = Math.abs(currentY - startY);
            
            if (!selectionDiv) {
                selectionDiv = document.createElement('div');
                selectionDiv.className = 'selection-rect';
                container.appendChild(selectionDiv);
            }
            
            selectionDiv.style.left = x + 'px';
            selectionDiv.style.top = y + 'px';
            selectionDiv.style.width = w + 'px';
            selectionDiv.style.height = h + 'px';
            
            currentRect = { x, y, w, h };
        }
        
        function endDraw() {
            if (!isDrawing) return;
            isDrawing = false;
            
            if (currentRect && currentRect.w > 20 && currentRect.h > 20) {
                // Crop and preview
                cropAndPreview();
                document.getElementById('confirmBtn').disabled = false;
            }
        }
        
        function cropAndPreview() {
            if (!currentRect) return;
            
            const cropCanvas = document.getElementById('cropCanvas');
            const cropCtx = cropCanvas.getContext('2d');
            cropCanvas.width = 150;
            cropCanvas.height = 150;
            
            cropCtx.drawImage(
                pdfCanvas,
                currentRect.x, currentRect.y, currentRect.w, currentRect.h,
                0, 0, 150, 150
            );
            
            const photoData = cropCanvas.toDataURL('image/jpeg', 0.85);
            
            // Update preview
            document.getElementById('currentPreview').innerHTML = `<img src="${photoData}">`;
            
            // Store temporarily
            students[currentIndex].tempPhotoData = photoData;
            students[currentIndex].tempRect = { ...currentRect };
        }
        
        function confirmSelection() {
            const student = students[currentIndex];
            
            if (student.tempPhotoData) {
                student.photoData = student.tempPhotoData;
                student.photoRect = student.tempRect;
                student.confirmed = true;
                
                // Learn pattern if we have name position
                if (student.namePosition && student.photoRect) {
                    learnPattern(student);
                }
                
                // Move to next unconfirmed student
                const nextIndex = students.findIndex((s, i) => i > currentIndex && !s.confirmed);
                if (nextIndex !== -1) {
                    showStudent(nextIndex);
                } else {
                    // Check if all done
                    const allDone = students.every(s => s.confirmed);
                    if (allDone) {
                        showReview();
                    } else {
                        // Find first unconfirmed
                        const firstUnconfirmed = students.findIndex(s => !s.confirmed);
                        if (firstUnconfirmed !== -1) {
                            showStudent(firstUnconfirmed);
                        }
                    }
                }
            }
            
            renderStudentList();
        }
        
        function learnPattern(student) {
            const pattern = {
                offsetX: student.photoRect.x - student.namePosition.x,
                offsetY: student.photoRect.y - student.namePosition.y,
                width: student.photoRect.w,
                height: student.photoRect.h
            };
            
            patterns.push(pattern);
            
            // Check if pattern is consistent (learned)
            if (patterns.length >= 2) {
                const avgOffsetX = patterns.reduce((a, p) => a + p.offsetX, 0) / patterns.length;
                const avgOffsetY = patterns.reduce((a, p) => a + p.offsetY, 0) / patterns.length;
                const avgWidth = patterns.reduce((a, p) => a + p.width, 0) / patterns.length;
                const avgHeight = patterns.reduce((a, p) => a + p.height, 0) / patterns.length;
                
                // Check variance
                const consistent = patterns.every(p => 
                    Math.abs(p.offsetX - avgOffsetX) < 50 &&
                    Math.abs(p.offsetY - avgOffsetY) < 50
                );
                
                if (consistent && patterns.length >= 2) {
                    patternLearned = true;
                    document.getElementById('patternStatus').className = 'pattern-status learned';
                    document.getElementById('patternStatus').innerHTML = 
                        '<span class="icon">‚úì</span><span>Pattern learned! Auto-suggesting faces</span>';
                }
            }
        }
        
        function suggestPhotoPosition(student) {
            if (patterns.length === 0 || !student.namePosition) return;
            
            // Calculate average pattern
            const avgOffsetX = patterns.reduce((a, p) => a + p.offsetX, 0) / patterns.length;
            const avgOffsetY = patterns.reduce((a, p) => a + p.offsetY, 0) / patterns.length;
            const avgWidth = patterns.reduce((a, p) => a + p.width, 0) / patterns.length;
            const avgHeight = patterns.reduce((a, p) => a + p.height, 0) / patterns.length;
            
            const suggestedRect = {
                x: student.namePosition.x + avgOffsetX,
                y: student.namePosition.y + avgOffsetY,
                w: avgWidth,
                h: avgHeight
            };
            
            // Show suggestion
            const container = document.getElementById('canvasContainer');
            let suggestionDiv = container.querySelector('.suggestion-rect');
            if (!suggestionDiv) {
                suggestionDiv = document.createElement('div');
                suggestionDiv.className = 'suggestion-rect';
                container.appendChild(suggestionDiv);
            }
            
            suggestionDiv.style.left = suggestedRect.x + 'px';
            suggestionDiv.style.top = suggestedRect.y + 'px';
            suggestionDiv.style.width = suggestedRect.w + 'px';
            suggestionDiv.style.height = suggestedRect.h + 'px';
            suggestionDiv.style.display = 'block';
            
            // Auto-apply suggestion
            currentRect = suggestedRect;
            cropAndPreview();
            document.getElementById('confirmBtn').disabled = false;
            document.getElementById('instruction').textContent = 'Suggested face - confirm or draw a new rectangle';
        }
        
        function clearSelectionRect() {
            if (selectionDiv) {
                selectionDiv.remove();
                selectionDiv = null;
            }
            
            const container = document.getElementById('canvasContainer');
            const suggestion = container.querySelector('.suggestion-rect');
            if (suggestion) suggestion.style.display = 'none';
            
            currentRect = null;
            document.getElementById('confirmBtn').disabled = true;
            document.getElementById('instruction').textContent = 'Draw a rectangle around this student\'s face';
        }
        
        function clearSelection() {
            clearSelectionRect();
            document.getElementById('currentPreview').innerHTML = '';
            students[currentIndex].tempPhotoData = null;
            students[currentIndex].tempRect = null;
        }
        
        function skipStudent() {
            const nextIndex = students.findIndex((s, i) => i > currentIndex && !s.confirmed);
            if (nextIndex !== -1) {
                showStudent(nextIndex);
            } else {
                // Show first unconfirmed
                const firstUnconfirmed = students.findIndex(s => !s.confirmed);
                if (firstUnconfirmed !== -1) {
                    showStudent(firstUnconfirmed);
                }
            }
        }
        
        function showReview() {
            showSection('reviewSection');
            
            const grid = document.getElementById('reviewGrid');
            grid.innerHTML = students.filter(s => s.confirmed).map(s => `
                <div class="review-card">
                    <img src="${s.photoData}" alt="${s.firstName}">
                    <div class="name">${s.displayName}</div>
                    <div class="pos">Row ${s.position.row + 1}, Col ${s.position.col + 1}</div>
                </div>
            `).join('');
        }
        
        function saveClass() {
            const className = document.getElementById('className').value.trim() || 'Unnamed Class';
            const confirmedStudents = students.filter(s => s.confirmed);
            
            if (confirmedStudents.length === 0) {
                alert('No students to save.');
                return;
            }
            
            const classData = {
                version: 4,
                settings: {
                    classId: 'class_' + Date.now(),
                    className: className,
                    gridSize: { 
                        rows: Math.max(...confirmedStudents.map(s => s.position.row)) + 1,
                        cols: Math.max(...confirmedStudents.map(s => s.position.col)) + 1
                    }
                },
                styles: {
                    available: [{ id: 'photo', name: 'Photo', emoji: 'üì∑' }],
                    default: 'photo'
                },
                students: confirmedStudents.map((s, i) => ({
                    id: i + 1,
                    firstName: s.firstName,
                    lastInitial: s.lastInitial,
                    position: s.position,
                    caricatures: { photo: s.photoData },
                    caricature: s.photoData,
                    status: 'active'
                }))
            };
            
            localStorage.setItem('hallpass_class', JSON.stringify(classData));
            
            alert('‚úì Saved "' + className + '" with ' + confirmedStudents.length + ' students!');
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
