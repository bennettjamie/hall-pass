<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hall Pass</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-card: #252540;
            --bg-hover: #2d2d4a;
            --accent: #6366f1;
            --accent-light: #818cf8;
            --success: #22c55e;
            --success-glow: rgba(34, 197, 94, 0.3);
            --warning: #f59e0b;
            --warning-glow: rgba(245, 158, 11, 0.3);
            --danger: #ef4444;
            --danger-glow: rgba(239, 68, 68, 0.3);
            --excused: #8b5cf6;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --border: rgba(255,255,255,0.1);
            --shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            user-select: none;
        }

        /* Navigation */
        .nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        
        .logo {
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-tabs {
            display: flex;
            gap: 4px;
        }
        
        .nav-tab {
            padding: 20px 16px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.95rem;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .nav-tab:hover {
            color: var(--text-primary);
        }
        
        .nav-tab.active {
            color: var(--accent-light);
            border-bottom-color: var(--accent);
        }
        
        .nav-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .class-selector select {
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            padding: 10px 16px;
            border-radius: 10px;
        }
        
        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: none;
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .icon-btn:hover {
            background: var(--bg-hover);
        }

        /* Status Bar */
        .status-bar {
            background: var(--bg-secondary);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }
        
        .period-info {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        
        .date-display {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--bg-card);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .date-display:hover {
            background: var(--bg-hover);
        }
        
        .date-day {
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .date-full {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }
        
        .schedule-type {
            background: var(--accent);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .schedule-type.amfit {
            background: #f59e0b;
            color: black;
        }
        
        .schedule-type.pmfit {
            background: #8b5cf6;
        }
        
        .schedule-type.custom {
            background: #06b6d4;
        }
        
        .class-name {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Schedule Tabs */
        .sched-tab.active {
            background: var(--accent) !important;
            color: white;
        }
        
        .sched-panel {
            display: none;
        }
        
        .sched-panel.active {
            display: block;
        }
        
        .day-sched {
            padding: 6px 10px;
            border-radius: 6px;
            background: var(--bg-card);
            color: white;
            border: 1px solid var(--border);
            width: 120px;
        }
        
        .class-assignment {
            display: grid;
            grid-template-columns: 100px 1fr 100px;
            gap: 8px;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .period-badge {
            background: var(--accent);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        .period-badge:hover {
            background: var(--accent-light);
        }
        
        .countdown {
            font-size: 2rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }
        
        .countdown.pre-class {
            color: var(--success);
        }
        
        .countdown.in-class {
            color: var(--text-secondary);
        }
        
        .countdown.ending-soon {
            color: var(--warning);
        }
        
        .class-status {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .stats {
            display: flex;
            gap: 20px;
        }
        
        .stat {
            text-align: center;
            padding: 8px 16px;
            border-radius: 12px;
            background: var(--bg-card);
        }
        
        .stat.ontime { border-left: 3px solid var(--success); }
        .stat.late { border-left: 3px solid var(--warning); }
        .stat.absent { border-left: 3px solid var(--danger); }
        
        .stat-value {
            font-size: 1.6rem;
            font-weight: 700;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .close-attendance-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 16px;
        }
        
        .close-attendance-btn:hover {
            background: #dc2626;
        }

        /* Main Content */
        .main {
            padding: 24px;
            min-height: calc(100vh - 180px);
        }
        
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
        }

        /* Seating Canvas */
        .seating-container {
            width: 100%;
            height: calc(100vh - 220px);
            overflow: auto;
            position: relative;
        }
        
        .seating-toolbar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .toolbar-group {
            display: flex;
            gap: 8px;
        }
        
        .toolbar-btn {
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        
        .toolbar-btn:hover {
            background: var(--bg-hover);
        }
        
        .toolbar-btn.active {
            background: var(--accent);
        }
        
        .seating-canvas {
            position: relative;
            width: 100%;
            min-height: 600px;
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            overflow: hidden;
        }
        
        .seating-canvas.edit-mode {
            background: repeating-linear-gradient(
                0deg,
                var(--bg-card),
                var(--bg-card) 20px,
                var(--bg-hover) 20px,
                var(--bg-hover) 21px
            ),
            repeating-linear-gradient(
                90deg,
                var(--bg-card),
                var(--bg-card) 20px,
                var(--bg-hover) 20px,
                var(--bg-hover) 21px
            );
        }

        /* Student Cards */
        .canvas-student {
            position: absolute;
            width: 100px;
            text-align: center;
            padding: 8px;
            border-radius: 12px;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            border: 3px solid transparent;
        }
        
        .canvas-student:hover {
            transform: scale(1.05);
        }
        
        .canvas-student.dragging {
            z-index: 1000;
            opacity: 0.9;
            transform: scale(1.1);
        }
        
        /* Attendance States */
        .canvas-student.unchecked {
            border-color: var(--border);
            opacity: 0.6;
        }
        
        .canvas-student.ontime {
            border-color: var(--success);
            box-shadow: 0 0 20px var(--success-glow);
            animation: pulseGreen 2s ease-in-out;
        }
        
        .canvas-student.late {
            border-color: var(--warning);
            box-shadow: 0 0 20px var(--warning-glow);
        }
        
        .canvas-student.absent {
            border-color: var(--danger);
            opacity: 0.5;
        }
        
        .canvas-student.excused {
            border-color: var(--excused);
            opacity: 0.7;
        }
        
        @keyframes pulseGreen {
            0% { box-shadow: 0 0 0 0 var(--success-glow); }
            50% { box-shadow: 0 0 30px 10px var(--success-glow); }
            100% { box-shadow: 0 0 20px var(--success-glow); }
        }
        
        .student-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 6px;
        }
        
        .student-name {
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .student-status {
            font-size: 0.7rem;
            margin-top: 4px;
            color: var(--text-secondary);
        }
        
        .canvas-student.ontime .student-status {
            color: var(--success);
        }
        
        .canvas-student.late .student-status {
            color: var(--warning);
        }
        
        .late-timer {
            font-size: 0.75rem;
            color: var(--warning);
            font-weight: 600;
            margin-top: 2px;
        }
        
        .streak-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 700;
        }
        
        .streak-badge.fire::after {
            content: ' üî•';
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 8px 0;
            min-width: 200px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
        }
        
        .context-menu.open {
            display: block;
        }
        
        .context-menu-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
        }
        
        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.15s;
        }
        
        .context-menu-item:hover {
            background: var(--bg-hover);
        }
        
        .context-menu-item.danger {
            color: var(--danger);
        }
        
        .context-menu-divider {
            height: 1px;
            background: var(--border);
            margin: 8px 0;
        }
        
        .context-menu-note {
            padding: 8px 16px;
        }
        
        .context-menu-note input {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-overlay.open {
            display: flex;
        }
        
        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-header h2 {
            font-size: 1.3rem;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .setting-section {
            margin-bottom: 24px;
        }
        
        .setting-section h3 {
            margin-bottom: 12px;
            font-size: 1rem;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--accent-light);
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: var(--bg-hover);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: black;
        }
        
        .btn-warning:hover {
            background: #d97706;
        }
        
        /* Hall Pass */
        .hp-duration.active {
            background: var(--accent) !important;
            color: white;
        }
        
        .hp-student {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.15s;
            border: 2px solid transparent;
        }
        
        .hp-student:hover {
            background: var(--bg-hover);
        }
        
        .hp-student.on-pass {
            border-color: #06b6d4;
            background: rgba(6,182,212,0.15);
            animation: passGlow 2s infinite;
        }
        
        .hp-student.in-queue {
            border-color: var(--warning);
            background: rgba(245,158,11,0.1);
        }
        
        .hp-student img {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            margin-bottom: 6px;
        }
        
        .hp-student .name {
            font-size: 12px;
            font-weight: 500;
            text-align: center;
        }
        
        .hp-student .pass-timer {
            font-size: 11px;
            color: #06b6d4;
            font-weight: 600;
            margin-top: 4px;
        }
        
        .hp-student .queue-pos {
            font-size: 10px;
            color: var(--warning);
            margin-top: 4px;
        }
        
        @keyframes passGlow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(6,182,212,0.4); }
            50% { box-shadow: 0 0 12px 4px rgba(6,182,212,0.2); }
        }
        
        .queue-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 12px;
            margin-bottom: 8px;
        }
        
        .queue-item.active {
            background: rgba(6,182,212,0.15);
            border: 1px solid #06b6d4;
        }
        
        .queue-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
        
        .queue-item .info {
            flex: 1;
        }
        
        .queue-item .name {
            font-weight: 600;
        }
        
        .queue-item .time {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .queue-item .etd {
            font-size: 13px;
            font-weight: 600;
            color: #06b6d4;
        }
        
        .queue-item .back-btn {
            padding: 6px 12px;
            background: var(--success);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .queue-item .back-btn:hover {
            background: #16a34a;
        }
        
        .avatar-tab.active {
            background: var(--accent) !important;
            color: white;
        }

        /* Schedule Editor */
        .schedule-grid {
            display: grid;
            gap: 12px;
        }
        
        .schedule-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
        }
        
        .schedule-row label {
            width: 100px;
            font-weight: 500;
        }
        
        .schedule-row input[type="time"] {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .pattern-select {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 16px;
        }
        
        .pattern-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid var(--border);
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .pattern-btn.active {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
        }

        /* Summary Modal */
        .summary-grid {
            display: grid;
            gap: 16px;
        }
        
        .summary-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }
        
        .summary-stat.ontime { border-left: 4px solid var(--success); }
        .summary-stat.late { border-left: 4px solid var(--warning); }
        .summary-stat.absent { border-left: 4px solid var(--danger); }
        .summary-stat.excused { border-left: 4px solid var(--excused); }
        
        .summary-label {
            font-weight: 500;
        }
        
        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .summary-names {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
            z-index: 3000;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
        
        /* Mini Overlay */
        .mini-overlay {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 320px;
            min-width: 200px;
            max-width: 500px;
            background: var(--bg-card);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 5000;
            display: none;
            opacity: 0.9;
            border: 1px solid var(--border);
            overflow: hidden;
            resize: both;
        }
        
        .mini-overlay.open {
            display: block;
        }
        
        .mini-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-secondary);
            cursor: move;
            gap: 8px;
        }
        
        .mini-title {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .mini-stats {
            display: flex;
            gap: 6px;
        }
        
        .mini-stat {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 8px;
        }
        
        .mini-stat.ontime { background: var(--success); color: white; }
        .mini-stat.late { background: var(--warning); color: black; }
        .mini-stat.absent { background: var(--danger); color: white; }
        
        .mini-controls {
            display: flex;
            gap: 4px;
        }
        
        .mini-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 4px;
            border-radius: 4px;
        }
        
        .mini-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .mini-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 6px;
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .mini-student {
            text-align: center;
            cursor: pointer;
            padding: 4px;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.15s;
        }
        
        .mini-student:hover {
            background: var(--bg-hover);
        }
        
        .mini-student.unchecked {
            opacity: 0.5;
        }
        
        .mini-student.ontime {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }
        
        .mini-student.late {
            border-color: var(--warning);
            background: rgba(245, 158, 11, 0.1);
        }
        
        .mini-student.absent {
            border-color: var(--danger);
            opacity: 0.4;
        }
        
        .mini-student img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }
        
        .mini-student .name {
            font-size: 0.6rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }
        
        .mini-student .late-badge {
            font-size: 0.55rem;
            color: var(--warning);
            font-weight: 600;
        }
        
        .mini-resize {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 16px;
            height: 16px;
            cursor: se-resize;
            background: linear-gradient(135deg, transparent 50%, var(--text-secondary) 50%);
            opacity: 0.3;
            border-radius: 0 0 16px 0;
        }
        
        /* Fun animations */
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-100px) rotate(720deg); opacity: 0; }
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--success);
            animation: confetti 1s ease-out forwards;
            pointer-events: none;
            z-index: 3000;
        }
        
        /* Student History Panel */
        .history-panel {
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }
        
        .history-title {
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .history-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }
        
        .history-row:last-child {
            border-bottom: none;
        }
        
        .history-status {
            font-weight: 500;
        }
        
        .history-status.ontime { color: var(--success); }
        .history-status.late { color: var(--warning); }
        .history-status.absent { color: var(--danger); }
        .history-status.excused { color: var(--excused); }

        /* Upload zone */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .upload-zone:hover {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.05);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-left">
            <div class="logo">
                <span>üéüÔ∏è</span>
                <span>Hall Pass</span>
            </div>
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="showView('attendance')">üìã Attendance</div>
                <div class="nav-tab" onclick="showView('hallpass')">üö™ Hall Pass</div>
                <div class="nav-tab" onclick="showView('groups')">üë• Groups</div>
                <div class="nav-tab" onclick="showView('history')">üìä History</div>
            </div>
        </div>
        <div class="nav-right">
            <select id="classSelect" class="class-selector">
                <option>No class loaded</option>
            </select>
            <button class="icon-btn" title="Schedule" onclick="openSchedule()">üïê</button>
            <button class="icon-btn" title="Settings" onclick="openSettings()">‚öôÔ∏è</button>
            <button class="icon-btn" title="Help" onclick="openHelp()">‚ùì</button>
        </div>
    </nav>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="period-info">
            <div class="date-display" id="dateDisplay" onclick="openSchedule()">
                <span class="date-day" id="dateDay">Monday</span>
                <span class="date-full" id="dateFull">Feb 10</span>
                <span class="schedule-type" id="scheduleType">Regular</span>
            </div>
            <div class="period-badge" onclick="openSchedule()" id="periodBadge">Period 1</div>
            <div class="class-name" id="className" onclick="openSchedule()"></div>
            <div class="countdown pre-class" id="countdown">--:--</div>
            <div class="class-status" id="classStatus">Loading...</div>
        </div>
        <div class="stats">
            <div class="stat ontime">
                <div class="stat-value" id="statOntime">0</div>
                <div class="stat-label">On Time</div>
            </div>
            <div class="stat late">
                <div class="stat-value" id="statLate">0</div>
                <div class="stat-label">Late</div>
            </div>
            <div class="stat absent">
                <div class="stat-value" id="statAbsent">0</div>
                <div class="stat-label">Not Here</div>
            </div>
            <button class="close-attendance-btn" onclick="closeAttendance()" id="closeAttendanceBtn">
                Close Attendance
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main">
        <!-- Attendance View -->
        <div class="view active" id="attendanceView">
            <div class="seating-container">
                <div class="seating-toolbar">
                    <div class="toolbar-group">
                        <button class="toolbar-btn" id="editModeBtn" onclick="toggleEditMode()">‚úèÔ∏è Edit Layout</button>
                        <button class="toolbar-btn" onclick="openStudentManager()">üë§ Edit Students</button>
                        <button class="toolbar-btn" onclick="resetAttendance()">üîÑ Reset Day</button>
                    </div>
                    <div class="toolbar-group">
                        <button class="toolbar-btn" id="miniModeBtn" onclick="toggleMiniOverlay()">üìå Mini Overlay</button>
                        <button class="toolbar-btn" onclick="zoomCanvas(-0.1)">‚ûñ</button>
                        <button class="toolbar-btn" onclick="zoomCanvas(0)">Fit</button>
                        <button class="toolbar-btn" onclick="zoomCanvas(0.1)">‚ûï</button>
                    </div>
                </div>
                <div class="seating-canvas" id="seatingCanvas">
                    <!-- Students rendered here -->
                </div>
            </div>
        </div>

        <!-- Hall Pass View -->
        <div class="view" id="hallpassView">
            <div style="display:flex;gap:24px;padding:20px;height:calc(100vh - 84px);">
                <!-- Left: Student Grid -->
                <div style="flex:1;overflow-y:auto;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                        <h2>üö™ Hall Pass</h2>
                        <div style="font-size:14px;color:var(--text-secondary);">
                            Tap a student to start a hall pass
                        </div>
                    </div>
                    <div id="hallpassGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:12px;"></div>
                </div>
                <!-- Right: Queue -->
                <div style="width:280px;background:var(--bg-card);border-radius:16px;padding:16px;display:flex;flex-direction:column;">
                    <h3 style="margin-bottom:16px;display:flex;align-items:center;gap:8px;">
                        <span>üìã Queue</span>
                        <span id="queueCount" style="background:var(--accent);padding:2px 8px;border-radius:10px;font-size:12px;">0</span>
                    </h3>
                    <div id="hallpassQueue" style="flex:1;overflow-y:auto;"></div>
                    <div style="margin-top:16px;padding-top:16px;border-top:1px solid var(--border);font-size:12px;color:var(--text-secondary);">
                        <div>‚ö†Ô∏è One student out at a time</div>
                        <div style="margin-top:4px;">üö® Emergency override available</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hall Pass Duration Modal -->
        <div class="modal-overlay" id="hallpassModal" onclick="if(event.target===this)closeHallPassModal()">
            <div class="modal" style="max-width:400px;">
                <div class="modal-header">
                    <h2>üö∂ Hall Pass</h2>
                    <button class="close-btn" onclick="closeHallPassModal()">‚úï</button>
                </div>
                <div class="modal-body">
                    <div id="hallpassModalStudent" style="display:flex;align-items:center;gap:12px;margin-bottom:20px;padding:12px;background:var(--bg-secondary);border-radius:12px;">
                        <img id="hallpassModalImg" src="" style="width:48px;height:48px;border-radius:50%;">
                        <div>
                            <div id="hallpassModalName" style="font-weight:600;font-size:18px;"></div>
                            <div id="hallpassModalStatus" style="font-size:13px;color:var(--text-secondary);"></div>
                        </div>
                    </div>
                    <label style="display:block;margin-bottom:8px;font-weight:500;">How long?</label>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;">
                        <button class="btn btn-secondary hp-duration active" data-min="3" onclick="selectHpDuration(3)">3 min</button>
                        <button class="btn btn-secondary hp-duration" data-min="5" onclick="selectHpDuration(5)">5 min</button>
                        <button class="btn btn-secondary hp-duration" data-min="8" onclick="selectHpDuration(8)">8 min</button>
                    </div>
                    <div style="margin-bottom:16px;">
                        <label style="display:block;margin-bottom:6px;font-size:13px;color:var(--text-secondary);">Or special reason:</label>
                        <input type="text" id="hallpassCustomReason" placeholder="e.g., Counselor visit, Office..." 
                               style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--bg-secondary);color:white;">
                    </div>
                    <div id="hallpassQueueWarning" style="display:none;padding:12px;background:rgba(245,158,11,0.1);border:1px solid var(--warning);border-radius:8px;margin-bottom:16px;">
                        <div style="color:var(--warning);font-weight:500;">‚ö†Ô∏è Someone is already out</div>
                        <div id="hallpassQueueInfo" style="font-size:13px;margin-top:4px;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="closeHallPassModal()">Cancel</button>
                    <button class="btn btn-primary" id="hallpassStartBtn" onclick="startHallPass()">üö∂ Start Pass</button>
                    <button class="btn btn-warning" id="hallpassQueueBtn" style="display:none;" onclick="queueHallPass()">üìã Join Queue</button>
                </div>
            </div>
        </div>

        <!-- Groups View -->
        <div class="view" id="groupsView">
            <div style="max-width:1000px;margin:0 auto;">
                <h2 style="margin-bottom:24px;">üë• Quick Groups</h2>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;">
                    <button class="btn btn-secondary" onclick="makeGroups(2)">Pairs</button>
                    <button class="btn btn-secondary" onclick="makeGroups(3)">3s</button>
                    <button class="btn btn-secondary" onclick="makeGroups(4)">4s</button>
                    <button class="btn btn-secondary" onclick="makeGroups(5)">5s</button>
                    <button class="btn btn-secondary" onclick="shuffleGroups()">üîÄ Shuffle</button>
                </div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:24px;padding-top:12px;border-top:1px solid var(--border);">
                    <button class="btn btn-primary" onclick="saveCurrentGroups()">üíæ Save Groups</button>
                    <button class="btn btn-secondary" onclick="showSavedGroups()">üìÇ Load Past Groups</button>
                </div>
                <div id="savedGroupsPanel" style="display:none;margin-bottom:24px;padding:16px;background:var(--bg-card);border-radius:12px;">
                    <h3 style="margin-bottom:12px;">üìÇ Saved Groups</h3>
                    <div id="savedGroupsList"></div>
                </div>
                <div id="groupsContainer"></div>
            </div>
        </div>

        <!-- History View -->
        <div class="view" id="historyView">
            <div style="max-width:800px;margin:0 auto;">
                <h2 style="margin-bottom:24px;">üìä Attendance History</h2>
                <div id="historyContainer">
                    <p style="color:var(--text-secondary);">Select a student to view their history, or view class trends.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-header" id="contextMenuHeader">Student Name</div>
        <div class="context-menu-item" onclick="setStatus('ontime')">‚úÖ Mark On-Time</div>
        <div class="context-menu-item" onclick="setStatus('late')">‚ö†Ô∏è Mark Late</div>
        <div class="context-menu-item" onclick="setStatus('absent')">‚ùå Mark Absent</div>
        <div class="context-menu-item" onclick="setStatus('excused')">üìù Mark Excused</div>
        <div class="context-menu-item" onclick="clearStatus()">üîÑ Clear (Reset)</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="ctxHallPass" onclick="showHallPassModal()">üö∂ Hall Pass</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-note">
            <input type="text" id="contextMenuNote" placeholder="Add note..." onkeypress="if(event.key==='Enter')saveNote()">
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="viewStudentHistory()">üìä View History</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="editStudent()">‚úèÔ∏è Edit Student</div>
        <div class="context-menu-item danger" onclick="removeStudent()">üóëÔ∏è Remove Student</div>
    </div>

    <!-- Canvas Context Menu (for adding students) -->
    <div class="context-menu" id="canvasContextMenu">
        <div class="context-menu-header">Canvas Options</div>
        <div class="context-menu-item" onclick="addStudentAtPosition()">‚ûï Add Student Here</div>
        <div class="context-menu-item" onclick="openStudentManager()">üë§ Manage Students</div>
    </div>

    <!-- Student Manager Modal -->
    <div class="modal-overlay" id="studentManagerModal" onclick="if(event.target===this)closeStudentManager()">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header">
                <h2>üë§ Manage Students</h2>
                <button class="close-btn" onclick="closeStudentManager()">‚úï</button>
            </div>
            <div class="modal-body">
                <div style="display:flex;gap:12px;margin-bottom:16px;">
                    <button class="btn btn-primary" onclick="showAddStudentForm()">‚ûï Add Student</button>
                    <input type="text" id="studentSearch" placeholder="Search students..." 
                           style="flex:1;padding:10px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);"
                           oninput="filterStudentList()">
                </div>
                <div id="studentManagerList" style="max-height:400px;overflow-y:auto;">
                    <!-- Filled dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Student Modal -->
    <div class="modal-overlay" id="editStudentModal" onclick="if(event.target===this)closeEditStudent()">
        <div class="modal" style="max-width:550px;">
            <div class="modal-header">
                <h2 id="editStudentTitle">‚ûï Add Student</h2>
                <button class="close-btn" onclick="closeEditStudent()">‚úï</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editStudentId">
                <input type="hidden" id="editSelectedAvatar">
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                    <div class="setting-section">
                        <label style="display:block;margin-bottom:8px;font-weight:500;">First Name *</label>
                        <input type="text" id="editFirstName" placeholder="First name" 
                               style="width:100%;padding:12px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:1rem;">
                    </div>
                    <div class="setting-section">
                        <label style="display:block;margin-bottom:8px;font-weight:500;">Last Name</label>
                        <input type="text" id="editLastName" placeholder="Last name" 
                               style="width:100%;padding:12px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:1rem;">
                    </div>
                </div>
                
                <div class="setting-section">
                    <label style="display:block;margin-bottom:8px;font-weight:500;">Preferred Name (optional)</label>
                    <input type="text" id="editPreferredName" placeholder="What they like to be called" 
                           style="width:100%;padding:12px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:1rem;">
                </div>
                
                <div class="setting-section">
                    <label style="display:block;margin-bottom:8px;font-weight:500;">Choose Avatar</label>
                    <div style="display:flex;gap:8px;margin-bottom:12px;">
                        <button type="button" class="btn btn-secondary avatar-tab active" onclick="showAvatarTab('cartoon')" style="padding:6px 12px;font-size:13px;">üé® Cartoon</button>
                        <button type="button" class="btn btn-secondary avatar-tab" onclick="showAvatarTab('modern')" style="padding:6px 12px;font-size:13px;">‚ú® Modern</button>
                        <button type="button" class="btn btn-secondary avatar-tab" onclick="showAvatarTab('playful')" style="padding:6px 12px;font-size:13px;">üòä Playful</button>
                        <button type="button" class="btn btn-secondary avatar-tab" onclick="showAvatarTab('pixel')" style="padding:6px 12px;font-size:13px;">üéÆ Pixel</button>
                        <button type="button" class="btn btn-secondary avatar-tab" onclick="showAvatarTab('classic')" style="padding:6px 12px;font-size:13px;">üé≠ Classic</button>
                    </div>
                    <div id="avatarGrid" style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;max-height:180px;overflow-y:auto;padding:8px;background:var(--bg-secondary);border-radius:12px;">
                        <!-- Avatars loaded dynamically -->
                    </div>
                </div>
                
                <div class="setting-section">
                    <label style="display:block;margin-bottom:8px;font-weight:500;">Or paste image URL</label>
                    <input type="text" id="editPhotoUrl" placeholder="https://..." 
                           style="width:100%;padding:12px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:1rem;"
                           oninput="clearAvatarSelection()">
                </div>
                
                <div style="display:flex;gap:12px;margin-top:24px;">
                    <button class="btn btn-primary" onclick="saveStudent()">Save Student</button>
                    <button class="btn btn-secondary" onclick="closeEditStudent()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div class="modal-overlay" id="scheduleModal" onclick="if(event.target===this)closeSchedule()">
        <div class="modal" style="max-width:700px;">
            <div class="modal-header">
                <h2>üïê Schedule Settings</h2>
                <button class="close-btn" onclick="closeSchedule()">‚úï</button>
            </div>
            <div class="modal-body">
                <!-- Tab Navigation -->
                <div style="display:flex;gap:4px;margin-bottom:20px;border-bottom:1px solid var(--border);padding-bottom:12px;">
                    <button class="btn btn-secondary sched-tab active" onclick="showSchedTab('today')">üìÖ Today</button>
                    <button class="btn btn-secondary sched-tab" onclick="showSchedTab('weekly')">üóìÔ∏è Weekly Pattern</button>
                    <button class="btn btn-secondary sched-tab" onclick="showSchedTab('classes')">üìö My Classes</button>
                    <button class="btn btn-secondary sched-tab" onclick="showSchedTab('presets')">‚ö° Presets</button>
                </div>
                
                <!-- Today Tab -->
                <div class="sched-panel active" id="schedPanelToday">
                    <div class="setting-section">
                        <h3>Today: <span id="schedTodayDate">Monday, Feb 10</span></h3>
                        <div class="schedule-grid">
                            <div class="schedule-row">
                                <label>Schedule Type:</label>
                                <select id="schedType" onchange="onSchedTypeChange()">
                                    <option value="regular">Regular</option>
                                    <option value="amfit">AM FIT</option>
                                    <option value="pmfit">PM FIT</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            <div class="schedule-row">
                                <label>Period:</label>
                                <select id="schedPeriod" onchange="updateSchedulePreview()">
                                    <option value="1">Period 1</option>
                                    <option value="2">Period 2</option>
                                    <option value="3">Period 3</option>
                                    <option value="4">Period 4</option>
                                </select>
                            </div>
                            <div class="schedule-row">
                                <label>Class:</label>
                                <select id="schedClass" onchange="onClassChange()">
                                    <option value="">-- Select Class --</option>
                                </select>
                            </div>
                            <div class="schedule-row">
                                <label>Start:</label>
                                <input type="time" id="schedStart" value="08:40" onchange="updateSchedulePreview()">
                            </div>
                            <div class="schedule-row">
                                <label>End:</label>
                                <input type="time" id="schedEnd" value="10:00" onchange="updateSchedulePreview()">
                            </div>
                        </div>
                        <div style="margin-top:12px;padding:12px;background:var(--bg-secondary);border-radius:8px;font-size:0.85rem;">
                            <div>üö™ Hall pass: <span id="hallpassWindow">8:50 AM - 9:50 AM</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Weekly Pattern Tab -->
                <div class="sched-panel" id="schedPanelWeekly">
                    <div class="setting-section">
                        <h3>Weekly Pattern</h3>
                        <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:16px;">
                            Set what schedule type applies to each day. The app will auto-detect based on this pattern.
                        </p>
                        <div style="margin-bottom:16px;">
                            <label style="display:block;margin-bottom:8px;">Pattern Type:</label>
                            <select id="weekPatternType" onchange="onWeekPatternTypeChange()" style="padding:8px;border-radius:8px;background:var(--bg-secondary);color:white;border:1px solid var(--border);">
                                <option value="simple">Same every week</option>
                                <option value="biweekly">Week 1 / Week 2 (alternating)</option>
                                <option value="cycle">Day cycle (1-2-3-4...)</option>
                            </select>
                        </div>
                        <div id="weekPatternSimple">
                            <table style="width:100%;border-collapse:collapse;">
                                <tr style="background:var(--bg-secondary);">
                                    <th style="padding:10px;text-align:left;">Day</th>
                                    <th style="padding:10px;text-align:left;">Schedule</th>
                                </tr>
                                <tr><td style="padding:8px;">Monday</td><td><select class="day-sched" data-day="mon"><option value="regular">Regular</option><option value="amfit">AM FIT</option><option value="pmfit">PM FIT</option><option value="noschool">No School</option></select></td></tr>
                                <tr><td style="padding:8px;">Tuesday</td><td><select class="day-sched" data-day="tue"><option value="regular">Regular</option><option value="amfit">AM FIT</option><option value="pmfit" selected>PM FIT</option><option value="noschool">No School</option></select></td></tr>
                                <tr><td style="padding:8px;">Wednesday</td><td><select class="day-sched" data-day="wed"><option value="regular">Regular</option><option value="amfit" selected>AM FIT</option><option value="pmfit">PM FIT</option><option value="noschool">No School</option></select></td></tr>
                                <tr><td style="padding:8px;">Thursday</td><td><select class="day-sched" data-day="thu"><option value="regular">Regular</option><option value="amfit">AM FIT</option><option value="pmfit" selected>PM FIT</option><option value="noschool">No School</option></select></td></tr>
                                <tr><td style="padding:8px;">Friday</td><td><select class="day-sched" data-day="fri"><option value="regular">Regular</option><option value="amfit" selected>AM FIT</option><option value="pmfit">PM FIT</option><option value="noschool">No School</option></select></td></tr>
                            </table>
                        </div>
                        <div id="weekPatternBiweekly" style="display:none;">
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                                <div>
                                    <h4 style="margin-bottom:8px;">Week 1</h4>
                                    <div id="week1Pattern"></div>
                                </div>
                                <div>
                                    <h4 style="margin-bottom:8px;">Week 2</h4>
                                    <div id="week2Pattern"></div>
                                </div>
                            </div>
                            <div style="margin-top:12px;padding:10px;background:var(--bg-secondary);border-radius:8px;font-size:0.85rem;">
                                <label>Current week: </label>
                                <select id="currentWeekNum" style="padding:4px;border-radius:4px;background:var(--bg-card);color:white;border:none;">
                                    <option value="1">Week 1</option>
                                    <option value="2">Week 2</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- My Classes Tab -->
                <div class="sched-panel" id="schedPanelClasses">
                    <div class="setting-section">
                        <h3>My Classes</h3>
                        <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:16px;">
                            Set up which class you teach at each period. The app will auto-load the right roster.
                        </p>
                        <div id="classAssignments">
                            <div style="display:grid;grid-template-columns:100px 1fr 100px;gap:8px;align-items:center;margin-bottom:8px;">
                                <strong>Period</strong>
                                <strong>Class Name</strong>
                                <strong>Roster</strong>
                            </div>
                            <div class="class-assignment" data-period="1">
                                <span style="padding:8px;">Period 1</span>
                                <input type="text" placeholder="e.g., CLE 10-003" class="class-name-input" style="padding:8px;border-radius:8px;background:var(--bg-secondary);color:white;border:1px solid var(--border);">
                                <button class="btn btn-secondary" style="font-size:12px;" onclick="loadRosterForPeriod(1)">Load</button>
                            </div>
                            <div class="class-assignment" data-period="2">
                                <span style="padding:8px;">Period 2</span>
                                <input type="text" placeholder="e.g., CLE 10-004" class="class-name-input" style="padding:8px;border-radius:8px;background:var(--bg-secondary);color:white;border:1px solid var(--border);">
                                <button class="btn btn-secondary" style="font-size:12px;" onclick="loadRosterForPeriod(2)">Load</button>
                            </div>
                            <div class="class-assignment" data-period="3">
                                <span style="padding:8px;">Period 3</span>
                                <input type="text" placeholder="e.g., Planning" class="class-name-input" style="padding:8px;border-radius:8px;background:var(--bg-secondary);color:white;border:1px solid var(--border);">
                                <button class="btn btn-secondary" style="font-size:12px;" onclick="loadRosterForPeriod(3)">Load</button>
                            </div>
                            <div class="class-assignment" data-period="4">
                                <span style="padding:8px;">Period 4</span>
                                <input type="text" placeholder="e.g., CLE 10-005" class="class-name-input" style="padding:8px;border-radius:8px;background:var(--bg-secondary);color:white;border:1px solid var(--border);">
                                <button class="btn btn-secondary" style="font-size:12px;" onclick="loadRosterForPeriod(4)">Load</button>
                            </div>
                        </div>
                        <div style="margin-top:16px;padding:12px;background:var(--bg-secondary);border-radius:8px;">
                            <p style="font-size:0.85rem;color:var(--text-secondary);">
                                üí° Tip: Import each class roster from MyEd using the <strong>Settings ‚Üí Create from MyEd</strong> tool, 
                                then save each as a separate JSON file. Load them here by period.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Presets Tab -->
                <div class="sched-panel" id="schedPanelPresets">
                    <div class="setting-section">
                        <h3>Bell Schedule Presets</h3>
                        <p style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:16px;">
                            Quick-load common bell schedules. Currently configured for Britannia Secondary.
                        </p>
                        <div style="display:grid;gap:12px;">
                            <div style="padding:16px;background:var(--bg-secondary);border-radius:12px;cursor:pointer;" onclick="loadPreset('regular')">
                                <div style="font-weight:600;margin-bottom:8px;">üìó Regular Day</div>
                                <div style="font-size:0.85rem;color:var(--text-secondary);">P1: 8:40-10:00 ‚Ä¢ P2: 10:10-11:30 ‚Ä¢ P3: 12:15-1:35 ‚Ä¢ P4: 1:45-3:05</div>
                            </div>
                            <div style="padding:16px;background:var(--bg-secondary);border-radius:12px;cursor:pointer;" onclick="loadPreset('amfit')">
                                <div style="font-weight:600;margin-bottom:8px;">üåÖ AM FIT (Wed/Fri)</div>
                                <div style="font-size:0.85rem;color:var(--text-secondary);">P1: 9:20-10:20 ‚Ä¢ P2: 10:30-11:30 ‚Ä¢ P3: 12:15-1:35 ‚Ä¢ P4: 1:45-3:05</div>
                            </div>
                            <div style="padding:16px;background:var(--bg-secondary);border-radius:12px;cursor:pointer;" onclick="loadPreset('pmfit')">
                                <div style="font-weight:600;margin-bottom:8px;">üåÜ PM FIT (Tue/Thu)</div>
                                <div style="font-size:0.85rem;color:var(--text-secondary);">P1: 8:40-10:00 ‚Ä¢ P2: 10:10-11:30 ‚Ä¢ P3: 12:15-1:15 ‚Ä¢ P4: 1:25-2:25</div>
                            </div>
                        </div>
                        <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border);">
                            <h4 style="margin-bottom:12px;">Custom Preset</h4>
                            <button class="btn btn-secondary" onclick="createCustomPreset()">+ Create New Preset</button>
                        </div>
                    </div>
                </div>
                
                <div style="display:flex;gap:12px;margin-top:24px;padding-top:16px;border-top:1px solid var(--border);">
                    <button class="btn btn-primary" onclick="saveSchedule()">üíæ Save Schedule</button>
                    <button class="btn btn-secondary" onclick="closeSchedule()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal" onclick="if(event.target===this)closeSettings()">
        <div class="modal">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="close-btn" onclick="closeSettings()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="setting-section">
                    <h3>üì• Import Class</h3>
                    <div class="upload-zone" onclick="document.getElementById('importFile').click()">
                        <div style="font-size:2rem;margin-bottom:8px;">üìÅ</div>
                        <div>Click to import class JSON</div>
                    </div>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="handleImport(event)">
                    <div style="margin-top:12px;">
                        <a href="processor.html" class="btn btn-secondary" style="display:inline-block;text-decoration:none;">
                            ‚ú® Create from MyEd
                        </a>
                    </div>
                </div>
                
                <div class="setting-section">
                    <h3>üì§ Export All Data</h3>
                    <p style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:12px;">
                        Export everything for laptop migration. Includes class roster, attendance history, and settings.
                    </p>
                    <button class="btn btn-secondary" onclick="exportAllData()">üíæ Export Full Backup</button>
                </div>
                
                <div class="setting-section">
                    <h3>üìä Export Attendance</h3>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-secondary" onclick="exportAttendance('csv')">üìä CSV</button>
                        <button class="btn btn-secondary" onclick="exportAttendance('json')">üíæ JSON</button>
                    </div>
                </div>
                
                <div class="setting-section">
                    <h3>üóëÔ∏è Clear Data</h3>
                    <button class="btn btn-danger" onclick="clearAllData()">Clear Everything</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Modal -->
    <div class="modal-overlay" id="summaryModal" onclick="if(event.target===this)closeSummary()">
        <div class="modal">
            <div class="modal-header">
                <h2>üìã Attendance Summary</h2>
                <button class="close-btn" onclick="closeSummary()">‚úï</button>
            </div>
            <div class="modal-body" id="summaryContent">
                <!-- Filled dynamically -->
            </div>
        </div>
    </div>

    <!-- Student History Modal -->
    <div class="modal-overlay" id="studentHistoryModal" onclick="if(event.target===this)closeStudentHistory()">
        <div class="modal">
            <div class="modal-header">
                <h2 id="studentHistoryTitle">üìä Student History</h2>
                <button class="close-btn" onclick="closeStudentHistory()">‚úï</button>
            </div>
            <div class="modal-body" id="studentHistoryContent">
                <!-- Filled dynamically -->
            </div>
        </div>
    </div>

    <!-- Toast -->
    <!-- Help Modal -->
    <div class="modal-overlay" id="helpModal" onclick="if(event.target===this)closeHelp()">
        <div class="modal" style="max-width:550px;">
            <div class="modal-header">
                <h2>‚ùì Help</h2>
                <button class="close-btn" onclick="closeHelp()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="setting-section">
                    <h3>üìã Taking Attendance</h3>
                    <ul style="margin-left:20px;color:var(--text-secondary);line-height:1.8;">
                        <li><strong>Click a student</strong> to check them in</li>
                        <li><strong style="color:var(--success);">Green</strong> = On time</li>
                        <li><strong style="color:var(--warning);">Amber</strong> = Late (shows how late)</li>
                        <li><strong>Right-click</strong> to change status or add notes</li>
                        <li><strong>Close Attendance</strong> marks remaining as absent</li>
                    </ul>
                </div>
                
                <div class="setting-section">
                    <h3>üìå Mini Overlay</h3>
                    <p style="color:var(--text-secondary);margin-bottom:12px;">
                        Perfect for marking attendance while presenting!
                    </p>
                    <ul style="margin-left:20px;color:var(--text-secondary);line-height:1.8;">
                        <li>Click <strong>üìå Mini Overlay</strong> to show floating window</li>
                        <li>Click <strong>ü™ü Pop Out</strong> to open in separate window</li>
                        <li>Drag to reposition, resize from corner</li>
                    </ul>
                </div>
                
                <div class="setting-section">
                    <h3>ü™ü Keep Pop-Out Window on Top</h3>
                    <div style="background:var(--bg-secondary);border-radius:12px;padding:16px;margin-top:8px;">
                        <div style="margin-bottom:16px;">
                            <strong style="font-size:1rem;">ü™ü Windows</strong>
                            <ol style="margin-left:20px;margin-top:8px;color:var(--text-secondary);line-height:1.8;">
                                <li>Install <a href="https://github.com/microsoft/PowerToys/releases" target="_blank" style="color:var(--accent-light);">Microsoft PowerToys</a> (free)</li>
                                <li>Click the pop-out attendance window</li>
                                <li>Press <strong style="color:var(--text-primary);">Win + Ctrl + T</strong></li>
                                <li>Window stays on top of PowerPoint! üìå</li>
                            </ol>
                        </div>
                        <div>
                            <strong style="font-size:1rem;">üçé Mac</strong>
                            <ol style="margin-left:20px;margin-top:8px;color:var(--text-secondary);line-height:1.8;">
                                <li>Install <a href="https://apps.apple.com/app/afloat/id1612376590" target="_blank" style="color:var(--accent-light);">Afloat</a> or <a href="https://www.macupdate.com/app/mac/31724/afloat" target="_blank" style="color:var(--accent-light);">Rectangle Pro</a></li>
                                <li>Or use <strong>Shortcut:</strong> Some apps use <strong style="color:var(--text-primary);">Cmd + Shift + T</strong></li>
                                <li>Alternative: Use Split View or position in corner</li>
                            </ol>
                        </div>
                    </div>
                </div>
                
                <div class="setting-section">
                    <h3>üî• Streaks</h3>
                    <ul style="margin-left:20px;color:var(--text-secondary);line-height:1.8;">
                        <li>Students build streaks for consecutive on-time days</li>
                        <li>3+ days shows a badge on their card</li>
                        <li>5+ days = üî• fire badge</li>
                        <li>View full history by right-clicking ‚Üí View History</li>
                    </ul>
                </div>
                
                <div style="margin-top:24px;text-align:center;">
                    <button class="btn btn-primary" onclick="closeHelp()">Got it!</button>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Mini Overlay -->
    <div class="mini-overlay" id="miniOverlay">
        <div class="mini-header" id="miniHeader">
            <span class="mini-title">üìã Attendance</span>
            <div class="mini-stats">
                <span class="mini-stat ontime" id="miniOntime">0</span>
                <span class="mini-stat late" id="miniLate">0</span>
                <span class="mini-stat absent" id="miniAbsent">0</span>
            </div>
            <div class="mini-controls">
                <button class="mini-btn" onclick="popOutMini()" title="Pop out to separate window">ü™ü</button>
                <button class="mini-btn" onclick="adjustMiniOpacity(-0.1)" title="More transparent">üëª</button>
                <button class="mini-btn" onclick="adjustMiniOpacity(0.1)" title="Less transparent">üî≤</button>
                <button class="mini-btn" onclick="toggleMiniOverlay()" title="Close">‚úï</button>
            </div>
        </div>
        <div class="mini-grid" id="miniGrid">
            <!-- Mini student cards -->
        </div>
        <div class="mini-resize" id="miniResize"></div>
    </div>

    <script>
        // ========== APP STATE ==========
        let students = [];
        let classData = null;
        let currentZoom = 1;
        let editMode = false;
        let contextStudentId = null;
        let currentGroups = [];
        
        // Schedule state
        let schedule = {
            period: 1,
            startTime: '08:40',
            endTime: '10:00',
            pattern: 'oneoff',
            patternName: ''
        };
        
        // Attendance history: { date: { studentId: { status, time, note, lateBy } } }
        let attendanceHistory = {};
        
        // Student streaks: { studentId: { current: N, best: N, lastDate: 'YYYY-MM-DD' } }
        let streaks = {};
        
        // Fun messages
        const ontimeMessages = [
            "‚úì On time!",
            "‚úì Nice! Right on time",
            "‚úì Perfect timing!",
            "‚úì Looking good!",
            "‚úì Nailed it!"
        ];
        
        const streakMessages = {
            3: "üé© Hat trick! 3 days on time!",
            5: "üî• On fire! 5 days!",
            10: "‚≠ê Perfect 10! You're unstoppable!",
            20: "üèÜ Legend status! 20 days!"
        };
        
        const improvementMessages = [
            "üìà Better than yesterday!",
            "üìà Improvement! Keep it up!",
            "üìà Nice progress!"
        ];
        
        // Britannia bell schedule presets
        const presets = {
            regular: {
                1: { start: '08:40', end: '10:00' },
                2: { start: '10:10', end: '11:30' },
                3: { start: '12:15', end: '13:35' },
                4: { start: '13:45', end: '15:05' }
            },
            amfit: { // Wed, Fri
                1: { start: '09:20', end: '10:20' },
                2: { start: '10:30', end: '11:30' },
                3: { start: '12:15', end: '13:35' },
                4: { start: '13:45', end: '15:05' }
            },
            pmfit: { // Tue, Thu
                1: { start: '08:40', end: '10:00' },
                2: { start: '10:10', end: '11:30' },
                3: { start: '12:15', end: '13:15' },
                4: { start: '13:25', end: '14:25' }
            }
        };
        
        // ========== DATE HELPERS ==========
        function getToday() {
            return new Date().toISOString().split('T')[0];
        }
        
        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }
        
        function parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            const d = new Date();
            d.setHours(hours, minutes, 0, 0);
            return d;
        }
        
        // ========== SCHEDULE ==========
        let weeklyPattern = {
            type: 'simple', // simple, biweekly, cycle
            simple: { mon: 'regular', tue: 'pmfit', wed: 'amfit', thu: 'pmfit', fri: 'amfit' },
            week1: { mon: 'regular', tue: 'pmfit', wed: 'amfit', thu: 'pmfit', fri: 'amfit' },
            week2: { mon: 'regular', tue: 'pmfit', wed: 'amfit', thu: 'pmfit', fri: 'amfit' },
            currentWeek: 1
        };
        
        let classAssignments = {
            1: { name: '', rosterId: null },
            2: { name: '', rosterId: null },
            3: { name: '', rosterId: null },
            4: { name: '', rosterId: null }
        };
        
        // Load saved patterns
        const savedWeekly = localStorage.getItem('hallpass_weeklyPattern');
        if (savedWeekly) {
            try { weeklyPattern = JSON.parse(savedWeekly); } catch(e) {}
        }
        const savedClasses = localStorage.getItem('hallpass_classAssignments');
        if (savedClasses) {
            try { classAssignments = JSON.parse(savedClasses); } catch(e) {}
        }
        
        function openSchedule() {
            // Update today's date display
            const now = new Date();
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            document.getElementById('schedTodayDate').textContent = 
                `${dayNames[now.getDay()]}, ${monthNames[now.getMonth()]} ${now.getDate()}`;
            
            // Load current values
            document.getElementById('schedPeriod').value = schedule.period;
            document.getElementById('schedStart').value = schedule.startTime;
            document.getElementById('schedEnd').value = schedule.endTime;
            document.getElementById('schedType').value = schedule.scheduleType || 'regular';
            
            // Populate class dropdown
            populateClassDropdown();
            
            // Load weekly pattern
            loadWeeklyPatternUI();
            
            // Load class assignments
            loadClassAssignmentsUI();
            
            updateSchedulePreview();
            showSchedTab('today');
            document.getElementById('scheduleModal').classList.add('open');
        }
        
        function closeSchedule() {
            document.getElementById('scheduleModal').classList.remove('open');
        }
        
        function showSchedTab(tab) {
            document.querySelectorAll('.sched-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sched-panel').forEach(p => p.classList.remove('active'));
            
            document.querySelector(`.sched-tab[onclick*="${tab}"]`)?.classList.add('active');
            document.getElementById('schedPanel' + tab.charAt(0).toUpperCase() + tab.slice(1))?.classList.add('active');
        }
        
        function updateSchedulePreview() {
            const start = parseTime(document.getElementById('schedStart').value);
            const end = parseTime(document.getElementById('schedEnd').value);
            
            // Hall pass: 10 min after start until 10 min before end
            const passStart = new Date(start.getTime() + 10 * 60000);
            const passEnd = new Date(end.getTime() - 10 * 60000);
            
            document.getElementById('hallpassWindow').textContent = 
                `${formatTime(passStart)} - ${formatTime(passEnd)}`;
        }
        
        function onSchedTypeChange() {
            const type = document.getElementById('schedType').value;
            const period = parseInt(document.getElementById('schedPeriod').value);
            
            if (type !== 'custom' && presets[type] && presets[type][period]) {
                document.getElementById('schedStart').value = presets[type][period].start;
                document.getElementById('schedEnd').value = presets[type][period].end;
                updateSchedulePreview();
            }
        }
        
        function onClassChange() {
            const classSelect = document.getElementById('schedClass');
            const className = classSelect.options[classSelect.selectedIndex]?.text || '';
            // Could auto-load roster here
        }
        
        function populateClassDropdown() {
            const select = document.getElementById('schedClass');
            select.innerHTML = '<option value="">-- Select Class --</option>';
            
            Object.entries(classAssignments).forEach(([period, data]) => {
                if (data.name) {
                    const opt = document.createElement('option');
                    opt.value = period;
                    opt.textContent = `P${period}: ${data.name}`;
                    select.appendChild(opt);
                }
            });
            
            // Select current period's class
            if (classAssignments[schedule.period]?.name) {
                select.value = schedule.period;
            }
        }
        
        function loadWeeklyPatternUI() {
            // Set pattern type
            document.getElementById('weekPatternType').value = weeklyPattern.type;
            onWeekPatternTypeChange();
            
            // Load simple pattern
            document.querySelectorAll('.day-sched').forEach(sel => {
                const day = sel.dataset.day;
                sel.value = weeklyPattern.simple[day] || 'regular';
            });
            
            // Set current week
            const weekSelect = document.getElementById('currentWeekNum');
            if (weekSelect) weekSelect.value = weeklyPattern.currentWeek || 1;
        }
        
        function onWeekPatternTypeChange() {
            const type = document.getElementById('weekPatternType').value;
            document.getElementById('weekPatternSimple').style.display = type === 'simple' ? 'block' : 'none';
            document.getElementById('weekPatternBiweekly').style.display = type === 'biweekly' ? 'block' : 'none';
        }
        
        function loadClassAssignmentsUI() {
            document.querySelectorAll('.class-assignment').forEach(row => {
                const period = row.dataset.period;
                const input = row.querySelector('.class-name-input');
                if (input && classAssignments[period]) {
                    input.value = classAssignments[period].name || '';
                }
            });
        }
        
        function loadRosterForPeriod(period) {
            // Open file picker to load a roster JSON for this period
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = JSON.parse(evt.target.result);
                        // Save roster reference
                        const className = document.querySelector(`.class-assignment[data-period="${period}"] .class-name-input`).value || `Period ${period}`;
                        classAssignments[period] = {
                            name: className,
                            roster: data.students || data
                        };
                        localStorage.setItem('hallpass_classAssignments', JSON.stringify(classAssignments));
                        showToast(`Loaded roster for ${className}`);
                    } catch (err) {
                        showToast('Error loading roster file');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function loadPreset(preset) {
            const period = parseInt(document.getElementById('schedPeriod').value);
            const times = presets[preset][period];
            if (times) {
                document.getElementById('schedStart').value = times.start;
                document.getElementById('schedEnd').value = times.end;
                document.getElementById('schedType').value = preset;
                updateSchedulePreview();
                showToast('Loaded ' + preset + ' preset');
                showSchedTab('today');
            }
        }
        
        function createCustomPreset() {
            const name = prompt('Enter preset name:');
            if (!name) return;
            // Would open a full preset editor - for now just show a message
            showToast('Custom preset editor coming soon!');
        }
        
        function saveSchedule() {
            // Save today's settings
            schedule.period = parseInt(document.getElementById('schedPeriod').value);
            schedule.startTime = document.getElementById('schedStart').value;
            schedule.endTime = document.getElementById('schedEnd').value;
            schedule.scheduleType = document.getElementById('schedType').value;
            
            localStorage.setItem('hallpass_schedule', JSON.stringify(schedule));
            
            // Save weekly pattern
            weeklyPattern.type = document.getElementById('weekPatternType').value;
            document.querySelectorAll('.day-sched').forEach(sel => {
                const day = sel.dataset.day;
                weeklyPattern.simple[day] = sel.value;
            });
            const weekSelect = document.getElementById('currentWeekNum');
            if (weekSelect) weeklyPattern.currentWeek = parseInt(weekSelect.value);
            localStorage.setItem('hallpass_weeklyPattern', JSON.stringify(weeklyPattern));
            
            // Save class assignments
            document.querySelectorAll('.class-assignment').forEach(row => {
                const period = row.dataset.period;
                const input = row.querySelector('.class-name-input');
                if (input) {
                    if (!classAssignments[period]) classAssignments[period] = {};
                    classAssignments[period].name = input.value;
                }
            });
            localStorage.setItem('hallpass_classAssignments', JSON.stringify(classAssignments));
            
            updateDateDisplay();
            updateStatusBar();
            closeSchedule();
            showToast('Schedule saved!');
        }
        
        function getTodayScheduleType() {
            const now = new Date();
            const dayIndex = now.getDay(); // 0=Sun, 1=Mon, etc.
            const dayKeys = ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'];
            const dayKey = dayKeys[dayIndex];
            
            if (weeklyPattern.type === 'simple') {
                return weeklyPattern.simple[dayKey] || 'regular';
            } else if (weeklyPattern.type === 'biweekly') {
                const pattern = weeklyPattern.currentWeek === 1 ? weeklyPattern.week1 : weeklyPattern.week2;
                return pattern[dayKey] || 'regular';
            }
            return 'regular';
        }
        
        function updateDateDisplay() {
            const now = new Date();
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            const dayEl = document.getElementById('dateDay');
            const fullEl = document.getElementById('dateFull');
            const typeEl = document.getElementById('scheduleType');
            const classNameEl = document.getElementById('className');
            
            if (dayEl) dayEl.textContent = dayNames[now.getDay()];
            if (fullEl) fullEl.textContent = `${monthNames[now.getMonth()]} ${now.getDate()}`;
            
            // Get schedule type for today
            const todayType = getTodayScheduleType();
            if (typeEl) {
                typeEl.textContent = todayType === 'regular' ? 'Regular' : 
                                    todayType === 'amfit' ? 'AM FIT' : 
                                    todayType === 'pmfit' ? 'PM FIT' : 
                                    todayType === 'noschool' ? 'No School' : todayType;
                typeEl.className = 'schedule-type ' + todayType;
            }
            
            // Show class name for current period
            const className = classAssignments[schedule.period]?.name;
            if (classNameEl) {
                classNameEl.textContent = className || '';
            }
            
            // Auto-apply schedule type if not manually overridden today
            if (presets[todayType] && presets[todayType][schedule.period]) {
                // Only auto-apply if schedule hasn't been manually set today
                const lastSaved = localStorage.getItem('hallpass_schedule_date');
                const today = getToday();
                if (lastSaved !== today) {
                    schedule.scheduleType = todayType;
                    schedule.startTime = presets[todayType][schedule.period].start;
                    schedule.endTime = presets[todayType][schedule.period].end;
                    localStorage.setItem('hallpass_schedule', JSON.stringify(schedule));
                    localStorage.setItem('hallpass_schedule_date', today);
                }
            }
        }
        
        // ========== COUNTDOWN & STATUS ==========
        function updateStatusBar() {
            // Update date display
            updateDateDisplay();
            
            const now = new Date();
            const start = parseTime(schedule.startTime);
            const end = parseTime(schedule.endTime);
            
            const periodBadge = document.getElementById('periodBadge');
            const countdown = document.getElementById('countdown');
            const classStatus = document.getElementById('classStatus');
            
            // Show period and time range
            const startFormatted = formatTime(start);
            const endFormatted = formatTime(end);
            periodBadge.textContent = `Period ${schedule.period}`;
            periodBadge.title = `${startFormatted} - ${endFormatted}`;
            
            if (now < start) {
                // Pre-class
                const diff = start - now;
                const mins = Math.floor(diff / 60000);
                const secs = Math.floor((diff % 60000) / 1000);
                countdown.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                countdown.className = 'countdown pre-class';
                classStatus.textContent = `Class starts in ${mins} minute${mins !== 1 ? 's' : ''}`;
            } else if (now < end) {
                // In class
                const diff = end - now;
                const mins = Math.floor(diff / 60000);
                countdown.textContent = `${mins}m left`;
                countdown.className = mins <= 10 ? 'countdown ending-soon' : 'countdown in-class';
                classStatus.textContent = 'Class in session';
            } else {
                // After class
                countdown.textContent = 'Done';
                countdown.className = 'countdown';
                classStatus.textContent = 'Class ended';
            }
            
            // Update stats
            updateStats();
        }
        
        function updateStats() {
            let ontime = 0, late = 0, absent = 0;
            students.forEach(s => {
                if (s.status === 'ontime') ontime++;
                else if (s.status === 'late') late++;
                else if (s.status !== 'excused' && s.status !== 'withdrawn') absent++;
            });
            
            document.getElementById('statOntime').textContent = ontime;
            document.getElementById('statLate').textContent = late;
            document.getElementById('statAbsent').textContent = absent;
        }
        
        // ========== CHECK-IN LOGIC ==========
        function handleStudentClick(event, studentId) {
            if (editMode) return;
            
            // Right-click opens context menu
            if (event.button === 2) {
                openContextMenu(event, studentId);
                return;
            }
            
            // Left-click: toggle check-in
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // If already checked in, do nothing (use right-click to change)
            if (student.status === 'ontime' || student.status === 'late') {
                showToast('Right-click to change status');
                return;
            }
            
            // Check in
            checkInStudent(student);
        }
        
        function checkInStudent(student) {
            const now = new Date();
            const start = parseTime(schedule.startTime);
            
            // Determine on-time vs late
            const isLate = now > start;
            student.status = isLate ? 'late' : 'ontime';
            student.checkInTime = now.toISOString();
            
            if (isLate) {
                const lateBy = Math.floor((now - start) / 60000);
                student.lateBy = lateBy;
                student.statusText = `Late by ${lateBy}m`;
            } else {
                student.lateBy = 0;
                student.statusText = ontimeMessages[Math.floor(Math.random() * ontimeMessages.length)];
            }
            
            // Update streak
            updateStreak(student, isLate);
            
            // Save to today's attendance
            saveAttendance(student);
            
            // Show fun effects
            if (!isLate) {
                const streak = streaks[student.id]?.current || 0;
                if (streakMessages[streak]) {
                    showToast(streakMessages[streak]);
                    spawnConfetti();
                } else {
                    showToast(student.statusText);
                }
            } else {
                // Check for improvement
                const yesterday = getYesterdayAttendance(student.id);
                if (yesterday?.lateBy && student.lateBy < yesterday.lateBy) {
                    const improvement = yesterday.lateBy - student.lateBy;
                    student.statusText += ` (${improvement}m better than yesterday!)`;
                    showToast(improvementMessages[Math.floor(Math.random() * improvementMessages.length)]);
                } else {
                    showToast(`Late by ${student.lateBy} minutes`);
                }
            }
            
            renderCanvas();
            updateStats();
            saveClass();
        }
        
        function updateStreak(student, isLate) {
            const today = getToday();
            if (!streaks[student.id]) {
                streaks[student.id] = { current: 0, best: 0, lastDate: null, broken: false };
            }
            
            const streak = streaks[student.id];
            
            if (!isLate) {
                // Clear broken flag on on-time arrival
                streak.broken = false;
                
                // Check if continuing streak (was yesterday)
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                
                if (streak.lastDate === yesterdayStr || streak.lastDate === today) {
                    if (streak.lastDate !== today) {
                        streak.current++;
                    }
                } else {
                    streak.current = 1;
                }
                
                streak.best = Math.max(streak.best, streak.current);
                streak.lastDate = today;
            } else {
                // Late breaks streak - flag if they had a good streak going
                if (streak.current >= 3) {
                    streak.broken = true;
                    streak.brokenFrom = streak.current;
                }
                streak.current = 0;
            }
            
            localStorage.setItem('hallpass_streaks', JSON.stringify(streaks));
        }
        
        function getYesterdayAttendance(studentId) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const dateStr = yesterday.toISOString().split('T')[0];
            return attendanceHistory[dateStr]?.[studentId];
        }
        
        function saveAttendance(student) {
            const today = getToday();
            if (!attendanceHistory[today]) {
                attendanceHistory[today] = {};
            }
            
            attendanceHistory[today][student.id] = {
                status: student.status,
                time: student.checkInTime,
                lateBy: student.lateBy || 0,
                note: student.note || ''
            };
            
            localStorage.setItem('hallpass_attendance', JSON.stringify(attendanceHistory));
        }
        
        // ========== CONTEXT MENU ==========
        function openContextMenu(event, studentId) {
            event.preventDefault();
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            contextStudentId = studentId;
            
            const menu = document.getElementById('contextMenu');
            const name = student.displayName || `${student.firstName} ${student.lastInitial}.`;
            document.getElementById('contextMenuHeader').textContent = name;
            document.getElementById('contextMenuNote').value = student.note || '';
            
            // Update hall pass option based on student's pass status
            updateHallPassContextMenu();
            
            // Smart positioning - keep menu on screen
            positionContextMenu(menu, event.clientX, event.clientY);
            menu.classList.add('open');
        }
        
        function positionContextMenu(menu, x, y) {
            // Temporarily show to get dimensions
            menu.style.visibility = 'hidden';
            menu.style.display = 'block';
            const menuRect = menu.getBoundingClientRect();
            menu.style.display = '';
            menu.style.visibility = '';
            
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            // Adjust X if menu would go off right edge
            if (x + menuRect.width > viewportWidth - 10) {
                x = viewportWidth - menuRect.width - 10;
            }
            
            // Adjust Y if menu would go off bottom edge
            if (y + menuRect.height > viewportHeight - 10) {
                y = viewportHeight - menuRect.height - 10;
            }
            
            // Ensure minimum values
            x = Math.max(10, x);
            y = Math.max(10, y);
            
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
        }
        
        function closeContextMenu() {
            document.getElementById('contextMenu').classList.remove('open');
            contextStudentId = null;
        }
        
        function setStatus(status) {
            if (!contextStudentId) return;
            const student = students.find(s => s.id === contextStudentId);
            if (!student) return;
            
            student.status = status;
            student.checkInTime = new Date().toISOString();
            
            if (status === 'late' && !student.lateBy) {
                const now = new Date();
                const start = parseTime(schedule.startTime);
                student.lateBy = Math.max(0, Math.floor((now - start) / 60000));
            }
            
            // Log correction
            logCorrection(student, status);
            saveAttendance(student);
            renderCanvas();
            updateStats();
            closeContextMenu();
            showToast(`Marked ${student.firstName} as ${status}`);
            saveClass();
        }
        
        function clearStatus() {
            if (!contextStudentId) return;
            const student = students.find(s => s.id === contextStudentId);
            if (!student) return;
            
            student.status = 'unchecked';
            student.checkInTime = null;
            student.lateBy = null;
            student.statusText = null;
            
            saveAttendance(student);
            renderCanvas();
            updateStats();
            closeContextMenu();
            showToast(`Cleared status for ${student.firstName}`);
            saveClass();
        }
        
        function saveNote() {
            if (!contextStudentId) return;
            const student = students.find(s => s.id === contextStudentId);
            if (!student) return;
            
            student.note = document.getElementById('contextMenuNote').value;
            saveAttendance(student);
            closeContextMenu();
            showToast('Note saved');
            saveClass();
        }
        
        function logCorrection(student, newStatus) {
            const corrections = JSON.parse(localStorage.getItem('hallpass_corrections') || '[]');
            corrections.push({
                date: getToday(),
                time: new Date().toISOString(),
                studentId: student.id,
                studentName: student.firstName + ' ' + student.lastInitial,
                newStatus,
                note: student.note || ''
            });
            localStorage.setItem('hallpass_corrections', JSON.stringify(corrections));
        }
        
        function viewStudentHistory() {
            if (!contextStudentId) return;
            closeContextMenu();
            showStudentHistoryModal(contextStudentId);
        }
        
        // ========== STUDENT HISTORY MODAL ==========
        function showStudentHistoryModal(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const name = student.displayName || `${student.firstName} ${student.lastInitial}.`;
            document.getElementById('studentHistoryTitle').textContent = `üìä ${name}'s History`;
            
            const streak = streaks[studentId] || { current: 0, best: 0 };
            
            // Get last 14 days of attendance
            const days = [];
            for (let i = 0; i < 14; i++) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                const record = attendanceHistory[dateStr]?.[studentId];
                if (record) {
                    days.push({ date: dateStr, ...record });
                }
            }
            
            // Calculate stats
            const ontimeCount = days.filter(d => d.status === 'ontime').length;
            const lateCount = days.filter(d => d.status === 'late').length;
            const absentCount = days.filter(d => d.status === 'absent').length;
            const avgLateBy = days.filter(d => d.lateBy > 0).length > 0
                ? Math.round(days.filter(d => d.lateBy > 0).reduce((a, d) => a + d.lateBy, 0) / days.filter(d => d.lateBy > 0).length)
                : 0;
            
            let html = `
                <div class="summary-grid" style="margin-bottom:24px;">
                    <div class="summary-stat ontime">
                        <span class="summary-label">Current Streak</span>
                        <span class="summary-value">${streak.current} ${streak.current >= 5 ? 'üî•' : ''}</span>
                    </div>
                    <div class="summary-stat" style="border-left:4px solid var(--accent);">
                        <span class="summary-label">Best Streak</span>
                        <span class="summary-value">${streak.best}</span>
                    </div>
                </div>
                
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px;">
                    <div style="text-align:center;">
                        <div style="font-size:1.5rem;font-weight:700;color:var(--success);">${ontimeCount}</div>
                        <div style="font-size:0.8rem;color:var(--text-secondary);">On Time</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:1.5rem;font-weight:700;color:var(--warning);">${lateCount}</div>
                        <div style="font-size:0.8rem;color:var(--text-secondary);">Late</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:1.5rem;font-weight:700;color:var(--danger);">${absentCount}</div>
                        <div style="font-size:0.8rem;color:var(--text-secondary);">Absent</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:1.5rem;font-weight:700;color:var(--warning);">${avgLateBy}m</div>
                        <div style="font-size:0.8rem;color:var(--text-secondary);">Avg Late</div>
                    </div>
                </div>
                
                <h3 style="margin-bottom:12px;">Recent Days</h3>
                <div class="history-panel" style="margin-top:0;">
            `;
            
            if (days.length === 0) {
                html += '<p style="color:var(--text-secondary);">No attendance records yet.</p>';
            } else {
                days.slice(0, 10).forEach(d => {
                    const dateObj = new Date(d.date + 'T12:00:00');
                    const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    const lateText = d.lateBy > 0 ? ` (+${d.lateBy}m)` : '';
                    html += `
                        <div class="history-row">
                            <span>${dateStr}</span>
                            <span class="history-status ${d.status}">${d.status}${lateText}</span>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            
            document.getElementById('studentHistoryContent').innerHTML = html;
            document.getElementById('studentHistoryModal').classList.add('open');
        }
        
        function closeStudentHistory() {
            document.getElementById('studentHistoryModal').classList.remove('open');
        }
        
        // ========== CLOSE ATTENDANCE ==========
        function closeAttendance() {
            const now = new Date();
            const end = parseTime(schedule.endTime);
            
            // Mark remaining as absent
            students.forEach(s => {
                if (!s.status || s.status === 'unchecked') {
                    s.status = 'absent';
                    s.checkInTime = now.toISOString();
                    saveAttendance(s);
                }
            });
            
            // Show summary
            showSummary();
            saveClass();
        }
        
        function showSummary() {
            const today = getToday();
            const ontime = students.filter(s => s.status === 'ontime');
            const late = students.filter(s => s.status === 'late');
            const absent = students.filter(s => s.status === 'absent');
            const excused = students.filter(s => s.status === 'excused');
            
            const className = classData?.settings?.className || 'Class';
            const dateStr = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            
            let html = `
                <div style="text-align:center;margin-bottom:24px;">
                    <h3>${className}</h3>
                    <p style="color:var(--text-secondary);">${dateStr} ‚Ä¢ Period ${schedule.period}</p>
                </div>
                
                <div class="summary-grid">
                    <div class="summary-stat ontime">
                        <div>
                            <span class="summary-label">‚úÖ On Time</span>
                            <div class="summary-names">${ontime.map(s => s.firstName).join(', ') || 'None'}</div>
                        </div>
                        <span class="summary-value">${ontime.length}</span>
                    </div>
                    <div class="summary-stat late">
                        <div>
                            <span class="summary-label">‚ö†Ô∏è Late</span>
                            <div class="summary-names">${late.map(s => s.firstName + (s.lateBy ? ` +${s.lateBy}m` : '')).join(', ') || 'None'}</div>
                        </div>
                        <span class="summary-value">${late.length}</span>
                    </div>
                    <div class="summary-stat absent">
                        <div>
                            <span class="summary-label">‚ùå Absent</span>
                            <div class="summary-names">${absent.map(s => s.firstName).join(', ') || 'None'}</div>
                        </div>
                        <span class="summary-value">${absent.length}</span>
                    </div>
            `;
            
            if (excused.length > 0) {
                html += `
                    <div class="summary-stat excused">
                        <div>
                            <span class="summary-label">üìù Excused</span>
                            <div class="summary-names">${excused.map(s => s.firstName).join(', ')}</div>
                        </div>
                        <span class="summary-value">${excused.length}</span>
                    </div>
                `;
            }
            
            html += `
                </div>
                <div style="margin-top:24px;text-align:center;">
                    <button class="btn btn-primary" onclick="closeSummary()">Done</button>
                </div>
            `;
            
            document.getElementById('summaryContent').innerHTML = html;
            document.getElementById('summaryModal').classList.add('open');
        }
        
        function closeSummary() {
            document.getElementById('summaryModal').classList.remove('open');
        }
        
        // ========== RESET DAY ==========
        function resetAttendance() {
            if (!confirm('Reset attendance for all students today?')) return;
            
            students.forEach(s => {
                s.status = 'unchecked';
                s.checkInTime = null;
                s.lateBy = null;
                s.statusText = null;
            });
            
            // Clear today's attendance
            const today = getToday();
            delete attendanceHistory[today];
            localStorage.setItem('hallpass_attendance', JSON.stringify(attendanceHistory));
            
            renderCanvas();
            updateStats();
            saveClass();
            showToast('Attendance reset');
        }
        
        // ========== RENDERING ==========
        function renderCanvas() {
            const canvas = document.getElementById('seatingCanvas');
            if (!canvas) return;
            
            if (students.length === 0) {
                canvas.innerHTML = `
                    <div style="text-align:center;padding:60px;color:var(--text-secondary);">
                        <div style="font-size:3rem;margin-bottom:16px;">üì•</div>
                        <h3>No class loaded</h3>
                        <p>Click ‚öôÔ∏è Settings to import a class</p>
                    </div>
                `;
                return;
            }
            
            const cardWidth = 100;
            const cardHeight = 130;
            const padding = 20;
            const gap = 15;
            
            // Calculate optimal grid: prefer wider layouts (more columns)
            // For 30 students: 6x5, for 35: 7x5, for 40: 8x5, etc.
            const studentCount = students.length;
            let cols = Math.min(10, Math.max(4, Math.ceil(Math.sqrt(studentCount * 1.5))));
            let rows = Math.ceil(studentCount / cols);
            
            // Adjust canvas size to fit all students
            const seatingEl = document.getElementById('seatingCanvas');
            const neededWidth = padding * 2 + cols * (cardWidth + gap);
            const neededHeight = padding * 2 + rows * (cardHeight + gap);
            seatingEl.style.minWidth = neededWidth + 'px';
            seatingEl.style.minHeight = neededHeight + 'px';
            
            // Migrate positions for students without positions
            students.forEach((s, idx) => {
                if (!s.position || s.position.x === undefined) {
                    s.position = {
                        x: padding + (idx % cols) * (cardWidth + gap),
                        y: padding + Math.floor(idx / cols) * (cardHeight + gap)
                    };
                }
            });
            
            let html = '';
            students.forEach(s => {
                const imgSrc = getStudentImage(s);
                const name = s.displayName || `${s.firstName} ${s.lastInitial || ''}.`;
                const status = s.status || 'unchecked';
                const streak = streaks[s.id]?.current || 0;
                
                let statusHtml = '';
                if (status === 'ontime') {
                    statusHtml = `<div class="student-status">${s.statusText || '‚úì On time'}</div>`;
                } else if (status === 'late') {
                    statusHtml = `
                        <div class="student-status">‚ö†Ô∏è Late</div>
                        <div class="late-timer">+${s.lateBy || 0}m</div>
                    `;
                } else if (status === 'absent') {
                    statusHtml = `<div class="student-status" style="color:var(--danger);">‚ùå Absent</div>`;
                } else if (status === 'excused') {
                    statusHtml = `<div class="student-status" style="color:var(--excused);">üìù Excused</div>`;
                } else {
                    statusHtml = `<div class="student-status">Tap to check in</div>`;
                }
                
                let streakBadge = '';
                if (streak >= 3) {
                    streakBadge = `<div class="streak-badge${streak >= 5 ? ' fire' : ''}">${streak}</div>`;
                }
                
                html += `
                    <div class="canvas-student ${status}" 
                         data-id="${s.id}"
                         style="left:${s.position.x}px; top:${s.position.y}px;"
                         onclick="handleStudentClick(event, ${s.id})"
                         oncontextmenu="handleStudentClick(event, ${s.id}); return false;"
                         onmousedown="startDrag(event, ${s.id})"
                         ontouchstart="startDrag(event, ${s.id})">
                        ${streakBadge}
                        <img class="student-avatar" src="${imgSrc}" alt="${name}">
                        <div class="student-name">${name}</div>
                        ${statusHtml}
                    </div>
                `;
            });
            
            canvas.innerHTML = html;
        }
        
        function getStudentImage(student) {
            if (student.caricatures?.photo) return student.caricatures.photo;
            if (student.caricature) return student.caricature;
            return `https://api.dicebear.com/7.x/avataaars/svg?seed=${student.firstName}`;
        }
        
        // ========== EDIT MODE ==========
        let dragState = null;
        
        function toggleEditMode() {
            editMode = !editMode;
            const canvas = document.getElementById('seatingCanvas');
            const btn = document.getElementById('editModeBtn');
            
            if (editMode) {
                canvas.classList.add('edit-mode');
                btn.classList.add('active');
                btn.textContent = '‚úì Done Editing';
            } else {
                canvas.classList.remove('edit-mode');
                btn.classList.remove('active');
                btn.textContent = '‚úèÔ∏è Edit Layout';
                saveClass();
            }
        }
        
        function startDrag(event, studentId) {
            if (!editMode) return;
            event.preventDefault();
            
            const canvas = document.getElementById('seatingCanvas');
            const studentEl = canvas.querySelector(`[data-id="${studentId}"]`);
            if (!studentEl) return;
            
            const touch = event.touches ? event.touches[0] : event;
            
            dragState = {
                studentId,
                element: studentEl,
                startX: touch.clientX,
                startY: touch.clientY,
                origLeft: parseInt(studentEl.style.left),
                origTop: parseInt(studentEl.style.top)
            };
            
            studentEl.classList.add('dragging');
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchmove', onDrag, { passive: false });
            document.addEventListener('touchend', endDrag);
        }
        
        function onDrag(event) {
            if (!dragState) return;
            event.preventDefault();
            
            const touch = event.touches ? event.touches[0] : event;
            const dx = touch.clientX - dragState.startX;
            const dy = touch.clientY - dragState.startY;
            
            dragState.element.style.left = (dragState.origLeft + dx) + 'px';
            dragState.element.style.top = (dragState.origTop + dy) + 'px';
        }
        
        function endDrag() {
            if (!dragState) return;
            
            const student = students.find(s => s.id === dragState.studentId);
            if (student) {
                student.position = {
                    x: parseInt(dragState.element.style.left),
                    y: parseInt(dragState.element.style.top)
                };
            }
            
            dragState.element.classList.remove('dragging');
            dragState = null;
            
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchmove', onDrag);
            document.removeEventListener('touchend', endDrag);
        }
        
        function zoomCanvas(delta) {
            const canvas = document.getElementById('seatingCanvas');
            if (delta === 0) {
                currentZoom = 1;
            } else {
                currentZoom = Math.max(0.5, Math.min(2, currentZoom + delta));
            }
            canvas.style.transform = `scale(${currentZoom})`;
            canvas.style.transformOrigin = 'top left';
        }
        
        // ========== GROUPS ==========
        const groupColors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899'];
        
        function makeGroups(size) {
            if (students.length === 0) {
                showToast('No students loaded');
                return;
            }
            
            const shuffled = [...students].sort(() => Math.random() - 0.5);
            currentGroups = [];
            
            for (let i = 0; i < shuffled.length; i += size) {
                currentGroups.push({
                    id: currentGroups.length + 1,
                    members: shuffled.slice(i, i + size),
                    color: groupColors[currentGroups.length % groupColors.length]
                });
            }
            
            renderGroups();
        }
        
        function shuffleGroups() {
            if (currentGroups.length === 0) {
                makeGroups(2);
            } else {
                const avgSize = Math.round(currentGroups.reduce((a, g) => a + g.members.length, 0) / currentGroups.length);
                makeGroups(avgSize);
            }
        }
        
        function renderGroups() {
            const container = document.getElementById('groupsContainer');
            if (!container) return;
            
            if (currentGroups.length === 0) {
                container.innerHTML = '<p style="color:var(--text-secondary);">Click a group size above to create groups.</p>';
                return;
            }
            
            container.innerHTML = currentGroups.map(g => `
                <div style="background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:12px;border-left:4px solid ${g.color};">
                    <h4 style="margin-bottom:12px;">Group ${g.id}</h4>
                    <div style="display:flex;flex-wrap:wrap;gap:12px;">
                        ${g.members.map(m => `
                            <div style="display:flex;align-items:center;gap:8px;">
                                <img src="${getStudentImage(m)}" style="width:32px;height:32px;border-radius:50%;">
                                <span>${m.displayName || m.firstName}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        // ========== SAVE/LOAD GROUPS ==========
        function saveCurrentGroups() {
            if (currentGroups.length === 0) {
                showToast('Create groups first!');
                return;
            }
            
            const name = prompt('Name these groups (e.g., "Project Teams", "Lab Partners"):');
            if (!name) return;
            
            const savedGroups = JSON.parse(localStorage.getItem('hallpass_saved_groups') || '[]');
            
            const groupData = {
                id: Date.now(),
                name: name,
                date: new Date().toISOString(),
                groupCount: currentGroups.length,
                groups: currentGroups.map(g => ({
                    id: g.id,
                    color: g.color,
                    memberIds: g.members.map(m => m.id),
                    memberNames: g.members.map(m => m.displayName || m.firstName)
                }))
            };
            
            savedGroups.unshift(groupData);
            
            // Keep max 20 saved groups
            if (savedGroups.length > 20) savedGroups.pop();
            
            localStorage.setItem('hallpass_saved_groups', JSON.stringify(savedGroups));
            showToast(`üíæ Saved "${name}"`);
        }
        
        function showSavedGroups() {
            const panel = document.getElementById('savedGroupsPanel');
            const list = document.getElementById('savedGroupsList');
            
            if (panel.style.display === 'block') {
                panel.style.display = 'none';
                return;
            }
            
            const savedGroups = JSON.parse(localStorage.getItem('hallpass_saved_groups') || '[]');
            
            if (savedGroups.length === 0) {
                list.innerHTML = '<p style="color:var(--text-secondary);">No saved groups yet. Create groups and click "Save Groups".</p>';
            } else {
                list.innerHTML = savedGroups.map(sg => {
                    const date = new Date(sg.date);
                    const dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    return `
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg-secondary);border-radius:8px;margin-bottom:8px;">
                            <div>
                                <div style="font-weight:500;">${sg.name}</div>
                                <div style="font-size:0.8rem;color:var(--text-secondary);">${dateStr} ‚Ä¢ ${sg.groupCount} groups</div>
                            </div>
                            <div style="display:flex;gap:8px;">
                                <button class="btn btn-primary" style="padding:6px 12px;font-size:0.85rem;" onclick="loadSavedGroup(${sg.id})">Load</button>
                                <button class="btn btn-danger" style="padding:6px 12px;font-size:0.85rem;" onclick="deleteSavedGroup(${sg.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            panel.style.display = 'block';
        }
        
        function loadSavedGroup(groupId) {
            const savedGroups = JSON.parse(localStorage.getItem('hallpass_saved_groups') || '[]');
            const saved = savedGroups.find(g => g.id === groupId);
            
            if (!saved) {
                showToast('Group not found');
                return;
            }
            
            // Rebuild groups with current student data
            currentGroups = saved.groups.map(g => ({
                id: g.id,
                color: g.color,
                members: g.memberIds.map(id => students.find(s => s.id === id)).filter(Boolean)
            }));
            
            // Check if any students are missing
            const missingCount = saved.groups.reduce((count, g) => 
                count + g.memberIds.filter(id => !students.find(s => s.id === id)).length, 0);
            
            if (missingCount > 0) {
                showToast(`‚ö†Ô∏è Loaded "${saved.name}" (${missingCount} students no longer in class)`);
            } else {
                showToast(`‚úì Loaded "${saved.name}"`);
            }
            
            document.getElementById('savedGroupsPanel').style.display = 'none';
            renderGroups();
        }
        
        function deleteSavedGroup(groupId) {
            if (!confirm('Delete this saved group?')) return;
            
            let savedGroups = JSON.parse(localStorage.getItem('hallpass_saved_groups') || '[]');
            savedGroups = savedGroups.filter(g => g.id !== groupId);
            localStorage.setItem('hallpass_saved_groups', JSON.stringify(savedGroups));
            
            showSavedGroups(); // Refresh the list
            showToast('Deleted');
        }
        
        // ========== VIEW SWITCHING ==========
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(viewName + 'View')?.classList.add('active');
            document.querySelectorAll('.nav-tab').forEach(t => {
                if (t.textContent.toLowerCase().includes(viewName)) {
                    t.classList.add('active');
                }
            });
            
            if (viewName === 'groups') renderGroups();
            if (viewName === 'history') renderHistoryView();
            if (viewName === 'hallpass') renderHallPassView();
        }
        
        // ========== HALL PASS SYSTEM ==========
        let hallPassQueue = []; // Array of { studentId, duration, reason, startTime, queuedAt }
        let selectedHpDuration = 3;
        let hallPassModalStudentId = null;
        
        function renderHallPassView() {
            const grid = document.getElementById('hallpassGrid');
            const queueEl = document.getElementById('hallpassQueue');
            const countEl = document.getElementById('queueCount');
            if (!grid || !queueEl) return;
            
            // Load hall pass state from localStorage
            const saved = localStorage.getItem('hallpass_queue');
            if (saved) {
                try { hallPassQueue = JSON.parse(saved); } catch(e) {}
            }
            
            // Clean up expired passes (auto-return after 30 min)
            const now = Date.now();
            hallPassQueue = hallPassQueue.filter(p => {
                if (p.startTime && (now - p.startTime) > 30 * 60 * 1000) {
                    // Auto-return after 30 min
                    logHallPassReturn(p);
                    return false;
                }
                return true;
            });
            saveHallPassQueue();
            
            // Render student grid
            grid.innerHTML = students.map(s => {
                const pass = hallPassQueue.find(p => p.studentId === s.id);
                const isOut = pass && pass.startTime;
                const inQueue = pass && !pass.startTime;
                const queuePos = inQueue ? hallPassQueue.filter(p => !p.startTime).findIndex(p => p.studentId === s.id) + 1 : 0;
                const img = getStudentImage(s);
                const name = s.preferredName || s.firstName || '';
                const lastName = s.lastName || '';
                const displayName = name + (lastName ? ' ' + lastName.charAt(0) + '.' : '');
                
                let timerHtml = '';
                if (isOut) {
                    const mins = Math.floor((now - pass.startTime) / 60000);
                    const etd = pass.duration - mins;
                    timerHtml = `<div class="pass-timer">üö∂ ${mins}m (ETD: ${etd > 0 ? etd : 0}m)</div>`;
                } else if (inQueue) {
                    timerHtml = `<div class="queue-pos">üìã #${queuePos} in queue</div>`;
                }
                
                return `
                    <div class="hp-student ${isOut ? 'on-pass' : ''} ${inQueue ? 'in-queue' : ''}" 
                         onclick="${isOut ? `returnFromPass(${s.id})` : `openHallPassModal(${s.id})`}">
                        <img src="${img}" alt="${name}">
                        <div class="name">${displayName}</div>
                        ${timerHtml}
                    </div>
                `;
            }).join('');
            
            // Render queue
            const activePass = hallPassQueue.find(p => p.startTime);
            const waiting = hallPassQueue.filter(p => !p.startTime);
            
            let queueHtml = '';
            
            if (activePass) {
                const student = students.find(s => s.id === activePass.studentId);
                if (student) {
                    const mins = Math.floor((now - activePass.startTime) / 60000);
                    const etd = activePass.duration - mins;
                    const img = getStudentImage(student);
                    queueHtml += `
                        <div class="queue-item active">
                            <img src="${img}">
                            <div class="info">
                                <div class="name">${student.preferredName || student.firstName}</div>
                                <div class="time">${activePass.reason || `${activePass.duration} min pass`}</div>
                            </div>
                            <div style="text-align:right;">
                                <div class="etd">ETD: ${etd > 0 ? etd : 0}m</div>
                                <button class="back-btn" onclick="returnFromPass(${student.id})">I'm Back</button>
                            </div>
                        </div>
                    `;
                }
            }
            
            waiting.forEach((p, i) => {
                const student = students.find(s => s.id === p.studentId);
                if (student) {
                    const img = getStudentImage(student);
                    queueHtml += `
                        <div class="queue-item">
                            <img src="${img}">
                            <div class="info">
                                <div class="name">${student.preferredName || student.firstName}</div>
                                <div class="time">#${i + 1} in queue ‚Ä¢ ${p.duration} min</div>
                            </div>
                            <button class="btn btn-secondary" style="font-size:11px;padding:4px 8px;" onclick="removeFromQueue(${student.id})">‚úï</button>
                        </div>
                    `;
                }
            });
            
            if (!activePass && waiting.length === 0) {
                queueHtml = '<div style="text-align:center;padding:24px;color:var(--text-secondary);">No active passes</div>';
            }
            
            queueEl.innerHTML = queueHtml;
            countEl.textContent = hallPassQueue.length;
            
            // Update context menu item based on student status
            updateHallPassContextMenu();
        }
        
        function openHallPassModal(studentId) {
            hallPassModalStudentId = studentId;
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // Check if already has a pass
            const existingPass = hallPassQueue.find(p => p.studentId === studentId);
            if (existingPass) {
                if (existingPass.startTime) {
                    // Already out - offer to return
                    if (confirm(`${student.preferredName || student.firstName} is already out. Mark as returned?`)) {
                        returnFromPass(studentId);
                    }
                } else {
                    // In queue - offer to remove
                    if (confirm(`${student.preferredName || student.firstName} is in the queue. Remove from queue?`)) {
                        removeFromQueue(studentId);
                    }
                }
                return;
            }
            
            // Set up modal
            const img = getStudentImage(student);
            document.getElementById('hallpassModalImg').src = img;
            document.getElementById('hallpassModalName').textContent = student.preferredName || student.firstName;
            document.getElementById('hallpassModalStatus').textContent = student.status === 'ontime' ? '‚úì On time today' : student.status === 'late' ? '‚è∞ Late today' : '';
            
            // Reset duration selection
            selectedHpDuration = 3;
            document.querySelectorAll('.hp-duration').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.min === '3');
            });
            document.getElementById('hallpassCustomReason').value = '';
            
            // Check if someone is already out
            const activePass = hallPassQueue.find(p => p.startTime);
            const warning = document.getElementById('hallpassQueueWarning');
            const startBtn = document.getElementById('hallpassStartBtn');
            const queueBtn = document.getElementById('hallpassQueueBtn');
            
            if (activePass) {
                const outStudent = students.find(s => s.id === activePass.studentId);
                const mins = Math.floor((Date.now() - activePass.startTime) / 60000);
                const etd = activePass.duration - mins;
                warning.style.display = 'block';
                document.getElementById('hallpassQueueInfo').textContent = 
                    `${outStudent?.preferredName || outStudent?.firstName} is out (ETD: ${etd > 0 ? etd : 0}m)`;
                startBtn.style.display = 'none';
                queueBtn.style.display = 'inline-flex';
            } else {
                warning.style.display = 'none';
                startBtn.style.display = 'inline-flex';
                queueBtn.style.display = 'none';
            }
            
            document.getElementById('hallpassModal').classList.add('open');
        }
        
        function closeHallPassModal() {
            document.getElementById('hallpassModal').classList.remove('open');
            hallPassModalStudentId = null;
        }
        
        function selectHpDuration(mins) {
            selectedHpDuration = mins;
            document.querySelectorAll('.hp-duration').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.min) === mins);
            });
        }
        
        function startHallPass() {
            if (!hallPassModalStudentId) return;
            
            const customReason = document.getElementById('hallpassCustomReason').value.trim();
            
            hallPassQueue.push({
                studentId: hallPassModalStudentId,
                duration: selectedHpDuration,
                reason: customReason || null,
                startTime: Date.now(),
                queuedAt: Date.now()
            });
            
            saveHallPassQueue();
            closeHallPassModal();
            renderHallPassView();
            renderCanvas(); // Update main view too
            
            const student = students.find(s => s.id === hallPassModalStudentId);
            showToast(`üö∂ ${student?.preferredName || student?.firstName} is out on hall pass`);
        }
        
        function queueHallPass() {
            if (!hallPassModalStudentId) return;
            
            const customReason = document.getElementById('hallpassCustomReason').value.trim();
            
            hallPassQueue.push({
                studentId: hallPassModalStudentId,
                duration: selectedHpDuration,
                reason: customReason || null,
                startTime: null, // Not started yet
                queuedAt: Date.now()
            });
            
            saveHallPassQueue();
            closeHallPassModal();
            renderHallPassView();
            
            const student = students.find(s => s.id === hallPassModalStudentId);
            const pos = hallPassQueue.filter(p => !p.startTime).length;
            showToast(`üìã ${student?.preferredName || student?.firstName} added to queue (#${pos})`);
        }
        
        function returnFromPass(studentId) {
            const passIndex = hallPassQueue.findIndex(p => p.studentId === studentId && p.startTime);
            if (passIndex === -1) return;
            
            const pass = hallPassQueue[passIndex];
            const duration = Math.floor((Date.now() - pass.startTime) / 60000);
            
            // Log the completed pass
            logHallPassReturn(pass, duration);
            
            // Remove from queue
            hallPassQueue.splice(passIndex, 1);
            
            // Start next person in queue
            const nextInQueue = hallPassQueue.find(p => !p.startTime);
            if (nextInQueue) {
                nextInQueue.startTime = Date.now();
                const nextStudent = students.find(s => s.id === nextInQueue.studentId);
                showToast(`üö∂ ${nextStudent?.preferredName || nextStudent?.firstName}'s turn!`);
            }
            
            saveHallPassQueue();
            renderHallPassView();
            renderCanvas();
            
            const student = students.find(s => s.id === studentId);
            showToast(`‚úì ${student?.preferredName || student?.firstName} back in ${duration}m`);
        }
        
        function removeFromQueue(studentId) {
            hallPassQueue = hallPassQueue.filter(p => p.studentId !== studentId);
            saveHallPassQueue();
            renderHallPassView();
        }
        
        function logHallPassReturn(pass, duration) {
            // Save to history
            const today = getToday();
            const student = students.find(s => s.id === pass.studentId);
            if (!student) return;
            
            if (!student.hallPassHistory) student.hallPassHistory = [];
            student.hallPassHistory.push({
                date: today,
                duration: duration || Math.floor((Date.now() - pass.startTime) / 60000),
                reason: pass.reason,
                startTime: pass.startTime,
                endTime: Date.now()
            });
            
            saveToLocalStorage();
        }
        
        function saveHallPassQueue() {
            localStorage.setItem('hallpass_queue', JSON.stringify(hallPassQueue));
        }
        
        function showHallPassModal() {
            if (!contextStudentId) return;
            closeContextMenu();
            openHallPassModal(contextStudentId);
        }
        
        function updateHallPassContextMenu() {
            const ctxItem = document.getElementById('ctxHallPass');
            if (!ctxItem || !contextStudentId) return;
            
            const pass = hallPassQueue.find(p => p.studentId === contextStudentId);
            if (pass && pass.startTime) {
                ctxItem.textContent = 'üèÅ End Hall Pass';
                ctxItem.onclick = () => { closeContextMenu(); returnFromPass(contextStudentId); };
            } else if (pass) {
                ctxItem.textContent = '‚ùå Remove from Queue';
                ctxItem.onclick = () => { closeContextMenu(); removeFromQueue(contextStudentId); };
            } else {
                ctxItem.textContent = 'üö∂ Hall Pass';
                ctxItem.onclick = showHallPassModal;
            }
        }
        
        // Update hall pass view periodically
        setInterval(() => {
            if (document.getElementById('hallpassView')?.classList.contains('active')) {
                renderHallPassView();
            }
        }, 10000);
        
        function renderHistoryView() {
            const container = document.getElementById('historyContainer');
            if (!container || students.length === 0) return;
            
            // Class overview
            const days = Object.keys(attendanceHistory).sort().reverse().slice(0, 7);
            
            let html = `
                <h3 style="margin-bottom:16px;">Class Trends (Last 7 Days)</h3>
                <div style="background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:24px;">
            `;
            
            if (days.length === 0) {
                html += '<p style="color:var(--text-secondary);">No attendance data yet.</p>';
            } else {
                html += '<div style="display:grid;gap:8px;">';
                days.forEach(date => {
                    const day = attendanceHistory[date];
                    const total = Object.keys(day).length;
                    const ontime = Object.values(day).filter(d => d.status === 'ontime').length;
                    const late = Object.values(day).filter(d => d.status === 'late').length;
                    const absent = Object.values(day).filter(d => d.status === 'absent').length;
                    const pct = total > 0 ? Math.round((ontime / total) * 100) : 0;
                    
                    const dateObj = new Date(date + 'T12:00:00');
                    const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    
                    html += `
                        <div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg-secondary);border-radius:8px;">
                            <span>${dateStr}</span>
                            <span>
                                <span style="color:var(--success);">${ontime}‚úì</span>
                                <span style="color:var(--warning);margin-left:8px;">${late}‚ö†Ô∏è</span>
                                <span style="color:var(--danger);margin-left:8px;">${absent}‚ùå</span>
                                <span style="margin-left:12px;color:var(--text-secondary);">${pct}%</span>
                            </span>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '</div>';
            
            // Student list
            html += `
                <h3 style="margin-bottom:16px;">Student Records</h3>
                <p style="color:var(--text-secondary);margin-bottom:16px;">Click a student to view their detailed history.</p>
                <div style="display:grid;gap:8px;">
            `;
            
            students.forEach(s => {
                const streak = streaks[s.id]?.current || 0;
                const name = s.displayName || `${s.firstName} ${s.lastInitial}.`;
                html += `
                    <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-card);border-radius:10px;cursor:pointer;" onclick="showStudentHistoryModal(${s.id})">
                        <img src="${getStudentImage(s)}" style="width:40px;height:40px;border-radius:50%;">
                        <div style="flex:1;">
                            <div style="font-weight:500;">${name}</div>
                            <div style="font-size:0.8rem;color:var(--text-secondary);">
                                ${streak > 0 ? `üî• ${streak} day streak` : 'No streak'}
                            </div>
                        </div>
                        <span style="color:var(--text-secondary);">‚Üí</span>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // ========== SETTINGS & IMPORT/EXPORT ==========
        function openSettings() {
            document.getElementById('settingsModal').classList.add('open');
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('open');
        }
        
        function openHelp() {
            document.getElementById('helpModal').classList.add('open');
        }
        
        function closeHelp() {
            document.getElementById('helpModal').classList.remove('open');
        }
        
        async function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                // Check if this is a full backup or just class data
                if (data.hallpass_backup) {
                    // Full backup import
                    if (data.classData) {
                        classData = data.classData;
                        students = data.classData.students || [];
                    }
                    if (data.attendanceHistory) {
                        attendanceHistory = data.attendanceHistory;
                        localStorage.setItem('hallpass_attendance', JSON.stringify(attendanceHistory));
                    }
                    if (data.streaks) {
                        streaks = data.streaks;
                        localStorage.setItem('hallpass_streaks', JSON.stringify(streaks));
                    }
                    if (data.schedule) {
                        schedule = data.schedule;
                        localStorage.setItem('hallpass_schedule', JSON.stringify(schedule));
                    }
                    showToast('Full backup restored!');
                } else if (data.students) {
                    // Just class data
                    classData = data;
                    students = data.students.map(s => ({
                        ...s,
                        status: 'unchecked'
                    }));
                    showToast(`Loaded ${students.length} students`);
                }
                
                if (classData?.settings?.className) {
                    document.getElementById('classSelect').innerHTML = `<option>${classData.settings.className}</option>`;
                }
                
                saveClass();
                renderCanvas();
                updateStats();
                closeSettings();
            } catch (e) {
                alert('Error importing: ' + e.message);
            }
        }
        
        function exportAllData() {
            const backup = {
                hallpass_backup: true,
                exportDate: new Date().toISOString(),
                classData,
                students,
                attendanceHistory,
                streaks,
                schedule,
                corrections: JSON.parse(localStorage.getItem('hallpass_corrections') || '[]')
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hallpass-backup-${getToday()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Backup exported!');
        }
        
        function exportAttendance(format) {
            if (format === 'csv') {
                let csv = 'Date,Student ID,Name,Status,Late By (min),Note\n';
                Object.entries(attendanceHistory).forEach(([date, day]) => {
                    Object.entries(day).forEach(([studentId, record]) => {
                        const student = students.find(s => s.id == studentId);
                        const name = student ? `${student.firstName} ${student.lastInitial}` : studentId;
                        csv += `${date},"${name}",${record.status},${record.lateBy || 0},"${record.note || ''}"\n`;
                    });
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `attendance-${getToday()}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            } else {
                // Anonymized JSON (no names for privacy)
                const anonymized = {};
                Object.entries(attendanceHistory).forEach(([date, day]) => {
                    anonymized[date] = {
                        ontime: Object.values(day).filter(d => d.status === 'ontime').length,
                        late: Object.values(day).filter(d => d.status === 'late').length,
                        absent: Object.values(day).filter(d => d.status === 'absent').length,
                        avgLateBy: Math.round(
                            Object.values(day).filter(d => d.lateBy > 0).reduce((a, d) => a + d.lateBy, 0) /
                            Math.max(1, Object.values(day).filter(d => d.lateBy > 0).length)
                        )
                    };
                });
                
                const blob = new Blob([JSON.stringify(anonymized, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `attendance-trends-${getToday()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
            showToast(`Exported as ${format.toUpperCase()}`);
        }
        
        function clearAllData() {
            if (!confirm('This will delete ALL Hall Pass data. Are you sure?')) return;
            if (!confirm('Really? This cannot be undone!')) return;
            
            localStorage.removeItem('hallpass_class');
            localStorage.removeItem('hallpass_attendance');
            localStorage.removeItem('hallpass_streaks');
            localStorage.removeItem('hallpass_schedule');
            localStorage.removeItem('hallpass_corrections');
            
            classData = null;
            students = [];
            attendanceHistory = {};
            streaks = {};
            
            renderCanvas();
            updateStats();
            closeSettings();
            showToast('All data cleared');
        }
        
        // ========== PERSISTENCE ==========
        function saveClass() {
            if (classData) {
                classData.students = students;
                localStorage.setItem('hallpass_class', JSON.stringify(classData));
            }
        }
        
        function loadSavedData() {
            // Load class
            const savedClass = localStorage.getItem('hallpass_class');
            if (savedClass) {
                classData = JSON.parse(savedClass);
                students = classData.students || [];
                if (classData.settings?.className) {
                    document.getElementById('classSelect').innerHTML = `<option>${classData.settings.className}</option>`;
                }
            }
            
            // Load attendance history
            const savedAttendance = localStorage.getItem('hallpass_attendance');
            if (savedAttendance) {
                attendanceHistory = JSON.parse(savedAttendance);
            }
            
            // Load streaks
            const savedStreaks = localStorage.getItem('hallpass_streaks');
            if (savedStreaks) {
                streaks = JSON.parse(savedStreaks);
            }
            
            // Load schedule
            const savedSchedule = localStorage.getItem('hallpass_schedule');
            if (savedSchedule) {
                schedule = JSON.parse(savedSchedule);
            }
        }
        
        // ========== STUDENT MANAGEMENT ==========
        let addStudentPosition = null;
        
        function openStudentManager() {
            renderStudentManagerList();
            document.getElementById('studentManagerModal').classList.add('open');
        }
        
        function closeStudentManager() {
            document.getElementById('studentManagerModal').classList.remove('open');
        }
        
        function renderStudentManagerList() {
            const container = document.getElementById('studentManagerList');
            const search = document.getElementById('studentSearch')?.value?.toLowerCase() || '';
            
            let filtered = students;
            if (search) {
                filtered = students.filter(s => 
                    s.firstName?.toLowerCase().includes(search) ||
                    s.lastName?.toLowerCase().includes(search) ||
                    s.preferredName?.toLowerCase().includes(search)
                );
            }
            
            if (filtered.length === 0) {
                container.innerHTML = '<p style="color:var(--text-secondary);text-align:center;padding:24px;">No students found. Click "Add Student" to get started.</p>';
                return;
            }
            
            container.innerHTML = filtered.map(s => {
                const name = s.displayName || `${s.preferredName || s.firstName} ${s.lastInitial || s.lastName?.charAt(0) || ''}.`;
                return `
                    <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-secondary);border-radius:10px;margin-bottom:8px;">
                        <img src="${getStudentImage(s)}" style="width:48px;height:48px;border-radius:50%;object-fit:cover;">
                        <div style="flex:1;">
                            <div style="font-weight:500;">${name}</div>
                            <div style="font-size:0.8rem;color:var(--text-secondary);">${s.firstName} ${s.lastName || ''}</div>
                        </div>
                        <button class="btn btn-secondary" style="padding:8px 12px;" onclick="showEditStudentForm(${s.id})">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger" style="padding:8px 12px;" onclick="confirmRemoveStudent(${s.id})">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');
        }
        
        function filterStudentList() {
            renderStudentManagerList();
        }
        
        // Avatar options - organized by style/vibe with diverse seeds
        const avatarOptions = {
            cartoon: [
                // Avataaars - Bitmoji-like, very popular
                { seed: 'Aiden', style: 'avataaars' },
                { seed: 'Bella', style: 'avataaars' },
                { seed: 'Carlos', style: 'avataaars' },
                { seed: 'Diana', style: 'avataaars' },
                { seed: 'Ethan', style: 'avataaars' },
                { seed: 'Fatima', style: 'avataaars' },
                { seed: 'Kai', style: 'avataaars' },
                { seed: 'Luna', style: 'avataaars' },
                { seed: 'Marcus', style: 'avataaars' },
                { seed: 'Nadia', style: 'avataaars' },
                { seed: 'Omar', style: 'avataaars' },
                { seed: 'Priya', style: 'avataaars' },
                // Adventurer - cute cartoon style
                { seed: 'River', style: 'adventurer' },
                { seed: 'Sage', style: 'adventurer' },
                { seed: 'Tyler', style: 'adventurer' },
                { seed: 'Uma', style: 'adventurer' },
                { seed: 'Victor', style: 'adventurer' },
                { seed: 'Willow', style: 'adventurer' }
            ],
            modern: [
                // Micah - clean modern illustrated
                { seed: 'Alex', style: 'micah' },
                { seed: 'Brooklyn', style: 'micah' },
                { seed: 'Charlie', style: 'micah' },
                { seed: 'Dakota', style: 'micah' },
                { seed: 'Ellis', style: 'micah' },
                { seed: 'Finley', style: 'micah' },
                { seed: 'Gray', style: 'micah' },
                { seed: 'Harper', style: 'micah' },
                { seed: 'Indigo', style: 'micah' },
                { seed: 'Jordan', style: 'micah' },
                // Notionists - Notion-style clean
                { seed: 'Kira', style: 'notionists' },
                { seed: 'Leo', style: 'notionists' },
                { seed: 'Morgan', style: 'notionists' },
                { seed: 'Noah', style: 'notionists' },
                { seed: 'Ocean', style: 'notionists' },
                { seed: 'Phoenix', style: 'notionists' },
                { seed: 'Quinn', style: 'notionists' },
                { seed: 'Reese', style: 'notionists' }
            ],
            playful: [
                // Big Smile - happy fun faces
                { seed: 'Sunny', style: 'big-smile' },
                { seed: 'Happy', style: 'big-smile' },
                { seed: 'Joy', style: 'big-smile' },
                { seed: 'Bliss', style: 'big-smile' },
                { seed: 'Spark', style: 'big-smile' },
                { seed: 'Glow', style: 'big-smile' },
                { seed: 'Shine', style: 'big-smile' },
                { seed: 'Bright', style: 'big-smile' },
                { seed: 'Lucky', style: 'big-smile' },
                { seed: 'Star', style: 'big-smile' },
                // Fun Emoji - expressive emoji faces
                { seed: 'Chill', style: 'fun-emoji' },
                { seed: 'Vibe', style: 'fun-emoji' },
                { seed: 'Cool', style: 'fun-emoji' },
                { seed: 'Rad', style: 'fun-emoji' },
                { seed: 'Epic', style: 'fun-emoji' },
                { seed: 'Ace', style: 'fun-emoji' },
                { seed: 'Zen', style: 'fun-emoji' },
                { seed: 'Wave', style: 'fun-emoji' }
            ],
            pixel: [
                // Pixel Art - retro gamer style
                { seed: 'Player1', style: 'pixel-art' },
                { seed: 'Player2', style: 'pixel-art' },
                { seed: 'Gamer', style: 'pixel-art' },
                { seed: 'Hero', style: 'pixel-art' },
                { seed: 'Legend', style: 'pixel-art' },
                { seed: 'Boss', style: 'pixel-art' },
                { seed: 'Ninja', style: 'pixel-art' },
                { seed: 'Knight', style: 'pixel-art' },
                { seed: 'Mage', style: 'pixel-art' },
                { seed: 'Rogue', style: 'pixel-art' },
                { seed: 'Scout', style: 'pixel-art' },
                { seed: 'Tank', style: 'pixel-art' },
                { seed: 'Healer', style: 'pixel-art' },
                { seed: 'Ranger', style: 'pixel-art' },
                { seed: 'Mystic', style: 'pixel-art' },
                { seed: 'Champion', style: 'pixel-art' }
            ],
            classic: [
                // Lorelei - illustrated portraits
                { seed: 'Emma', style: 'lorelei' },
                { seed: 'James', style: 'lorelei' },
                { seed: 'Sophia', style: 'lorelei' },
                { seed: 'William', style: 'lorelei' },
                { seed: 'Olivia', style: 'lorelei' },
                { seed: 'Benjamin', style: 'lorelei' },
                { seed: 'Ava', style: 'lorelei' },
                { seed: 'Lucas', style: 'lorelei' },
                { seed: 'Mia', style: 'lorelei' },
                { seed: 'Henry', style: 'lorelei' },
                // Open Peeps - hand-drawn trendy
                { seed: 'Ash', style: 'open-peeps' },
                { seed: 'Blake', style: 'open-peeps' },
                { seed: 'Casey', style: 'open-peeps' },
                { seed: 'Drew', style: 'open-peeps' },
                { seed: 'Emery', style: 'open-peeps' },
                { seed: 'Frankie', style: 'open-peeps' }
            ]
        };
        
        let currentAvatarTab = 'cartoon';
        
        function getAvatarUrl(seed, style = 'lorelei') {
            return `https://api.dicebear.com/7.x/${style}/svg?seed=${seed}`;
        }
        
        function showAvatarTab(tab) {
            currentAvatarTab = tab;
            document.querySelectorAll('.avatar-tab').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderAvatarGrid();
        }
        
        function renderAvatarGrid() {
            const grid = document.getElementById('avatarGrid');
            const options = avatarOptions[currentAvatarTab] || avatarOptions.cartoon;
            const selectedAvatar = document.getElementById('editSelectedAvatar').value;
            
            grid.innerHTML = options.map(opt => {
                const url = getAvatarUrl(opt.seed, opt.style);
                const isSelected = selectedAvatar === url;
                return `
                    <div onclick="selectAvatar('${url}')" 
                         style="cursor:pointer;padding:4px;border-radius:8px;border:3px solid ${isSelected ? 'var(--accent)' : 'transparent'};transition:border 0.2s;">
                        <img src="${url}" style="width:100%;border-radius:50%;background:var(--bg-card);">
                    </div>
                `;
            }).join('');
        }
        
        function selectAvatar(url) {
            document.getElementById('editSelectedAvatar').value = url;
            document.getElementById('editPhotoUrl').value = '';
            renderAvatarGrid();
        }
        
        function clearAvatarSelection() {
            document.getElementById('editSelectedAvatar').value = '';
            renderAvatarGrid();
        }
        
        function showAddStudentForm() {
            document.getElementById('editStudentTitle').textContent = '‚ûï Add Student';
            document.getElementById('editStudentId').value = '';
            document.getElementById('editSelectedAvatar').value = '';
            document.getElementById('editFirstName').value = '';
            document.getElementById('editLastName').value = '';
            document.getElementById('editPreferredName').value = '';
            document.getElementById('editPhotoUrl').value = '';
            currentAvatarTab = 'cartoon';
            document.querySelectorAll('.avatar-tab').forEach((btn, i) => {
                btn.classList.toggle('active', i === 0);
            });
            renderAvatarGrid();
            document.getElementById('editStudentModal').classList.add('open');
        }
        
        function showEditStudentForm(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            document.getElementById('editStudentTitle').textContent = '‚úèÔ∏è Edit Student';
            document.getElementById('editStudentId').value = studentId;
            document.getElementById('editFirstName').value = student.firstName || '';
            document.getElementById('editLastName').value = student.lastName || '';
            document.getElementById('editPreferredName').value = student.preferredName || '';
            
            const existingPhoto = student.caricature || student.caricatures?.photo || '';
            if (existingPhoto.includes('dicebear.com')) {
                document.getElementById('editSelectedAvatar').value = existingPhoto;
                document.getElementById('editPhotoUrl').value = '';
            } else {
                document.getElementById('editSelectedAvatar').value = '';
                document.getElementById('editPhotoUrl').value = existingPhoto;
            }
            
            currentAvatarTab = 'cartoon';
            document.querySelectorAll('.avatar-tab').forEach((btn, i) => {
                btn.classList.toggle('active', i === 0);
            });
            renderAvatarGrid();
            document.getElementById('editStudentModal').classList.add('open');
        }
        
        function closeEditStudent() {
            document.getElementById('editStudentModal').classList.remove('open');
        }
        
        function saveStudent() {
            const idVal = document.getElementById('editStudentId').value;
            const firstName = document.getElementById('editFirstName').value.trim();
            const lastName = document.getElementById('editLastName').value.trim();
            const preferredName = document.getElementById('editPreferredName').value.trim();
            const selectedAvatar = document.getElementById('editSelectedAvatar').value.trim();
            const photoUrl = document.getElementById('editPhotoUrl').value.trim();
            
            // Use selected avatar, or photo URL, or generate from name
            const finalPhoto = photoUrl || selectedAvatar || getAvatarUrl(firstName || 'Student', 'lorelei');
            
            if (!firstName) {
                alert('First name is required');
                return;
            }
            
            if (idVal) {
                // Edit existing
                const student = students.find(s => s.id == idVal);
                if (student) {
                    student.firstName = firstName;
                    student.lastName = lastName;
                    student.preferredName = preferredName || firstName;
                    student.lastInitial = lastName ? lastName.charAt(0) : '';
                    student.displayName = `${preferredName || firstName} ${student.lastInitial}.`;
                    student.caricature = finalPhoto;
                    if (!student.caricatures) student.caricatures = {};
                    student.caricatures.photo = finalPhoto;
                    showToast(`Updated ${firstName}`);
                }
            } else {
                // Add new
                const newId = Math.max(0, ...students.map(s => s.id)) + 1;
                const lastInit = lastName ? lastName.charAt(0) : '';
                const newStudent = {
                    id: newId,
                    firstName,
                    lastName,
                    lastInitial: lastInit,
                    preferredName: preferredName || firstName,
                    displayName: `${preferredName || firstName} ${lastInit}.`,
                    status: 'unchecked',
                    caricature: finalPhoto,
                    caricatures: { photo: finalPhoto },
                    position: addStudentPosition || calculateNewStudentPosition(students.length)
                };
                
                students.push(newStudent);
                addStudentPosition = null;
                showToast(`Added ${firstName}`);
            }
            
            closeEditStudent();
            saveClass();
            renderCanvas();
            renderStudentManagerList();
        }
        
        function editStudent() {
            if (!contextStudentId) return;
            closeContextMenu();
            showEditStudentForm(contextStudentId);
        }
        
        function removeStudent() {
            if (!contextStudentId) return;
            confirmRemoveStudent(contextStudentId);
            closeContextMenu();
        }
        
        function confirmRemoveStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const name = student.displayName || student.firstName;
            if (!confirm(`Remove ${name} from the class?`)) return;
            
            students = students.filter(s => s.id !== studentId);
            saveClass();
            renderCanvas();
            renderStudentManagerList();
            showToast(`Removed ${name}`);
        }
        
        function addStudentAtPosition() {
            closeCanvasContextMenu();
            showAddStudentForm();
        }
        
        function openCanvasContextMenu(event) {
            const menu = document.getElementById('canvasContextMenu');
            addStudentPosition = {
                x: event.offsetX - 50,
                y: event.offsetY - 50
            };
            // Smart positioning - keep menu on screen
            positionContextMenu(menu, event.clientX, event.clientY);
            menu.classList.add('open');
        }
        
        function closeCanvasContextMenu() {
            document.getElementById('canvasContextMenu').classList.remove('open');
        }
        
        // ========== MINI OVERLAY ==========
        let miniOverlayOpen = false;
        let miniOpacity = 0.9;
        let miniDragState = null;
        
        function toggleMiniOverlay() {
            miniOverlayOpen = !miniOverlayOpen;
            const overlay = document.getElementById('miniOverlay');
            const btn = document.getElementById('miniModeBtn');
            
            if (miniOverlayOpen) {
                overlay.classList.add('open');
                btn.classList.add('active');
                btn.textContent = 'üìå Mini ON';
                renderMiniGrid();
            } else {
                overlay.classList.remove('open');
                btn.classList.remove('active');
                btn.textContent = 'üìå Mini Overlay';
            }
        }
        
        function renderMiniGrid() {
            if (!miniOverlayOpen) return;
            
            const grid = document.getElementById('miniGrid');
            let ontime = 0, late = 0, absent = 0;
            
            const html = students.map(s => {
                const status = s.status || 'unchecked';
                const name = s.preferredName || s.firstName || '';
                const shortName = name.length > 6 ? name.substring(0, 5) + '‚Ä¶' : name;
                const img = getStudentImage(s);
                
                if (status === 'ontime') ontime++;
                else if (status === 'late') late++;
                else if (status !== 'excused' && status !== 'withdrawn') absent++;
                
                const lateBadge = s.lateBy ? `<div class="late-badge">+${s.lateBy}m</div>` : '';
                
                return `
                    <div class="mini-student ${status}" onclick="miniCheckIn(${s.id})" title="${name}">
                        <img src="${img}" alt="${name}">
                        <div class="name">${shortName}</div>
                        ${lateBadge}
                    </div>
                `;
            }).join('');
            
            grid.innerHTML = html;
            
            // Update mini stats
            document.getElementById('miniOntime').textContent = ontime;
            document.getElementById('miniLate').textContent = late;
            document.getElementById('miniAbsent').textContent = absent;
        }
        
        function miniCheckIn(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // If already checked in, show quick menu
            if (student.status === 'ontime' || student.status === 'late') {
                // Toggle through: ontime -> late -> absent -> clear
                if (student.status === 'ontime') {
                    student.status = 'late';
                    const now = new Date();
                    const start = parseTime(schedule.startTime);
                    student.lateBy = Math.max(1, Math.floor((now - start) / 60000));
                } else if (student.status === 'late') {
                    student.status = 'absent';
                    student.lateBy = null;
                } else {
                    student.status = 'unchecked';
                    student.lateBy = null;
                }
                saveAttendance(student);
            } else {
                // Check in
                checkInStudent(student);
            }
            
            renderMiniGrid();
            renderCanvas();
            updateStats();
            saveClass();
        }
        
        function adjustMiniOpacity(delta) {
            miniOpacity = Math.max(0.3, Math.min(1, miniOpacity + delta));
            document.getElementById('miniOverlay').style.opacity = miniOpacity;
        }
        
        // Make mini overlay draggable
        function initMiniDrag() {
            const header = document.getElementById('miniHeader');
            const overlay = document.getElementById('miniOverlay');
            
            header.addEventListener('mousedown', (e) => {
                if (e.target.closest('.mini-btn')) return;
                
                miniDragState = {
                    startX: e.clientX,
                    startY: e.clientY,
                    origLeft: overlay.offsetLeft,
                    origTop: overlay.offsetTop
                };
                
                document.addEventListener('mousemove', onMiniDrag);
                document.addEventListener('mouseup', endMiniDrag);
            });
        }
        
        function onMiniDrag(e) {
            if (!miniDragState) return;
            
            const overlay = document.getElementById('miniOverlay');
            const dx = e.clientX - miniDragState.startX;
            const dy = e.clientY - miniDragState.startY;
            
            let newLeft = miniDragState.origLeft + dx;
            let newTop = miniDragState.origTop + dy;
            
            // Keep on screen
            newLeft = Math.max(0, Math.min(window.innerWidth - overlay.offsetWidth, newLeft));
            newTop = Math.max(0, Math.min(window.innerHeight - overlay.offsetHeight, newTop));
            
            overlay.style.left = newLeft + 'px';
            overlay.style.top = newTop + 'px';
            overlay.style.right = 'auto';
        }
        
        function endMiniDrag() {
            miniDragState = null;
            document.removeEventListener('mousemove', onMiniDrag);
            document.removeEventListener('mouseup', endMiniDrag);
        }
        
        // Pop out to separate window
        let popoutWindow = null;
        
        function popOutMini() {
            // Calculate tall & thin layout (3 columns, sidebar style)
            const count = students.length || 30;
            const cols = 3; // Fixed 3 columns for tall/thin layout
            const rows = Math.ceil(count / cols);
            const tileSize = 58; // Tile height including name
            const width = 200; // Narrow sidebar width
            const height = Math.max(300, rows * tileSize + 80); // Fit all rows + header/footer
            
            // Open popup window
            popoutWindow = window.open('', 'HallPassMini', 
                `width=${width},height=${height},top=50,left=${screen.width - width - 50},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`
            );
            
            if (!popoutWindow) {
                alert('Popup blocked! Please allow popups for this site.');
                return;
            }
            
            // Build the popup HTML
            const popupHTML = buildPopoutHTML();
            popoutWindow.document.write(popupHTML);
            popoutWindow.document.close();
            
            // Set proper window title
            popoutWindow.document.title = 'üìã Attendance';
            
            // Close the in-page overlay
            toggleMiniOverlay();
            
            // Set up communication
            popoutWindow.hallPassData = {
                students: students,
                schedule: schedule,
                checkIn: (id) => {
                    miniCheckIn(id);
                    updatePopoutWindow();
                }
            };
            
            // Update popup periodically
            const updateInterval = setInterval(() => {
                if (popoutWindow.closed) {
                    clearInterval(updateInterval);
                    return;
                }
                updatePopoutWindow();
            }, 2000);
            
            showToast('ü™ü Popped out! Use Win+Ctrl+T (PowerToys) to keep on top');
        }
        
        function buildPopoutHTML() {
            return `<!DOCTYPE html>
<html>
<head>
    <title>üìã Hall Pass</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #1a1a2e;
            color: white;
            padding: 4px;
            min-height: 100vh;
            overflow: hidden;
            user-select: none;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 6px;
            background: #252540;
            border-radius: 5px;
            margin-bottom: 4px;
            font-size: 10px;
        }
        .tabs { display: flex; gap: 2px; }
        .tab {
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            background: transparent;
            border: none;
            color: #888;
            font-size: 11px;
            transition: all 0.15s;
        }
        .tab:hover { color: #fff; background: #333; }
        .tab.active { background: #818cf8; color: white; }
        .stats { display: flex; gap: 4px; }
        .stat {
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 10px;
        }
        .stat.ontime { background: #22c55e; }
        .stat.late { background: #f59e0b; color: black; }
        .stat.absent { background: #ef4444; }
        .grid-container {
            height: calc(100vh - 46px);
            overflow: hidden;
            display: flex;
            align-items: start;
        }
        .grid {
            display: grid;
            gap: 4px;
            padding: 2px;
            height: 100%;
            align-content: start;
        }
        .student {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.12s;
            aspect-ratio: 1;
            min-width: 0;
            overflow: hidden;
        }
        .student:hover { background: #2d2d4a; transform: scale(1.02); }
        .student.unchecked { opacity: 0.5; }
        .student.ontime { border-color: #22c55e; background: rgba(34,197,94,0.15); }
        .student.late { border-color: #f59e0b; background: rgba(245,158,11,0.15); }
        .student.absent { border-color: #ef4444; background: rgba(239,68,68,0.1); opacity: 0.5; }
        .student.excused { border-color: #6366f1; background: rgba(99,102,241,0.1); opacity: 0.6; }
        .student.on-pass { border-color: #06b6d4; background: rgba(6,182,212,0.15); animation: pulse 2s infinite; }
        @keyframes pulse { 0%,100% { box-shadow: 0 0 0 0 rgba(6,182,212,0.4); } 50% { box-shadow: 0 0 0 4px rgba(6,182,212,0); } }
        .student img { width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; }
        .student .name { font-size: 11px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; line-height: 1.2; margin-top: 2px; font-weight: 500; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .student .badge { font-size: 7px; font-weight: 600; line-height: 1; }
        .student .badge.late-badge { color: #fbbf24; }
        .student .badge.streak-badge { color: #22c55e; }
        .student .badge.broken-badge { color: #f87171; }
        .student .badge.pass-badge { color: #06b6d4; }
        .context-menu {
            position: fixed;
            background: #252540;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 4px 0;
            min-width: 140px;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .context-menu.open { display: block; }
        .context-menu-item {
            padding: 6px 12px;
            cursor: pointer;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .context-menu-item:hover { background: #333; }
        .context-menu-divider { border-top: 1px solid #444; margin: 4px 0; }
        .help-tip {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1e1e32;
            padding: 2px 6px;
            font-size: 8px;
            color: #555;
            text-align: center;
        }
        .help-tip strong { color: #818cf8; }
        .mode-groups .grid { gap: 8px; }
        .group-section { background: #252540; border-radius: 8px; padding: 6px; }
        .group-title { font-size: 10px; color: #888; margin-bottom: 4px; text-align: center; }
    </style>
</head>
<body>
    <div class="header">
        <div class="tabs">
            <button class="tab active" onclick="setMode('attendance')">üìã</button>
            <button class="tab" onclick="setMode('passes')">üö∂</button>
            <button class="tab" onclick="setMode('groups')">üë•</button>
        </div>
        <div class="stats" id="statsBar">
            <span class="stat ontime" id="statOn">0</span>
            <span class="stat late" id="statLate">0</span>
            <span class="stat absent" id="statAbs">0</span>
        </div>
    </div>
    <div class="grid-container">
        <div class="grid" id="grid"></div>
    </div>
    <div class="context-menu" id="ctxMenu"></div>
    <div class="help-tip">üìå <strong>Win+Ctrl+T</strong> to pin on top</div>
    <script>
        let currentMode = 'attendance';
        let contextStudentId = null;
        
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab').forEach((t,i) => {
                t.classList.toggle('active', 
                    (mode === 'attendance' && i === 0) ||
                    (mode === 'passes' && i === 1) ||
                    (mode === 'groups' && i === 2)
                );
            });
            render();
        }
        
        function calcGrid() {
            const data = window.hallPassData;
            if (!data) return { cols: 3, size: 50 };
            const count = data.students.length;
            const container = document.querySelector('.grid-container');
            const w = container.clientWidth - 8;
            const h = container.clientHeight - 8;
            // Default to 3 columns (tall/thin), allow 2-4 based on window width
            let cols = 3;
            if (w < 140) cols = 2;
            else if (w > 280) cols = 4;
            const rows = Math.ceil(count / cols);
            const tileW = Math.floor((w - (cols - 1) * 4) / cols);
            const tileH = Math.floor((h - (rows - 1) * 4) / rows);
            const size = Math.min(tileW, tileH, 65); // Cap at 65px
            return { cols: cols, size: Math.max(40, size) };
        }
        
        function getDisplayName(s) {
            const first = s.preferredName || s.firstName || '';
            const last = s.lastName || '';
            const initial = last ? last.charAt(0).toUpperCase() + '.' : '';
            return first.length > 7 ? first.substring(0,6) + '.' : first + (initial ? ' ' + initial : '');
        }
        
        function render() {
            const data = window.hallPassData;
            if (!data) return;
            
            const grid = document.getElementById('grid');
            const { cols, size } = calcGrid();
            grid.style.gridTemplateColumns = 'repeat(' + cols + ', ' + size + 'px)';
            
            let on = 0, late = 0, abs = 0;
            
            if (currentMode === 'groups' && data.groups && data.groups.length > 0) {
                // Groups mode
                document.getElementById('statsBar').style.display = 'none';
                grid.innerHTML = data.groups.map((group, gi) => {
                    return '<div class="group-section"><div class="group-title">Group ' + (gi+1) + '</div><div style="display:flex;flex-wrap:wrap;gap:3px;justify-content:center;">' +
                        group.map(sid => {
                            const s = data.students.find(st => st.id === sid);
                            if (!s) return '';
                            const img = s.caricature || s.caricatures?.photo || 'https://api.dicebear.com/7.x/lorelei/svg?seed=' + s.firstName;
                            return '<div style="text-align:center;"><img src="' + img + '" style="width:32px;height:32px;border-radius:50%;"><div style="font-size:8px;">' + (s.preferredName || s.firstName || '').substring(0,6) + '</div></div>';
                        }).join('') +
                    '</div></div>';
                }).join('');
                return;
            }
            
            document.getElementById('statsBar').style.display = 'flex';
            
            // Filter for passes mode
            let displayStudents = data.students;
            if (currentMode === 'passes') {
                displayStudents = data.students.filter(s => s.hallPass || s.status === 'ontime' || s.status === 'late');
            }
            
            grid.innerHTML = displayStudents.map(s => {
                const status = s.hallPass ? 'on-pass' : (s.status || 'unchecked');
                const name = getDisplayName(s);
                const img = s.caricature || s.caricatures?.photo || 'https://api.dicebear.com/7.x/lorelei/svg?seed=' + s.firstName;
                
                if (s.status === 'ontime') on++;
                else if (s.status === 'late') late++;
                else if (s.status !== 'excused' && !s.hallPass) abs++;
                
                let badge = '';
                if (s.hallPass) {
                    const mins = Math.floor((Date.now() - s.hallPass.startTime) / 60000);
                    badge = '<div class="badge pass-badge">üö∂ ' + mins + 'm</div>';
                } else if (s.lateBy) {
                    badge = '<div class="badge late-badge">+' + s.lateBy + 'm late</div>';
                }
                
                // Streak info
                const streak = data.streaks && data.streaks[s.id];
                if (streak && streak.current >= 3 && !s.hallPass) {
                    badge += '<div class="badge streak-badge">' + (streak.current >= 5 ? 'üî•' : '‚ö°') + streak.current + '</div>';
                }
                if (streak && streak.broken) {
                    badge = '<div class="badge broken-badge">üíî streak</div>' + badge;
                }
                
                return '<div class="student ' + status + '" onclick="handleClick(event,' + s.id + ')" oncontextmenu="showCtx(event,' + s.id + ')" data-id="' + s.id + '">' +
                    '<img src="' + img + '">' +
                    '<div class="name">' + name + '</div>' +
                    badge +
                '</div>';
            }).join('');
            
            document.getElementById('statOn').textContent = on;
            document.getElementById('statLate').textContent = late;
            document.getElementById('statAbs').textContent = abs;
        }
        
        function handleClick(e, id) {
            e.preventDefault();
            if (currentMode === 'passes') {
                // Toggle hall pass
                window.hallPassData.togglePass(id);
            } else {
                // Check in
                window.hallPassData.checkIn(id);
            }
        }
        
        function showCtx(e, id) {
            e.preventDefault();
            contextStudentId = id;
            const menu = document.getElementById('ctxMenu');
            const s = window.hallPassData.students.find(st => st.id === id);
            if (!s) return;
            
            const passOption = s.hallPass 
                ? '<div class="context-menu-item" onclick="doAction(\\'endPass\\')">üèÅ End Hall Pass</div>'
                : '<div class="context-menu-item" onclick="doAction(\\'startPass\\')">üö∂ Start Hall Pass</div>';
            
            menu.innerHTML = 
                '<div class="context-menu-item" onclick="doAction(\\'ontime\\')">‚úÖ Mark On-Time</div>' +
                '<div class="context-menu-item" onclick="doAction(\\'late\\')">‚è∞ Mark Late</div>' +
                '<div class="context-menu-item" onclick="doAction(\\'absent\\')">‚ùå Mark Absent</div>' +
                '<div class="context-menu-item" onclick="doAction(\\'excused\\')">üìù Mark Excused</div>' +
                '<div class="context-menu-divider"></div>' +
                passOption +
                '<div class="context-menu-divider"></div>' +
                '<div class="context-menu-item" onclick="doAction(\\'clear\\')">üîÑ Clear / Reset</div>';
            
            // Position menu
            let x = e.clientX, y = e.clientY;
            menu.classList.add('open');
            const rect = menu.getBoundingClientRect();
            if (x + rect.width > window.innerWidth) x = window.innerWidth - rect.width - 5;
            if (y + rect.height > window.innerHeight) y = window.innerHeight - rect.height - 5;
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
        }
        
        function doAction(action) {
            document.getElementById('ctxMenu').classList.remove('open');
            if (!contextStudentId) return;
            window.hallPassData.doAction(contextStudentId, action);
        }
        
        document.addEventListener('click', e => {
            if (!e.target.closest('.context-menu')) {
                document.getElementById('ctxMenu').classList.remove('open');
            }
        });
        
        window.addEventListener('resize', () => render());
        setInterval(render, 1000);
        setTimeout(render, 100);
    <\/script>
</body>
</html>`;
        }
        
        function updatePopoutWindow() {
            if (!popoutWindow || popoutWindow.closed) return;
            popoutWindow.hallPassData = {
                students: students,
                schedule: schedule,
                streaks: streaks,
                groups: currentGroups,
                checkIn: (id) => {
                    miniCheckIn(id);
                    updatePopoutWindow();
                },
                togglePass: (id) => {
                    const student = students.find(s => s.id === id);
                    if (!student) return;
                    if (student.hallPass) {
                        // End pass
                        student.hallPass = null;
                    } else {
                        // Start pass
                        student.hallPass = { startTime: Date.now(), reason: 'Hall pass' };
                    }
                    saveToLocalStorage();
                    updatePopoutWindow();
                    renderCanvas();
                },
                doAction: (id, action) => {
                    const student = students.find(s => s.id === id);
                    if (!student) return;
                    
                    switch(action) {
                        case 'ontime':
                            student.status = 'ontime';
                            student.lateBy = null;
                            saveAttendance(student);
                            break;
                        case 'late':
                            student.status = 'late';
                            const now = new Date();
                            const start = parseTime(schedule.startTime);
                            student.lateBy = Math.max(1, Math.floor((now - start) / 60000));
                            saveAttendance(student);
                            break;
                        case 'absent':
                            student.status = 'absent';
                            student.lateBy = null;
                            saveAttendance(student);
                            break;
                        case 'excused':
                            student.status = 'excused';
                            student.lateBy = null;
                            saveAttendance(student);
                            break;
                        case 'clear':
                            student.status = 'unchecked';
                            student.lateBy = null;
                            student.hallPass = null;
                            saveAttendance(student);
                            break;
                        case 'startPass':
                            student.hallPass = { startTime: Date.now(), reason: 'Hall pass' };
                            saveToLocalStorage();
                            break;
                        case 'endPass':
                            student.hallPass = null;
                            saveToLocalStorage();
                            break;
                    }
                    
                    updatePopoutWindow();
                    renderCanvas();
                }
            };
        }
        
        // Calculate position for a new student
        function calculateNewStudentPosition(currentCount) {
            const cardWidth = 100;
            const cardHeight = 130;
            const padding = 20;
            const gap = 15;
            
            // Use same column calculation as renderCanvas
            const totalCount = currentCount + 1;
            let cols = Math.min(10, Math.max(4, Math.ceil(Math.sqrt(totalCount * 1.5))));
            
            return {
                x: padding + (currentCount % cols) * (cardWidth + gap),
                y: padding + Math.floor(currentCount / cols) * (cardHeight + gap)
            };
        }
        
        // ========== UTILS ==========
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function spawnConfetti() {
            const colors = ['#22c55e', '#f59e0b', '#3b82f6', '#ec4899', '#8b5cf6'];
            for (let i = 0; i < 20; i++) {
                const conf = document.createElement('div');
                conf.className = 'confetti';
                conf.style.left = (Math.random() * window.innerWidth) + 'px';
                conf.style.top = (window.innerHeight - 100) + 'px';
                conf.style.background = colors[Math.floor(Math.random() * colors.length)];
                conf.style.animationDelay = (Math.random() * 0.5) + 's';
                document.body.appendChild(conf);
                setTimeout(() => conf.remove(), 1500);
            }
        }
        
        // ========== INIT ==========
        document.addEventListener('click', e => {
            if (!e.target.closest('.context-menu') && !e.target.closest('.canvas-student')) {
                closeContextMenu();
                closeCanvasContextMenu();
            }
        });
        
        // Context menu handling
        document.addEventListener('contextmenu', e => {
            const canvas = e.target.closest('.seating-canvas');
            const studentCard = e.target.closest('.canvas-student');
            
            if (studentCard) {
                // Right-click on student - handled by handleStudentClick
                e.preventDefault();
            } else if (canvas) {
                // Right-click on empty canvas area
                e.preventDefault();
                closeContextMenu();
                openCanvasContextMenu(e);
            }
        });
        
        // Load and start
        loadSavedData();
        renderCanvas();
        updateStatusBar();
        initMiniDrag();
        
        // Update countdown every second
        setInterval(updateStatusBar, 1000);
        
        // Update mini overlay when open
        setInterval(() => {
            if (miniOverlayOpen) renderMiniGrid();
        }, 5000);
    </script>
</body>
</html>
