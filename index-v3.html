<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Hall Pass</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        :root {
            --bg-primary: #0f0f1a;
            --bg-secondary: #1a1a2e;
            --bg-card: #252540;
            --bg-hover: #2d2d4a;
            --accent: #6366f1;
            --accent-light: #818cf8;
            --success: #22c55e;
            --success-glow: rgba(34, 197, 94, 0.3);
            --warning: #f59e0b;
            --warning-glow: rgba(245, 158, 11, 0.3);
            --danger: #ef4444;
            --danger-glow: rgba(239, 68, 68, 0.3);
            --excused: #8b5cf6;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --border: rgba(255,255,255,0.1);
            --shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            user-select: none;
        }

        /* Navigation */
        .nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 64px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        
        .logo {
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-tabs {
            display: flex;
            gap: 4px;
        }
        
        .nav-tab {
            padding: 20px 16px;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.95rem;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .nav-tab:hover {
            color: var(--text-primary);
        }
        
        .nav-tab.active {
            color: var(--accent-light);
            border-bottom-color: var(--accent);
        }
        
        .nav-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .class-selector select {
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            padding: 10px 16px;
            border-radius: 10px;
        }
        
        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: none;
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .icon-btn:hover {
            background: var(--bg-hover);
        }

        /* Status Bar */
        .status-bar {
            background: var(--bg-secondary);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }
        
        .period-info {
            display: flex;
            align-items: center;
            gap: 24px;
        }
        
        .period-badge {
            background: var(--accent);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        .period-badge:hover {
            background: var(--accent-light);
        }
        
        .countdown {
            font-size: 2rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
        }
        
        .countdown.pre-class {
            color: var(--success);
        }
        
        .countdown.in-class {
            color: var(--text-secondary);
        }
        
        .countdown.ending-soon {
            color: var(--warning);
        }
        
        .class-status {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .stats {
            display: flex;
            gap: 20px;
        }
        
        .stat {
            text-align: center;
            padding: 8px 16px;
            border-radius: 12px;
            background: var(--bg-card);
        }
        
        .stat.ontime { border-left: 3px solid var(--success); }
        .stat.late { border-left: 3px solid var(--warning); }
        .stat.absent { border-left: 3px solid var(--danger); }
        
        .stat-value {
            font-size: 1.6rem;
            font-weight: 700;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        .close-attendance-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 16px;
        }
        
        .close-attendance-btn:hover {
            background: #dc2626;
        }

        /* Main Content */
        .main {
            padding: 24px;
            min-height: calc(100vh - 180px);
        }
        
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
        }

        /* Seating Canvas */
        .seating-container {
            width: 100%;
            height: calc(100vh - 220px);
            overflow: auto;
            position: relative;
        }
        
        .seating-toolbar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .toolbar-group {
            display: flex;
            gap: 8px;
        }
        
        .toolbar-btn {
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        
        .toolbar-btn:hover {
            background: var(--bg-hover);
        }
        
        .toolbar-btn.active {
            background: var(--accent);
        }
        
        .seating-canvas {
            position: relative;
            width: 100%;
            min-height: 600px;
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            overflow: hidden;
        }
        
        .seating-canvas.edit-mode {
            background: repeating-linear-gradient(
                0deg,
                var(--bg-card),
                var(--bg-card) 20px,
                var(--bg-hover) 20px,
                var(--bg-hover) 21px
            ),
            repeating-linear-gradient(
                90deg,
                var(--bg-card),
                var(--bg-card) 20px,
                var(--bg-hover) 20px,
                var(--bg-hover) 21px
            );
        }

        /* Student Cards */
        .canvas-student {
            position: absolute;
            width: 100px;
            text-align: center;
            padding: 8px;
            border-radius: 12px;
            background: var(--bg-secondary);
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            border: 3px solid transparent;
        }
        
        .canvas-student:hover {
            transform: scale(1.05);
        }
        
        .canvas-student.dragging {
            z-index: 1000;
            opacity: 0.9;
            transform: scale(1.1);
        }
        
        /* Attendance States */
        .canvas-student.unchecked {
            border-color: var(--border);
            opacity: 0.6;
        }
        
        .canvas-student.ontime {
            border-color: var(--success);
            box-shadow: 0 0 20px var(--success-glow);
            animation: pulseGreen 2s ease-in-out;
        }
        
        .canvas-student.late {
            border-color: var(--warning);
            box-shadow: 0 0 20px var(--warning-glow);
        }
        
        .canvas-student.absent {
            border-color: var(--danger);
            opacity: 0.5;
        }
        
        .canvas-student.excused {
            border-color: var(--excused);
            opacity: 0.7;
        }
        
        @keyframes pulseGreen {
            0% { box-shadow: 0 0 0 0 var(--success-glow); }
            50% { box-shadow: 0 0 30px 10px var(--success-glow); }
            100% { box-shadow: 0 0 20px var(--success-glow); }
        }
        
        .student-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 6px;
        }
        
        .student-name {
            font-size: 0.8rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .student-status {
            font-size: 0.7rem;
            margin-top: 4px;
            color: var(--text-secondary);
        }
        
        .canvas-student.ontime .student-status {
            color: var(--success);
        }
        
        .canvas-student.late .student-status {
            color: var(--warning);
        }
        
        .late-timer {
            font-size: 0.75rem;
            color: var(--warning);
            font-weight: 600;
            margin-top: 2px;
        }
        
        .streak-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 700;
        }
        
        .streak-badge.fire::after {
            content: ' üî•';
        }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 8px 0;
            min-width: 200px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
        }
        
        .context-menu.open {
            display: block;
        }
        
        .context-menu-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
        }
        
        .context-menu-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.15s;
        }
        
        .context-menu-item:hover {
            background: var(--bg-hover);
        }
        
        .context-menu-item.danger {
            color: var(--danger);
        }
        
        .context-menu-divider {
            height: 1px;
            background: var(--border);
            margin: 8px 0;
        }
        
        .context-menu-note {
            padding: 8px 16px;
        }
        
        .context-menu-note input {
            width: 100%;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-overlay.open {
            display: flex;
        }
        
        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }
        
        .modal-header h2 {
            font-size: 1.3rem;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .setting-section {
            margin-bottom: 24px;
        }
        
        .setting-section h3 {
            margin-bottom: 12px;
            font-size: 1rem;
        }
        
        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--accent-light);
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: var(--bg-hover);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }

        /* Schedule Editor */
        .schedule-grid {
            display: grid;
            gap: 12px;
        }
        
        .schedule-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
        }
        
        .schedule-row label {
            width: 100px;
            font-weight: 500;
        }
        
        .schedule-row input[type="time"] {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .pattern-select {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 16px;
        }
        
        .pattern-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid var(--border);
            background: transparent;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .pattern-btn.active {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.1);
        }

        /* Summary Modal */
        .summary-grid {
            display: grid;
            gap: 16px;
        }
        
        .summary-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }
        
        .summary-stat.ontime { border-left: 4px solid var(--success); }
        .summary-stat.late { border-left: 4px solid var(--warning); }
        .summary-stat.absent { border-left: 4px solid var(--danger); }
        .summary-stat.excused { border-left: 4px solid var(--excused); }
        
        .summary-label {
            font-weight: 500;
        }
        
        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .summary-names {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: transform 0.3s;
            z-index: 3000;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
        
        /* Fun animations */
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-100px) rotate(720deg); opacity: 0; }
        }
        
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: var(--success);
            animation: confetti 1s ease-out forwards;
            pointer-events: none;
            z-index: 3000;
        }
        
        /* Student History Panel */
        .history-panel {
            margin-top: 16px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }
        
        .history-title {
            font-weight: 600;
            margin-bottom: 12px;
        }
        
        .history-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }
        
        .history-row:last-child {
            border-bottom: none;
        }
        
        .history-status {
            font-weight: 500;
        }
        
        .history-status.ontime { color: var(--success); }
        .history-status.late { color: var(--warning); }
        .history-status.absent { color: var(--danger); }
        .history-status.excused { color: var(--excused); }

        /* Upload zone */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .upload-zone:hover {
            border-color: var(--accent);
            background: rgba(99, 102, 241, 0.05);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-left">
            <div class="logo">
                <span>üéüÔ∏è</span>
                <span>Hall Pass</span>
            </div>
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="showView('attendance')">üìã Attendance</div>
                <div class="nav-tab" onclick="showView('hallpass')">üö™ Hall Pass</div>
                <div class="nav-tab" onclick="showView('groups')">üë• Groups</div>
                <div class="nav-tab" onclick="showView('history')">üìä History</div>
            </div>
        </div>
        <div class="nav-right">
            <select id="classSelect" class="class-selector">
                <option>No class loaded</option>
            </select>
            <button class="icon-btn" title="Schedule" onclick="openSchedule()">üïê</button>
            <button class="icon-btn" title="Settings" onclick="openSettings()">‚öôÔ∏è</button>
        </div>
    </nav>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="period-info">
            <div class="period-badge" onclick="openSchedule()" id="periodBadge">Period 1</div>
            <div class="countdown pre-class" id="countdown">--:--</div>
            <div class="class-status" id="classStatus">Loading...</div>
        </div>
        <div class="stats">
            <div class="stat ontime">
                <div class="stat-value" id="statOntime">0</div>
                <div class="stat-label">On Time</div>
            </div>
            <div class="stat late">
                <div class="stat-value" id="statLate">0</div>
                <div class="stat-label">Late</div>
            </div>
            <div class="stat absent">
                <div class="stat-value" id="statAbsent">0</div>
                <div class="stat-label">Not Here</div>
            </div>
            <button class="close-attendance-btn" onclick="closeAttendance()" id="closeAttendanceBtn">
                Close Attendance
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main">
        <!-- Attendance View -->
        <div class="view active" id="attendanceView">
            <div class="seating-container">
                <div class="seating-toolbar">
                    <div class="toolbar-group">
                        <button class="toolbar-btn" id="editModeBtn" onclick="toggleEditMode()">‚úèÔ∏è Edit Layout</button>
                        <button class="toolbar-btn" onclick="resetAttendance()">üîÑ Reset Day</button>
                    </div>
                    <div class="toolbar-group">
                        <button class="toolbar-btn" onclick="zoomCanvas(-0.1)">‚ûñ</button>
                        <button class="toolbar-btn" onclick="zoomCanvas(0)">Fit</button>
                        <button class="toolbar-btn" onclick="zoomCanvas(0.1)">‚ûï</button>
                    </div>
                </div>
                <div class="seating-canvas" id="seatingCanvas">
                    <!-- Students rendered here -->
                </div>
            </div>
        </div>

        <!-- Hall Pass View -->
        <div class="view" id="hallpassView">
            <div style="text-align:center;padding:60px;">
                <h2>üö™ Hall Pass</h2>
                <p style="color:var(--text-secondary);margin-top:16px;">
                    Hall pass available during class time (not first or last 10 minutes).
                </p>
                <div id="hallpassStatus" style="margin-top:24px;"></div>
            </div>
        </div>

        <!-- Groups View -->
        <div class="view" id="groupsView">
            <div style="max-width:1000px;margin:0 auto;">
                <h2 style="margin-bottom:24px;">üë• Quick Groups</h2>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:24px;">
                    <button class="btn btn-secondary" onclick="makeGroups(2)">Pairs</button>
                    <button class="btn btn-secondary" onclick="makeGroups(3)">3s</button>
                    <button class="btn btn-secondary" onclick="makeGroups(4)">4s</button>
                    <button class="btn btn-secondary" onclick="makeGroups(5)">5s</button>
                    <button class="btn btn-secondary" onclick="shuffleGroups()">üîÄ Shuffle</button>
                </div>
                <div id="groupsContainer"></div>
            </div>
        </div>

        <!-- History View -->
        <div class="view" id="historyView">
            <div style="max-width:800px;margin:0 auto;">
                <h2 style="margin-bottom:24px;">üìä Attendance History</h2>
                <div id="historyContainer">
                    <p style="color:var(--text-secondary);">Select a student to view their history, or view class trends.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-header" id="contextMenuHeader">Student Name</div>
        <div class="context-menu-item" onclick="setStatus('ontime')">‚úÖ Mark On-Time</div>
        <div class="context-menu-item" onclick="setStatus('late')">‚ö†Ô∏è Mark Late</div>
        <div class="context-menu-item" onclick="setStatus('absent')">‚ùå Mark Absent</div>
        <div class="context-menu-item" onclick="setStatus('excused')">üìù Mark Excused</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-note">
            <input type="text" id="contextMenuNote" placeholder="Add note..." onkeypress="if(event.key==='Enter')saveNote()">
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="viewStudentHistory()">üìä View History</div>
        <div class="context-menu-item danger" onclick="clearStatus()">üóëÔ∏è Clear Status</div>
    </div>

    <!-- Schedule Modal -->
    <div class="modal-overlay" id="scheduleModal" onclick="if(event.target===this)closeSchedule()">
        <div class="modal">
            <div class="modal-header">
                <h2>üïê Schedule Settings</h2>
                <button class="close-btn" onclick="closeSchedule()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="setting-section">
                    <h3>Today's Schedule</h3>
                    <div class="schedule-grid">
                        <div class="schedule-row">
                            <label>Period:</label>
                            <select id="schedPeriod" onchange="updateSchedulePreview()">
                                <option value="1">Period 1</option>
                                <option value="2">Period 2</option>
                                <option value="3">Period 3</option>
                                <option value="4">Period 4</option>
                            </select>
                        </div>
                        <div class="schedule-row">
                            <label>Start Time:</label>
                            <input type="time" id="schedStart" value="08:40" onchange="updateSchedulePreview()">
                        </div>
                        <div class="schedule-row">
                            <label>End Time:</label>
                            <input type="time" id="schedEnd" value="10:00" onchange="updateSchedulePreview()">
                        </div>
                    </div>
                    <div style="margin-top:12px;padding:12px;background:var(--bg-secondary);border-radius:8px;font-size:0.85rem;">
                        <div>üö™ Hall pass available: <span id="hallpassWindow">8:50 AM - 9:50 AM</span></div>
                    </div>
                </div>
                
                <div class="setting-section">
                    <h3>Save As</h3>
                    <div class="pattern-select">
                        <button class="pattern-btn active" onclick="setPattern('oneoff', this)">üìÖ One-off (just today)</button>
                        <button class="pattern-btn" onclick="setPattern('regular', this)">üîÑ Regular Pattern</button>
                        <button class="pattern-btn" onclick="setPattern('special', this)">‚≠ê Special Pattern</button>
                    </div>
                    <input type="text" id="patternName" placeholder="Pattern name (e.g., 'Assembly Day')" 
                           style="display:none;margin-top:12px;width:100%;padding:10px;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);">
                </div>
                
                <div class="setting-section">
                    <h3>Quick Presets (Britannia)</h3>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;">
                        <button class="btn btn-secondary" onclick="loadPreset('regular')">Regular Day</button>
                        <button class="btn btn-secondary" onclick="loadPreset('amfit')">AM FIT (Wed/Fri)</button>
                        <button class="btn btn-secondary" onclick="loadPreset('pmfit')">PM FIT (Tue/Thu)</button>
                    </div>
                </div>
                
                <div style="display:flex;gap:12px;margin-top:24px;">
                    <button class="btn btn-primary" onclick="saveSchedule()">Save Schedule</button>
                    <button class="btn btn-secondary" onclick="closeSchedule()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal" onclick="if(event.target===this)closeSettings()">
        <div class="modal">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="close-btn" onclick="closeSettings()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="setting-section">
                    <h3>üì• Import Class</h3>
                    <div class="upload-zone" onclick="document.getElementById('importFile').click()">
                        <div style="font-size:2rem;margin-bottom:8px;">üìÅ</div>
                        <div>Click to import class JSON</div>
                    </div>
                    <input type="file" id="importFile" accept=".json" style="display:none" onchange="handleImport(event)">
                    <div style="margin-top:12px;">
                        <a href="processor.html" class="btn btn-secondary" style="display:inline-block;text-decoration:none;">
                            ‚ú® Create from MyEd
                        </a>
                    </div>
                </div>
                
                <div class="setting-section">
                    <h3>üì§ Export All Data</h3>
                    <p style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:12px;">
                        Export everything for laptop migration. Includes class roster, attendance history, and settings.
                    </p>
                    <button class="btn btn-secondary" onclick="exportAllData()">üíæ Export Full Backup</button>
                </div>
                
                <div class="setting-section">
                    <h3>üìä Export Attendance</h3>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-secondary" onclick="exportAttendance('csv')">üìä CSV</button>
                        <button class="btn btn-secondary" onclick="exportAttendance('json')">üíæ JSON</button>
                    </div>
                </div>
                
                <div class="setting-section">
                    <h3>üóëÔ∏è Clear Data</h3>
                    <button class="btn btn-danger" onclick="clearAllData()">Clear Everything</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Modal -->
    <div class="modal-overlay" id="summaryModal" onclick="if(event.target===this)closeSummary()">
        <div class="modal">
            <div class="modal-header">
                <h2>üìã Attendance Summary</h2>
                <button class="close-btn" onclick="closeSummary()">‚úï</button>
            </div>
            <div class="modal-body" id="summaryContent">
                <!-- Filled dynamically -->
            </div>
        </div>
    </div>

    <!-- Student History Modal -->
    <div class="modal-overlay" id="studentHistoryModal" onclick="if(event.target===this)closeStudentHistory()">
        <div class="modal">
            <div class="modal-header">
                <h2 id="studentHistoryTitle">üìä Student History</h2>
                <button class="close-btn" onclick="closeStudentHistory()">‚úï</button>
            </div>
            <div class="modal-body" id="studentHistoryContent">
                <!-- Filled dynamically -->
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ========== APP STATE ==========
        let students = [];
        let classData = null;
        let currentZoom = 1;
        let editMode = false;
        let contextStudentId = null;
        let currentGroups = [];
        
        // Schedule state
        let schedule = {
            period: 1,
            startTime: '08:40',
            endTime: '10:00',
            pattern: 'oneoff',
            patternName: ''
        };
        
        // Attendance history: { date: { studentId: { status, time, note, lateBy } } }
        let attendanceHistory = {};
        
        // Student streaks: { studentId: { current: N, best: N, lastDate: 'YYYY-MM-DD' } }
        let streaks = {};
        
        // Fun messages
        const ontimeMessages = [
            "‚úì On time!",
            "‚úì Nice! Right on time",
            "‚úì Perfect timing!",
            "‚úì Looking good!",
            "‚úì Nailed it!"
        ];
        
        const streakMessages = {
            3: "üé© Hat trick! 3 days on time!",
            5: "üî• On fire! 5 days!",
            10: "‚≠ê Perfect 10! You're unstoppable!",
            20: "üèÜ Legend status! 20 days!"
        };
        
        const improvementMessages = [
            "üìà Better than yesterday!",
            "üìà Improvement! Keep it up!",
            "üìà Nice progress!"
        ];
        
        // Britannia bell schedule presets
        const presets = {
            regular: {
                1: { start: '08:40', end: '10:00' },
                2: { start: '10:10', end: '11:30' },
                3: { start: '12:15', end: '13:35' },
                4: { start: '13:45', end: '15:05' }
            },
            amfit: { // Wed, Fri
                1: { start: '09:20', end: '10:20' },
                2: { start: '10:30', end: '11:30' },
                3: { start: '12:15', end: '13:35' },
                4: { start: '13:45', end: '15:05' }
            },
            pmfit: { // Tue, Thu
                1: { start: '08:40', end: '10:00' },
                2: { start: '10:10', end: '11:30' },
                3: { start: '12:15', end: '13:15' },
                4: { start: '13:25', end: '14:25' }
            }
        };
        
        // ========== DATE HELPERS ==========
        function getToday() {
            return new Date().toISOString().split('T')[0];
        }
        
        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }
        
        function parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            const d = new Date();
            d.setHours(hours, minutes, 0, 0);
            return d;
        }
        
        // ========== SCHEDULE ==========
        function openSchedule() {
            document.getElementById('schedPeriod').value = schedule.period;
            document.getElementById('schedStart').value = schedule.startTime;
            document.getElementById('schedEnd').value = schedule.endTime;
            updateSchedulePreview();
            document.getElementById('scheduleModal').classList.add('open');
        }
        
        function closeSchedule() {
            document.getElementById('scheduleModal').classList.remove('open');
        }
        
        function updateSchedulePreview() {
            const start = parseTime(document.getElementById('schedStart').value);
            const end = parseTime(document.getElementById('schedEnd').value);
            
            // Hall pass: 10 min after start until 10 min before end
            const passStart = new Date(start.getTime() + 10 * 60000);
            const passEnd = new Date(end.getTime() - 10 * 60000);
            
            document.getElementById('hallpassWindow').textContent = 
                `${formatTime(passStart)} - ${formatTime(passEnd)}`;
        }
        
        function setPattern(pattern, btn) {
            document.querySelectorAll('.pattern-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            schedule.pattern = pattern;
            
            const nameInput = document.getElementById('patternName');
            nameInput.style.display = pattern === 'special' ? 'block' : 'none';
        }
        
        function loadPreset(preset) {
            const period = parseInt(document.getElementById('schedPeriod').value);
            const times = presets[preset][period];
            if (times) {
                document.getElementById('schedStart').value = times.start;
                document.getElementById('schedEnd').value = times.end;
                updateSchedulePreview();
                showToast('Loaded ' + preset + ' preset');
            }
        }
        
        function saveSchedule() {
            schedule.period = parseInt(document.getElementById('schedPeriod').value);
            schedule.startTime = document.getElementById('schedStart').value;
            schedule.endTime = document.getElementById('schedEnd').value;
            schedule.patternName = document.getElementById('patternName').value;
            
            localStorage.setItem('hallpass_schedule', JSON.stringify(schedule));
            
            // Save pattern if not one-off
            if (schedule.pattern === 'regular' || schedule.pattern === 'special') {
                const patterns = JSON.parse(localStorage.getItem('hallpass_patterns') || '{}');
                const key = schedule.pattern === 'regular' 
                    ? `regular_p${schedule.period}` 
                    : schedule.patternName || 'special';
                patterns[key] = { ...schedule };
                localStorage.setItem('hallpass_patterns', JSON.stringify(patterns));
            }
            
            updateStatusBar();
            closeSchedule();
            showToast('Schedule saved!');
        }
        
        // ========== COUNTDOWN & STATUS ==========
        function updateStatusBar() {
            const now = new Date();
            const start = parseTime(schedule.startTime);
            const end = parseTime(schedule.endTime);
            
            const periodBadge = document.getElementById('periodBadge');
            const countdown = document.getElementById('countdown');
            const classStatus = document.getElementById('classStatus');
            
            periodBadge.textContent = `Period ${schedule.period}`;
            
            if (now < start) {
                // Pre-class
                const diff = start - now;
                const mins = Math.floor(diff / 60000);
                const secs = Math.floor((diff % 60000) / 1000);
                countdown.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                countdown.className = 'countdown pre-class';
                classStatus.textContent = `Class starts in ${mins} minute${mins !== 1 ? 's' : ''}`;
            } else if (now < end) {
                // In class
                const diff = end - now;
                const mins = Math.floor(diff / 60000);
                countdown.textContent = `${mins}m left`;
                countdown.className = mins <= 10 ? 'countdown ending-soon' : 'countdown in-class';
                classStatus.textContent = 'Class in session';
            } else {
                // After class
                countdown.textContent = 'Done';
                countdown.className = 'countdown';
                classStatus.textContent = 'Class ended';
            }
            
            // Update stats
            updateStats();
        }
        
        function updateStats() {
            let ontime = 0, late = 0, absent = 0;
            students.forEach(s => {
                if (s.status === 'ontime') ontime++;
                else if (s.status === 'late') late++;
                else if (s.status !== 'excused' && s.status !== 'withdrawn') absent++;
            });
            
            document.getElementById('statOntime').textContent = ontime;
            document.getElementById('statLate').textContent = late;
            document.getElementById('statAbsent').textContent = absent;
        }
        
        // ========== CHECK-IN LOGIC ==========
        function handleStudentClick(event, studentId) {
            if (editMode) return;
            
            // Right-click opens context menu
            if (event.button === 2) {
                openContextMenu(event, studentId);
                return;
            }
            
            // Left-click: toggle check-in
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // If already checked in, do nothing (use right-click to change)
            if (student.status === 'ontime' || student.status === 'late') {
                showToast('Right-click to change status');
                return;
            }
            
            // Check in
            checkInStudent(student);
        }
        
        function checkInStudent(student) {
            const now = new Date();
            const start = parseTime(schedule.startTime);
            
            // Determine on-time vs late
            const isLate = now > start;
            student.status = isLate ? 'late' : 'ontime';
            student.checkInTime = now.toISOString();
            
            if (isLate) {
                const lateBy = Math.floor((now - start) / 60000);
                student.lateBy = lateBy;
                student.statusText = `Late by ${lateBy}m`;
            } else {
                student.lateBy = 0;
                student.statusText = ontimeMessages[Math.floor(Math.random() * ontimeMessages.length)];
            }
            
            // Update streak
            updateStreak(student, isLate);
            
            // Save to today's attendance
            saveAttendance(student);
            
            // Show fun effects
            if (!isLate) {
                const streak = streaks[student.id]?.current || 0;
                if (streakMessages[streak]) {
                    showToast(streakMessages[streak]);
                    spawnConfetti();
                } else {
                    showToast(student.statusText);
                }
            } else {
                // Check for improvement
                const yesterday = getYesterdayAttendance(student.id);
                if (yesterday?.lateBy && student.lateBy < yesterday.lateBy) {
                    const improvement = yesterday.lateBy - student.lateBy;
                    student.statusText += ` (${improvement}m better than yesterday!)`;
                    showToast(improvementMessages[Math.floor(Math.random() * improvementMessages.length)]);
                } else {
                    showToast(`Late by ${student.lateBy} minutes`);
                }
            }
            
            renderCanvas();
            updateStats();
            saveClass();
        }
        
        function updateStreak(student, isLate) {
            const today = getToday();
            if (!streaks[student.id]) {
                streaks[student.id] = { current: 0, best: 0, lastDate: null };
            }
            
            const streak = streaks[student.id];
            
            if (!isLate) {
                // Check if continuing streak (was yesterday)
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                
                if (streak.lastDate === yesterdayStr || streak.lastDate === today) {
                    if (streak.lastDate !== today) {
                        streak.current++;
                    }
                } else {
                    streak.current = 1;
                }
                
                streak.best = Math.max(streak.best, streak.current);
                streak.lastDate = today;
            } else {
                // Late breaks streak
                streak.current = 0;
            }
            
            localStorage.setItem('hallpass_streaks', JSON.stringify(streaks));
        }
        
        function getYesterdayAttendance(studentId) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const dateStr = yesterday.toISOString().split('T')[0];
            return attendanceHistory[dateStr]?.[studentId];
        }
        
        function saveAttendance(student) {
            const today = getToday();
            if (!attendanceHistory[today]) {
                attendanceHistory[today] = {};
            }
            
            attendanceHistory[today][student.id] = {
                status: student.status,
                time: student.checkInTime,
                lateBy: student.lateBy || 0,
                note: student.note || ''
            };
            
            localStorage.setItem('hallpass_attendance', JSON.stringify(attendanceHistory));
        }
        
        // ========== CONTEXT MENU ==========
        function openContextMenu(event, studentId) {
            event.preventDefault();
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            contextStudentId = studentId;
            
            const menu = document.getElementById('contextMenu');
            const name = student.displayName || `${student.firstName} ${student.lastInitial}.`;
            document.getElementById('contextMenuHeader').textContent = name;
            document.getElementById('contextMenuNote').value = student.note || '';
            
            menu.style.left = event.clientX + 'px';
            menu.style.top = event.clientY + 'px';
            menu.classList.add('open');
        }
        
        function closeContextMenu() {
            document.getElementById('contextMenu').classList.remove('open');
            contextStudentId = null;
        }
        
        function setStatus(status) {
            if (!contextStudentId) return;
            const student = students.find(s => s.id === contextStudentId);
            if (!student) return;
            
            student.status = status;
            student.checkInTime = new Date().toISOString();
            
            if (status === 'late' && !student.lateBy) {
                const now = new Date();
                const start = parseTime(schedule.startTime);
                student.lateBy = Math.max(0, Math.floor((now - start) / 60000));
            }
            
            // Log correction
            logCorrection(student, status);
            saveAttendance(student);
            renderCanvas();
            updateStats();
            closeContextMenu();
            showToast(`Marked ${student.firstName} as ${status}`);
            saveClass();
        }
        
        function clearStatus() {
            if (!contextStudentId) return;
            const student = students.find(s => s.id === contextStudentId);
            if (!student) return;
            
            student.status = 'unchecked';
            student.checkInTime = null;
            student.lateBy = null;
            student.statusText = null;
            
            saveAttendance(student);
            renderCanvas();
            updateStats();
            closeContextMenu();
            showToast(`Cleared status for ${student.firstName}`);
            saveClass();
        }
        
        function saveNote() {
            if (!contextStudentId) return;
            const student = students.find(s => s.id === contextStudentId);
            if (!student) return;
            
            student.note = document.getElementById('contextMenuNote').value;
            saveAttendance(student);
            closeContextMenu();
            showToast('Note saved');
            saveClass();
        }
        
        function logCorrection(student, newStatus) {
            const corrections = JSON.parse(localStorage.getItem('hallpass_corrections') || '[]');
            corrections.push({
                date: getToday(),
                time: new Date().toISOString(),
                studentId: student.id,
                studentName: student.firstName + ' ' + student.lastInitial,
                newStatus,
                note: student.note || ''
            });
            localStorage.setItem('hallpass_corrections', JSON.stringify(corrections));
        }
        
        function viewStudentHistory() {
            if (!contextStudentId) return;
            closeContextMenu();
            showStudentHistoryModal(contextStudentId);
        }
        
        // ========== STUDENT HISTORY MODAL ==========
        function showStudentHistoryModal(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const name = student.displayName || `${student.firstName} ${student.lastInitial}.`;
            document.getElementById('studentHistoryTitle').textContent = `üìä ${name}'s History`;
            
            const streak = streaks[studentId] || { current: 0, best: 0 };
            
            // Get last 14 days of attendance
            const days = [];
            for (let i = 0; i < 14; i++) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                const record = attendanceHistory[dateStr]?.[studentId];
                if (record) {
                    days.push({ date: dateStr, ...record });
                }
            }
            
            // Calculate stats
            const ontimeCount = days.filter(d => d.status === 'ontime').length;
            const lateCount = days.filter(d => d.status === 'late').length;
            const absentCount = days.filter(d => d.status === 'absent').length;
            const avgLateBy = days.filter(d => d.lateBy > 0).length > 0
                ? Math.round(days.filter(d => d.lateBy > 0).reduce((a, d) => a + d.lateBy, 0) / days.filter(d => d.lateBy > 0).length)
                : 0;
            
            let html = `
                <div class="summary-grid" style="margin-bottom:24px;">
                    <div class="summary-stat ontime">
                        <span class="summary-label">Current Streak</span>
                        <span class="summary-value">${streak.current} ${streak.current >= 5 ? 'üî•' : ''}</span>
                    </div>
                    <div class="summary-stat" style="border-left:4px solid var(--accent);">
                        <span class="summary-label">Best Streak</span>
                        <span class="summary-value">${streak.best}</span>
                    </div>
                </div>
                
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px;">
                    <div style="text-align:center;">
                        <div style="font-size:1.5rem;font-weight:700;color:var(--success);">${ontimeCount}</div>
                        <div style="font-size:0.8rem;color:var(--text-secondary);">On Time</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:1.5rem;font-weight:700;color:var(--warning);">${lateCount}</div>
                        <div style="font-size:0.8rem;color:var(--text-secondary);">Late</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:1.5rem;font-weight:700;color:var(--danger);">${absentCount}</div>
                        <div style="font-size:0.8rem;color:var(--text-secondary);">Absent</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:1.5rem;font-weight:700;color:var(--warning);">${avgLateBy}m</div>
                        <div style="font-size:0.8rem;color:var(--text-secondary);">Avg Late</div>
                    </div>
                </div>
                
                <h3 style="margin-bottom:12px;">Recent Days</h3>
                <div class="history-panel" style="margin-top:0;">
            `;
            
            if (days.length === 0) {
                html += '<p style="color:var(--text-secondary);">No attendance records yet.</p>';
            } else {
                days.slice(0, 10).forEach(d => {
                    const dateObj = new Date(d.date + 'T12:00:00');
                    const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    const lateText = d.lateBy > 0 ? ` (+${d.lateBy}m)` : '';
                    html += `
                        <div class="history-row">
                            <span>${dateStr}</span>
                            <span class="history-status ${d.status}">${d.status}${lateText}</span>
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            
            document.getElementById('studentHistoryContent').innerHTML = html;
            document.getElementById('studentHistoryModal').classList.add('open');
        }
        
        function closeStudentHistory() {
            document.getElementById('studentHistoryModal').classList.remove('open');
        }
        
        // ========== CLOSE ATTENDANCE ==========
        function closeAttendance() {
            const now = new Date();
            const end = parseTime(schedule.endTime);
            
            // Mark remaining as absent
            students.forEach(s => {
                if (!s.status || s.status === 'unchecked') {
                    s.status = 'absent';
                    s.checkInTime = now.toISOString();
                    saveAttendance(s);
                }
            });
            
            // Show summary
            showSummary();
            saveClass();
        }
        
        function showSummary() {
            const today = getToday();
            const ontime = students.filter(s => s.status === 'ontime');
            const late = students.filter(s => s.status === 'late');
            const absent = students.filter(s => s.status === 'absent');
            const excused = students.filter(s => s.status === 'excused');
            
            const className = classData?.settings?.className || 'Class';
            const dateStr = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            
            let html = `
                <div style="text-align:center;margin-bottom:24px;">
                    <h3>${className}</h3>
                    <p style="color:var(--text-secondary);">${dateStr} ‚Ä¢ Period ${schedule.period}</p>
                </div>
                
                <div class="summary-grid">
                    <div class="summary-stat ontime">
                        <div>
                            <span class="summary-label">‚úÖ On Time</span>
                            <div class="summary-names">${ontime.map(s => s.firstName).join(', ') || 'None'}</div>
                        </div>
                        <span class="summary-value">${ontime.length}</span>
                    </div>
                    <div class="summary-stat late">
                        <div>
                            <span class="summary-label">‚ö†Ô∏è Late</span>
                            <div class="summary-names">${late.map(s => s.firstName + (s.lateBy ? ` +${s.lateBy}m` : '')).join(', ') || 'None'}</div>
                        </div>
                        <span class="summary-value">${late.length}</span>
                    </div>
                    <div class="summary-stat absent">
                        <div>
                            <span class="summary-label">‚ùå Absent</span>
                            <div class="summary-names">${absent.map(s => s.firstName).join(', ') || 'None'}</div>
                        </div>
                        <span class="summary-value">${absent.length}</span>
                    </div>
            `;
            
            if (excused.length > 0) {
                html += `
                    <div class="summary-stat excused">
                        <div>
                            <span class="summary-label">üìù Excused</span>
                            <div class="summary-names">${excused.map(s => s.firstName).join(', ')}</div>
                        </div>
                        <span class="summary-value">${excused.length}</span>
                    </div>
                `;
            }
            
            html += `
                </div>
                <div style="margin-top:24px;text-align:center;">
                    <button class="btn btn-primary" onclick="closeSummary()">Done</button>
                </div>
            `;
            
            document.getElementById('summaryContent').innerHTML = html;
            document.getElementById('summaryModal').classList.add('open');
        }
        
        function closeSummary() {
            document.getElementById('summaryModal').classList.remove('open');
        }
        
        // ========== RESET DAY ==========
        function resetAttendance() {
            if (!confirm('Reset attendance for all students today?')) return;
            
            students.forEach(s => {
                s.status = 'unchecked';
                s.checkInTime = null;
                s.lateBy = null;
                s.statusText = null;
            });
            
            // Clear today's attendance
            const today = getToday();
            delete attendanceHistory[today];
            localStorage.setItem('hallpass_attendance', JSON.stringify(attendanceHistory));
            
            renderCanvas();
            updateStats();
            saveClass();
            showToast('Attendance reset');
        }
        
        // ========== RENDERING ==========
        function renderCanvas() {
            const canvas = document.getElementById('seatingCanvas');
            if (!canvas) return;
            
            if (students.length === 0) {
                canvas.innerHTML = `
                    <div style="text-align:center;padding:60px;color:var(--text-secondary);">
                        <div style="font-size:3rem;margin-bottom:16px;">üì•</div>
                        <h3>No class loaded</h3>
                        <p>Click ‚öôÔ∏è Settings to import a class</p>
                    </div>
                `;
                return;
            }
            
            const cardWidth = 100;
            const cardHeight = 130;
            const padding = 20;
            
            // Migrate positions
            students.forEach((s, idx) => {
                if (!s.position || s.position.x === undefined) {
                    s.position = {
                        x: padding + (idx % 6) * (cardWidth + 15),
                        y: padding + Math.floor(idx / 6) * (cardHeight + 15)
                    };
                }
            });
            
            let html = '';
            students.forEach(s => {
                const imgSrc = getStudentImage(s);
                const name = s.displayName || `${s.firstName} ${s.lastInitial || ''}.`;
                const status = s.status || 'unchecked';
                const streak = streaks[s.id]?.current || 0;
                
                let statusHtml = '';
                if (status === 'ontime') {
                    statusHtml = `<div class="student-status">${s.statusText || '‚úì On time'}</div>`;
                } else if (status === 'late') {
                    statusHtml = `
                        <div class="student-status">‚ö†Ô∏è Late</div>
                        <div class="late-timer">+${s.lateBy || 0}m</div>
                    `;
                } else if (status === 'absent') {
                    statusHtml = `<div class="student-status" style="color:var(--danger);">‚ùå Absent</div>`;
                } else if (status === 'excused') {
                    statusHtml = `<div class="student-status" style="color:var(--excused);">üìù Excused</div>`;
                } else {
                    statusHtml = `<div class="student-status">Tap to check in</div>`;
                }
                
                let streakBadge = '';
                if (streak >= 3) {
                    streakBadge = `<div class="streak-badge${streak >= 5 ? ' fire' : ''}">${streak}</div>`;
                }
                
                html += `
                    <div class="canvas-student ${status}" 
                         data-id="${s.id}"
                         style="left:${s.position.x}px; top:${s.position.y}px;"
                         onclick="handleStudentClick(event, ${s.id})"
                         oncontextmenu="handleStudentClick(event, ${s.id}); return false;"
                         onmousedown="startDrag(event, ${s.id})"
                         ontouchstart="startDrag(event, ${s.id})">
                        ${streakBadge}
                        <img class="student-avatar" src="${imgSrc}" alt="${name}">
                        <div class="student-name">${name}</div>
                        ${statusHtml}
                    </div>
                `;
            });
            
            canvas.innerHTML = html;
        }
        
        function getStudentImage(student) {
            if (student.caricatures?.photo) return student.caricatures.photo;
            if (student.caricature) return student.caricature;
            return `https://api.dicebear.com/7.x/avataaars/svg?seed=${student.firstName}`;
        }
        
        // ========== EDIT MODE ==========
        let dragState = null;
        
        function toggleEditMode() {
            editMode = !editMode;
            const canvas = document.getElementById('seatingCanvas');
            const btn = document.getElementById('editModeBtn');
            
            if (editMode) {
                canvas.classList.add('edit-mode');
                btn.classList.add('active');
                btn.textContent = '‚úì Done Editing';
            } else {
                canvas.classList.remove('edit-mode');
                btn.classList.remove('active');
                btn.textContent = '‚úèÔ∏è Edit Layout';
                saveClass();
            }
        }
        
        function startDrag(event, studentId) {
            if (!editMode) return;
            event.preventDefault();
            
            const canvas = document.getElementById('seatingCanvas');
            const studentEl = canvas.querySelector(`[data-id="${studentId}"]`);
            if (!studentEl) return;
            
            const touch = event.touches ? event.touches[0] : event;
            
            dragState = {
                studentId,
                element: studentEl,
                startX: touch.clientX,
                startY: touch.clientY,
                origLeft: parseInt(studentEl.style.left),
                origTop: parseInt(studentEl.style.top)
            };
            
            studentEl.classList.add('dragging');
            document.addEventListener('mousemove', onDrag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchmove', onDrag, { passive: false });
            document.addEventListener('touchend', endDrag);
        }
        
        function onDrag(event) {
            if (!dragState) return;
            event.preventDefault();
            
            const touch = event.touches ? event.touches[0] : event;
            const dx = touch.clientX - dragState.startX;
            const dy = touch.clientY - dragState.startY;
            
            dragState.element.style.left = (dragState.origLeft + dx) + 'px';
            dragState.element.style.top = (dragState.origTop + dy) + 'px';
        }
        
        function endDrag() {
            if (!dragState) return;
            
            const student = students.find(s => s.id === dragState.studentId);
            if (student) {
                student.position = {
                    x: parseInt(dragState.element.style.left),
                    y: parseInt(dragState.element.style.top)
                };
            }
            
            dragState.element.classList.remove('dragging');
            dragState = null;
            
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchmove', onDrag);
            document.removeEventListener('touchend', endDrag);
        }
        
        function zoomCanvas(delta) {
            const canvas = document.getElementById('seatingCanvas');
            if (delta === 0) {
                currentZoom = 1;
            } else {
                currentZoom = Math.max(0.5, Math.min(2, currentZoom + delta));
            }
            canvas.style.transform = `scale(${currentZoom})`;
            canvas.style.transformOrigin = 'top left';
        }
        
        // ========== GROUPS ==========
        const groupColors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#06b6d4', '#3b82f6', '#8b5cf6', '#ec4899'];
        
        function makeGroups(size) {
            if (students.length === 0) {
                showToast('No students loaded');
                return;
            }
            
            const shuffled = [...students].sort(() => Math.random() - 0.5);
            currentGroups = [];
            
            for (let i = 0; i < shuffled.length; i += size) {
                currentGroups.push({
                    id: currentGroups.length + 1,
                    members: shuffled.slice(i, i + size),
                    color: groupColors[currentGroups.length % groupColors.length]
                });
            }
            
            renderGroups();
        }
        
        function shuffleGroups() {
            if (currentGroups.length === 0) {
                makeGroups(2);
            } else {
                const avgSize = Math.round(currentGroups.reduce((a, g) => a + g.members.length, 0) / currentGroups.length);
                makeGroups(avgSize);
            }
        }
        
        function renderGroups() {
            const container = document.getElementById('groupsContainer');
            if (!container) return;
            
            if (currentGroups.length === 0) {
                container.innerHTML = '<p style="color:var(--text-secondary);">Click a group size above to create groups.</p>';
                return;
            }
            
            container.innerHTML = currentGroups.map(g => `
                <div style="background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:12px;border-left:4px solid ${g.color};">
                    <h4 style="margin-bottom:12px;">Group ${g.id}</h4>
                    <div style="display:flex;flex-wrap:wrap;gap:12px;">
                        ${g.members.map(m => `
                            <div style="display:flex;align-items:center;gap:8px;">
                                <img src="${getStudentImage(m)}" style="width:32px;height:32px;border-radius:50%;">
                                <span>${m.displayName || m.firstName}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }
        
        // ========== VIEW SWITCHING ==========
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            
            document.getElementById(viewName + 'View')?.classList.add('active');
            document.querySelectorAll('.nav-tab').forEach(t => {
                if (t.textContent.toLowerCase().includes(viewName)) {
                    t.classList.add('active');
                }
            });
            
            if (viewName === 'groups') renderGroups();
            if (viewName === 'history') renderHistoryView();
        }
        
        function renderHistoryView() {
            const container = document.getElementById('historyContainer');
            if (!container || students.length === 0) return;
            
            // Class overview
            const days = Object.keys(attendanceHistory).sort().reverse().slice(0, 7);
            
            let html = `
                <h3 style="margin-bottom:16px;">Class Trends (Last 7 Days)</h3>
                <div style="background:var(--bg-card);border-radius:12px;padding:16px;margin-bottom:24px;">
            `;
            
            if (days.length === 0) {
                html += '<p style="color:var(--text-secondary);">No attendance data yet.</p>';
            } else {
                html += '<div style="display:grid;gap:8px;">';
                days.forEach(date => {
                    const day = attendanceHistory[date];
                    const total = Object.keys(day).length;
                    const ontime = Object.values(day).filter(d => d.status === 'ontime').length;
                    const late = Object.values(day).filter(d => d.status === 'late').length;
                    const absent = Object.values(day).filter(d => d.status === 'absent').length;
                    const pct = total > 0 ? Math.round((ontime / total) * 100) : 0;
                    
                    const dateObj = new Date(date + 'T12:00:00');
                    const dateStr = dateObj.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
                    
                    html += `
                        <div style="display:flex;justify-content:space-between;padding:8px;background:var(--bg-secondary);border-radius:8px;">
                            <span>${dateStr}</span>
                            <span>
                                <span style="color:var(--success);">${ontime}‚úì</span>
                                <span style="color:var(--warning);margin-left:8px;">${late}‚ö†Ô∏è</span>
                                <span style="color:var(--danger);margin-left:8px;">${absent}‚ùå</span>
                                <span style="margin-left:12px;color:var(--text-secondary);">${pct}%</span>
                            </span>
                        </div>
                    `;
                });
                html += '</div>';
            }
            
            html += '</div>';
            
            // Student list
            html += `
                <h3 style="margin-bottom:16px;">Student Records</h3>
                <p style="color:var(--text-secondary);margin-bottom:16px;">Click a student to view their detailed history.</p>
                <div style="display:grid;gap:8px;">
            `;
            
            students.forEach(s => {
                const streak = streaks[s.id]?.current || 0;
                const name = s.displayName || `${s.firstName} ${s.lastInitial}.`;
                html += `
                    <div style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--bg-card);border-radius:10px;cursor:pointer;" onclick="showStudentHistoryModal(${s.id})">
                        <img src="${getStudentImage(s)}" style="width:40px;height:40px;border-radius:50%;">
                        <div style="flex:1;">
                            <div style="font-weight:500;">${name}</div>
                            <div style="font-size:0.8rem;color:var(--text-secondary);">
                                ${streak > 0 ? `üî• ${streak} day streak` : 'No streak'}
                            </div>
                        </div>
                        <span style="color:var(--text-secondary);">‚Üí</span>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // ========== SETTINGS & IMPORT/EXPORT ==========
        function openSettings() {
            document.getElementById('settingsModal').classList.add('open');
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('open');
        }
        
        async function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                // Check if this is a full backup or just class data
                if (data.hallpass_backup) {
                    // Full backup import
                    if (data.classData) {
                        classData = data.classData;
                        students = data.classData.students || [];
                    }
                    if (data.attendanceHistory) {
                        attendanceHistory = data.attendanceHistory;
                        localStorage.setItem('hallpass_attendance', JSON.stringify(attendanceHistory));
                    }
                    if (data.streaks) {
                        streaks = data.streaks;
                        localStorage.setItem('hallpass_streaks', JSON.stringify(streaks));
                    }
                    if (data.schedule) {
                        schedule = data.schedule;
                        localStorage.setItem('hallpass_schedule', JSON.stringify(schedule));
                    }
                    showToast('Full backup restored!');
                } else if (data.students) {
                    // Just class data
                    classData = data;
                    students = data.students.map(s => ({
                        ...s,
                        status: 'unchecked'
                    }));
                    showToast(`Loaded ${students.length} students`);
                }
                
                if (classData?.settings?.className) {
                    document.getElementById('classSelect').innerHTML = `<option>${classData.settings.className}</option>`;
                }
                
                saveClass();
                renderCanvas();
                updateStats();
                closeSettings();
            } catch (e) {
                alert('Error importing: ' + e.message);
            }
        }
        
        function exportAllData() {
            const backup = {
                hallpass_backup: true,
                exportDate: new Date().toISOString(),
                classData,
                students,
                attendanceHistory,
                streaks,
                schedule,
                corrections: JSON.parse(localStorage.getItem('hallpass_corrections') || '[]')
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `hallpass-backup-${getToday()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Backup exported!');
        }
        
        function exportAttendance(format) {
            if (format === 'csv') {
                let csv = 'Date,Student ID,Name,Status,Late By (min),Note\n';
                Object.entries(attendanceHistory).forEach(([date, day]) => {
                    Object.entries(day).forEach(([studentId, record]) => {
                        const student = students.find(s => s.id == studentId);
                        const name = student ? `${student.firstName} ${student.lastInitial}` : studentId;
                        csv += `${date},"${name}",${record.status},${record.lateBy || 0},"${record.note || ''}"\n`;
                    });
                });
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `attendance-${getToday()}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            } else {
                // Anonymized JSON (no names for privacy)
                const anonymized = {};
                Object.entries(attendanceHistory).forEach(([date, day]) => {
                    anonymized[date] = {
                        ontime: Object.values(day).filter(d => d.status === 'ontime').length,
                        late: Object.values(day).filter(d => d.status === 'late').length,
                        absent: Object.values(day).filter(d => d.status === 'absent').length,
                        avgLateBy: Math.round(
                            Object.values(day).filter(d => d.lateBy > 0).reduce((a, d) => a + d.lateBy, 0) /
                            Math.max(1, Object.values(day).filter(d => d.lateBy > 0).length)
                        )
                    };
                });
                
                const blob = new Blob([JSON.stringify(anonymized, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `attendance-trends-${getToday()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
            showToast(`Exported as ${format.toUpperCase()}`);
        }
        
        function clearAllData() {
            if (!confirm('This will delete ALL Hall Pass data. Are you sure?')) return;
            if (!confirm('Really? This cannot be undone!')) return;
            
            localStorage.removeItem('hallpass_class');
            localStorage.removeItem('hallpass_attendance');
            localStorage.removeItem('hallpass_streaks');
            localStorage.removeItem('hallpass_schedule');
            localStorage.removeItem('hallpass_corrections');
            
            classData = null;
            students = [];
            attendanceHistory = {};
            streaks = {};
            
            renderCanvas();
            updateStats();
            closeSettings();
            showToast('All data cleared');
        }
        
        // ========== PERSISTENCE ==========
        function saveClass() {
            if (classData) {
                classData.students = students;
                localStorage.setItem('hallpass_class', JSON.stringify(classData));
            }
        }
        
        function loadSavedData() {
            // Load class
            const savedClass = localStorage.getItem('hallpass_class');
            if (savedClass) {
                classData = JSON.parse(savedClass);
                students = classData.students || [];
                if (classData.settings?.className) {
                    document.getElementById('classSelect').innerHTML = `<option>${classData.settings.className}</option>`;
                }
            }
            
            // Load attendance history
            const savedAttendance = localStorage.getItem('hallpass_attendance');
            if (savedAttendance) {
                attendanceHistory = JSON.parse(savedAttendance);
            }
            
            // Load streaks
            const savedStreaks = localStorage.getItem('hallpass_streaks');
            if (savedStreaks) {
                streaks = JSON.parse(savedStreaks);
            }
            
            // Load schedule
            const savedSchedule = localStorage.getItem('hallpass_schedule');
            if (savedSchedule) {
                schedule = JSON.parse(savedSchedule);
            }
        }
        
        // ========== UTILS ==========
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function spawnConfetti() {
            const colors = ['#22c55e', '#f59e0b', '#3b82f6', '#ec4899', '#8b5cf6'];
            for (let i = 0; i < 20; i++) {
                const conf = document.createElement('div');
                conf.className = 'confetti';
                conf.style.left = (Math.random() * window.innerWidth) + 'px';
                conf.style.top = (window.innerHeight - 100) + 'px';
                conf.style.background = colors[Math.floor(Math.random() * colors.length)];
                conf.style.animationDelay = (Math.random() * 0.5) + 's';
                document.body.appendChild(conf);
                setTimeout(() => conf.remove(), 1500);
            }
        }
        
        // ========== INIT ==========
        document.addEventListener('click', e => {
            if (!e.target.closest('.context-menu') && !e.target.closest('.canvas-student')) {
                closeContextMenu();
            }
        });
        
        // Prevent default context menu
        document.addEventListener('contextmenu', e => {
            if (e.target.closest('.canvas-student')) {
                e.preventDefault();
            }
        });
        
        // Load and start
        loadSavedData();
        renderCanvas();
        updateStatusBar();
        
        // Update countdown every second
        setInterval(updateStatusBar, 1000);
    </script>
</body>
</html>
